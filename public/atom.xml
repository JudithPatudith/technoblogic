<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[JP]]></title>
  <link href="httpL://www.jeffmalnick.com/atom.xml" rel="self"/>
  <link href="httpL://www.jeffmalnick.com/"/>
  <updated>2014-11-17T08:01:09-08:00</updated>
  <id>httpL://www.jeffmalnick.com/</id>
  <author>
    <name><![CDATA[Jeff]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[hiera-template]]></title>
    <link href="httpL://www.jeffmalnick.com/blog/2014/11/03/hiera-template/"/>
    <updated>2014-11-03T05:02:03-08:00</updated>
    <id>httpL://www.jeffmalnick.com/blog/2014/11/03/hiera-template</id>
    <content type="html"><![CDATA[<p>Every time we create a new profile, or update a profile, we have to update our hiera data. This process is error prone and time consuming. Hiera leverages almost any data interchange format (in fact I&rsquo;d bet if you can write the backend for it, it&rsquo;ll support it). The writing of that data can easily be automated, so a tool to write the data files for us was an obvious decision.</p>

<p><a href="https://github.com/malnick/hiera-template">hiera-template</a> is still in its infancy, and will eventually become a much larger part of our workflow. The main goal of this tool, however, remains the same: automate the generation of our hiera data files from our profile classes.</p>

<p>hiera-template is up in Rubygems, but be forewarned, it is VERY much still in BETA. Your mileage will vary and your bug reporting is appreciated.</p>

<h3>Install</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gem install hiera-template</span></code></pre></td></tr></table></div></figure>


<h3>Usage</h3>

<p>hiera-template accepts a single path to a profile as an argument. It can be a local or fully qualified path.</p>

<p>By default, hiera-template will store all processed yaml&rsquo;s in <code>~/.hiera-template/templates/${profile_name}-${hierarchy_level}-template.yaml</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span> <span class="nv">$confdir</span>/modules/profiles/manifests
</span><span class='line'>hiera-template company_frontend.pp
</span></code></pre></td></tr></table></div></figure>


<p>The above will create a baseline hiera data file from all the explicit hiera() lookups in the profile. Yes, you read that right, it will not work on non-explicit hiera() lookups. That will be a feature down the road. For now, the following like-lines will be parsed:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vg">$myvar</span> <span class="o">=</span> <span class="n">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::company_frontend::myvar&#39;</span><span class="p">),</span>
</span></code></pre></td></tr></table></div></figure>


<p>That line will be written to a yaml file as:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">profiles::company_frontend::myvar</span><span class="p-Indicator">:</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Hierarchy Keys</h3>

<p>hiera-template uses <code>#[keys]</code> in the profile to determine what part of the hierarchy the data resides.</p>

<p>Given the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="ss">profiles</span><span class="p">:</span><span class="ss">:csx_frontend_base</span><span class="p">(</span>
</span><span class='line'>  <span class="c1">#[node]</span>
</span><span class='line'>  <span class="vg">$csx_db_name</span>                          <span class="o">=</span> <span class="n">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::csx_frontend_base::csx_db_name&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="vg">$csx_db_user</span>                          <span class="o">=</span> <span class="n">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::csx_frontend_base::csx_db_user&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="vg">$csx_db_password_hash</span>                 <span class="o">=</span> <span class="n">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::csx_frontend_base::csx_db_password_hash&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="c1">#[datacenter]</span>
</span><span class='line'>  <span class="vg">$csx_db_host</span>                          <span class="o">=</span> <span class="n">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::csx_frontend_base::csx_db_host&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="vg">$csx_db_driverclassname</span>               <span class="o">=</span> <span class="n">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::csx_frontend_base::csx_db_driverclassname&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="vg">$csx_db_url</span>                           <span class="o">=</span> <span class="n">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::csx_frontend_base::csx_db_url&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="vg">$csx_db_password</span>                      <span class="o">=</span> <span class="n">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::csx_frontend_base::csx_db_password&#39;</span><span class="p">),</span>
</span></code></pre></td></tr></table></div></figure>


<p>hiera-template will create two yaml files in <code>~/.hiera-template/templates</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">csx_frontend_base</span><span class="o">-</span><span class="n">node</span><span class="o">-</span><span class="n">template</span><span class="o">.</span><span class="n">yaml</span>
</span><span class='line'><span class="n">csx_frontend_base</span><span class="o">-</span><span class="n">datacenter</span><span class="o">-</span><span class="n">template</span><span class="o">.</span><span class="n">yaml</span>
</span></code></pre></td></tr></table></div></figure>


<p>Those templates contain all the keys for the given profile. You can <code>cat *-node-template.yaml &gt; my.new.node.yaml</code> or <code>cat *-datacenter-template.yaml &gt;&gt; out_dc.yaml</code> to create or append the keys to data files. Then, all you need to do is fill in your values.</p>

<h3>Upcoming</h3>

<p>Since writing in data can be so error prone, and hiera is by it&rsquo;s nature hard to debug, a tool ensures your data written to your data files is the same as what is declared in your profiles &ndash; on the flip side, it&rsquo;ll propogate your errors from the profile data declarations to the data file. Either way, you&rsquo;re automating it!</p>

<p>To help write the values to the data files I&rsquo;ll up adding a feature to populate, so you don&rsquo;t have to worry about all that new-fangled white space that YAML loves to hate you for. Populate will prompt your for each value and write it in automatically, so you don&rsquo;t have to open vim: you&rsquo;re prompted with the key, and you type in the value. Done deal.</p>

<h3>Debugging</h3>

<p>Currently, this tool is not hardened by any means. And like everyone else, I can&rsquo;t stay on top of everything. So if you&rsquo;re using it, hit me up with bug reports. There is a <code>-D</code> option to run at debugger level, and I tried to make it obvious what is going on. That&rsquo;s no substitution for reading <code>/lib/template.rb</code> if you get a stack trace though. It&rsquo;s a very simple tool, and right now everything lives in <code>template.rb</code> so it should be easy to figure out.</p>

<h3>Known issues:</h3>

<ol>
<li>It will break if you have other comments in the hiera look up declarations other than keys</li>
<li>It will not work on implicit lookups, you need hiera()</li>
<li>It&rsquo;ll probably be buggy, but have fun and support it if you find it useful</li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Streamlining Puppet Dev Part Duce: Branch the enviro]]></title>
    <link href="httpL://www.jeffmalnick.com/blog/2014/10/07/streamlining-puppet-dev-part-duce-branch-the-enviro/"/>
    <updated>2014-10-07T14:31:39-07:00</updated>
    <id>httpL://www.jeffmalnick.com/blog/2014/10/07/streamlining-puppet-dev-part-duce-branch-the-enviro</id>
    <content type="html"><![CDATA[<p>Most companies don&rsquo;t have a single monolithic application, today most applications evolve out of lots of atomic services: thus, service oriented architecture.</p>

<p>What this means for your development environment is that you end up having many different applications, which is many cases are atomic services and in other cases are a conglomeration of services. Either way, you end up with a need for many dev environments.</p>

<p>At Connect Solutions we have several environments that require infrastructure development. The main ones are our custom load balancer (we call it MTLB), our Connect Cluster, CQ, and our Connect Experience applications.</p>

<p>In order to streamline our dev process with Puppet we created a repo called &lsquo;puppet-dev-enviro&rsquo; that deploys VM&rsquo;s with Vagrant and manages what modules you want to test via Rake &amp; r10k.</p>

<p>For any given envio we like to mirror what it looks like in prod as best we can. Therefore, any enviro always uses the version of puppet we run in prod on a separate Puppet Master, then the nodes that make of the rest of the enviro.</p>

<p>A simple example, theMTLB enviro deploys a Puppet Master and an MTLB load balancer node.</p>

<h2>Enviro Management</h2>

<p>Since we have so many enviros we branch the &lsquo;puppet-dev-enviro&rsquo; repo for each one. So if you&rsquo;re testing MTLB code the workflow looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">cd</span> <span class="n">puppet</span><span class="o">-</span><span class="n">dev</span><span class="o">-</span><span class="n">enviro</span>
</span><span class='line'><span class="n">git</span> <span class="n">checkout</span> <span class="n">mtlb</span>
</span><span class='line'><span class="no">MONO</span><span class="o">=</span><span class="kp">true</span> <span class="n">rake</span> <span class="n">deploy</span>
</span></code></pre></td></tr></table></div></figure>


<p>Those first two commands are pretty straight forward. However, the deploy command probably needs some explanation. I wrote this task to streamline our development pipeline. It&rsquo;s main functionality is to read from a subdirectory called puppet and a file called the Puppetfile.</p>

<p>You might be familiar with the Puppetfile concept if you&rsquo;ve used Puppet Librarian or r10k. In this task, I actually invoke r10k locally on the Puppetfile to pull down all the modules listed in it to puppet/modules. In the case of Connect Solutions, we&rsquo;re currently in the process of moving our legacy puppet module structure from a monolithic one to their own atomic repos. This isn&rsquo;t complete yet, so the MONO=true env variable envokes a subcommand in deploy to rip out all the sub-modules of this monolithic repo and place them in puppet/modules.</p>

<p>&lsquo;Deploy&rsquo; also supports hiera data management by checking for our <code>puppet-configuration</code> repo in the puppet/modules directory. If it&rsquo;s listed in the Puppetfile this repo will be present here. If so, it moves all the data from puppet-configuration into puppet/data.</p>

<p>Both <code>puppet/modueles</code> and <code>puppet/data</code> are shared with the puppet master VM deploed with Vagrant. As a Vagrant post-provisioning step I blow away the <code>/etc/puppetlabs/puppet/modules</code>, <code>/etc/puppetlabs/puppet/data</code> directories and sym link the shared modules and data directories out of <code>/tmp</code>.</p>

<h4>The Deploy Task</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">desc</span> <span class="s1">&#39;Deploying modules form Puppetfile and booting master and agent VMs&#39;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:deploy</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Building out Puppet module directory...&quot;</span>
</span><span class='line'>  <span class="n">confdir</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span>
</span><span class='line'>  <span class="c1"># Check directory structure:</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Checking for puppet/modules...&quot;</span>
</span><span class='line'>  <span class="k">unless</span> <span class="no">Dir</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/modules&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;puppet/modules not found, creating.&quot;</span>
</span><span class='line'>    <span class="no">Dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/modules&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Checking for puppet/data...&quot;</span>
</span><span class='line'>  <span class="k">unless</span> <span class="no">Dir</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/data&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;puppet/data not found, creating.&quot;</span>
</span><span class='line'>    <span class="no">Dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/data&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">moduledir</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/modules&quot;</span>
</span><span class='line'>  <span class="n">puppetfile</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/Puppetfile&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Placing modules in </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Using Puppetfile at </span><span class="si">#{</span><span class="n">puppetfile</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;PUPPETFILE=</span><span class="si">#{</span><span class="n">puppetfile</span><span class="si">}</span><span class="s2"> PUPPETFILE_DIR=</span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2"> /usr/bin/r10k puppetfile install&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">abort</span> <span class="s1">&#39;Failed to build out Puppet module directory. Exiting...&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">if</span> <span class="no">Dir</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">/puppet-configuration/&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Detected puppet data repo, copying contents to </span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/data&quot;</span>
</span><span class='line'>      <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;cp -Rv </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">/puppet-configuration/* </span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/data/&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s2">&quot;Failed to move puppet-configuration&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">mono</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Moving modules out of monolithic dir </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">/puppet-modules to </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;mv </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">/puppet-modules/* </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s2">&quot;Failed to move modules from monolithic repo to </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Bringing up vagrant machines&quot;</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vagrant up --provider virtualbox&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">abort</span> <span class="s1">&#39;Vagrant up failed. Exiting...&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Vagrant Machines Up Successfully</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This structure allows us to play around with the module code on the fly from the host VM, with our own dotfiles and local editing or preferred pipelines. For example, I am a heavy Vim user, however, a lot of my colleagues are Sublime text users. You can choose what method best suites you and not be beholden to who provisioned the VM .box file beforehand.</p>

<p>For large code-base changes, i.e., developing an entireley new topic branch, this pipeline allows seamless integration with git and enables better version control management. An example workflow would be:</p>

<ol>
<li>Open two screen or tmux sessions</li>
<li>In one session cd into <code>/path/to/monolithic/puppet-modules/test-mod/manifests</code></li>
<li>In the other session cd into <code>/path/to/puppet-dev-enviro</code></li>
<li>In <code>puppet-dev-enviro</code>:

<ol>
<li>git checkout my-enviro</li>
<li>update <code>puppet/Puppetfile</code> and <code>`puppet/manifests/site.pp</code></li>
</ol>
</li>
</ol>


<p>puppet/Puppetfile:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="s1">&#39;puppet-modules&#39;</span><span class="p">,</span> <span class="ss">:git</span> <span class="o">=&gt;</span> <span class="n">git</span><span class="vi">@github</span><span class="o">.</span><span class="n">com</span><span class="ss">:connectsolutions</span><span class="o">/</span><span class="n">puppet</span><span class="o">-</span><span class="n">modules</span><span class="s1">&#39;, :ref =&gt; &#39;</span><span class="n">my</span><span class="o">-</span><span class="n">topic</span><span class="o">-</span><span class="n">branch</span><span class="s1">&#39;</span>
</span><span class='line'><span class="s1">&#39;</span><span class="n">puppet</span><span class="o">-</span><span class="n">configuration</span><span class="s1">&#39;, :git =&gt; git@github.com:connectsolutions/puppet-configuration&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>puppet/manifests/site.pp:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">node</span> <span class="err">&#39;</span><span class="n">my</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">dev</span><span class="sb">` {</span>
</span><span class='line'><span class="sb"> include my::class</span>
</span><span class='line'><span class="sb">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>DEPLOY: In <code>puppet-dev-enviro</code> run <code>MONO=true rake deploy</code></p>

<p>This will now pull down and configure the environment for the VM&rsquo;s. When finished, all the puppet data and modules will be live on the master VM.</p>

<h3>Enviro-Specific Vagrantfile</h3>

<p>One step I&rsquo;ve skipped here however is making a git-branch for my-enviro. That&rsquo;s a completely different step but mainly involves updateing the Vagrantfile with the neccessary VM information. I won&rsquo;t cover that here since that is specific to every enviro the same way Puppet code is speciic to each module. I will however share what stays the same between most Vagrantfiles in each enviro and that is the Master VM configuration block:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="no">VAGRANTFILE_API_VERSION</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;ubuntuamd64&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box_url</span> <span class="o">=</span> <span class="s2">&quot;https://cloud-images.ubuntu.com/vagrant/precise/current/precise-server-cloudimg-amd64-vagrant-disk1.box&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">pe_build</span><span class="o">.</span><span class="n">download_root</span> <span class="o">=</span> <span class="s1">&#39;https://s3.amazonaws.com/pe-builds/released/:version&#39;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">pe_build</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;3.3.0&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">forward_agent</span>  <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="ss">:master</span> <span class="k">do</span> <span class="o">|</span><span class="n">master</span><span class="o">|</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="ss">:virtualbox</span> <span class="k">do</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span>
</span><span class='line'>      <span class="n">v</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="mi">2048</span>
</span><span class='line'>  <span class="n">v</span><span class="o">.</span><span class="n">cpus</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;10.28.126.141&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;master.dev&#39;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:hosts</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:pe_bootstrap</span> <span class="k">do</span> <span class="o">|</span><span class="n">pe</span><span class="o">|</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">role</span> <span class="o">=</span> <span class="ss">:master</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;puppet/modules&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/modules&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;puppet/manifests&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/manifests&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;puppet/data&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/data&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;puppet/filestore&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/filestore&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;puppet/&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/puppet&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;rm -rf /etc/puppetlabs/puppet/modules/ &amp;&amp; ln -s /tmp/modules/ /etc/puppetlabs/puppet/&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;rm -rf /etc/puppetlabs/puppet/manifests/ &amp;&amp; ln -s /tmp/manifests/ /etc/puppetlabs/puppet/&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;rm -rf /etc/puppetlabs/puppet/data &amp;&amp; ln -s /tmp/data/ /etc/puppetlabs/puppet/&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;ln -s /tmp/filestore/ /etc/puppetlabs/puppet/&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;rm /etc/puppetlabs/puppet/hiera.yaml &amp;&amp; ln -s /tmp/puppet/hiera.yaml /etc/puppetlabs/puppet/hiera.yaml&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;ln -s /tmp/puppet/fileserver.conf /etc/puppetlabs/puppet/fileserver.conf&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Code Test &ndash;> Develop Pipeline</h3>

<p>Once the VM&rsquo;s are up and running you can ssh into the VM under test and run <code>puppet agent -t</code>. If everything went as planned the agent will get a catlog from the master and start configuring itself. If you&rsquo;re like me, it didn&rsquo;t work on the first try. Now we need to update our code-base.</p>

<p>In the screen or tmux session that is CD&#8217;ed to your <code>puppet-modules</code> directory go into the manifests dir of the code in question. Edit that code or make whatever changes are needed for further testing.</p>

<p>Keep in mind we are working on our <code>my-topic-branch</code> branch of the <code>puppet-modules</code> repo. So when we&rsquo;re done making the local changes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git add my-class.pp
</span><span class='line'>git commit -m <span class="s2">&quot;I made changes&quot;</span>
</span><span class='line'>git push origin my-topic-branch
</span></code></pre></td></tr></table></div></figure>


<p>Then in the other screen window that&rsquo;s in the <code>puppet-dev-enviro</code> directory run:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">MONO</span><span class="o">=</span><span class="nb">true </span>rake pull
</span></code></pre></td></tr></table></div></figure>


<p>This runs only r10k and the workflow neccessary to pull down the new Puppet code. It is a heavy operation if you have a LOT of code in that Puppetfile. We haven&rsquo;t ran into an issue with that yet however for our individual test enviros. The :pull task looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">desc</span> <span class="s1">&#39;Pull down modules in Puppetfile&#39;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:pull</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;This will blow away everything in puppet/modules. Are you sure you want to continue? [y/n]&quot;</span>
</span><span class='line'>  <span class="n">ans</span> <span class="o">=</span> <span class="no">STDIN</span><span class="o">.</span><span class="n">gets</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">ans</span> <span class="o">=~</span> <span class="sr">/^y/</span>
</span><span class='line'>      <span class="n">confdir</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span>
</span><span class='line'>      <span class="n">moduledir</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/modules&quot;</span>
</span><span class='line'>      <span class="n">puppetfile</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/Puppetfile&quot;</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Pulling down new modules in </span><span class="si">#{</span><span class="n">puppetfile</span><span class="si">}</span><span class="s2"> to </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;PUPPETFILE=</span><span class="si">#{</span><span class="n">puppetfile</span><span class="si">}</span><span class="s2"> PUPPETFILE_DIR=</span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2"> /usr/bin/r10k puppetfile install&quot;</span><span class="p">)</span>
</span><span class='line'>          <span class="nb">abort</span> <span class="s1">&#39;Failed to build out Puppet module directory. Exiting...&#39;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;New modules successfully pulled down&quot;</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">mono</span>
</span><span class='line'>          <span class="nb">puts</span> <span class="s2">&quot;Moving modules out of monolithic dir </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">/puppet-modules to </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>          <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;mv </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">/puppet-modules/* </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="nb">abort</span> <span class="s2">&quot;Failed to move modules from monolithic repo to </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="k">if</span> <span class="no">Dir</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">/puppet-configuration/&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;cp -Rv </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">/puppet-configuration/* </span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/data/&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="nb">abort</span> <span class="s2">&quot;Failed to move puppet-configuration&quot;</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>  <span class="k">else</span> <span class="nb">puts</span> <span class="s2">&quot;Exiting...&quot;</span>
</span><span class='line'>      <span class="nb">exit</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now you have new code in your master VM, run <code>puppet agent -t</code> again on your agent.</p>

<h3>Wait a minute!</h3>

<p>Some will say, &ldquo;This is more work than before. Now I have this extra git step!&rdquo;. Yup, that&rsquo;s right, you&rsquo;re forced to commit your changes to your own topic branch before you test on your local machine. Yes, this isn&rsquo;t good for doing work on the airplane. Granted, this test enviro as it currently stands isn&rsquo;t designed for the latter, it&rsquo;s designed towards <strong><em>seamless collaboration</em></strong>.</p>

<p>What do I mean by that? I mean, I don&rsquo;t want to have the conversation with a colleage at 4PM on a Thursday night that goes like this: &ldquo;Hey, I need to collaborate on your code. Can you push it to a topic branch in git for me?&rdquo; &ldquo;Sure, I&rsquo;ll do that as soon as I get home tonight after picking up the kids and making dinner.&rdquo; &ldquo;Great!&rdquo; &hellip; The following day: &ldquo;So hey, I REALLY wanted to test out that code we need in prod by this afternoon last night, but I never saw a push for your branch.&rdquo; &ldquo;Yeah, sorry, I got caught up in stuff. You know, life!&rdquo;.</p>

<p>That &lsquo;extra&rsquo; git step ensures all the development steps are being tracked, and anyone at anytime can spin up this environmnet with the exact same Puppetfile and site.pp configuration and get similar testing results.</p>

<p>Some day, I&rsquo;ll put together a local-only development environment but for now this is not the purpose of what we&rsquo;ve created here.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Arbitrary Commandline Functions for MCO]]></title>
    <link href="httpL://www.jeffmalnick.com/blog/2014/08/31/arbitrary-commandline-functions-for-mco/"/>
    <updated>2014-08-31T08:16:59-07:00</updated>
    <id>httpL://www.jeffmalnick.com/blog/2014/08/31/arbitrary-commandline-functions-for-mco</id>
    <content type="html"><![CDATA[<p>mCollective is a funny tool. The idea behind it is obvious and great: a message bus for node orchestration. But the API and underpinnings are often a black box for many Puppet noobs and even other automation professionals. They mostly stick to the Puppet Enterprise Live Management console to interact with the mCollective back-end, never <code>su peadmin</code> and running a few <code>mco $some_application -F $some_fact</code>.</p>

<p>The truth is, MCO is a powerful backend for orchestration. It gets a bad name because the performance isn&rsquo;t there sometimes, especially at scale. Not to dive into a rabbit hole, but that&rsquo;s often due to user error: 1 broker running over 1000&rsquo;s of nodes; the ActiveMQ JVM being improperly tuned; bad layer 1  (yup, it can be that simple).</p>

<p>One thing about MCO that is true is the API is hard to get through. It makes sense once you get under the hood, and especially after reading through other agents and DDl&rsquo;s but what if all you want is a simple way to run an arbitrary commandline argument on some remote node with MCO? If you don&rsquo;t know what you&rsquo;re doing that could take a while; if you know what you&rsquo;re doing, you still have the write the code.</p>

<p>Well, since MCO runs through an API we can actually architect templates for this exact task, for both the data description language file and the agent ruby script.</p>

<p>Let&rsquo;s start with a basic DDL that will inform an agent running this arbitary command:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">metadata</span> <span class="ss">:name</span>        <span class="o">=&gt;</span> <span class="s1">&#39;&lt;%= @action_name %&gt;&#39;</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:description</span> <span class="o">=&gt;</span> <span class="s1">&#39;&lt;%= @description %&gt;&#39;</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:author</span>      <span class="o">=&gt;</span> <span class="s1">&#39;&lt;%= (@author_name+&#39;</span> <span class="s1">&#39;+ @author_email).strip %&gt;&#39;</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:license</span>     <span class="o">=&gt;</span> <span class="s1">&#39;&lt;%= @license %&gt;&#39;</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:version</span>     <span class="o">=&gt;</span> <span class="s1">&#39;&lt;%= @version %&gt;&#39;</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:url</span>         <span class="o">=&gt;</span> <span class="s1">&#39;&lt;%= @project_url %&gt;&#39;</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:timeout</span>     <span class="o">=&gt;</span> <span class="o">&lt;</span><span class="sx">%= @timeout %&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sx">action &quot;run&quot;, :description =</span><span class="o">&gt;</span> <span class="s1">&#39;&lt;%= @description %&gt;&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">display</span> <span class="ss">:always</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">output</span> <span class="ss">:status</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:description</span> <span class="o">=&gt;</span> <span class="s2">&quot;The exit code of the script&quot;</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:display_as</span>  <span class="o">=&gt;</span> <span class="s2">&quot;Return Value&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">output</span> <span class="ss">:out</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:description</span> <span class="o">=&gt;</span> <span class="s2">&quot;The output of the script on stdout&quot;</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:display_as</span>  <span class="o">=&gt;</span> <span class="s2">&quot;Output Channel&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">output</span> <span class="ss">:err</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:description</span> <span class="o">=&gt;</span> <span class="s2">&quot;The output of the script on stderr&quot;</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:display_as</span>  <span class="o">=&gt;</span> <span class="s2">&quot;Error Channel&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Just a quick shout out to Jeremy Adams who wrote <a href="https://forge.puppetlabs.com/jpadams/runyer">this</a> very ERB template for his Runyer module which does what this rake task does but in Puppet code.</p>

<p>So we&rsquo;ve templated out the basic DDL for the agent. We&rsquo;ve included some metadata and output &ndash; arbitary commands usually just need to be ran without input, for instance <code>df -h</code> and returns the mounted volumes and data about them. That could be handy in orchestration. If we wanted to we could add some inputs here, for example, if we wanted to pass in an arbitrary input to a command. I&rsquo;m not interested in that here, just basic output from a command.</p>

<p>Let&rsquo;s build out the ruby script to run this command:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">MCollective</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Agent</span>
</span><span class='line'>    <span class="k">class</span> <span class="o">&lt;</span><span class="sx">%= @action_name.capitalize %&gt;&lt;RPC::Agent</span>
</span><span class='line'><span class="sx">      activate_when do</span>
</span><span class='line'><span class="sx">        &lt;%=</span> <span class="vi">@activate_condition</span> <span class="sx">%&gt; </span>
</span><span class='line'><span class="sx">      end</span>
</span><span class='line'>
</span><span class='line'><span class="sx">      action &quot;run&quot; do</span>
</span><span class='line'><span class="sx">        command = &#39;&lt;%= (@cmd_prefix+&#39; &#39;+@command).strip %&gt;</span><span class="err">&#39;</span>
</span><span class='line'>        <span class="n">reply</span><span class="o">[</span><span class="ss">:status</span><span class="o">]</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">command</span><span class="p">,</span><span class="ss">:stdout</span> <span class="o">=&gt;</span> <span class="ss">:out</span><span class="p">,</span> <span class="ss">:stderr</span> <span class="o">=&gt;</span> <span class="ss">:err</span><span class="p">,</span> <span class="ss">:chomp</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our arbitary command only has 1 action. It&rsquo;s that simple. We run the command and push our output to the ouputs in the command.</p>

<p>Now let&rsquo;s look at the Rakefile that actually runs this. For me, I store most of my Rakefiles as <code>*.task</code> in <code>~/.rake</code> so I can run them anywhere with <code>rake -g</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Rakefile to create MCO agents and associated DDL</span>
</span><span class='line'><span class="c1"># Author: Jeff Malnick</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">get_agent_template</span><span class="p">()</span>
</span><span class='line'>  <span class="n">template</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;rb.erb&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">get_ddl_template</span><span class="p">()</span>
</span><span class='line'>  <span class="n">template</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;ddl.erb&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">McoAgent</span>
</span><span class='line'>  <span class="nb">require</span> <span class="s1">&#39;erb&#39;</span>
</span><span class='line'>  <span class="kp">attr_accessor</span> <span class="ss">:command</span><span class="p">,</span> <span class="ss">:template</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@command</span>        <span class="o">=</span> <span class="n">command</span>
</span><span class='line'>      <span class="vi">@template</span>       <span class="o">=</span> <span class="n">template</span>
</span><span class='line'>      <span class="vi">@action_name</span>        <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>      <span class="vi">@cmd_prefix</span>     <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>      <span class="vi">@activate_condition</span>     <span class="o">=</span> <span class="kp">false</span>
</span><span class='line'>      <span class="vi">@author_name</span>        <span class="o">=</span> <span class="s1">&#39;anonymous&#39;</span>
</span><span class='line'>      <span class="vi">@author_email</span>       <span class="o">=</span> <span class="s1">&#39;anonym@us&#39;</span>
</span><span class='line'>          <span class="vi">@license</span>            <span class="o">=</span> <span class="s1">&#39;Apache v2&#39;</span>
</span><span class='line'>      <span class="vi">@version</span>            <span class="o">=</span> <span class="s1">&#39;1.0&#39;</span>
</span><span class='line'>          <span class="vi">@project_url</span>        <span class="o">=</span> <span class="s1">&#39;http://www.puppetlabs.com&#39;</span>
</span><span class='line'>      <span class="vi">@timeout</span>            <span class="o">=</span> <span class="mi">15</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">render</span><span class="p">()</span>
</span><span class='line'>      <span class="no">ERB</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@template</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="nb">binding</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span class='line'>      <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</span><span class='line'>          <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">render</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">task</span> <span class="ss">:mco_cmd</span> <span class="k">do</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">command</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;command&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Creating mco agent and data description file for </span><span class="si">#{</span><span class="n">command</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Create Agent .rb File</span>
</span><span class='line'>  <span class="n">agent</span> <span class="o">=</span> <span class="no">McoAgent</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">get_agent_template</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
</span><span class='line'>  <span class="n">agent</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span><span class="p">,</span> <span class="s2">&quot;mco_agents&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">command</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="si">}</span><span class="s2">.rb&quot;</span><span class="p">))</span>
</span><span class='line'>  <span class="n">ddl</span> <span class="o">=</span> <span class="no">McoAgent</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">get_ddl_template</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
</span><span class='line'>  <span class="n">ddl</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span><span class="p">,</span> <span class="s2">&quot;mco_agents&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">command</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="si">}</span><span class="s2">.ddl&quot;</span><span class="p">))</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Path to agent: &quot;</span><span class="p">,</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span><span class="p">,</span> <span class="s2">&quot;mco_agents&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">command</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="si">}</span><span class="s2">.rb&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Path to ddl: &quot;</span><span class="p">,</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span><span class="p">,</span> <span class="s2">&quot;mco_agents&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">command</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="si">}</span><span class="s2">.ddl&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, I wrote my Class into the Rakefile itself. It wasn&rsquo;t long and let me have some clarity, so there wasn&rsquo;t a need to break it out.</p>

<p>The McoAgent Class accepts two attributes, command and template. Pass it a command and a template, for me I have a couple of def&rsquo;s that do this for the agent and ddl respectavely, and it builds out the ERB for us. My init def just declares the variables that we want available to our templates and we&rsquo;re good to go &ndash; the rest is accomplished via the ERB library.</p>

<p>The entire project repo is available <a href="https://github.com/malnick/rake_tasks/tree/master/mco_create_agent">here</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Deploying .box Files from VirtualBox for Vagrant]]></title>
    <link href="httpL://www.jeffmalnick.com/blog/2014/08/03/deploying-box-files-from-virtualbox-for-vagrant/"/>
    <updated>2014-08-03T17:22:54-07:00</updated>
    <id>httpL://www.jeffmalnick.com/blog/2014/08/03/deploying-box-files-from-virtualbox-for-vagrant</id>
    <content type="html"><![CDATA[<p>There are several tools available that streamline the production of the .box format for Vagrant from any open virtualization format (OVF).</p>

<ol>
<li><a href="www.packer.io">Packer</a>
Enables you to boot a given image from an easy to build template. You can provision the machine using many types of configuration management tools such as Puppet and Chef, and run post-installer scritps for anything else.</li>
</ol>


<p>The Templates are easy to use and you can push out a .box file from Packer directly.</p>

<ol>
<li><a href="https://github.com/jedi4ever/veewee">Veewee</a>
Easily converts an ISO to VM formats. Kinda like Packer but not, so Packer made <a href="http://www.packer.io/docs/templates/veewee-to-packer.html">this</a> tool to solve that problem.</li>
</ol>


<h2>My own tool</h2>

<p>Jeff, why would you ever build your own tool when so many others exist? Because I hate troubleshooting other peoples tools. If you&rsquo;ve ever used Packer for anything serious, you could empathize/understand why I want to build my own tool.</p>

<p>What do I want to do?</p>

<ol>
<li>Easily turn any VirtualBox registered VM on my host machine into a .box file and add it to Vagrant.</li>
<li>Deploy it in 1 command.</li>
</ol>


<h2>Architecture</h2>

<p>A Rakefile that calls to sub .task files in a subdir to create then build out the machine.</p>

<p>The top level Rakefile will allocate class variables such as directory strucutre, arrays and hashes used by the lower .task files. It will allocate ENV variables, in particular <code>VM_USER</code> and <code>VM_PASSWORD</code> to be used by the lower .tasks. It will also ensure all environment dependencies such as gems and programs are installed properly.</p>

<h2>Rakefile</h2>

<p>We&rsquo;ll start with the top level Rakefile and work our way down:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">begin</span>
</span><span class='line'>  <span class="nb">require</span> <span class="s1">&#39;rake&#39;</span>
</span><span class='line'>  <span class="nb">require</span> <span class="s1">&#39;expect&#39;</span>
</span><span class='line'>  <span class="nb">require</span> <span class="s1">&#39;net/ssh&#39;</span>
</span><span class='line'><span class="k">rescue</span> <span class="no">LoadError</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Error during load, running bundler&quot;</span>
</span><span class='line'>  <span class="nb">system</span><span class="p">(</span><span class="s1">&#39;bundler&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Load the subtasks</span>
</span><span class='line'><span class="no">Dir</span><span class="o">[</span><span class="s1">&#39;tasks/*.rake&#39;</span><span class="o">].</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span> <span class="nb">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Set top level dir for sub level rake tasks</span>
</span><span class='line'><span class="vi">@cwd</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Ensure we have some deps</span>
</span><span class='line'><span class="n">gems</span> <span class="o">=</span> <span class="sx">%w(net-ssh)</span>
</span><span class='line'><span class="n">gems</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">g</span><span class="o">|</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;gem list --local -q --no-versions --no-details </span><span class="si">#{</span><span class="n">g</span><span class="si">}</span><span class="s2"> | egrep &#39;^</span><span class="si">#{</span><span class="n">g</span><span class="si">}</span><span class="s2">$&#39; &gt; /dev/null 2&gt;&amp;1&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">g</span><span class="si">}</span><span class="s2"> gem not found, installing...&quot;</span>
</span><span class='line'>      <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;gem install </span><span class="si">#{</span><span class="n">g</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>          <span class="nb">abort</span> <span class="s2">&quot;Failed to install gem: </span><span class="si">#{</span><span class="n">g</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nb">exec</span> <span class="o">=</span> <span class="sx">%w(vboxmanage)</span>
</span><span class='line'><span class="nb">exec</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="nb">p</span><span class="o">|</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;which </span><span class="si">#{</span><span class="nb">p</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s2">&quot;Failed to find the executable &#39;</span><span class="si">#{</span><span class="nb">p</span><span class="si">}</span><span class="s2">&#39;, please make sure it&#39;s installed.&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">namespace</span> <span class="ss">:vm</span> <span class="k">do</span>
</span><span class='line'>  <span class="ss">Rake</span><span class="p">:</span><span class="ss">:Task</span><span class="o">[</span><span class="s1">&#39;create&#39;</span><span class="o">].</span><span class="n">execute</span>
</span><span class='line'>  <span class="ss">Rake</span><span class="p">:</span><span class="ss">:Task</span><span class="o">[</span><span class="s1">&#39;build&#39;</span><span class="o">].</span><span class="n">execute</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The comments are self explanitory. We do some basic enviro checks, declare some class variables and load up the subtask files.</p>

<p>Since this is <em>my</em> tool I can do whatever I want. This is going to be a super streamlined process, I only need it to work with VirtualBox so I don&rsquo;t need to get too crazy. I can basically rely on the <code>vboxmanage</code> command line tool to interact with the VM.</p>

<p><strong><em>DISCLAIMER:</em></strong> I originally was going to leverage the <a href="http://net-ssh.github.io">Net::SSH</a> ruby library to run all my post-processing on the VM. I needed some way to SCP scripts to the VM and execute them. Originally I used <code>vboxmanage</code> to get the IP address of the VM, then <code>Net::SSH</code> to SCP and execute commands. I had some methods all worked out for this, but then I ralized this needed to work on the VirtualBox NAT&#8217;ed network.</p>

<p>Ouch.</p>

<p>It would not reliably get a proper IP address and I also needed to do some fancy reverse SSH tunneling to SCP and execute with <code>Net::SSH</code>. I struggled with this for an hour or two and realized my desire to use all Ruby libs to do this interaction was going to be more trouble than it was worth. I instead decided to use the <code>vboxmanage</code> subset of tools that will actually copy data to the VM and execute the data. I re-wrote my copy and execute methods but still kept the <a href="https://github.com/malnick/create-vagrant-box/blob/master/extras/netssh_test.rb">Net::SSH code for later reference</a> since it&rsquo;s super handy.</p>

<h2>Create</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/bin/ruby</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;rake&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;expect&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;net/ssh&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">desc</span> <span class="s1">&#39;Build a Vagrant box from a vBox VM&#39;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:create</span> <span class="k">do</span>
</span><span class='line'>  <span class="c1"># Vars </span>
</span><span class='line'>  <span class="vi">@vmhash</span>     <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>  <span class="vi">@vmname</span>     <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;VM_NAME&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="vi">@vmuser</span>     <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;VM_USER&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="vi">@vmpwd</span>      <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;VM_PWD&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">guestiso</span> <span class="o">=</span> <span class="s1">&#39;4.3.8&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Get the guest edition ISO</span>
</span><span class='line'>  <span class="n">vboxexists</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@cwd</span><span class="si">}</span><span class="s2">/VBoxGuestAdditions_</span><span class="si">#{</span><span class="n">guestiso</span><span class="si">}</span><span class="s2">.iso&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">!</span> <span class="n">vboxexists</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Would you like to install the defualt version of guest editions? [</span><span class="si">#{</span><span class="n">guestiso</span><span class="si">}</span><span class="s2">] [y/n]&quot;</span>
</span><span class='line'>      <span class="n">installdefault</span> <span class="o">=</span> <span class="no">STDIN</span><span class="o">.</span><span class="n">gets</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">installdefault</span> <span class="o">=~</span> <span class="sr">/^y/</span>      
</span><span class='line'>          <span class="nb">puts</span> <span class="s2">&quot;Ok, downloading vBox guest editions version </span><span class="si">#{</span><span class="n">guestiso</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>          <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;wget http://download.virtualbox.org/virtualbox/4.3.8/VBoxGuestAdditions_</span><span class="si">#{</span><span class="n">guestiso</span><span class="si">}</span><span class="s2">.iso&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="nb">puts</span> <span class="s2">&quot;Something broke downloading the guest editions iso.&quot;</span>
</span><span class='line'>              <span class="nb">puts</span> <span class="s1">&#39;This may break the building of the box later, continue? [y/n]&#39;</span>
</span><span class='line'>              <span class="n">cont</span> <span class="o">=</span> <span class="no">STDIN</span><span class="o">.</span><span class="n">gets</span>
</span><span class='line'>              <span class="k">if</span> <span class="n">cont</span> <span class="o">=~</span><span class="sr">/^n/</span>
</span><span class='line'>                  <span class="nb">abort</span> <span class="s1">&#39;Aborting.&#39;</span>
</span><span class='line'>              <span class="k">end</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>          <span class="nb">puts</span> <span class="s2">&quot;Which version would you like to use? [x.x.x]&quot;</span>
</span><span class='line'>          <span class="n">installversion</span> <span class="o">=</span> <span class="no">STDIN</span><span class="o">.</span><span class="n">gets</span>
</span><span class='line'>          <span class="nb">puts</span> <span class="s2">&quot;Ok, downloading vBox guest edition version </span><span class="si">#{</span><span class="n">installversion</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>          <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;wget http://download.virtualbox.org/virtualbox/4.3.8/VBoxGuestAdditions_</span><span class="si">#{</span><span class="n">installversion</span><span class="si">}</span><span class="s2">.iso&quot;</span><span class="p">)</span>
</span><span class='line'>                  <span class="nb">puts</span> <span class="s2">&quot;Something broke downloading http://download.virtualbox.org/virtualbox/4.3.8/VBoxGuestAdditions_</span><span class="si">#{</span><span class="n">installversion</span><span class="si">}</span><span class="s2">.iso&quot;</span>
</span><span class='line'>              <span class="nb">puts</span> <span class="s1">&#39;This may break the buidling of the box later, continue? [y/n]&#39;</span>
</span><span class='line'>              <span class="n">cont</span> <span class="o">=</span> <span class="no">STDIN</span><span class="o">.</span><span class="n">gets</span>
</span><span class='line'>              <span class="k">if</span> <span class="n">cont</span> <span class="o">=~</span> <span class="sr">/^n/</span>
</span><span class='line'>                  <span class="nb">abort</span> <span class="s2">&quot;Aborting.&quot;</span>
</span><span class='line'>              <span class="k">end</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Create a hash of vBox VMs</span>
</span><span class='line'>      <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>      <span class="n">vms</span> <span class="o">=</span> <span class="no">IO</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">&#39;vboxmanage list vms&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">vms</span><span class="o">.</span><span class="n">readlines</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">name</span><span class="o">|</span>
</span><span class='line'>          <span class="vi">@vmhash</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">num</span><span class="p">,</span><span class="nb">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">chomp</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">chomp</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reverse</span><span class="p">)</span>
</span><span class='line'>          <span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="o">+</span><span class="mi">1</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># how many vm&#39;s do we have available?</span>
</span><span class='line'>      <span class="vi">@vmhash</span><span class="o">.</span><span class="n">each_with_index</span> <span class="p">{</span><span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>          <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="vi">@vmhash</span><span class="o">.</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span>
</span><span class='line'>              <span class="vi">@vmmax</span> <span class="o">=</span> <span class="n">i</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Method to find if VM_NAME matches our hash listing</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">findvm</span><span class="p">()</span>
</span><span class='line'>          <span class="vi">@vmhash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">|</span>
</span><span class='line'>              <span class="nb">test</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">chomp</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">chomp</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reverse</span>
</span><span class='line'>              <span class="k">return</span> <span class="n">v</span> <span class="k">if</span> <span class="vi">@vmname</span> <span class="o">=~</span> <span class="sr">/test/</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>          <span class="kp">nil</span>
</span><span class='line'>      <span class="k">end</span>      
</span><span class='line'>
</span><span class='line'>      <span class="c1"># If a VM_NAME was given, don&#39;t list them but check to make sure it&#39;s a good name</span>
</span><span class='line'>      <span class="k">if</span> <span class="o">!</span> <span class="vi">@vmname</span>
</span><span class='line'>          <span class="nb">puts</span> <span class="s2">&quot;Which vBox VM would you like to vagrantize? [1-</span><span class="si">#{</span><span class="vi">@vmmax</span><span class="si">}</span><span class="s2">]&quot;</span>
</span><span class='line'>          <span class="vi">@vmhash</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">#{</span><span class="n">v</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">}</span>
</span><span class='line'>          <span class="n">vmcreate</span> <span class="o">=</span> <span class="no">STDIN</span><span class="o">.</span><span class="n">gets</span><span class="o">.</span><span class="n">chomp</span><span class="o">.</span><span class="n">to_i</span>
</span><span class='line'>          <span class="n">vmax</span> <span class="o">=</span> <span class="vi">@vmmax</span>
</span><span class='line'>          <span class="k">until</span> <span class="n">vmcreate</span><span class="o">.</span><span class="n">between?</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">.</span><span class="n">to_i</span><span class="p">)</span>
</span><span class='line'>              <span class="nb">puts</span> <span class="s2">&quot;Range check&quot;</span>
</span><span class='line'>              <span class="nb">puts</span> <span class="s2">&quot;Please select an integer between 1 and </span><span class="si">#{</span><span class="vi">@vmmax</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>              <span class="n">vmcreate</span> <span class="o">=</span> <span class="no">STDIN</span><span class="o">.</span><span class="n">gets</span><span class="o">.</span><span class="n">chomp</span><span class="o">.</span><span class="n">to_i</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>          <span class="vi">@vmname</span> <span class="o">=</span> <span class="vi">@vmhash</span><span class="o">[</span><span class="n">vmcreate</span><span class="o">]</span>
</span><span class='line'>          <span class="ss">Rake</span><span class="p">:</span><span class="ss">:Task</span><span class="o">[</span><span class="s1">&#39;build&#39;</span><span class="o">].</span><span class="n">execute</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>          <span class="k">if</span> <span class="n">findvm</span>
</span><span class='line'>              <span class="vi">@vmname</span> <span class="o">=</span> <span class="n">findvm</span>
</span><span class='line'>              <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2"> found with actual name: </span><span class="si">#{</span><span class="n">vmname</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>              <span class="ss">Rake</span><span class="p">:</span><span class="ss">:Task</span><span class="o">[</span><span class="s1">&#39;build&#39;</span><span class="o">].</span><span class="n">execute</span>
</span><span class='line'>          <span class="k">else</span>
</span><span class='line'>              <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2"> not found, available vm&#39;s for building are:&quot;</span>
</span><span class='line'>              <span class="vi">@vmhash</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">#{</span><span class="n">v</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">}</span>
</span><span class='line'>              <span class="nb">puts</span> <span class="s2">&quot;Which VM would you like to use? [1-</span><span class="si">#{</span><span class="vi">@vmmax</span><span class="si">}</span><span class="s2">]&quot;</span>
</span><span class='line'>              <span class="n">vmcreate</span> <span class="o">=</span> <span class="no">STDIN</span><span class="o">.</span><span class="n">gets</span><span class="o">.</span><span class="n">chomp</span><span class="o">.</span><span class="n">to_i</span>
</span><span class='line'>              <span class="n">vmax</span> <span class="o">=</span> <span class="vi">@vmmax</span>
</span><span class='line'>              <span class="k">until</span> <span class="n">vmcreate</span><span class="o">.</span><span class="n">between?</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">.</span><span class="n">to_i</span><span class="p">)</span>
</span><span class='line'>                  <span class="nb">puts</span> <span class="s2">&quot;Please select an integer between 1 and </span><span class="si">#{</span><span class="vi">@vmmax</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>                  <span class="n">vmcreate</span> <span class="o">=</span> <span class="no">STDIN</span><span class="o">.</span><span class="n">gets</span><span class="o">.</span><span class="n">chomp</span><span class="o">.</span><span class="n">to_i</span>
</span><span class='line'>              <span class="k">end</span>
</span><span class='line'>              <span class="vi">@vmname</span> <span class="o">=</span> <span class="vi">@vmhash</span><span class="o">[</span><span class="n">vmcreate</span><span class="o">]</span>
</span><span class='line'>              <span class="ss">Rake</span><span class="p">:</span><span class="ss">:Task</span><span class="o">[</span><span class="s1">&#39;build&#39;</span><span class="o">].</span><span class="n">execute</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li><p>Check for vBox guest editions locally: I needed to make sure I had guest editions locally, if I didn&rsquo;t I would prompt to download the most recent release or give myself the option to install a different version.</p></li>
<li><p>Get a list of all the registered VirtualBox VM&rsquo;s on the host: Get the list, create a hash that I can easily choose from with a numbered key.</p></li>
<li><p>Override the previous step if the <code>VM_NAME</code> ENV was given at runtime, ensure this matches with an actual VM registered in the list anyways.</p></li>
<li><p>Run <code>``Rake::Task['build'].excute</code></p></li>
</ol>


<h2>Build</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">desc</span> <span class="s1">&#39;Build the vBox VM with Vagrant parameters&#39;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:build</span> <span class="k">do</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">vmrunning?</span> <span class="p">()</span>
</span><span class='line'>      <span class="k">if</span> <span class="nb">system</span><span class="p">(</span><span class="s1">&#39;vboxmanage list runningvms&#39;</span><span class="p">)</span>
</span><span class='line'>          <span class="n">runningvms</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>          <span class="n">vmproc</span> <span class="o">=</span> <span class="no">IO</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">&#39;vboxmanage list runningvms &gt; /dev/null&#39;</span><span class="p">)</span>
</span><span class='line'>          <span class="n">vmproc</span><span class="o">.</span><span class="n">readlines</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">runningvms</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">v</span><span class="p">)}</span>
</span><span class='line'>          <span class="n">runningvms</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span>
</span><span class='line'>              <span class="k">if</span> <span class="n">v</span> <span class="o">=~</span> <span class="sr">/&quot;</span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="sr">&quot;/</span>
</span><span class='line'>                  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">v</span><span class="si">}</span><span class="s2"> is running.&quot;</span>
</span><span class='line'>                  <span class="kp">true</span>
</span><span class='line'>              <span class="k">else</span>
</span><span class='line'>                  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">v</span><span class="si">}</span><span class="s2"> is not running.&quot;</span>
</span><span class='line'>                  <span class="kp">nil</span> 
</span><span class='line'>              <span class="k">end</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>          <span class="nb">puts</span> <span class="s2">&quot;No VMs are found running via [vboxmanage list runningvms]&quot;</span>
</span><span class='line'>          <span class="nb">exit</span> <span class="mi">1</span>          
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">vminfo</span><span class="p">()</span>
</span><span class='line'>      <span class="vi">@vmdata</span> <span class="o">=</span> <span class="no">IO</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s2">&quot;VBoxManage guestproperty enumerate </span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">vmcp</span><span class="p">(</span><span class="n">locpath</span><span class="p">)</span>
</span><span class='line'>      <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vboxmanage guestcontrol </span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2"> copyto </span><span class="si">#{</span><span class="n">locpath</span><span class="si">}</span><span class="s2"> /root/ --username </span><span class="si">#{</span><span class="vi">@vmuser</span><span class="si">}</span><span class="s2"> --password </span><span class="si">#{</span><span class="vi">@vmpwd</span><span class="si">}</span><span class="s2"> --domain 0755 --verbose&quot;</span><span class="p">)</span>
</span><span class='line'>          <span class="nb">abort</span> <span class="s2">&quot;Failed to copy </span><span class="si">#{</span><span class="n">locpath</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">vmexec</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
</span><span class='line'>      <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vboxmanage guestcontrol </span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2"> exec --image </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2"> --username </span><span class="si">#{</span><span class="vi">@vmuser</span><span class="si">}</span><span class="s2"> --password </span><span class="si">#{</span><span class="vi">@vmpwd</span><span class="si">}</span><span class="s2"> --verbose --wait-stdout&quot;</span><span class="p">)</span>
</span><span class='line'>          <span class="nb">abort</span> <span class="s2">&quot;Failed to run </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2"> on guest machine&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Successfully executed </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">def</span> <span class="nf">vmexec_with_args</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</span><span class='line'>      <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vboxmanage guestcontrol </span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2"> exec --image </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2"> --username </span><span class="si">#{</span><span class="vi">@vmuser</span><span class="si">}</span><span class="s2"> --password </span><span class="si">#{</span><span class="vi">@vmpwd</span><span class="si">}</span><span class="s2"> --verbose --wait-stdout -- </span><span class="si">#{</span><span class="n">args</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>          <span class="nb">abort</span> <span class="s2">&quot;Failed to run </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2"> on guest machine&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Successfully executed </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;-----&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Vagrantizing </span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1"># Start the VM</span>
</span><span class='line'>  <span class="n">start</span> <span class="o">=</span> <span class="no">IO</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s2">&quot;vboxmanage startvm </span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="vi">@proc_id</span> <span class="o">=</span> <span class="n">start</span><span class="o">.</span><span class="n">pid</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Process ID for VM: </span><span class="si">#{</span><span class="vi">@proc_id</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Waiting to bring up machine...&quot;</span>
</span><span class='line'>  <span class="nb">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># The main loop</span>
</span><span class='line'>  <span class="k">while</span> <span class="n">vmrunning?</span>
</span><span class='line'>      <span class="c1"># Get VM IP Address</span>
</span><span class='line'>      <span class="n">vminfo</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">line</span><span class="o">|</span>
</span><span class='line'>          <span class="k">if</span> <span class="n">line</span> <span class="o">=~</span> <span class="sr">/IP/</span>
</span><span class='line'>              <span class="n">arry</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="vi">@vmip</span> <span class="o">=</span> <span class="n">arry</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">strip</span><span class="o">.</span><span class="n">chomp</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Waiting for VM to become ready...&quot;</span>
</span><span class='line'>      <span class="nb">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Copy scripts dir to a locally accessible place</span>
</span><span class='line'>      <span class="n">scripts</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">[</span><span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@cwd</span><span class="si">}</span><span class="s2">/scripts/*.sh&quot;</span><span class="o">]</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Script dir: </span><span class="si">#{</span><span class="n">scripts</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="n">scripts</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">s</span><span class="o">|</span>
</span><span class='line'>          <span class="nb">puts</span> <span class="s2">&quot;Copying </span><span class="si">#{</span><span class="n">s</span><span class="si">}</span><span class="s2"> to VM...&quot;</span>
</span><span class='line'>          <span class="n">vmcp</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      
</span><span class='line'>      <span class="n">geiso</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">[</span><span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@cwd</span><span class="si">}</span><span class="s2">/*.iso&quot;</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Copy guest editions over</span>
</span><span class='line'>      <span class="n">geiso</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">iso</span><span class="o">|</span>
</span><span class='line'>          <span class="nb">puts</span> <span class="s2">&quot;Copying </span><span class="si">#{</span><span class="n">iso</span><span class="si">}</span><span class="s2"> to VM...&quot;</span>
</span><span class='line'>          <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vboxmanage guestcontrol </span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2"> copyto </span><span class="si">#{</span><span class="n">iso</span><span class="si">}</span><span class="s2"> /root/ --username </span><span class="si">#{</span><span class="vi">@vmuser</span><span class="si">}</span><span class="s2"> --password </span><span class="si">#{</span><span class="vi">@vmpwd</span><span class="si">}</span><span class="s2"> --domain 0755 --verbose&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="nb">abort</span> <span class="s2">&quot;Failed to copy </span><span class="si">#{</span><span class="n">iso</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">vmexec_with_args</span><span class="p">(</span><span class="s2">&quot;/bin/chmod&quot;</span><span class="p">,</span> <span class="s2">&quot;0755 /root/vagrant.sh&quot;</span><span class="p">)</span> 
</span><span class='line'>      <span class="n">vmexec_with_args</span><span class="p">(</span><span class="s2">&quot;/bin/chmod&quot;</span><span class="p">,</span> <span class="s2">&quot;0755 /root/vboxguest.sh&quot;</span><span class="p">)</span>   
</span><span class='line'>      <span class="n">vmexec_with_args</span><span class="p">(</span><span class="s2">&quot;/bin/chmod&quot;</span><span class="p">,</span> <span class="s2">&quot;0755 /root/compact.sh&quot;</span><span class="p">)</span> 
</span><span class='line'>      <span class="n">vmexec</span><span class="p">(</span><span class="s1">&#39;/root/vagrant.sh&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">vmexec</span><span class="p">(</span><span class="s1">&#39;/root/vboxguest.sh&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">vmexec</span><span class="p">(</span><span class="s1">&#39;/root/compact.sh&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># </span>
</span><span class='line'>      <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vboxmanage controlvm </span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2"> poweroff&quot;</span><span class="p">)</span>
</span><span class='line'>          <span class="nb">abort</span> <span class="s1">&#39;Failed to shutdown vm&#39;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Waiting for VM to shutdown.&quot;</span>
</span><span class='line'>      <span class="nb">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Packing vm...&quot;</span>
</span><span class='line'>      <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vagrant package --base </span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>                <span class="nb">abort</span> <span class="s2">&quot;Failed to package the vm.&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;All done.&quot;</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;-----&quot;</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;VM package available at:&quot;</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@cwd</span><span class="si">}</span><span class="s2">/package.box&quot;</span>
</span><span class='line'>      <span class="nb">exit</span> <span class="mi">0</span>
</span><span class='line'>      <span class="c1">#Process.kill(@proc_id) and exit 0</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Package the box up</span>
</span><span class='line'>  <span class="c1"># vagrant package --output centos-6.5-x86_64.box --base centos-6.5-x86_64 &lt;-- example.</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, that first method is what I&rsquo;m going to wrap this entire program in &ndash; as long as the VM is running, lets copy some scripts to it, ensure they can be executed, then execute them.</p>

<h3>vmrunning?()</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">vmrunning?</span> <span class="p">()</span>
</span><span class='line'>  <span class="k">if</span> <span class="nb">system</span><span class="p">(</span><span class="s1">&#39;vboxmanage list runningvms&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">runningvms</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>      <span class="n">vmproc</span> <span class="o">=</span> <span class="no">IO</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">&#39;vboxmanage list runningvms &gt; /dev/null&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">vmproc</span><span class="o">.</span><span class="n">readlines</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">runningvms</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">v</span><span class="p">)}</span>
</span><span class='line'>      <span class="n">runningvms</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span>
</span><span class='line'>          <span class="k">if</span> <span class="n">v</span> <span class="o">=~</span> <span class="sr">/&quot;</span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="sr">&quot;/</span>
</span><span class='line'>              <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">v</span><span class="si">}</span><span class="s2"> is running.&quot;</span>
</span><span class='line'>              <span class="kp">true</span>
</span><span class='line'>          <span class="k">else</span>
</span><span class='line'>              <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">v</span><span class="si">}</span><span class="s2"> is not running.&quot;</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;No VMs are found running via [vboxmanage list runningvms]&quot;</span>
</span><span class='line'>      <span class="nb">exit</span> <span class="mi">1</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Pop open a vboxmanage process to list out the running VM&rsquo;s, ensure our VM exists there.</p>

<h3>vminfo()</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">vminfo</span><span class="p">()</span>
</span><span class='line'>  <span class="vi">@vmdata</span> <span class="o">=</span> <span class="no">IO</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s2">&quot;VBoxManage guestproperty enumerate </span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Super simple, use vbox manage to get a listing of VM data using <code>guestproperty enumerate</code>. I used the <code>.readlines</code> method so I could iterate it into an array easily.</p>

<h3>vmcp(locpath)</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">vmcp</span><span class="p">(</span><span class="n">locpath</span><span class="p">)</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vboxmanage guestcontrol </span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2"> copyto </span><span class="si">#{</span><span class="n">locpath</span><span class="si">}</span><span class="s2"> /root/ --username </span><span class="si">#{</span><span class="vi">@vmuser</span><span class="si">}</span><span class="s2"> --password </span><span class="si">#{</span><span class="vi">@vmpwd</span><span class="si">}</span><span class="s2"> --domain 0755 --verbose&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s2">&quot;Failed to copy </span><span class="si">#{</span><span class="n">locpath</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Use the guestcontrol command for vboxmanage to copy stuff from my host to the guest. Copies it to <code>/root</code> by default.</p>

<h3>vmexec(cmd)</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">vmexec</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vboxmanage guestcontrol </span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2"> exec --image </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2"> --username </span><span class="si">#{</span><span class="vi">@vmuser</span><span class="si">}</span><span class="s2"> --password </span><span class="si">#{</span><span class="vi">@vmpwd</span><span class="si">}</span><span class="s2"> --verbose --wait-stdout&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s2">&quot;Failed to run </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2"> on guest machine&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Successfully executed </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Execute commands without arguments on the guest VM. Handy for running my scripts after I copy them over or changing file permissions.</p>

<h3>vmexec_with_args(cmd, args)</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">vmexec_with_args</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vboxmanage guestcontrol </span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2"> exec --image </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2"> --username </span><span class="si">#{</span><span class="vi">@vmuser</span><span class="si">}</span><span class="s2"> --password </span><span class="si">#{</span><span class="vi">@vmpwd</span><span class="si">}</span><span class="s2"> --verbose --wait-stdout -- </span><span class="si">#{</span><span class="n">args</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s2">&quot;Failed to run </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2"> on guest machine&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Successfully executed </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Do the exec with arguments if needed.</p>

<h2>Execute some scripts on the VM, exit, package the .box</h2>

<p>The rest of the script is pretty straight forward. I drop into my <code>unless vmrunning?()</code> loop, copy over my scripts, run some <code>chmod</code> commands and execute them.</p>

<p>The scripts setup the Vagrant user and environmnent then install vBox Guest Editions and shutdown the VM once the scripts complete.</p>

<p>Then it&rsquo;s simply a matter of using the <code>vagrant package --base</code> command on the box <strong><em>with the correct box timecode attached to it</em></strong>. (that last bit is completely undocumented).</p>

<h2>Complete Project</h2>

<p><a href="https://github.com/malnick/create-vagrant-box/">Available Here</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Agile Dev Environment for Puppet Code]]></title>
    <link href="httpL://www.jeffmalnick.com/blog/2014/07/21/agile-dev-environment-for-puppet-code/"/>
    <updated>2014-07-21T12:15:51-07:00</updated>
    <id>httpL://www.jeffmalnick.com/blog/2014/07/21/agile-dev-environment-for-puppet-code</id>
    <content type="html"><![CDATA[<p>When ever I am creating a new Puppet module or working on someone else&rsquo;s Puppet module I constantly look for ways to make more efficient the development process.</p>

<p>It may not seem like a lot of time but all those &lsquo;vagrant up&rsquo; &lsquo;vagrant destroy&rsquo; &lsquo;git pull&rsquo; &lsquo;git commit&rsquo; &lsquo;&hellip;push, branch&hellip;&rsquo; etc turn into a lot of time wasted.</p>

<p>What I need is an easy way to pull in git-based (or forge-based) modules to a VM and have them available locally to edit with my favorite editor.</p>

<p>This environment needs to satisfy these needs:</p>

<ol>
<li>I can edit my code on my host machine in my favorit editor (vim) which has all my favorite plugins</li>
<li>The code is live on the VM, sym linked from the VM to my host so I don&rsquo;t have to git push/pull to update the VM (or some other jank process)</li>
<li>I can easily deploy many modules/dependances for the code to the VM with a simple Rake command</li>
</ol>


<h2>Solution</h2>

<p>To solve this development issue I forked a loanly project from nval0. It was a basic Rakefile which was using Puppet-librarian to pull in modules from a Puppetfile.</p>

<p>The environment used:</p>

<ol>
<li>Puppet librarian for module management via Puppetfile</li>
<li>Vagrant VMs</li>
<li>Wrapped up some of the commands into a Rakefile (gem prereq&rsquo;s etc)</li>
</ol>


<p>After playing with this environment for a bit I realized some drawbacks:</p>

<ol>
<li>Puppet-librarian only worked on ruby 1.9</li>
<li>I wanted a rake task to &lsquo;deploy&rsquo; everything in the Puppetfile to sym-linked dir to the VM</li>
</ol>


<p>The first draw back was easily solved, instead of using Puppet-librarian I&rsquo;d use <a href="https://github.com/adrienthebo/r10k">r10k</a>. R10k builds off of Puppet-libarian and is most often used to map git branches for any Puppet module to local Puppet environments on a Puppet Master. However, you can use it in a similar fashion to Puppet-libarian where it only reads a Puppetfile then pulls in those modules directly. The great thing is it works on all major releases of Ruby so my dev environment will not need rbenv or another ruby environment manager.</p>

<h3>Let&rsquo;s put this together into some rake tasks:</h3>

<p>An example rake task to deploy the Puppetfile modules with r10k:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">desc</span> <span class="s1">&#39;Pull down modules in Puppetfile&#39;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:pull</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">confdir</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span>
</span><span class='line'>  <span class="n">moduledir</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/modules&quot;</span>
</span><span class='line'>  <span class="n">puppetfile</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/Puppetfile&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Pulling down new modules in </span><span class="si">#{</span><span class="n">puppetfile</span><span class="si">}</span><span class="s2"> to </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;PUPPETFILE=</span><span class="si">#{</span><span class="n">puppetfile</span><span class="si">}</span><span class="s2"> PUPPETFILE_DIR=</span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2"> /usr/bin/r10k puppetfile install&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s1">&#39;Failed to build out Puppet module directory. Exiting...&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;New modules successfully pulled down&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This first rake task uses r10k to read the Puppetfile and pull down the modules listed in it to the module directory.</p>

<p>Let&rsquo;s link this directory into the VM via the Vagrantfile, this way we can edit the code locally on the host while having it available to run on the Master VM:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="ss">:master</span> <span class="k">do</span> <span class="o">|</span><span class="n">master</span><span class="o">|</span>
</span><span class='line'>  <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;10.10.100.100&quot;</span>
</span><span class='line'>  <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;master.puppetlabs.vm&#39;</span>
</span><span class='line'>  <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:hosts</span>
</span><span class='line'>  <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:pe_bootstrap</span> <span class="k">do</span> <span class="o">|</span><span class="n">pe</span><span class="o">|</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">role</span> <span class="o">=</span> <span class="ss">:master</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;puppet/modules&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/modules&quot;</span>
</span><span class='line'>  <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;puppet/manifests&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/manifests&quot;</span>
</span><span class='line'>  <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;service iptables stop&quot;</span>
</span><span class='line'>  <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;rm -rf /etc/puppetlabs/puppet/modules/ &amp;&amp; ln -s /tmp/modules/ /etc/puppetlabs/puppet/&quot;</span>
</span><span class='line'>  <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;rm -rf /etc/puppetlabs/puppet/manifests/ &amp;&amp; ln -s /tmp/manifests/ /etc/puppetlabs/puppet/&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Why did I use the shell provisioner to sym link /tmp/modules and /tmp/manifests to <code>$confdir/modules</code> and <code>$confdir/manifests</code>?</p>

<p>The pe_build plugin for Vagrant will provision the master using the default Puppet Enterprise installer. However, the installer will fail if any PE-related directories already exist (/opt/puppet or /etc/puppetlabs for example).
To get around this, and still have live dir&rsquo;s provisioned on the VM I couldn&rsquo;t use the vagrant <code>synced_folder</code> method since that will run before the provisioners run (vagrant needs to build the machine before running any type of configuration managment on it) &ndash; the PE installer will blow up when the plugin runs since I have to sync into /etc/puppetlabs/puppet.</p>

<p>So instead of syncing into a PE-specific PATH I sync into /tmp, and then when the provisioner finishes (provisioners are ran in order) I can sym link the PE-specific module and manifests dir&rsquo;s from /tmp.</p>

<h3>Complete Vagrantfile:</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Now</span> <span class="n">we</span> <span class="n">have</span> <span class="n">a</span> <span class="no">Rakefile</span> <span class="n">that</span> <span class="n">wraps</span> <span class="n">up</span> <span class="n">some</span> <span class="n">deploy</span> <span class="n">commands</span> <span class="ow">and</span> <span class="n">a</span>
</span><span class='line'><span class="c1"># -*- mode: ruby -*-</span>
</span><span class='line'><span class="c1"># vi: set ft=ruby :</span>
</span><span class='line'><span class="c1"># Vagrantfile API/syntax version. Don&#39;t touch unless you know what you&#39;re doing!</span>
</span><span class='line'><span class="no">VAGRANTFILE_API_VERSION</span> <span class="o">=</span> <span class="s2">&quot;2&quot;</span>
</span><span class='line'><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="no">VAGRANTFILE_API_VERSION</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;centos-64-x64-vbox4210.box&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box_url</span> <span class="o">=</span> <span class="s2">&quot;http://puppet-vagrant-boxes.puppetlabs.com/centos-64-x64-vbox4210.box&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">pe_build</span><span class="o">.</span><span class="n">download_root</span> <span class="o">=</span> <span class="s1">&#39;https://s3.amazonaws.com/pe-builds/released/:version&#39;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">pe_build</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;3.2.3&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">## Master</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="ss">:master</span> <span class="k">do</span> <span class="o">|</span><span class="n">master</span><span class="o">|</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;10.10.100.100&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;master.puppetlabs.vm&#39;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:hosts</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:pe_bootstrap</span> <span class="k">do</span> <span class="o">|</span><span class="n">pe</span><span class="o">|</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">role</span> <span class="o">=</span> <span class="ss">:master</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;puppet/modules&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/modules&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;puppet/manifests&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/manifests&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;service iptables stop&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;rm -rf /etc/puppetlabs/puppet/modules/ &amp;&amp; ln -s /tmp/modules/ /etc/puppetlabs/puppet/&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;rm -rf /etc/puppetlabs/puppet/manifests/ &amp;&amp; ln -s /tmp/manifests/ /etc/puppetlabs/puppet/&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">## Agent </span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="ss">:agent1</span> <span class="k">do</span> <span class="o">|</span><span class="n">agent</span><span class="o">|</span>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;10.10.100.111&quot;</span>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;agent1.puppetlabs.vm&#39;</span>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:hosts</span>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:pe_bootstrap</span> <span class="k">do</span> <span class="o">|</span><span class="n">pe</span><span class="o">|</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">role</span>   <span class="o">=</span>  <span class="ss">:agent</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">master</span> <span class="o">=</span> <span class="s1">&#39;master.puppetlabs.vm&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now I have an easy to use Vagrantfile that can boot my master with sym linked module and manifests dirs and an agent to test on.</p>

<p>Now we need to finish out that Rakefile, adding in some dependancy checks and some tasks to setup, deploy, pull (modules on the fly) and destroy as needed:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">begin</span>
</span><span class='line'>  <span class="nb">require</span> <span class="s1">&#39;os&#39;</span>
</span><span class='line'>  <span class="nb">require</span> <span class="s1">&#39;ptools&#39;</span>
</span><span class='line'><span class="k">rescue</span> <span class="no">LoadError</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Error during requires: </span><span class="se">\t</span><span class="si">#{</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">abort</span> <span class="s2">&quot;You may be able to fix this problem by running &#39;bundle&#39;.&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">task</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="s1">&#39;deps&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">necessary_programs</span> <span class="o">=</span> <span class="sx">%w(VirtualBox vagrant)</span>
</span><span class='line'><span class="n">necessary_plugins</span> <span class="o">=</span> <span class="sx">%w(vagrant-auto_network vagrant-pe_build vagrant-vmware-fusion)</span>
</span><span class='line'><span class="n">necessary_gems</span> <span class="o">=</span> <span class="sx">%w(bundle r10k)</span>
</span><span class='line'>
</span><span class='line'><span class="n">desc</span> <span class="s1">&#39;Check for the environment dependencies&#39;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:deps</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s1">&#39;Checking environment dependencies...&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">printf</span> <span class="s2">&quot;Is this a POSIX OS?...&quot;</span>
</span><span class='line'>  <span class="k">unless</span> <span class="no">OS</span><span class="o">.</span><span class="n">posix?</span>
</span><span class='line'>    <span class="nb">abort</span> <span class="s1">&#39;Sorry, you need to be running Linux or OSX to use this Vagrant environment!&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;OK&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">necessary_programs</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">prog</span><span class="o">|</span>
</span><span class='line'>    <span class="nb">printf</span> <span class="s2">&quot;Checking for %s...&quot;</span><span class="p">,</span> <span class="n">prog</span>
</span><span class='line'>    <span class="k">unless</span> <span class="no">File</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="n">prog</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sorry but I didn&#39;t find require program </span><span class="se">\&#39;</span><span class="si">#{</span><span class="n">prog</span><span class="si">}</span><span class="se">\&#39;</span><span class="s2"> in your PATH.</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;OK&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">necessary_plugins</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">plugin</span><span class="o">|</span>
</span><span class='line'>    <span class="nb">printf</span> <span class="s2">&quot;Checking for vagrant plugin %s...&quot;</span><span class="p">,</span> <span class="n">plugin</span>
</span><span class='line'>    <span class="k">unless</span> <span class="sx">%x{vagrant plugin list}</span><span class="o">.</span><span class="n">include?</span> <span class="n">plugin</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sorry, I wasn&#39;t able to find the Vagrant plugin </span><span class="se">\&#39;</span><span class="si">#{</span><span class="n">plugin</span><span class="si">}</span><span class="se">\&#39;</span><span class="s2"> on your system.&quot;</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s2">&quot;You may be able to fix this by running &#39;rake setup</span><span class="se">\&#39;</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;OK&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">necessary_gems</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">gem</span><span class="o">|</span>
</span><span class='line'>    <span class="nb">printf</span> <span class="s2">&quot;Checking for Ruby gem %s...&quot;</span><span class="p">,</span> <span class="n">gem</span>
</span><span class='line'>    <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;gem list --local -q --no-versions --no-details </span><span class="si">#{</span><span class="n">gem</span><span class="si">}</span><span class="s2"> | egrep &#39;^</span><span class="si">#{</span><span class="n">gem</span><span class="si">}</span><span class="s2">$&#39; &gt; /dev/null 2&gt;&amp;1&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sorry, I wasn&#39;t able to find the </span><span class="se">\&#39;</span><span class="si">#{</span><span class="n">gem</span><span class="si">}</span><span class="se">\&#39;</span><span class="s2"> gem on your system.&quot;</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s2">&quot;You may be able to fix this by running </span><span class="se">\&#39;</span><span class="s2">gem install </span><span class="si">#{</span><span class="n">gem</span><span class="si">}</span><span class="se">\&#39;</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;OK&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">printf</span> <span class="s2">&quot;Checking for additional gems via &#39;bundle check&#39;...&quot;</span>
</span><span class='line'>  <span class="k">unless</span> <span class="sx">%x{bundle check}</span>
</span><span class='line'>    <span class="nb">abort</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;OK&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s1">&#39;*&#39;</span> <span class="o">*</span> <span class="mi">80</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Congratulations! Everything looks a-ok.&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s1">&#39;*&#39;</span> <span class="o">*</span> <span class="mi">80</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">desc</span> <span class="s1">&#39;Install the necessary Vagrant plugins&#39;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:setup</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">necessary_plugins</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">plugin</span><span class="o">|</span>
</span><span class='line'>    <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vagrant plugin install </span><span class="si">#{</span><span class="n">plugin</span><span class="si">}</span><span class="s2"> --verbose&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s2">&quot;Install of </span><span class="si">#{</span><span class="n">plugin</span><span class="si">}</span><span class="s2"> failed. Exiting...&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">necessary_gems</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">gem</span><span class="o">|</span>
</span><span class='line'>    <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;gem install </span><span class="si">#{</span><span class="n">gem</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s2">&quot;Install of </span><span class="si">#{</span><span class="n">gem</span><span class="si">}</span><span class="s2"> failed. Exiting...&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">unless</span> <span class="sx">%x{bundle check}</span>
</span><span class='line'>    <span class="nb">system</span><span class="p">(</span><span class="s1">&#39;bundle install&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">desc</span> <span class="s1">&#39;Deploying modules form Puppetfile and booting master and agent VMs&#39;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:deploy</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Building out Puppet module directory...&quot;</span>
</span><span class='line'>  <span class="n">confdir</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span>
</span><span class='line'>  <span class="n">moduledir</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/modules&quot;</span>
</span><span class='line'>  <span class="n">puppetfile</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/Puppetfile&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Placing modules in </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Using Puppetfile at </span><span class="si">#{</span><span class="n">puppetfile</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;PUPPETFILE=</span><span class="si">#{</span><span class="n">puppetfile</span><span class="si">}</span><span class="s2"> PUPPETFILE_DIR=</span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2"> /usr/bin/r10k puppetfile install&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">abort</span> <span class="s1">&#39;Failed to build out Puppet module directory. Exiting...&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Bringing up vagrant machines&quot;</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vagrant up master agent1&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">abort</span> <span class="s1">&#39;Vagrant up failed. Exiting...&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Vagrant Machines Up Successfully</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Access master at &#39;vagrant ssh master&#39; or &#39;ssh vagrant@10.10.100.100&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Password = vagrant&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;-----&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Puppet modules brought in via puppet/Puppetfile are available on the Vagrant master VM at /etc/puppetlabs/puppet/modules&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;-----&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Contact git owner for PR&#39;s &amp; bug fixes&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;-----&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Done.&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">desc</span> <span class="s1">&#39;Pull down modules in Puppetfile&#39;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:pull</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">confdir</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span>
</span><span class='line'>  <span class="n">moduledir</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/modules&quot;</span>
</span><span class='line'>  <span class="n">puppetfile</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/Puppetfile&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Pulling down new modules in </span><span class="si">#{</span><span class="n">puppetfile</span><span class="si">}</span><span class="s2"> to </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;PUPPETFILE=</span><span class="si">#{</span><span class="n">puppetfile</span><span class="si">}</span><span class="s2"> PUPPETFILE_DIR=</span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2"> /usr/bin/r10k puppetfile install&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s1">&#39;Failed to build out Puppet module directory. Exiting...&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;New modules successfully pulled down&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="n">desc</span> <span class="s1">&#39;Destroy Vagrant Machines&#39;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:destroy</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Are you sure you want to destroy the environment? [y/n]&quot;</span>
</span><span class='line'>  <span class="no">STDOUT</span><span class="o">.</span><span class="n">flush</span>
</span><span class='line'>  <span class="n">ans</span> <span class="o">=</span> <span class="no">STDIN</span><span class="o">.</span><span class="n">gets</span><span class="o">.</span><span class="n">chomp</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">ans</span> <span class="o">=~</span> <span class="sr">/^y/</span>
</span><span class='line'>      <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vagrant destroy -f&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s1">&#39;Aborting vagrant destroy, exiting...&#39;</span>
</span><span class='line'>  <span class="k">end</span>      
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><a href="https://github.com/malnick/puppet-module-devtest-skeleton/tree/malnick">Entire project</a> is available on git.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Managing Git Repos over Jump Hosts using Persistant Sockets]]></title>
    <link href="httpL://www.jeffmalnick.com/blog/2014/07/14/managing-git-repos-over-jump-hosts-using-persistant-sockets/"/>
    <updated>2014-07-14T07:09:09-07:00</updated>
    <id>httpL://www.jeffmalnick.com/blog/2014/07/14/managing-git-repos-over-jump-hosts-using-persistant-sockets</id>
    <content type="html"><![CDATA[<p>I was recently helping a customer who had a somewhat complicated git workflow to production. All their Puppet code was in a locally accessible Gitlab server which was used by all the Automation dev&rsquo;s to develop, test and push to.</p>

<p>However, their integration and production environments were located behind a jumphost which also required a custom VPN connection.</p>

<p>The problem was that this deployment relied on <a href="https://github.com/adrienthebo/r10k">r10k</a> and the Puppet master needed access to the Gitlab server to create the local environments in both integration and eventually production.</p>

<p>Enabling a streamlined process to move the Gitlab codebase from our dev area into the corralled VM behind the jumphost was needed.</p>

<p>This workflow involves several steps:</p>

<ol>
<li>Connect NA Client VPN to Jumphost</li>
<li>SSH to Jumphost and enter auth credentials</li>
<li>SSH into yum repo server behind jumphost</li>
<li>Enter in yum repo auth credentials</li>
<li>scp your data &ndash; many ways to skin that cat, all are somewhat complicated</li>
</ol>


<h2>Automate with persistant SSH sockets</h2>

<p>I decided to write a SSH script which will do this, and I wanted to ensure we didn&rsquo;t fall into &lsquo;password&rsquo; hell and have to enter in a new password every time. I had heard you could do this by using the &lsquo;ControlMaster&rsquo; SSH param in SSH_config, open a persistant socket, and reuse it as needed. If I could enable this over a jumphost was another question but I gave it a shot.</p>

<ol>
<li><p>Create a persistant socket to jumphost with tunnel on localhost through the jumphost, pushing traffic from port 22 &ndash;> 5000</p>

<pre><code> ssh -o 'ControlMaster auto' -o 'ControlPath ~/.ssh/jump.sock' -N -f -L 5000:[git_repo_ip]:22 root@[jumphost_ip]
</code></pre></li>
<li><p>Create a direct persistant socket to the integration or production Gitlab server on localhost tunnel</p>

<pre><code> ssh -o 'ControlMaster auto' -o 'ControlPath ~/.ssh/git.sock' -N -f root@localhost -p 5000
</code></pre></li>
<li><p>CP arbitrary documents easily</p>

<p> scp -o &lsquo;ControlPath ~/.ssh/yum.sock&rsquo; -P 5000 $filepath root@localhost:/tmp/</p></li>
<li><p>SSH (no password required once socket is created!)</p>

<pre><code> ssh -S ~/.ssh/yum.sock root@localhost -p 5000
</code></pre></li>
<li><p>To destroy the sockets you need to do the yum repo first and jump second</p>

<pre><code> ssh -S ~/.ssh/yum.sock -O exit root@localhost &amp;&amp; ssh -S ~/.ssh/jump.sock -O exit root@172.20.100.11
</code></pre></li>
</ol>


<h2>A quick script</h2>

<p>Now that I can create persistant sockets I wrote a script to SSH into the local git, run <code>rake::restore</code>, scp the backup to my host, scp the backup from my host into the integration git over the jumphost connection, and run rake::restore.</p>

<ol>
<li>Check to ensure I&rsquo;m connected to the correct VPN Gateway</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="nb">test</span> <span class="o">-</span><span class="n">e</span> <span class="o">~</span><span class="sr">/.ssh || { echo &quot;Create an ssh dir&quot;; exit 1; }</span>
</span><span class='line'>
</span><span class='line'><span class="sr"> VPNENV=`echo $(naclient status | awk &#39;NR==4&#39; | cut -d: -f2)`</span>
</span><span class='line'><span class="sr"> VPNREMOTE=&quot;data_center&quot;</span>
</span><span class='line'><span class="sr"> LOCALGIT=&quot;10.10.100.100&quot;</span>
</span><span class='line'><span class="sr"> INTGIT=&quot;172.24.100.10&quot;</span>
</span><span class='line'><span class="sr"> JUMPHOST=&quot;172.20.100.11&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="sr"> if [ &quot;$VPNENV&quot; == &quot;$VPNREMOTE&quot; ]</span>
</span><span class='line'><span class="sr"> then</span>
</span><span class='line'><span class="sr">     echo &quot;Connected to $VPNENV&quot;</span>
</span><span class='line'><span class="sr"> </span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>Build the sockets</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="n">echo</span> <span class="s2">&quot;Connecting to local git:&quot;</span>
</span><span class='line'>  <span class="n">ssh</span> <span class="o">-</span><span class="n">o</span> <span class="s1">&#39;ControlMaster auto&#39;</span> <span class="o">-</span><span class="n">o</span> <span class="s1">&#39;ControlPath ~/.ssh/LOCALGIT.sock&#39;</span> <span class="o">-</span><span class="n">N</span> <span class="o">-</span><span class="n">f</span> <span class="n">root</span><span class="err">@</span><span class="vg">$LOCALGIT</span>
</span><span class='line'>  <span class="n">echo</span> <span class="s2">&quot;Connecting to jumphost:&quot;</span>
</span><span class='line'>  <span class="n">ssh</span> <span class="o">-</span><span class="n">o</span> <span class="s1">&#39;ControlMaster auto&#39;</span> <span class="o">-</span><span class="n">o</span> <span class="s1">&#39;ControlPath ~/.ssh/jump.sock&#39;</span> <span class="o">-</span><span class="n">N</span> <span class="o">-</span><span class="n">f</span> <span class="o">-</span><span class="n">L</span> <span class="vg">$PORT</span><span class="p">:</span><span class="vg">$INTGIT</span><span class="p">:</span><span class="mi">22</span> <span class="n">root</span><span class="err">@</span><span class="vg">$JUMPHOST</span>
</span><span class='line'>  <span class="n">echo</span> <span class="s2">&quot;Connecting to git in integration:&quot;</span>
</span><span class='line'>  <span class="n">ssh</span> <span class="o">-</span><span class="n">o</span> <span class="s1">&#39;ControlMaster auto&#39;</span> <span class="o">-</span><span class="n">o</span> <span class="s1">&#39;ControlPath ~/.ssh/intgit.sock&#39;</span> <span class="o">-</span><span class="n">o</span> <span class="s1">&#39;UserKnownHostsFile /dev/null&#39;</span> <span class="o">-</span><span class="n">N</span> <span class="o">-</span><span class="n">f</span> <span class="n">root</span><span class="vi">@localhost</span> <span class="o">-</span><span class="nb">p</span> <span class="vg">$PORT</span>  
</span><span class='line'>  
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>Use the sockets for SSH and SCP</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="n">ssh</span> <span class="o">-</span><span class="n">S</span> <span class="o">~</span><span class="sr">/.ssh/</span><span class="no">LOCALGIT</span><span class="o">.</span><span class="n">sock</span> <span class="n">root</span><span class="err">@</span><span class="vg">$LOCALGIT</span> <span class="n">gitlab</span><span class="o">-</span><span class="n">rake</span> <span class="ss">gitlab</span><span class="p">:</span><span class="ss">backup</span><span class="p">:</span><span class="n">create</span>
</span><span class='line'>  <span class="n">ssh</span> <span class="o">-</span><span class="n">S</span> <span class="o">~</span><span class="sr">/.ssh/</span><span class="no">LOCALGIT</span><span class="o">.</span><span class="n">sock</span> <span class="n">root</span><span class="err">@</span><span class="vg">$LOCALGIT</span> <span class="s2">&quot;$(typeset -f); stagelatest&quot;</span>
</span><span class='line'>  
</span></code></pre></td></tr></table></div></figure>


<p>A note before moving on about the &lsquo;stagelatest&rsquo; function. I had a complicated command that I didn&rsquo;t want to toss into the SSH line, so I wrote a fuction and ran the <code>$(typeset -f)</code> command to make that function available on the remote SSH shell executing the commands. The function looked like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="n">stagelatest</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="no">LATESTBAK</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">ls</span> <span class="o">-</span><span class="n">t</span> <span class="sr">/var/o</span><span class="n">pt</span><span class="o">/</span><span class="n">gitlab</span><span class="o">/</span><span class="n">backups</span><span class="o">/</span> <span class="o">|</span> <span class="n">head</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>  <span class="n">rm</span> <span class="sr">/tmp/</span><span class="mi">1111111111</span><span class="n">_gitlab_backup</span><span class="o">.</span><span class="n">tar</span>
</span><span class='line'>  <span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="sr">/var/o</span><span class="n">pt</span><span class="o">/</span><span class="n">gitlab</span><span class="o">/</span><span class="n">backups</span><span class="o">/</span><span class="vg">$LATESTBAK</span> <span class="sr">/tmp/</span><span class="mi">1111111111</span><span class="n">_gitlab_backup</span><span class="o">.</span><span class="n">tar</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span></code></pre></td></tr></table></div></figure>


<p>Continuing with our SCP and SSH commands:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="n">scp</span> <span class="o">-</span><span class="n">o</span> <span class="s1">&#39;ControlPath ~/.ssh/LOCALGIT.sock&#39;</span> <span class="n">root</span><span class="err">@</span><span class="vg">$LOCALGIT</span><span class="ss">:/</span><span class="n">tmp</span><span class="o">/</span><span class="mi">1111111111</span><span class="n">_gitlab_backup</span><span class="o">.</span><span class="n">tar</span> <span class="sr">/tmp/</span>
</span><span class='line'>  <span class="n">scp</span> <span class="o">-</span><span class="n">o</span> <span class="s1">&#39;ControlPath ~/.ssh/intgit.sock&#39;</span> <span class="o">-</span><span class="n">P</span> <span class="vg">$PORT</span> <span class="sr">/tmp/</span><span class="mi">1111111111</span><span class="n">_gitlab_backup</span><span class="o">.</span><span class="n">tar</span> <span class="n">root</span><span class="vi">@localhost</span><span class="ss">:/</span><span class="n">var</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">gitlab</span><span class="o">/</span><span class="n">backups</span>
</span><span class='line'>  <span class="n">ssh</span> <span class="o">-</span><span class="n">S</span> <span class="o">~</span><span class="sr">/.ssh/in</span><span class="n">tgit</span><span class="o">.</span><span class="n">sock</span> <span class="n">root</span><span class="vi">@localhost</span> <span class="o">-</span><span class="nb">p</span> <span class="vg">$PORT</span> <span class="no">BACKUP</span><span class="o">=</span><span class="mi">1111111111</span> <span class="n">gitlab</span><span class="o">-</span><span class="n">rake</span> <span class="ss">gitlab</span><span class="p">:</span><span class="ss">backup</span><span class="p">:</span><span class="n">restore</span> <span class="o">&lt;&lt;&lt;</span> <span class="n">yes</span>
</span><span class='line'>  
</span></code></pre></td></tr></table></div></figure>


<h2>The final script</h2>

<p>My final script includes a cleanup() function that is exectued via <code>trap</code> and at the end of the script on a good run. Cleaning up the sockets and ensuring nothing is left is always good practice.</p>

<p>I also modified my SSH commands to not use the known_hosts file. This way I could reuse the tunnle on localhost:5000 to other jumphost connections inside the corralled integration or production environments. Had I used the known_hosts file every time and not pipped it to <code>/dev/null</code>, everytime I reused localhost:5000 to tunnel to a new server behind the jumphost the public key would change and SSH would think someone is trying to do something funny.</p>

<p>I also include some more logic to really make sure that the rake::restore should run on the integration/production gitlab server. Nerver hurts to double check!</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/bin/bash</span>
</span><span class='line'><span class="n">cleanup</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">echo</span> <span class="s2">&quot;Cleaning up sockets and exiting&quot;</span>
</span><span class='line'>  <span class="nb">test</span> <span class="o">-</span><span class="n">e</span> <span class="o">~</span><span class="sr">/.ssh/</span><span class="no">LOCALGIT</span><span class="o">.</span><span class="n">sock</span> <span class="o">&amp;&amp;</span> <span class="n">ssh</span> <span class="o">-</span><span class="n">S</span> <span class="o">~</span><span class="sr">/.ssh/</span><span class="no">LOCALGIT</span><span class="o">.</span><span class="n">sock</span> <span class="o">-</span><span class="n">O</span> <span class="nb">exit</span> <span class="n">root</span><span class="err">@</span><span class="vg">$GITLAB</span>
</span><span class='line'>  <span class="nb">test</span> <span class="o">-</span><span class="n">e</span> <span class="o">~</span><span class="sr">/.ssh/in</span><span class="n">tgit</span><span class="o">.</span><span class="n">sock</span> <span class="o">&amp;&amp;</span> <span class="n">ssh</span> <span class="o">-</span><span class="n">S</span> <span class="o">~</span><span class="sr">/.ssh/in</span><span class="n">tgit</span><span class="o">.</span><span class="n">sock</span> <span class="o">-</span><span class="n">O</span> <span class="nb">exit</span> <span class="n">root</span><span class="vi">@localhost</span>
</span><span class='line'>  <span class="nb">test</span> <span class="o">-</span><span class="n">e</span> <span class="o">~</span><span class="sr">/.ssh/</span><span class="n">jump</span><span class="o">.</span><span class="n">sock</span> <span class="o">&amp;&amp;</span> <span class="n">ssh</span> <span class="o">-</span><span class="n">S</span> <span class="o">~</span><span class="sr">/.ssh/</span><span class="n">jump</span><span class="o">.</span><span class="n">sock</span> <span class="o">-</span><span class="n">O</span> <span class="nb">exit</span> <span class="n">root</span><span class="err">@</span><span class="vg">$JUMPHOST</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="vg">$@</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nb">trap</span> <span class="n">cleanup</span> <span class="no">SIGHUP</span> <span class="no">SIGINT</span> <span class="no">SIGTERM</span>
</span><span class='line'>
</span><span class='line'><span class="n">stagelatest</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="no">LATESTBAK</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">ls</span> <span class="o">-</span><span class="n">t</span> <span class="sr">/var/o</span><span class="n">pt</span><span class="o">/</span><span class="n">gitlab</span><span class="o">/</span><span class="n">backups</span><span class="o">/</span> <span class="o">|</span> <span class="n">head</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>  <span class="n">rm</span> <span class="sr">/tmp/</span><span class="mi">1111111111</span><span class="n">_gitlab_backup</span><span class="o">.</span><span class="n">tar</span>
</span><span class='line'>  <span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="sr">/var/o</span><span class="n">pt</span><span class="o">/</span><span class="n">gitlab</span><span class="o">/</span><span class="n">backups</span><span class="o">/</span><span class="vg">$LATESTBAK</span> <span class="sr">/tmp/</span><span class="mi">1111111111</span><span class="n">_gitlab_backup</span><span class="o">.</span><span class="n">tar</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">getport</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="no">PORT</span><span class="o">=</span><span class="err">$</span><span class="p">((</span> <span class="vg">$RANDOM</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">+</span> <span class="mi">5000</span> <span class="p">))</span>
</span><span class='line'>  <span class="no">CHECK</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">netstat</span> <span class="o">-</span><span class="n">an</span> <span class="o">|</span><span class="n">grep</span> <span class="no">LISTEN</span> <span class="o">|</span> <span class="n">egrep</span> <span class="s2">&quot;[.:]${PORT}</span><span class="se">\s</span><span class="s2">&quot;</span> <span class="o">&gt;</span> <span class="sr">/dev/nu</span><span class="n">ll</span><span class="p">;</span> <span class="n">echo</span> <span class="vg">$?</span><span class="p">)</span>
</span><span class='line'>  <span class="k">while</span> <span class="o">[[</span> <span class="s2">&quot;$CHECK&quot;</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">]]</span>
</span><span class='line'>  <span class="k">do</span>
</span><span class='line'>      <span class="n">echo</span> <span class="s2">&quot;Port: $PORT is in use by another process, choosing another port.&quot;</span>
</span><span class='line'>      <span class="no">PORT</span><span class="o">=</span><span class="err">$</span><span class="p">((</span> <span class="vg">$RANDOM</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">+</span> <span class="n">port</span> <span class="p">))</span>
</span><span class='line'>
</span><span class='line'>      <span class="no">CHECK</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">netstat</span> <span class="o">-</span><span class="n">an</span> <span class="o">|</span><span class="n">grep</span> <span class="no">LISTEN</span> <span class="o">|</span> <span class="n">egrep</span> <span class="s2">&quot;[.:]$PORT</span><span class="se">\s</span><span class="s2">&quot;</span> <span class="o">&gt;</span> <span class="sr">/dev/nu</span><span class="n">ll</span><span class="p">;</span> <span class="n">echo</span> <span class="vg">$?</span><span class="p">)</span>
</span><span class='line'>  <span class="n">done</span>
</span><span class='line'>  <span class="n">echo</span> <span class="s2">&quot;Setting port to $PORT&quot;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="n">getport</span>
</span><span class='line'>
</span><span class='line'><span class="nb">test</span> <span class="o">-</span><span class="n">e</span> <span class="o">~</span><span class="sr">/.ssh || { echo &quot;Create an ssh dir&quot;; exit 1; }</span>
</span><span class='line'>
</span><span class='line'><span class="sr">VPNENV=`echo $(naclient status | awk &#39;NR==4&#39; | cut -d: -f2)`</span>
</span><span class='line'><span class="sr">VPNREMOTE=&quot;data_center&quot;</span>
</span><span class='line'><span class="sr">LOCALGIT=&quot;10.10.100.100&quot;</span>
</span><span class='line'><span class="sr">INTGIT=&quot;172.24.100.10&quot;</span>
</span><span class='line'><span class="sr">JUMPHOST=&quot;172.20.100.11&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">if [ &quot;$VPNENV&quot; == &quot;$VPNREMOTE&quot; ]</span>
</span><span class='line'><span class="sr">then</span>
</span><span class='line'><span class="sr"> echo &quot;Connected to $VPNENV&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="sr"> echo &quot;Connecting to local git:&quot;</span>
</span><span class='line'><span class="sr"> ssh -o &#39;ControlMaster auto&#39; -o &#39;ControlPath ~/</span><span class="o">.</span><span class="n">ssh</span><span class="o">/</span><span class="no">LOCALGIT</span><span class="o">.</span><span class="n">sock</span><span class="s1">&#39; -N -f root@$LOCALGIT </span>
</span><span class='line'><span class="s1"> echo &quot;Connecting to jumphost:&quot;</span>
</span><span class='line'><span class="s1"> ssh -o &#39;</span><span class="no">ControlMaster</span> <span class="n">auto</span><span class="s1">&#39; -o &#39;</span><span class="no">ControlPath</span> <span class="o">~</span><span class="sr">/.ssh/</span><span class="n">jump</span><span class="o">.</span><span class="n">sock</span><span class="s1">&#39; -N -f -L $PORT:$INTGIT:22 root@$JUMPHOST</span>
</span><span class='line'><span class="s1"> echo &quot;Connecting to git in integration:&quot;</span>
</span><span class='line'><span class="s1"> ssh -o &#39;</span><span class="no">ControlMaster</span> <span class="n">auto</span><span class="s1">&#39; -o &#39;</span><span class="no">ControlPath</span> <span class="o">~</span><span class="sr">/.ssh/in</span><span class="n">tgit</span><span class="o">.</span><span class="n">sock</span><span class="s1">&#39; -o &#39;</span><span class="no">UserKnownHostsFile</span> <span class="sr">/dev/nu</span><span class="n">ll</span><span class="s1">&#39; -N -f root@localhost -p $PORT</span>
</span><span class='line'>
</span><span class='line'><span class="s1"> # SSH LOCALGIT and run rake backup, scp latest backup to host </span>
</span><span class='line'><span class="s1"> echo &quot;Running gitlab:backup:create&quot;</span>
</span><span class='line'><span class="s1"> ssh -S ~/.ssh/LOCALGIT.sock root@$LOCALGIT gitlab-rake gitlab:backup:create</span>
</span><span class='line'><span class="s1"> echo &quot;Staging backup in /tmp&quot;</span>
</span><span class='line'><span class="s1"> ssh -S ~/.ssh/LOCALGIT.sock root@$LOCALGIT &quot;$(typeset -f); stagelatest&quot;</span>
</span><span class='line'><span class="s1"> echo &quot;Copying over from lab git to localhost&quot;</span>
</span><span class='line'><span class="s1"> scp -o &#39;</span><span class="no">ControlPath</span> <span class="o">~</span><span class="sr">/.ssh/</span><span class="no">LOCALGIT</span><span class="o">.</span><span class="n">sock</span><span class="s1">&#39; root@$LOCALGIT:/tmp/1111111111_gitlab_backup.tar /tmp/</span>
</span><span class='line'><span class="s1"> echo &quot;Copying lab git backup from localhost to integration git server&quot;</span>
</span><span class='line'><span class="s1"> scp -o &#39;</span><span class="no">ControlPath</span> <span class="o">~</span><span class="sr">/.ssh/in</span><span class="n">tgit</span><span class="o">.</span><span class="n">sock</span><span class="err">&#39;</span> <span class="o">-</span><span class="n">P</span> <span class="vg">$PORT</span> <span class="sr">/tmp/</span><span class="mi">1111111111</span><span class="n">_gitlab_backup</span><span class="o">.</span><span class="n">tar</span> <span class="n">root</span><span class="vi">@localhost</span><span class="ss">:/</span><span class="n">var</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">gitlab</span><span class="o">/</span><span class="n">backups</span>
</span><span class='line'>  <span class="n">echo</span> <span class="s2">&quot;Would you like to run restore on the integration server now?&quot;</span>
</span><span class='line'>  <span class="n">read</span> <span class="n">restore</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">[[</span> <span class="vg">$restore</span> <span class="o">=~</span> <span class="o">^</span><span class="n">y</span> <span class="o">]]</span>
</span><span class='line'>  <span class="k">then</span>
</span><span class='line'>      <span class="n">echo</span> <span class="s2">&quot;Running restore on integration git server&quot;</span>
</span><span class='line'>      <span class="n">ssh</span> <span class="o">-</span><span class="n">S</span> <span class="o">~</span><span class="sr">/.ssh/in</span><span class="n">tgit</span><span class="o">.</span><span class="n">sock</span> <span class="n">root</span><span class="vi">@localhost</span> <span class="o">-</span><span class="nb">p</span> <span class="vg">$PORT</span> <span class="no">BACKUP</span><span class="o">=</span><span class="mi">1111111111</span> <span class="n">gitlab</span><span class="o">-</span><span class="n">rake</span> <span class="ss">gitlab</span><span class="p">:</span><span class="ss">backup</span><span class="p">:</span><span class="n">restore</span> <span class="o">&lt;&lt;&lt;</span> <span class="n">yes</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>      <span class="n">echo</span> <span class="s2">&quot;Not running restore&quot;</span>
</span><span class='line'>      <span class="n">echo</span> <span class="s2">&quot;Backup located at /var/opt/gitlab/backups/1111111111_gitlab_backup.tar&quot;</span>
</span><span class='line'>      <span class="n">echo</span> <span class="s2">&quot;-----&quot;</span>
</span><span class='line'>      <span class="n">echo</span> <span class="s2">&quot;To backup manually run:&quot;</span>
</span><span class='line'>      <span class="n">echo</span> <span class="s2">&quot;BACKUP=1111111111_gitlab_backup.tar gitlab-rake gitlab:backup:restore&quot;</span>
</span><span class='line'>  <span class="n">fi</span>
</span><span class='line'>  <span class="n">cleanup</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">echo</span> <span class="s2">&quot;VPN Enviro not correct, connected to: $VPNENV&quot;</span>
</span><span class='line'>  <span class="n">echo</span> <span class="s2">&quot;Check VPN connection to data_center, or start NA Client&quot;</span>
</span><span class='line'>  <span class="n">cleanup</span> <span class="mi">1</span>
</span><span class='line'><span class="n">fi</span>
</span></code></pre></td></tr></table></div></figure>


<p>The final script can be pulled down from <a href="https://github.com/malnick/scripts/blob/master/connect.sh">my github account</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[A Simple Nagios Docker Plugin]]></title>
    <link href="httpL://www.jeffmalnick.com/blog/2014/06/24/a-simple-nagios-docker-plugin/"/>
    <updated>2014-06-24T12:19:43-07:00</updated>
    <id>httpL://www.jeffmalnick.com/blog/2014/06/24/a-simple-nagios-docker-plugin</id>
    <content type="html"><![CDATA[<p>Docker is an amazing tool with a lot great functional command line interfaces. A typical docker deployment might have a webapp running inside a container. In order to observe the beahvior of this container you might want to setup a Nagios plugin to monitor log output.</p>

<p>To do this I am going to do the following:</p>

<ol>
<li>Deploy an Ubuntu Precise VM on 10.10.33.2 via Vagrant</li>
<li>Provsion the VM with Puppet using the Vagrant Puppet provisioner:

<ol>
<li>Installs docker using garethr-docker</li>
<li>Installs the training/webapp image</li>
<li>Runs the container using an exec</li>
<li>Installs nagios and my ruby plugin to monitor the docker service and the training/webapp image for the following:

<ol>
<li>Is the docker command available?</li>
<li>Is the webapp running?

<ul>
<li>Ensures webapp is running on <code>localhost:5000</code></li>
<li>Checks the log for 404 errors and sends warnings if so</li>
<li>Counts the errors for each URL with a 404 and outputs the count and URL which has the highest hit count</li>
<li>test the above by trying <code>10.10.33.2:5000/test</code> over and over again</li>
</ul>
</li>
</ol>
</li>
</ol>
</li>
</ol>


<h2>The Vagrantfile</h2>

<p>I start with a basic Vagrantfile to deploy an Ubuntu Precise VM:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="s2">&quot;virtualbox&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span>
</span><span class='line'>  <span class="n">v</span><span class="o">.</span><span class="n">customize</span> <span class="o">[</span><span class="s2">&quot;modifyvm&quot;</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">&quot;--memory&quot;</span><span class="p">,</span> <span class="mi">1024</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="ss">:nagios</span> <span class="k">do</span> <span class="o">|</span><span class="n">deploy</span><span class="o">|</span>
</span><span class='line'>  <span class="n">deploy</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;precise64&quot;</span>
</span><span class='line'>  <span class="n">deploy</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s2">&quot;nagios.server.dev&quot;</span>
</span><span class='line'>  <span class="n">deploy</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box_url</span> <span class="o">=</span> <span class="s2">&quot;http://files.vagrantup.com/precise64.box&quot;</span>
</span><span class='line'>  <span class="n">deploy</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;modules&quot;</span><span class="p">,</span> <span class="s2">&quot;/etc/puppet/modules&quot;</span>
</span><span class='line'>  <span class="n">deploy</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;manifests&quot;</span><span class="p">,</span> <span class="s2">&quot;/etc/puppet/manifests&quot;</span>
</span><span class='line'>  <span class="n">deploy</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;10.10.33.2&quot;</span> <span class="c1"># Define static IP once dev completes</span>
</span><span class='line'>  <span class="n">deploy</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:puppet</span><span class="p">,</span> <span class="ss">:module_path</span> <span class="o">=&gt;</span> <span class="s2">&quot;modules&quot;</span><span class="p">,</span> <span class="ss">:manifests_path</span> <span class="o">=&gt;</span> <span class="s2">&quot;manifests&quot;</span><span class="p">,</span> <span class="ss">:manifest_file</span> <span class="o">=&gt;</span> <span class="s2">&quot;deploy_nagios.pp&quot;</span>
</span><span class='line'>   <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Puppet Provisioner</h2>

<p>In order to provision the VM on boot I used the Puppet provisioner which ships with Vagrant. For testing purposes I like to sync my manifests and modules directory to the VM. Usually I run a bash script before provisioning with Puppet to install from the Puppet Labs apt or yum repos, however for this project that wasn&rsquo;t neccessary as the goal is to have a quickly bootable dev environment for my Nagios server and Docker container.</p>

<p>The <code>deploy_nagios.pp</code> manifest looks like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Deploy docker and an Ubuntu image to play with</span>
</span><span class='line'><span class="k">class</span> <span class="p">{</span><span class="s1">&#39;docker&#39;</span><span class="p">:}</span>
</span><span class='line'><span class="ss">docker</span><span class="p">:</span><span class="ss">:image</span> <span class="p">{</span> <span class="s1">&#39;training/webapp&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="nb">require</span> <span class="o">=&gt;</span> <span class="no">Class</span><span class="o">[</span><span class="s1">&#39;docker&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1"># Super hero hack to run the docker image... see readme for why.</span>
</span><span class='line'><span class="c1"># Also, in no way is this idempotent, if it&#39;s running it&#39;ll fail.</span>
</span><span class='line'><span class="nb">exec</span> <span class="p">{</span> <span class="s1">&#39;/usr/bin/docker run -d -p 5000:5000 training/webapp python app.py&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="nb">require</span> <span class="o">=&gt;</span> <span class="ss">Docker</span><span class="p">:</span><span class="ss">:Image</span><span class="o">[</span><span class="s1">&#39;training/webapp&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">#docker::run { &#39;webapp&#39;:</span>
</span><span class='line'><span class="c1">#  image   =&gt; &#39;ubuntu&#39;,</span>
</span><span class='line'><span class="c1">#  command =&gt; &#39;/bin/echo test&#39;,</span>
</span><span class='line'><span class="c1">#  require =&gt; Docker::Image[&#39;training/webapp&#39;],</span>
</span><span class='line'><span class="c1">#}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Update this thing</span>
</span><span class='line'><span class="nb">exec</span> <span class="p">{</span> <span class="s1">&#39;/usr/bin/apt-get update&#39;</span><span class="p">:}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Install nagios </span>
</span><span class='line'><span class="k">class</span> <span class="p">{</span> <span class="s1">&#39;nagios&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="nb">require</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="no">Exec</span><span class="o">[</span><span class="s1">&#39;/usr/bin/apt-get update&#39;</span><span class="o">]</span><span class="p">,</span><span class="no">Class</span><span class="o">[</span><span class="s1">&#39;docker&#39;</span><span class="o">]]</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Get my plugin on the system correctly</span>
</span><span class='line'><span class="ss">nagios</span><span class="p">:</span><span class="ss">:plugin</span> <span class="p">{</span> <span class="s1">&#39;docker_status&#39;</span><span class="p">:</span>
</span><span class='line'>   <span class="n">source</span> <span class="o">=&gt;</span> <span class="s1">&#39;nagios/nagios-plugins/docker_status.rb&#39;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># WARNING: TOTAL HACK PLEASE DON&#39;T JUDGE ME</span>
</span><span class='line'><span class="nb">exec</span> <span class="p">{</span> <span class="s1">&#39;/bin/echo &quot;command[docker_status]=/usr/lib/nagios/plugins/docker_status&quot; &gt;&gt; /etc/nagios/nrpe.cfg&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="nb">require</span> <span class="o">=&gt;</span> <span class="no">File</span><span class="o">[</span><span class="s1">&#39;/etc/nagios/nrpe.cfg&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>  <span class="n">notify</span> <span class="o">=&gt;</span> <span class="no">Service</span><span class="o">[</span><span class="s1">&#39;nrpe&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Ensure docker and nagios are in the same group</span>
</span><span class='line'><span class="nb">exec</span> <span class="p">{</span><span class="s1">&#39;/usr/sbin/usermod -a -G docker nagios&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="nb">require</span> <span class="o">=&gt;</span> <span class="no">Class</span><span class="o">[</span><span class="s1">&#39;nagios&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>  <span class="n">notify</span>  <span class="o">=&gt;</span> <span class="no">Service</span><span class="o">[</span><span class="s1">&#39;nrpe&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="ss">nagios</span><span class="p">:</span><span class="ss">:command</span> <span class="p">{</span> <span class="s1">&#39;docker_status&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="n">command_line</span> <span class="o">=&gt;</span> <span class="s1">&#39;$USER1$/check_nrpe -H $HOSTADDRESS$ -c docker_status&#39;</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Set the nagiosadmin password </span>
</span><span class='line'><span class="nb">exec</span> <span class="p">{</span> <span class="s1">&#39;/usr/bin/htpasswd -cb /etc/nagios3/htpasswd.users nagiosadmin nagiosadmin&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="nb">require</span> <span class="o">=&gt;</span> <span class="no">Class</span><span class="o">[</span><span class="s1">&#39;nagios&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># I wrote my plugin in Ruby so lets make sure the VM has it. </span>
</span><span class='line'><span class="n">package</span> <span class="p">{</span> <span class="s1">&#39;ruby1.9.1&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="k">ensure</span> <span class="o">=&gt;</span> <span class="n">present</span><span class="p">,</span>
</span><span class='line'>  <span class="nb">require</span> <span class="o">=&gt;</span> <span class="no">Class</span><span class="o">[</span><span class="s1">&#39;nagios&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Yup, I had a couple of hero hacks in there to get around some issues with the <code>docker::run</code> define. That define should work, but  kept failing with a very odd &lsquo;&lt;&lt; is not a {}:hash&rsquo; error. I grep&#8217;ed through the module to try and find where this was coming from and I think it&rsquo;s a heredoc within a function for the define. I still need to look into it. I ran an exec after the image is downloaded to get around this problem.</p>

<p>I also hero hacked the update to the <code>nrpe.cfg</code> file as the Nagios module I used didn&rsquo;t make it clearly evident how or if it did this.</p>

<p>&hellip; In no way do any of these hacks make me an &ldquo;inpatient&rdquo; person.</p>

<h2>The Nagios Plugin</h2>

<p>Recall my plugin should monitor:</p>

<ol>
<li>Is the docker command available?</li>
<li>Is the webapp running?

<ul>
<li>Ensures webapp is running on <code>localhost:5000</code></li>
<li>Checks the log for 404 errors and sends warnings if so</li>
<li>Counts the errors for each URL with a 404 and outputs the count and URL which has the highest hit count</li>
<li>test the above by trying <code>10.10.33.2:5000/test</code> over and over again</li>
</ul>
</li>
</ol>


<h3>Let&rsquo;s break it down</h3>

<h4>Nagios Basics:</h4>

<p>First, let&rsquo;s define some basic outputs for the Nagios API. Since Nagios is only looking for specific exit codes from any given script we define those as methods here first.</p>

<pre><code>0 = OK
1 = Shit is potentially hitting the fan
2 = Shit is hitting the fan
3 = Unknown shit is happening
</code></pre>

<h4>The first part of my Plugin defines these:</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/bin/ruby</span>
</span><span class='line'><span class="c1"># Checks the docker status command for number of running containers</span>
</span><span class='line'><span class="c1"># Ensures the docker container is running by checking that the socket exists</span>
</span><span class='line'><span class="c1"># </span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Define some helper methods for Nagios with appropriate exit codes</span>
</span><span class='line'><span class="k">def</span> <span class="nf">ok</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;OK - </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="mi">0</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">critical</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Critical - </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="mi">2</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">warning</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Warning - </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="mi">1</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">unknown</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Unknown - </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="mi">3</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Check to ensure docker is installed</h4>

<p>Now let&rsquo;s check to ensure Docker is installed, we can use a simple <code>system()</code> method which returns exit codes only:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">docker_installed</span><span class="p">()</span>
</span><span class='line'>  <span class="k">if</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;which docker &gt; /dev/null&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">webapp_status</span><span class="p">()</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>      <span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Docker isn&#39;t installed&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Yup, it&rsquo;s that easy, <code>which docker</code> will return &lsquo;0&rsquo; or &lsquo;false&rsquo; if it does not find the command and &lsquo;1&rsquo; or &lsquo;true&rsquo; if a path to the command is found. This isn&rsquo;t the most robust check ever, but for now it&rsquo;s enough to move on. Since all my other def&rsquo;s work on the <code>docker</code> face and it&rsquo;s sub commands I need to ensure this is present before doing anything else.</p>

<h4>Check the webapp status</h4>

<p>First, I want to make sure the webapp is running on the VM on a specific port. I&rsquo;m going to use a <code>netstat</code> command and <code>awk</code> to return the process running on port 5000:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">webapp_status</span><span class="p">()</span>
</span><span class='line'>  <span class="c1"># Ensure the webapp is running on localhost:5000</span>
</span><span class='line'>  <span class="n">webapp_run</span> <span class="o">=</span> <span class="sb">`netstat -anp | grep 5000 | awk &#39;{print $7}&#39; | cut -d/ -f2`</span>
</span><span class='line'>  <span class="n">should_be</span>   <span class="o">=</span> <span class="s2">&quot;docker&quot;</span>
</span><span class='line'>  <span class="n">webapp_run</span><span class="o">.</span><span class="n">chomp!</span><span class="o">.</span><span class="n">strip!</span>
</span></code></pre></td></tr></table></div></figure>


<p>This should return this this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@nagios:/home/vagrant# netstat -anp | grep 5000 | awk <span class="s1">&#39;{print $7}&#39;</span> | cut -d/ -f2
</span><span class='line'>docker
</span></code></pre></td></tr></table></div></figure>


<p>Then we pass this into some basic &lsquo;if&rsquo; logic:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="k">if</span> <span class="n">webapp_run</span> <span class="o">==</span> <span class="n">should_be</span>
</span><span class='line'>      <span class="c1"># Check to ensure there are no 404 errors in the log</span>
</span><span class='line'>      <span class="n">check_this</span> <span class="o">=</span> <span class="s2">&quot;docker logs $(docker ps -l | awk &#39;{print $1}&#39; | awk &#39;{if (NR == 2){print $0}}&#39;) 2&gt;&amp;1 | grep 404 | awk &#39;{print $7}&#39; | sort | uniq -c&quot;</span>
</span><span class='line'>      <span class="n">check</span> <span class="o">=</span> <span class="nb">system</span><span class="p">(</span><span class="n">check_this</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">check</span>
</span><span class='line'>          <span class="no">IO</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="n">check_this</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">io</span><span class="o">|</span>
</span><span class='line'>              <span class="n">line</span>  <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">readlines</span>
</span><span class='line'>              <span class="n">errors</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>              <span class="n">line</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">this</span><span class="o">|</span>
</span><span class='line'>                  <span class="n">number</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>                  <span class="n">url</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>                  <span class="n">errors</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>   
</span><span class='line'>              <span class="k">end</span>  
</span><span class='line'>              <span class="n">max_value</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">max</span>
</span><span class='line'>              <span class="n">max_key</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span><span class="o">==</span><span class="n">max_value</span> <span class="p">}</span><span class="o">.</span><span class="n">keys</span>  
</span><span class='line'>              <span class="k">case</span> <span class="n">max_value</span><span class="o">.</span><span class="n">to_i</span> <span class="o">&gt;</span> <span class="mi">20</span>
</span><span class='line'>                  <span class="k">when</span> <span class="kp">false</span>
</span><span class='line'>                      <span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">max_value</span><span class="si">}</span><span class="s2"> 404 Errors at localhost</span><span class="si">#{</span><span class="n">max_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>                  <span class="k">when</span> <span class="kp">true</span>
</span><span class='line'>                      <span class="n">critical</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">max_value</span><span class="si">}</span><span class="s2"> 404 Errors at localhost</span><span class="si">#{</span><span class="n">max_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="k">end</span>
</span><span class='line'>          <span class="k">end</span>  
</span></code></pre></td></tr></table></div></figure>


<p>Lot&rsquo;s of things are happening there.</p>

<p>1st, if &lsquo;docker&rsquo; is the output of the webapp status command we drop into another loop. This loop runs a <code>check_this</code> command that is derived from the <code>docker log</code> face. That particular face feeds the output from a sys-log-like to the terminals stdin.</p>

<p>But first, <code>docker logs</code> needs to have the process hash of the container you want to query, so I run a <code>docker ps -l</code> and <code>awk</code> for the hash of the process I want.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@nagios:/home/vagrant# docker ps -l
</span><span class='line'>CONTAINER ID        IMAGE                    COMMAND             CREATED             STATUS              PORTS                    NAMES
</span><span class='line'>c968cced9f32        training/webapp:latest   python app.py       33 minutes ago      Up 33 minutes       0.0.0.0:5000-&gt;5000/tcp   berserk_pare
</span></code></pre></td></tr></table></div></figure>


<p>This would definitely break if you had many containers running.</p>

<p>So anyways, if we have that hash we can now pass it to <code>docker logs</code> like I did in the ruby script like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">root</span><span class="vi">@nagios</span><span class="ss">:/</span><span class="n">home</span><span class="o">/</span><span class="n">vagrant</span><span class="c1"># docker logs c968cced9f32</span>
</span><span class='line'> <span class="o">*</span> <span class="no">Running</span> <span class="n">on</span> <span class="ss">http</span><span class="p">:</span><span class="sr">//</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="p">:</span><span class="mi">5000</span><span class="o">/</span>
</span></code></pre></td></tr></table></div></figure>


<p>Tight.</p>

<p>Now that I have access to the log from the webapp I can grep URL&rsquo;s which have 404 errors, add those to a hash as k,v&rsquo;s and then iterate over the hash for the key with the largest value.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">IO</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="n">check_this</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">io</span><span class="o">|</span>
</span><span class='line'>  <span class="n">line</span>  <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">readlines</span>
</span><span class='line'>  <span class="n">errors</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>  <span class="n">line</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">this</span><span class="o">|</span>
</span><span class='line'>      <span class="n">number</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>      <span class="n">url</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>      <span class="n">errors</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>   
</span><span class='line'>  <span class="k">end</span>  
</span><span class='line'>  <span class="n">max_value</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">max</span>
</span><span class='line'>  <span class="n">max_key</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span><span class="o">==</span><span class="n">max_value</span> <span class="p">}</span><span class="o">.</span><span class="n">keys</span>  
</span></code></pre></td></tr></table></div></figure>


<p>Now I can use that key&rsquo;s value to hit my <code>warning</code> or <code>critical</code> methods.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">case</span> <span class="n">max_value</span><span class="o">.</span><span class="n">to_i</span> <span class="o">&gt;</span> <span class="mi">20</span>
</span><span class='line'><span class="k">when</span> <span class="kp">false</span>
</span><span class='line'>  <span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">max_value</span><span class="si">}</span><span class="s2"> 404 Errors at localhost</span><span class="si">#{</span><span class="n">max_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">when</span> <span class="kp">true</span>
</span><span class='line'>  <span class="n">critical</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">max_value</span><span class="si">}</span><span class="s2"> 404 Errors at localhost</span><span class="si">#{</span><span class="n">max_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Of course, the end to this giant loop of loops does&hellip;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>     <span class="k">else</span>
</span><span class='line'>          <span class="n">ok</span><span class="p">(</span><span class="s2">&quot;Docker &amp; Webapp are in good shape!&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>      <span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Webapp is not running on localhost:5000&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>&hellip; and finally start it</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">docker_installed</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>My entire script looks like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Full </span>
</span><span class='line'><span class="c1">#!/usr/bin/ruby</span>
</span><span class='line'><span class="c1"># Checks the docker status command for number of running containers</span>
</span><span class='line'><span class="c1"># Ensures the docker container is running by checking that the socket exists</span>
</span><span class='line'><span class="c1"># </span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Define some helper methods for Nagios with appropriate exit codes</span>
</span><span class='line'><span class="k">def</span> <span class="nf">ok</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;OK - </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="mi">0</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">critical</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Critical - </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="mi">2</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">warning</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Warning - </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="mi">1</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">unknown</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Unknown - </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="mi">3</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Check to ensure docker is installed</span>
</span><span class='line'><span class="k">def</span> <span class="nf">docker_installed</span><span class="p">()</span>
</span><span class='line'>  <span class="k">if</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;which docker &gt; /dev/null&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">webapp_status</span><span class="p">()</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>      <span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Docker isn&#39;t installed&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">webapp_status</span><span class="p">()</span>
</span><span class='line'>  <span class="c1"># Ensure the webapp is running on localhost:5000</span>
</span><span class='line'>  <span class="n">webapp_run</span> <span class="o">=</span> <span class="sb">`netstat -anp | grep 5000 | awk &#39;{print $7}&#39; | cut -d/ -f2`</span>
</span><span class='line'>  <span class="n">should_be</span>   <span class="o">=</span> <span class="s2">&quot;docker&quot;</span>
</span><span class='line'>  <span class="n">webapp_run</span><span class="o">.</span><span class="n">chomp!</span><span class="o">.</span><span class="n">strip!</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">webapp_run</span> <span class="o">==</span> <span class="n">should_be</span>
</span><span class='line'>      <span class="c1"># Check to ensure there are no 404 errors in the log</span>
</span><span class='line'>      <span class="n">check_this</span> <span class="o">=</span> <span class="s2">&quot;docker logs $(docker ps -l | awk &#39;{print $1}&#39; | awk &#39;{if (NR == 2){print $0}}&#39;) 2&gt;&amp;1 | grep 404 | awk &#39;{print $7}&#39; | sort | uniq -c&quot;</span>
</span><span class='line'>      <span class="n">check</span> <span class="o">=</span> <span class="nb">system</span><span class="p">(</span><span class="n">check_this</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">check</span>
</span><span class='line'>          <span class="no">IO</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="n">check_this</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">io</span><span class="o">|</span>
</span><span class='line'>              <span class="n">line</span>  <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">readlines</span>
</span><span class='line'>              <span class="n">errors</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>              <span class="n">line</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">this</span><span class="o">|</span>
</span><span class='line'>                  <span class="n">number</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>                  <span class="n">url</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>                  <span class="n">errors</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>   
</span><span class='line'>              <span class="k">end</span>  
</span><span class='line'>              <span class="n">max_value</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">max</span>
</span><span class='line'>              <span class="n">max_key</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span><span class="o">==</span><span class="n">max_value</span> <span class="p">}</span><span class="o">.</span><span class="n">keys</span>  
</span><span class='line'>              <span class="k">case</span> <span class="n">max_value</span><span class="o">.</span><span class="n">to_i</span> <span class="o">&gt;</span> <span class="mi">20</span>
</span><span class='line'>                  <span class="k">when</span> <span class="kp">false</span>
</span><span class='line'>                      <span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">max_value</span><span class="si">}</span><span class="s2"> 404 Errors at localhost</span><span class="si">#{</span><span class="n">max_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>                  <span class="k">when</span> <span class="kp">true</span>
</span><span class='line'>                      <span class="n">critical</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">max_value</span><span class="si">}</span><span class="s2"> 404 Errors at localhost</span><span class="si">#{</span><span class="n">max_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="k">end</span>
</span><span class='line'>          <span class="k">end</span>  
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>          <span class="n">ok</span><span class="p">(</span><span class="s2">&quot;Docker &amp; Webapp are in good shape!&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>      <span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Webapp is not running on localhost:5000&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">docker_installed</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Continuous Integration with Puppet Code]]></title>
    <link href="httpL://www.jeffmalnick.com/blog/2014/06/03/continuous-integration-with-puppet-code/"/>
    <updated>2014-06-03T07:54:12-07:00</updated>
    <id>httpL://www.jeffmalnick.com/blog/2014/06/03/continuous-integration-with-puppet-code</id>
    <content type="html"><![CDATA[<iframe src="http://www.slideshare.net/slideshow/embed_code/35435020" width="427" height="356" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px 1px 0; margin-bottom:5px; max-width: 100%;" allowfullscreen> </iframe>


<p> <div style="margin-bottom:5px"> <strong> <a href="https://www.slideshare.net/malnick/continuous-integration-withpuppet" title="Continuous integration with_puppet" target="_blank">Continuous integration with_puppet</a> </strong> from <strong><a href="http://www.slideshare.net/malnick" target="_blank">malnick</a></strong> </div></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Packer Templates &amp; VMWare]]></title>
    <link href="httpL://www.jeffmalnick.com/blog/2014/05/29/packer-templates-and-vmware/"/>
    <updated>2014-05-29T12:19:53-07:00</updated>
    <id>httpL://www.jeffmalnick.com/blog/2014/05/29/packer-templates-and-vmware</id>
    <content type="html"><![CDATA[<h2>tl;dr</h2>

<p>There&rsquo;s not a lot of docs on Packer and the logging can be tricky to find sometimes depending on the vm you&rsquo;re booting (which provider backs it). If you&rsquo;re using VMWare and you&rsquo;re booting centos the <code>guest_os_type</code> key needs to be set appropriatly.</p>

<p>Some people seem to think this can be $anything that sounds reasonable (I did!) and there is no documentation on what should actually go there (as of writing this, Google was sparce). So if you have a doubt on what the <code>guest_os_type</code> value should be the best bet is to <code>$ diff</code> it with an already existing <code>*.your_vm_type</code> (&lsquo;vmx&rsquo;, &lsquo;ovf&rsquo;, et cetera).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cat centos65-puppetmaster.json | grep -i guest_os_type
</span><span class='line'>    <span class="s2">&quot;guest_os_type&quot;</span>: <span class="s2">&quot;centos-65&quot;</span>,
</span></code></pre></td></tr></table></div></figure>


<p>However, if I query an already built <code>*.vmx</code> this is incorrect:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cat master2.vmx | grep -i guestos
</span><span class='line'>   <span class="nv">guestos</span> <span class="o">=</span> <span class="s2">&quot;redhat&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>For CentOS at least, your <code>guest_os_type</code> value should be set to <code>redhat</code>.</p>

<h2>Back Story</h2>

<p>This week I was working with a customer to automate the deployment of some VM&rsquo;s to vSphere. This deployment is replaceing some current scripts and manually configured templates. Actually, a lot of scripts and manually configured templates.</p>

<p>The long and the short of it, me and my team decided to implement Vagrant and Packer to push out pre-written Packer templates to vSphere via Vagrant&rsquo;s vSphere plugin using the VMWare provider.</p>

<p>After scripting the json for this node I ran <code>packer build centos65.json</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">==</span>&gt; vmware-iso: Downloading or copying <span class="nv">ISO</span>
</span><span class='line'><span class="o">==</span>&gt; vmware-iso: Downloading or copying ISO
</span><span class='line'>vmware-iso: Downloading or copying: http://mirrors.kernel.org/centos/6.5/isos/x86_64/CentOS-6.5
</span><span class='line'><span class="o">==</span>&gt; vmware-iso: Creating virtual machine <span class="nv">disk</span>
</span><span class='line'><span class="o">==</span>&gt; vmware-iso: Building and writing VMX <span class="nv">file</span>
</span><span class='line'><span class="o">==</span>&gt; vmware-iso: Starting HTTP server on port <span class="nv">8582</span>
</span><span class='line'><span class="o">==</span>&gt; vmware-iso: Starting virtual machine...
</span><span class='line'><span class="o">==</span>&gt; vmware-iso: Error starting VM: VMware error:
</span><span class='line'><span class="o">==</span>&gt; vmware-iso: Deleting output directory...
</span><span class='line'>Build <span class="s1">&#39;vmware-iso&#39;</span> errored: Error starting VM: VMware error:
</span><span class='line'><span class="o">==</span>&gt; Some builds didn<span class="err">&#39;</span>t <span class="nb">complete </span>successfully and had errors:
</span><span class='line'>--&gt; vmware-iso: Error starting VM: VMware error:
</span><span class='line'>
</span><span class='line'><span class="o">==</span>&gt; Builds finished but no artifacts were created.
</span></code></pre></td></tr></table></div></figure>


<p>The vm booted into fusion and opened but failed in <code>vmrun</code>. How did I know that was the issue?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>grep -r vmrun /var/log/*
</span><span class='line'>system.log:May 29 05:30:32 bohr vmrun<span class="o">[</span>13249<span class="o">]</span>: com.vmware.fusion.78704: Invalid argument
</span><span class='line'>... <span class="c"># lots of other crap </span>
</span></code></pre></td></tr></table></div></figure>


<p>BUT WHAT ARGUMENT???</p>

<p>After digging around I found that logging for this issue was sketchy at best. Syslog, <code>/var/tmp/vmware</code>, the <code>guest_os_type</code> key needs to have an appropriate value (i.e., arugment from syslog):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cat centos65-puppetmaster.json | grep -i guest_os_type
</span><span class='line'>    <span class="s2">&quot;guest_os_type&quot;</span>: <span class="s2">&quot;centos-65&quot;</span>,
</span></code></pre></td></tr></table></div></figure>


<p>However, if I query an already built <code>*.vmx</code> this is incorrect:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cat master2.vmx | grep -i guestos
</span><span class='line'>   <span class="nv">guestos</span> <span class="o">=</span> <span class="s2">&quot;redhat&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>After changing the k,v in the json template and running <code>packer build</code> the vmrun command ran successfully.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[r10k: Control Repos]]></title>
    <link href="httpL://www.jeffmalnick.com/blog/2014/05/16/r10k-control-repos/"/>
    <updated>2014-05-16T12:34:33-07:00</updated>
    <id>httpL://www.jeffmalnick.com/blog/2014/05/16/r10k-control-repos</id>
    <content type="html"><![CDATA[<p>This document explains the architecture and deployment of a control repository for syncing multiple puppet environments, their associated puppet code (modules) and their assocaited data (hiera). This document does not review how to deploy r10k, however that is discussed in relevant detail <a href="https://github.com/puppetlabs/prosvcs-malnick/blob/master/README.md#deploy-git-r10k-and-stuff">here</a>.</p>

<h2>What is a control repo?</h2>

<p>A control repository stores a Puppetfile and hiera data (hiera.yaml and hieradata/).</p>

<h3>What does it contain?</h3>

<pre><code>hieradata/
Puppetfile
</code></pre>

<p>It is also common to have a <code>hiera.yaml</code> in the control repo. However <a href="http://www.jeffmalnick.com/blog/2014/05/15/hiera-and-r10k/">for many reasons</a> I don&rsquo;t believe this is a good idea. It can lead to confusing issues with branching of the file that is only consulted once for it&rsquo;s <code>$datadir</code> path and is not used on a per environment basis &ndash; it&rsquo;s loaded once from <code>$confdir</code> during the <em>hiera()</em> call and is not consulted on a per environment basis (e.g. <code>$confdir/environments/$environments/hiera.yaml</code> <strong>is not used</strong> during the <em>hiera()</em> lookup, only <code>$confdir/hiera.yaml</code> is used).</p>

<h2>How does it work?</h2>

<p>The control repo is placed in a monolithic git repository.</p>

<p>The repository can have one or more topic branches that are used by r10k to sync to local Puppet environments.</p>

<h3>Configuration for Puppet code &amp; Hiera data sync via r10k</h3>

<p>Details on how to deploy a gitlab repo and assocaited topic branching for r10k sync are <a href="https://github.com/puppetlabs/prosvcs-malnick/blob/master/README.md#deploy-git-r10k-and-stuff">here</a>.</p>

<p>Place a Puppetfile in <code>$confdir/Puppetfile</code>.</p>

<p>Populate your Puppetfile with what ever crap you need.</p>

<p>In <code>$confdir</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git init
</span><span class='line'>git remote add origin git@whatever.com:your_name/control_repo.git
</span><span class='line'>git branch -m master production
</span><span class='line'>git add Puppetfile
</span><span class='line'>git add hiera.yaml <span class="c"># r10k really doesn&#39;t need this but we&#39;ll add it anyways. </span>
</span><span class='line'>git add hieradata/
</span><span class='line'>git push -u origin production:production <span class="c"># or whatever branch, maybe production?</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Configure hiera.yaml for dynamic environments</h3>

<p><strong>NOTE</strong>: the hiera.yaml is only loaded from <code>$confdir/hiera.yaml</code> on each puppet run, this means even though you&rsquo;ll have a hiera.yaml in <code>$confdir/environments/$environment/</code> those are not actually consulted, only the $confdir hiera.yaml is used &ndash; therefore, <strong><em>you can not have hierarchies per environment</em></strong>. Since the <code>$datadir</code> is environment aware that namespace is filled at run time, and consults the specific environment datadir <code>$confdir/environments/$environment/hieradata/</code>.</p>

<p>Your hiera.yaml needs to have a <code>datadir</code> configured for dynamic lookup so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="l-Scalar-Plain">:backends</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">yaml</span>
</span><span class='line'><span class="l-Scalar-Plain">:hierarchy</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="s">&quot;%{clientcert}&quot;</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="s">&quot;%{environment}&quot;</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">global</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">:yaml</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">:datadir</span><span class="p-Indicator">:</span> <span class="s">&#39;/etc/puppetlabs/puppet/environments/%{::environment}/hieradata&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Branching your Puppetfile</h3>

<p>For example, assuming you already have a master or production branch:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vi Puppetfile
</span></code></pre></td></tr></table></div></figure>


<p>&hellip;add some git modules etc&hellip;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git checkout -b development
</span><span class='line'>git push origin development:development
</span><span class='line'>git commit -am Puppetfile
</span><span class='line'>r10k deploy environment -pv
</span></code></pre></td></tr></table></div></figure>


<p>Now you have a new topic branch &lsquo;development&rsquo; and a new Puppet environment in <code>$confdir/environments/development</code>.</p>

<h3>Branching your hiera data</h3>

<p>Our <code>development</code> branch needs it&rsquo;s own data too:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span> <span class="nv">$confdir</span>/hieradata
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>modify K,V&rsquo;s in <code>whatever.yaml</code></li>
<li>modify other K,V&rsquo;s as needed for your development environment</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git branch <span class="c"># check your branch, make sure it&#39;s still development</span>
</span><span class='line'>git commit -am hieradata
</span><span class='line'>git push
</span><span class='line'>r10k deploy environment -pv
</span></code></pre></td></tr></table></div></figure>


<p>Check <code>$confdir/environments/development/hieradata</code></p>

<h2>Testing</h2>

<h3>Configuration files for r10k, hiera, puppet:</h3>

<h4>/etc/r10k.yaml</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@master hieradata<span class="o">]</span><span class="c"># cat /etc/r10k.yaml</span>
</span><span class='line'>:cachedir: /var/cache/r10k
</span><span class='line'>:sources:
</span><span class='line'>  puppet:
</span><span class='line'>    remote: <span class="s2">&quot;git@10.10.100.111:user/control_repo.git&quot;</span>
</span><span class='line'>    basedir: /etc/puppetlabs/puppet/environments
</span><span class='line'>    prefix: <span class="nb">false</span>
</span><span class='line'>:purgedirs:
</span><span class='line'>  - <span class="s2">&quot;&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h4>/etc/puppetlabs/puppet/puppet.conf</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> cat /etc/puppetlabs/puppet/puppet.conf
</span><span class='line'><span class="o">[</span>main<span class="o">]</span>
</span><span class='line'><span class="nv">certname</span> <span class="o">=</span> master.puppetlabs.vm
</span><span class='line'><span class="nv">dns_alt_names</span> <span class="o">=</span> master.puppetlabs.vm,puppet
</span><span class='line'><span class="nv">vardir</span> <span class="o">=</span> /var/opt/lib/pe-puppet
</span><span class='line'><span class="nv">logdir</span> <span class="o">=</span> /var/log/pe-puppet
</span><span class='line'><span class="nv">rundir</span> <span class="o">=</span> /var/run/pe-puppet
</span><span class='line'><span class="nv">modulepath</span> <span class="o">=</span> /etc/puppetlabs/puppet/environments/<span class="nv">$environment</span>/modules:/opt/puppet/share/puppet/modules
</span><span class='line'><span class="nv">server</span> <span class="o">=</span> master.puppetlabs.vm
</span><span class='line'><span class="nv">user</span>  <span class="o">=</span> pe-puppet
</span><span class='line'><span class="nv">group</span> <span class="o">=</span> pe-puppet
</span><span class='line'><span class="nv">archive_files</span> <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'><span class="nv">archive_file_server</span> <span class="o">=</span> master.puppetlabs.vm
</span><span class='line'><span class="c"># cut [master] &amp; [agent] sections, $modulepath above is the important config key here.</span>
</span></code></pre></td></tr></table></div></figure>


<h4>/etc/puppetlabs/puppet/hiera.yaml</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> cat hiera.yaml
</span><span class='line'>---
</span><span class='line'>:backends:
</span><span class='line'>  - yaml
</span><span class='line'>:hierarchy:
</span><span class='line'>  - <span class="s2">&quot;%{clientcert}&quot;</span>
</span><span class='line'>  - <span class="s2">&quot;%{environment}&quot;</span>
</span><span class='line'>  - global
</span><span class='line'>:yaml:
</span><span class='line'>  :datadir: <span class="s1">&#39;/etc/puppetlabs/puppet/environmets/%{environment}/hieradata&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h4>/etc/puppetlabs/puppet/Puppetfile</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span><span class="c"># cat Puppetfile</span>
</span><span class='line'><span class="c"># mod, &lt;module name&gt;, &lt;version or tag&gt;, &lt;source&gt;</span>
</span><span class='line'>forge <span class="s2">&quot;http://forge.puppetlabs.com&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Modules from the Puppet Forge</span>
</span><span class='line'>mod <span class="s2">&quot;puppetlabs/stdlib&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;puppetlabs/apache&quot;</span>, <span class="s2">&quot;0.11.0&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;puppetlabs/pe_gem&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;puppetlabs/mysql&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;puppetlabs/firewall&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;puppetlabs/vcsrepo&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;puppetlabs/git&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;puppetlabs/inifile&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;zack/r10k&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;gentoo/portage&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;thias/vsftpd&quot;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c"># Modules from Github using various references</span>
</span><span class='line'>mod <span class="s2">&quot;wordpress&quot;</span>,
</span><span class='line'>  :git <span class="o">=</span>&gt; <span class="s2">&quot;git://github.com/hunner/puppet-wordpress.git&quot;</span>,
</span><span class='line'>  :ref <span class="o">=</span>&gt; <span class="s1">&#39;0.4.0&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Testing the Puppet Master <code>master.puppetlabs.vm:$confdir/</code>:</h3>

<h4>Our topic branches:</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> git branch
</span><span class='line'>  development
</span><span class='line'>* production
</span><span class='line'>  staging
</span></code></pre></td></tr></table></div></figure>


<h4>For the given topic branch above, production, let&rsquo;s look at our hieradata in <code>$confdir/hieradata</code>:</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> <span class="nb">pwd</span>
</span><span class='line'>/etc/puppetlabs/puppet/hieradata
</span><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> ls
</span><span class='line'>agent1.puppetlabs.vm.yaml  agent2.puppetlabs.vm.yaml  agent3.puppetlabs.vm.yaml  master.puppetlabs.vm.yaml
</span></code></pre></td></tr></table></div></figure>


<h4>and for each of these files we have the same K,V:</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> cat master.puppetlabs.vm.yaml
</span><span class='line'>---
</span><span class='line'>message: <span class="s2">&quot;%{fqdn} is running in environment %{environment}&quot;</span>
</span><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> cat agent1.puppetlabs.vm.yaml
</span><span class='line'>---
</span><span class='line'>message: <span class="s2">&quot;%{fqdn} is running in environment %{environment}&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Now let&rsquo;s switch over to our development branch and compare:</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> git checkout development
</span><span class='line'>Switched to branch <span class="s1">&#39;development&#39;</span>
</span><span class='line'>root@master hieradata<span class="o">]</span> <span class="nb">pwd</span>
</span><span class='line'>/etc/puppetlabs/puppet/hieradata
</span><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> ls
</span><span class='line'>agent1.puppetlabs.vm.yaml  agent2.puppetlabs.vm.yaml  agent3.puppetlabs.vm.yaml  master.puppetlabs.vm.yaml
</span><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> cat agent1.puppetlabs.vm.yaml
</span><span class='line'>---
</span><span class='line'>message: <span class="s2">&quot;%{fqdn} is running in environment %{environment}&quot;</span>
</span><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> cat master.puppetlabs.vm.yaml
</span><span class='line'>---
</span><span class='line'>message: <span class="s2">&quot;%{fqdn} is running in environment %{environment}&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Sync everything up with r10k so we can test:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> r10k deploy environment -pv
</span><span class='line'><span class="o">[</span>R10K::Task::Deployment::DeployEnvironments - INFO<span class="o">]</span> Loading environments from all sources
</span><span class='line'><span class="o">[</span>R10K::Task::Environment::Deploy - NOTICE<span class="o">]</span> Deploying environment staging
</span><span class='line'><span class="o">[</span>R10K::Task::Puppetfile::Sync - INFO<span class="o">]</span> Loading modules from Puppetfile into queue
</span><span class='line'><span class="o">[</span>R10K::Task::Environment::Deploy - NOTICE<span class="o">]</span> Deploying environment production
</span><span class='line'><span class="o">[</span>R10K::Task::Puppetfile::Sync - INFO<span class="o">]</span> Loading modules from Puppetfile into queue
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying wordpress into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying vsftpd into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying portage into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying r10k into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying inifile into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying git into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying vcsrepo into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying firewall into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying mysql into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying pe_gem into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying apache into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying stdlib into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Environment::Deploy - NOTICE<span class="o">]</span> Deploying environment master
</span><span class='line'><span class="o">[</span>R10K::Task::Puppetfile::Sync - INFO<span class="o">]</span> Loading modules from Puppetfile into queue
</span><span class='line'><span class="o">[</span>R10K::Task::Environment::Deploy - NOTICE<span class="o">]</span> Deploying environment development
</span><span class='line'><span class="o">[</span>R10K::Task::Puppetfile::Sync - INFO<span class="o">]</span> Loading modules from Puppetfile into queue
</span><span class='line'><span class="o">[</span>R10K::Task::Deployment::PurgeEnvironments - INFO<span class="o">]</span> Purging stale environments from /etc/puppetlabs/puppet/environments
</span></code></pre></td></tr></table></div></figure>


<p>Since there is a <code>%{certname}.yaml</code> for the master we can do a quick check on the command line that we&rsquo;re accessing the correct data:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> git checkout production
</span><span class='line'>Already on <span class="s1">&#39;production&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> puppet apply -e <span class="s2">&quot;notice(hiera(message))&quot;</span>
</span><span class='line'>Notice: Scope<span class="o">(</span>Class<span class="o">[</span>main<span class="o">])</span>: master.puppetlabs.vm is running in environment production
</span><span class='line'>Notice: Compiled catalog <span class="k">for </span>master.puppetlabs.vm in environment production in 0.06 seconds
</span><span class='line'>Notice: Finished catalog run in 0.24 seconds
</span><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>$fqdn</code> and <code>$environment</code> values were correctly filled in. <strong>Note</strong> that this is a poor test since my data files are essentially all the same, <code>$environment</code> will always match it&rsquo;s environment and <code>$fqdn</code> will always match it&rsquo;s fqdn &ndash;  we could be grabbing this value from anywhere. So Let&rsquo;s try with hard coded values:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> <span class="nb">pwd</span>
</span><span class='line'>/etc/puppetlabs/puppet/hieradata
</span><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> git branch
</span><span class='line'>  development
</span><span class='line'>* production
</span><span class='line'>  staging
</span><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> cat master.puppetlabs.vm.yaml
</span><span class='line'>---
</span><span class='line'>message: <span class="s2">&quot;I&#39;m hard coding this value: environment production, master.puppetlabs.vm.yaml&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now push your new data for production branch up to gitlab</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span><span class="c"># git add hieradata/</span>
</span><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span><span class="c"># git commit -m &quot;hieradata hard coded&quot;</span>
</span><span class='line'><span class="o">[</span>production 3a58e49<span class="o">]</span> hieradata hard coded
</span><span class='line'> 1 files changed, 1 insertions<span class="o">(</span>+<span class="o">)</span>, 1 deletions<span class="o">(</span>-<span class="o">)</span>
</span><span class='line'> <span class="o">[</span>root@master puppet<span class="o">]</span><span class="c"># git push</span>
</span><span class='line'> Counting objects: 7, <span class="k">done</span>.
</span><span class='line'> Delta compression using up to 4 threads.
</span><span class='line'> Compressing objects: 100% <span class="o">(</span>4/4<span class="o">)</span>, <span class="k">done</span>.
</span><span class='line'> Writing objects: 100% <span class="o">(</span>4/4<span class="o">)</span>, 399 bytes, <span class="k">done</span>.
</span><span class='line'> Total 4 <span class="o">(</span>delta 2<span class="o">)</span>, reused 0 <span class="o">(</span>delta 0<span class="o">)</span>
</span><span class='line'> To git@10.10.100.111:user/control_repo.git
</span><span class='line'>    1b240c6..3a58e49  production -&gt; production
</span></code></pre></td></tr></table></div></figure>


<p>and sync r10k</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span><span class="c"># r10k deploy environment -pv</span>
</span><span class='line'><span class="o">[</span>R10K::Task::Deployment::DeployEnvironments - INFO<span class="o">]</span> Loading environments from all sources
</span><span class='line'><span class="o">[</span>R10K::Task::Environment::Deploy - NOTICE<span class="o">]</span> Deploying environment staging
</span><span class='line'><span class="o">[</span>R10K::Task::Puppetfile::Sync - INFO<span class="o">]</span> Loading modules from Puppetfile into queue
</span><span class='line'><span class="o">[</span>R10K::Task::Environment::Deploy - NOTICE<span class="o">]</span> Deploying environment production
</span><span class='line'><span class="o">[</span>R10K::Task::Puppetfile::Sync - INFO<span class="o">]</span> Loading modules from Puppetfile into queue
</span><span class='line'><span class="c"># ommitting other output ...</span>
</span></code></pre></td></tr></table></div></figure>


<p>and test for the correct hard coded K,V</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span><span class="c"># puppet apply -e &quot;notice(hiera(message))&quot;</span>
</span><span class='line'>Notice: Scope<span class="o">(</span>Class<span class="o">[</span>main<span class="o">])</span>: I<span class="err">&#39;</span>m hard coding this value: environment production, master.puppetlabs.vm.yaml
</span><span class='line'>Notice: Compiled catalog <span class="k">for </span>master.puppetlabs.vm in environment production in 0.05 seconds
</span><span class='line'>Notice: Finished catalog run in 0.26 seconds
</span></code></pre></td></tr></table></div></figure>


<p>YAY!</p>

<h4>And again on the development branch</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> <span class="nb">pwd</span>
</span><span class='line'>/etc/puppetlabs/puppet/hieradata
</span><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> git branch
</span><span class='line'>* development
</span><span class='line'>  production
</span><span class='line'>  staging
</span><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> cat hieradata/master.puppetlabs.vm.yaml
</span><span class='line'>---
</span><span class='line'>message: <span class="s2">&quot;I&#39;m hard coding this value: environment development, master.puppetlabs.vm.yaml&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Push our new hieradata for <code>development</code> to gitlab:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> git add hieradata/
</span><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> git commit -m <span class="s2">&quot;hieradata hard coded&quot;</span>
</span><span class='line'><span class="o">[</span>development 2873db5<span class="o">]</span> hieradata hard coded
</span><span class='line'> 1 files changed, 1 insertions<span class="o">(</span>+<span class="o">)</span>, 1 deletions<span class="o">(</span>-<span class="o">)</span>
</span><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> git push
</span><span class='line'>Counting objects: 7, <span class="k">done</span>.
</span><span class='line'>Delta compression using up to 4 threads.
</span><span class='line'>Compressing objects: 100% <span class="o">(</span>4/4<span class="o">)</span>, <span class="k">done</span>.
</span><span class='line'>Writing objects: 100% <span class="o">(</span>4/4<span class="o">)</span>, 398 bytes, <span class="k">done</span>.
</span><span class='line'>Total 4 <span class="o">(</span>delta 2<span class="o">)</span>, reused 0 <span class="o">(</span>delta 0<span class="o">)</span>
</span><span class='line'>To git@10.10.100.111:user/control_repo.git
</span><span class='line'>   08e249b..2873db5  development -&gt; development
</span></code></pre></td></tr></table></div></figure>


<p>andthen sync with r10k</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span><span class="c"># r10k deploy environment -pv</span>
</span><span class='line'><span class="o">[</span>R10K::Task::Deployment::DeployEnvironments - INFO<span class="o">]</span> Loading environments from all sources
</span><span class='line'><span class="o">[</span>R10K::Task::Environment::Deploy - NOTICE<span class="o">]</span> Deploying environment staging
</span><span class='line'><span class="o">[</span>R10K::Task::Puppetfile::Sync - INFO<span class="o">]</span> Loading modules from Puppetfile into queue
</span><span class='line'><span class="o">[</span>R10K::Task::Environment::Deploy - NOTICE<span class="o">]</span> Deploying environment production
</span><span class='line'><span class="o">[</span>R10K::Task::Puppetfile::Sync - INFO<span class="o">]</span> Loading modules from Puppetfile into queue
</span><span class='line'><span class="c"># ommitted the other output...</span>
</span></code></pre></td></tr></table></div></figure>


<p>and test with the <code>--environment development</code> switch</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span><span class="c"># puppet apply -e &quot;notice(hiera(message))&quot; --environment development</span>
</span><span class='line'>Notice: Scope<span class="o">(</span>Class<span class="o">[</span>main<span class="o">])</span>: I<span class="err">&#39;</span>m hard coding this value: environment development, master.puppetlabs.vm.yaml
</span><span class='line'>Notice: Compiled catalog <span class="k">for </span>master.puppetlabs.vm in environment development in 0.05 seconds
</span><span class='line'>Notice: Finished catalog run in 0.25 seconds
</span></code></pre></td></tr></table></div></figure>


<p>`</p>

<p>We can also do a quick one time environment run with the <code>--environment</code> flag:</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Why I don't place a hiera.yaml in my CR]]></title>
    <link href="httpL://www.jeffmalnick.com/blog/2014/05/15/hiera-and-r10k/"/>
    <updated>2014-05-15T16:12:36-07:00</updated>
    <id>httpL://www.jeffmalnick.com/blog/2014/05/15/hiera-and-r10k</id>
    <content type="html"><![CDATA[<p>Here&rsquo;s a really good reason. First off, unless your hiera.yaml is super complicated, then it probably doesn&rsquo;t need to be in version control. However, for a lot of deployments you need it in VC, but not in your control repo (i.e., the one that r10k will access for Puppetfile, hieradata and build our corrosponding enviros for on your master).</p>

<p>No, place that hiera.yaml in it&rsquo;s own VC repo.</p>

<p>I had a control repo with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Puppetfile
</span><span class='line'>hieradata/
</span><span class='line'>hiera.yaml</span></code></pre></td></tr></table></div></figure>


<p>and I kept running in to this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@master hieradata]# puppet apply -e "notice(hiera(message))"
</span><span class='line'>Error: Could not find data item message in any Hiera data file and no default supplied at line 1 on node master.puppetlabs.vm</span></code></pre></td></tr></table></div></figure>


<p>This was a very simple test to see if my <code>production</code> environment was grabbing the correct data via a message K,V in <code>$confdir/environments/production/hieradata/master.puppetlabs.vm.yaml</code> .</p>

<p>Check out the &mdash;debug</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Debug: hiera(): Hiera YAML backend starting
</span><span class='line'>Debug: hiera(): Looking up message in YAML backend
</span><span class='line'>Debug: hiera(): Looking for data source master.puppetlabs.vm
</span><span class='line'>Debug: hiera(): Cannot find datafile /etc/puppetlabs/puppet/environmets/production/hieradata/master.puppetlabs.vm.yaml, skipping
</span><span class='line'>Debug: hiera(): Looking for data source production
</span><span class='line'>Debug: hiera(): Cannot find datafile /etc/puppetlabs/puppet/environmets/production/hieradata/production.yaml, skipping
</span><span class='line'>Debug: hiera(): Looking for data source global
</span><span class='line'>Debug: hiera(): Cannot find datafile /etc/puppetlabs/puppet/environmets/production/hieradata/global.yaml, skipping</span></code></pre></td></tr></table></div></figure>


<p>So I copied the <code>datafile</code> path and redirected it to a diff along with a &#8220;`$(pwd) while in the /etc/puppetlabs/puppet/environments/production/hieradata directory:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@master hieradata]# diff &lt;(echo "/etc/puppetlabs/puppet/environmets/production/hieradata/") &lt;(echo "$(pwd)")
</span><span class='line'>1c1
</span><span class='line'>&lt; /etc/puppetlabs/puppet/environmets/production/hieradata/
</span><span class='line'>---
</span><span class='line'>&gt; /etc/puppetlabs/puppet/environments/production/hieradata</span></code></pre></td></tr></table></div></figure>


<p>So the <code>$datadir</code> path in hiera.yaml</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@master puppet]# cat hiera.yaml | grep datadir
</span><span class='line'>  :datadir: '/etc/puppetlabs/puppet/environmets/%{environment}/hieradata'</span></code></pre></td></tr></table></div></figure>


<p>is indeed missing that f-ing &lsquo;n&rsquo;. Why? Because this was the second time this happened to me today.</p>

<p>Really? The second time? Really. The second fucking time.</p>

<p>I previously committed hiera.yaml along with hieradata/ and my Puppetfile to branch production. I tested it and came across this problem. Did the same test to figure out the correct path and updated hiera.yaml.</p>

<p>However, hiera.yaml was also in my development and staging branches. I didn&rsquo;t update those. So here I was again doing tests on development data for Puppet and <strong>boom</strong> my shit&rsquo;s broken again.</p>

<p>Since hiera.yaml is only used singularly on a puppet run, i.e., it&rsquo;s not consulted on a per environment basis, you only need one copy of it, and that&rsquo;s the one in your puppet $confdir. Having it scattered to the winds with r10k in the control repo does not give you any extra functionality (yet, someday we might make it enviro aware, but currently is not the case).</p>

<p>So if you&rsquo;re going to run your hiera.yaml into a VCS then do it in it&rsquo;s own monolithic repo. You can symlink it into the $confdir for Puppet.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Continous Integration Hooks with r10k &amp; Puppet]]></title>
    <link href="httpL://www.jeffmalnick.com/blog/2014/05/04/continous-integration-hooks-with-r10k-and-puppet/"/>
    <updated>2014-05-04T07:47:05-07:00</updated>
    <id>httpL://www.jeffmalnick.com/blog/2014/05/04/continous-integration-hooks-with-r10k-and-puppet</id>
    <content type="html"><![CDATA[<p>A week ago I was modifiying a webhook to run r10k on push to a git repository. The goal here was to sync up r10k everytime a push was made to the repo. However, in doing so I found that the <a href="https://github.com/acidprime/r10k/blob/master/templates/usr/local/bin/webhook.erb">current</a> hook didn&rsquo;t take advantage of deploying a specific puppet environmnet, and instead runs a full r10k sync across all topic branchs and thus all puppet environments.</p>

<p>I figured the first place to start was modifying the <a href="https://github.com/acidprime/r10k/blob/master/templates/usr/local/bin/webhook.erb#L35">&lsquo;post&rsquo;</a> method:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">post</span> <span class="s1">&#39;/payload&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="c1">#protected!</span>
</span><span class='line'>      <span class="n">deploy</span><span class="p">()</span>
</span><span class='line'>    <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p> to parse the json sent by git (in this case I was integrating with gitlab) for the <a href="http://demo.gitlab.com/help/web_hooks">ref branch</a>. So the &lsquo;post&rsquo; hook now looks like <a href="https://github.com/malnick/r10k/blob/master/templates/usr/local/bin/webhook.erb#L52">this</a>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">post</span> <span class="s1">&#39;/payload&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="c1">#protected!</span>
</span><span class='line'>    <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">rewind</span>  <span class="c1"># in case someone already read it</span>
</span><span class='line'>    <span class="n">data</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">read</span>
</span><span class='line'>    <span class="n">branch</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="s1">&#39;ref&#39;</span><span class="o">].</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>    <span class="s2">&quot;ref branch: </span><span class="si">#{</span><span class="n">branch</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="c1">#deploy(refs)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>So the #branch effectively is our puppet environment that we want to pass to the r10k mcollective agent so we can deploy a specific puppet enviro and not sync across all topic branches/enviros. This will make it lightweight.</p>

<p>However, I ran into a blocker in the mcollective r10k agent itself. I want to pass this argument to it so I can sync all r10k nodes at once from this hook based on the ref branch the current r10k <a href="https://github.com/acidprime/r10k/blob/master/files/agent/r10k.rb#L28">agent</a> does not accept any arugments and only syncs across all topic branches using the &lsquo;syncronize&rsquo; method.</p>

<p>In order to pass this ref branch in and leverage &lsquo;r10k deploy environmnet #{topic_branch}&rsquo; as I&rsquo;m attempting here the agent will need to be modified to parse the argument.</p>

<p><a href="https://github.com/acidprime/r10k/blob/master/files/agent/r10k.rb#L28">Zach&rsquo;s current r10k agent</a> is pretty good, so we&rsquo;ll stick to modifying that (at this point I handed over the agent writing to a colleague Andrew Brader since I was sent to a training site and he had a week/time to modifying the mco agent):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>     <span class="k">def</span> <span class="nf">run_cmd</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="n">path</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>        <span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>        <span class="n">git</span>  <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;/usr/bin/env&#39;</span><span class="p">,</span> <span class="s1">&#39;git&#39;</span><span class="o">]</span>
</span><span class='line'>        <span class="n">r10k</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;/usr/bin/env&#39;</span><span class="p">,</span> <span class="s1">&#39;r10k&#39;</span><span class="o">]</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">action</span>
</span><span class='line'>        <span class="k">when</span> <span class="s1">&#39;push&#39;</span><span class="p">,</span><span class="s1">&#39;pull&#39;</span><span class="p">,</span><span class="s1">&#39;status&#39;</span>
</span><span class='line'>          <span class="n">cmd</span> <span class="o">=</span> <span class="n">git</span>
</span><span class='line'>          <span class="n">cmd</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;push&#39;</span>   <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;push&#39;</span>
</span><span class='line'>          <span class="n">cmd</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;pull&#39;</span>   <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;pull&#39;</span>
</span><span class='line'>          <span class="n">cmd</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;status&#39;</span> <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;status&#39;</span>
</span><span class='line'>          <span class="n">reply</span><span class="o">[</span><span class="ss">:status</span><span class="o">]</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="ss">:stderr</span> <span class="o">=&gt;</span> <span class="ss">:error</span><span class="p">,</span> <span class="ss">:stdout</span> <span class="o">=&gt;</span> <span class="ss">:output</span><span class="p">,</span> <span class="ss">:chomp</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:cwd</span> <span class="o">=&gt;</span> <span class="n">path</span> <span class="p">)</span>
</span><span class='line'>        <span class="k">when</span> <span class="s1">&#39;cache&#39;</span><span class="p">,</span><span class="s1">&#39;environment&#39;</span><span class="p">,</span><span class="s1">&#39;module&#39;</span><span class="p">,</span><span class="s1">&#39;synchronize&#39;</span><span class="p">,</span><span class="s1">&#39;sync&#39;</span><span class="p">,</span> <span class="s1">&#39;deploy_all&#39;</span>
</span><span class='line'>          <span class="n">cmd</span> <span class="o">=</span> <span class="n">r10k</span>
</span><span class='line'>          <span class="n">cmd</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;cache&#39;</span>       <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;cache&#39;</span>
</span><span class='line'>          <span class="n">cmd</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;synchronize&#39;</span> <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;synchronize&#39;</span> <span class="ow">or</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;sync&#39;</span>
</span><span class='line'>          <span class="n">cmd</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;environment&#39;</span> <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;environment&#39;</span>
</span><span class='line'>          <span class="n">cmd</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;module&#39;</span>      <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;module&#39;</span>
</span><span class='line'>          <span class="n">cmd</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;deploy&#39;</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;environment&#39;</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;-p&#39;</span> <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;deploy_all&#39;</span>
</span><span class='line'>          <span class="n">reply</span><span class="o">[</span><span class="ss">:status</span><span class="o">]</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="ss">:stderr</span> <span class="o">=&gt;</span> <span class="ss">:error</span><span class="p">,</span> <span class="ss">:stdout</span> <span class="o">=&gt;</span> <span class="ss">:output</span><span class="p">,</span> <span class="ss">:chomp</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In order to parse the topic branch from the hook we need to add a method, which Andrew did <a href="https://github.com/abrader/r10k/blob/master/files/agent/r10k.rb#L59">here</a>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>      <span class="k">def</span> <span class="nf">deploy_only_cmd</span><span class="p">(</span><span class="n">r10k_env</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>        <span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>        <span class="n">r10k</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;/usr/bin/env&#39;</span><span class="p">,</span> <span class="s1">&#39;r10k&#39;</span><span class="o">]</span>
</span><span class='line'>        <span class="n">cmd</span> <span class="o">=</span> <span class="n">r10k</span>
</span><span class='line'>        <span class="n">cmd</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;deploy&#39;</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;environment&#39;</span> <span class="o">&lt;&lt;</span> <span class="n">r10k_env</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;-p&#39;</span>
</span><span class='line'>        <span class="n">reply</span><span class="o">[</span><span class="ss">:status</span><span class="o">]</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">deploy_only_cmd</span><span class="p">,</span> <span class="ss">:stderr</span> <span class="o">=&gt;</span> <span class="ss">:error</span><span class="p">,</span> <span class="ss">:stdout</span> <span class="o">=&gt;</span> <span class="ss">:output</span><span class="p">,</span> <span class="ss">:chomp</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Testing the new hook &amp; agent</h3>

<p>&hellip; to be updated shortly&hellip;</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Puppet Types: Understanding Parameters and Properties]]></title>
    <link href="httpL://www.jeffmalnick.com/blog/2014/04/19/puppet-types-understanding-parameters-and-properties/"/>
    <updated>2014-04-19T08:30:28-07:00</updated>
    <id>httpL://www.jeffmalnick.com/blog/2014/04/19/puppet-types-understanding-parameters-and-properties</id>
    <content type="html"><![CDATA[<p>When starting out with Types and Providers for Puppet it&rsquo;s common to misunderstand when something is a <em>Parameter</em> and when something is a <em>Property</em>.</p>

<h3><strong>Properties</strong></h3>

<p>Properties are anything that will <strong>modify</strong> a resource. In other words, attributes of a type that will change how that resource type exists on your system. A property is a charactaristic of a resource. A property does not change what a resource is, which is where the confusion usually begins.</p>

<p>For example, let&rsquo;s take the file resource (anyone who has had the opportunity of taking Extending Puppet for Developers might find this redundant).</p>

<pre><code>file {'/tmp/test':
    ensure   =&gt; file,
    path     =&gt; '/tmp/test', # $namevar
    owner    =&gt; 'root',
    group    =&gt; 'root',
    checksum =&gt; 'md5',
    content  =&gt; 'foo',
    }
</code></pre>

<p>Any ideas which attributes are parameters and which are properties? Let&rsquo;s start with</p>

<pre><code>ensure =&gt; file,
</code></pre>

<p>The &lsquo;ensure&rsquo; attribute is actually created by the &lsquo;ensurable&rsquo; method from the Puppet::Type class. Any attribute calling &lsquo;ensurable&rsquo; gets the default &lsquo;present&#8217;and &#8216;absent&rsquo; values telling the type to call from the provider &lsquo;exists?()&rsquo; then based on output from &lsquo;exists?&rsquo; evaluates &lsquo;creates()&rsquo; or &lsquo;destroy()&rsquo;.</p>

<p>Ensure modifies the resource, but does not change the definition of what that resource is to the system, therefore ensure is a property.</p>

<p>Other properties of file are</p>

<pre><code>owner
group
content
</code></pre>

<p>Content? Yes, content. On a file system the content of the file does not define the file, the <em>$path</em> to the file is the definition of a file. Therefore content is just a charactaristic of that file, making that attribute a property as well.</p>

<h3><strong>Parameters</strong></h3>

<p>Parameters are used by Puppet to provision the resource onto the system. Parameters are resource attributes that can be retrieved and are used to create, or define the resource as it exists on the system.</p>

<pre><code>path =&gt; '/tmp/testing',
</code></pre>

<p>For example, the $namevar of the the file resource is the $path. That&rsquo;s because the $path of a file defines the resource on the system. You can query the path of a file, however if you change the path of a file you define an entierly new file. Therefore, $path is a parameter.</p>

<p>Another parameter of file would the checksum attribute. The checksum type is used when determining whether to replace a file’s contents. If your md5 checksum does not match the md5 checksum of the file on the system your file will be created; if it does match your file will not be updated if it exists; if it doesn&rsquo;t exist if will be provisioned. Checksum defines what the file should look like on the system; it&rsquo;s used by Puppet to provision the file but not stored as part of the file resource.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Brief Intro to Puppetizing STIG Compliance]]></title>
    <link href="httpL://www.jeffmalnick.com/blog/2014/03/20/brief-intro-to-puppetizing-stig-compliance/"/>
    <updated>2014-03-20T10:01:05-07:00</updated>
    <id>httpL://www.jeffmalnick.com/blog/2014/03/20/brief-intro-to-puppetizing-stig-compliance</id>
    <content type="html"><![CDATA[<p>STIG is a methodology for the implementation of security compliance across heterogeneous operating systems. Every OS has a specific STIG. The STIG for a given OS is maintained and distributed by the Defense Information Systems Agency (DISA). Current STIGs can be found on the <a href="http://iase.disa.mil/stigs/">DISA website</a>.</p>

<p>Puppet is an excellent tool for bringing machines into STIG compliance. At my previous job I was in <a href="https://github.com/malnick/do_debian_stig/blob/master/do_debian_stig.sh">shell script hell</a> until we spun up a POS master and started writing a STIG module that worked across all OS&rsquo;s we supported (14 linux distros, 30 territorial sys admins, ~250 nodes).</p>

<p>In doing a STIG module for puppet it’s best to just work from Cat 1 down. 1 &amp; 2 offenses are pretty big, 3 &amp; 4 are usually minor security patches and can be overlooked if you’re time crunched. Staying on top of the false positives and keeping your module up to date with actual security implementation is the biggest hurdle.</p>

<p>This document is a general guideline from my experience in implementing STIG compliance measures.</p>

<h3>Basic STIG Process</h3>

<ol>
<li><p>Go to the DISA site and download the STIG for the appropriate OS</p></li>
<li><p>Do some sort of benchmark scan on a base OS:</p>

<ul>
<li>I used retina (which is awful) scans that were preloaded with the appropriate <a href="http://www.public.navy.mil/spawar/Atlantic/ProductsServices/Pages/SCAP.aspx">Security Content Automation Protocol (SCAP)</a> documents (.xml files, see below).</li>
<li> You can also get SCAP benchmarks on the DISA site for the appropriate OS listed with the STIG benchmarks (see below on SCAP)</li>
</ul>
</li>
<li><p>Take retina report with categorized vulnerabilities and start writing puppet modules &ndash; oh wait, just kidding! first you’ll need to:</p>

<ol type="a">
<li> Check for false positives &ndash; in most cases the OS provider is way ahead of the game, and simply running ‘apt-get update’ or ‘yum update’ will take care of 80% of the vulnerabilities on the box. STIG guidelines are notoriously behind the OS and will have LOTS of false positives. Most of your time will be spent accounting for what is actually a vulnerability and what is actually already patched by the OS provider.</li>
</ol>
</li>
<li><p>What vulnerabilities are left after cross correlating with security patches are what you have to develop specified puppet classes for, this is actually the easy part.</p></li>
</ol>


<p>A really good resource for this is the <a href="https://fedorahosted.org/aqueduct/wiki/RhelStigProcess">Aqueduct Project</a> at Fedora. They’re really good about staying on top of the recent STIG process and also maintaining a set puppet module for STIGing RHEL boxes (or at least they used to, not sure what their status is now. A recent look shows they&rsquo;re only on RHEL 5 so&hellip;).</p>

<h3>SCAP</h3>

<p>The Security <a href="http://scap.nist.gov">Content Automation Protocol (SCAP)</a> is a protocol developed by the NSA puppet branch of government known as NIST for implementing IT security measures. Some parts of the protocol can be useful in scanning tools such as retina since the XML format for the vulnerability index are standardized.</p>

<p>For example, when you are on the DISA site looking at the current STIG for a specific OS there will be a download button for &lsquo;SCAP Benchmarks&rsquo;. This is a .zip of several .xml&rsquo;s that contain:</p>

<p><a href="http://scap.nist.gov/specifications/cpe/">Common Platform Enumeration (CPE)</a> files for describing and identifying classes of applications, operating systems, and hardware devices present among an enterprise&rsquo;s computing assets.</p>

<p><a href="http://oval.mitre.org">Open Vulnerability and Assessment Language (OVAL)</a> for assessing and reporting upon the rachine state.</p>

<p><a href="http://scap.nist.gov/specifications/xccdf/index.html">Extensible Configuration Checklist Description Format (XCCDF)</a> which is a structured collection of security configuration rules for some set of target systems.</p>

<p>&hellip; and maybe some other random ones as well.</p>

<p>This is a document in motion so I&rsquo;ll be adding more here, feel free to add as you find information as well.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How To Install Rspec-Puppet on Puppet Enterprise]]></title>
    <link href="httpL://www.jeffmalnick.com/blog/2014/03/20/rspec-testing-puppet-enterprise-modules/"/>
    <updated>2014-03-20T09:42:50-07:00</updated>
    <id>httpL://www.jeffmalnick.com/blog/2014/03/20/rspec-testing-puppet-enterprise-modules</id>
    <content type="html"><![CDATA[<p>If you&rsquo;re getting into rspec testing for your manifests you might already know this:  Puppet Enterprise has it&rsquo;s own gem environment. This is a quick post on how to install rspec-puppet to your PE gem environment.</p>

<p>If you&rsquo;re new to rspec-puppet check out <a href="www.rspec-puppet.com">this great site</a> for a brief on installing (except if you&rsquo;re on PE, then follow the install below). rspec-puppet.com also has a great tutorial to get your up and running.</p>

<h3>Installing rspec-puppet on Puppet Enterprise</h3>

<p>If you&rsquo;ve already installed rspec-puppet via system gem you will get this error on rspec-puppet-init:</p>

<pre><code>[root@master users]# rspec-puppet-init 
/usr/lib/ruby/site_ruby/1.8/rubygems/custom_require.rb:31:in `gem_original_require': no such file to load -- puppet (LoadError)
</code></pre>

<p>If you&rsquo;ve already installed rspec-puppet vis system gem:</p>

<pre><code>$ /usr/bin/gem uninstall rspec-puppet
</code></pre>

<p>Once system rspec-puppet is removed:</p>

<pre><code>$ /opt/puppet/bin/gem install rspec-puppet
</code></pre>

<p>Then to init a new puppet rspec enviro in your $moduledir:</p>

<pre><code>$ /opt/puppet/bin/rspec-puppet-init
</code></pre>

<p>This should build:</p>

<pre><code>+ spec/
+ spec/classes/
+ spec/defines/
+ spec/functions/
+ spec/hosts/
+ spec/fixtures/
+ spec/fixtures/manifests/
+ spec/fixtures/modules/
+ spec/fixtures/modules/users/
+ spec/fixtures/manifests/site.pp
+ spec/fixtures/modules/users/manifests
+ spec/fixtures/modules/users/lib
+ spec/spec_helper.rb
+ Rakefile
</code></pre>

<h3>Installing PE-Specific Gems using PE-Gem Provider</h3>

<p><a href="https://github.com/puppetlabs/puppetlabs-pe_gem">puppetlabs/pe_gem</a> has the provider for pe_gem so you can simply:</p>

<pre><code>package { 'json':
    ensure   =&gt; present,
    provider =&gt; pe_gem,
    }
</code></pre>

<p>That&rsquo;s it!</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[TLS/SSL DH Cipher Padding Bug in ActiveMQ]]></title>
    <link href="httpL://www.jeffmalnick.com/blog/2014/03/17/tls-slash-ssl-dh-cipher-padding-bug-in-activemq/"/>
    <updated>2014-03-17T16:23:11-07:00</updated>
    <id>httpL://www.jeffmalnick.com/blog/2014/03/17/tls-slash-ssl-dh-cipher-padding-bug-in-activemq</id>
    <content type="html"><![CDATA[<h3>Update</h3>

<p>As of March 18 it appears that Oracle has implemented a fix in their release of <a href="http://www.oracle.com/technetwork/java/javase/8train-relnotes-latest-2153846.html">JDK and Java Standard Edition version 8</a> and it&rsquo;s assocaited <a href="http://docs.oracle.com/javase/8/docs/technotes/guides/security/enhancements-8.html">security extensions</a>:</p>

<p>&ldquo;Support stronger ephemeral DH keys in the SunJSSE provider: Make ephemeral DH key match the length of the certificate key during SSL/TLS handshaking in the SunJSSE provider. A new system property, jdk.tls.ephemeralDHKeySize, is defined to customize the ephemeral DH key sizes. The minimum acceptable DH key size is 1024 bits, except for exportable cipher suites or legacy mode (jdk.tls.ephemeralDHKeySize=legacy). See Customizing Size of Ephemeral DH Keys and RFE 6956398.&rdquo;</p>

<hr />

<p>In helping a client with an ActiveMQ issue in Puppet Enterprise I recently stumbled across this line in their wrapper log:</p>

<pre><code>INFO | jvm 1 | 2014/02/26 12:47:20 | WARN | Transport Connection to: tcp://ip.removed:49867 failed: javax.net.ssl.SSLHandshake
Exception: Invalid Padding length: 239
</code></pre>

<p>The client thought this may have been exacberating a JVM memory problem, however I found it actually is a not related but in and of itself it&rsquo;s own  bug in the Java Security Extensions for Diffe-Helman cipher implementation over SSL.</p>

<p>We have seen similar issues in JDK 1.7x security extensions in other Java-powered backends for Puppet Enterprise such as <a href="http://projects.puppetlabs.com/issues/19884">PuppetDB</a>. It has also been documented on the <a href="https://issues.apache.org/jira/browse/APLO-287">Apache ActiveMQ ticket board</a> and the <a href="https://community.oracle.com/message/11001587">Oracle community</a> board.</p>

<p>The issue is dependant on:</p>

<pre><code>* OpenJDK Runtime Environment (PE Java 1.7.0.19) 
* Linux OS's (so far my testing is on CentOS 6x) 
* TLS_DHE_RSA_WITH_AES_128_CBC_SHA Cipher
* openssl-1.0.0-27.el6_4.2.x86_64
</code></pre>

<p>To sum up the problem, every few hundred messages that are encrypted over SSL or TLS using DH ciphers the client gets a handshake exception. The exception is caused by a faulty SSL packet.</p>

<h3>Oracle&rsquo;s Solution</h3>

<p><a href="http://bugs.java.com/bugdatabase/view_bug.do?bug_id=8013059">A ticket was submitted</a> to Java bugs and was set &ldquo;resolved&rdquo; on 2013-10-25. However, and this is a big however, their resolution is, &ldquo;In order to have reliable TLS handshakes, Diffie Hellman key exchanges must be disabled.&rdquo;</p>

<p>I personally don&rsquo;t like this resolution since DH keys are sometimes neccessary, and in terms of security is superior to standard RSA ciphers. DH ciphers provide perfect forward secrecy. That means even if the private key is compromised you can not decrypt past data. Ciper suites which use DHE-RSA-AES128-SHA all implement the slower, more secure ephemeral DH crypto &ndash; it&rsquo;s ephemeral since new random numbers that generate the key are used each time. This is also why it&rsquo;s slower. However, it&rsquo;s also harder to run a selected clear text attack on EDH since the private key is used for only authentication and use an independant method to agree on a shared secret &ndash; standard RSA ciphers employ the private key for both auth and encryption for better performance in exchange for not providing perfect forward secrecy.</p>

<p>You may now chime in with your own conspiracy theories as to why Oracle would settle for solving this cyrpto issue by simply using a less secure cipher &ndash; does the NSA not want Java applications, which function as the backbone to a great deal of web traffic, encrypting data with perfect forward secrecy?</p>

<h3>Workaround in AMQ</h3>

<p>Since there is no good way to get around this problem in JDK 1.7x security extensions you have two choices:</p>

<pre><code>1. Live with the error in approx. 5% of the SSL traffic
2. Run SSL with a non-DH or DHE cipher  
</code></pre>

<h4>Door #1</h4>

<p>Example, you&rsquo;ve got an AMQ broker administering messaging for 1000+ AMQ agents in a live management setup in Puppet Enterprise you&rsquo;ll see this error a lot, and it may (warning, assumption) degrade live management performance in such a large deployment.</p>

<p>If you can live with either seeing this error 5% of the time or you can live with the hit in performance sticking it out with DH can still work.</p>

<h4>Door #2</h4>

<p>You need the performance or are a stickler for perfect SSL key exchange.</p>

<p>A possible solution would be modifying the transportConnector in /etc/puppetlabs/activemq/activemq.xml:</p>

<pre><code>&lt;transportConnector name="openwire" uri="ssl://0.0.0.0:61616"/&gt;
&lt;!-- Puppet mcollective_enable_stomp_ssl=true
&lt;transportConnector name="stomp+ssl" uri="stomp+ssl://0.0.0.0:61613"/&gt;\
</code></pre>

<p>With the transport.enabledCipherSuites embedded:</p>

<pre><code>ssl://localhost:61616?transport.enabledCipherSuites=SSL_RSA_WITH_3DES_EDE_CBC_SHA
</code></pre>

<p>The SSL_RSA_WITH_3DES_EDE_CBC_SHA is non-DH cipher versus the  SSL_DH_anon_WITH_3DES_EDE_CBC_SHA which I think is what AMQ currently uses.</p>

<p>Note syntax:</p>

<pre><code>ssl://…?socket.enabledCipherSuites=THE_CIPHER # for agents 
</code></pre>

<p>and</p>

<pre><code>ssl://…?transport.enabledCipherSuites=THE_CIPHER # for brokers 
</code></pre>

<p>More information about this can be found on the <a href="https://activemq.apache.org/ssl-transport-reference.html">AMQ reference page</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Debugging ActiveMQ JVM Heap Memory Errors]]></title>
    <link href="httpL://www.jeffmalnick.com/blog/2014/03/12/debugging-activemq-jvm-heap-memory-errors/"/>
    <updated>2014-03-12T21:08:06-07:00</updated>
    <id>httpL://www.jeffmalnick.com/blog/2014/03/12/debugging-activemq-jvm-heap-memory-errors</id>
    <content type="html"><![CDATA[<h2>This just happened:</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>INFO   | jvm 1    | 2014/03/11 16:12:34 | Exception in thread "ActiveMQ BrokerService[ppm.prod.dc2.adpghs.com] Task-79" Exception in thread "ActiveMQ BrokerService[ppm.prod.dc2.adpghs.com] Task-101" Exception in thread "ActiveMQ BrokerService[ppm.prod.dc2.adpghs.com] Task-87" Exception in thread "ActiveMQ BrokerService[ppm.prod.dc2.adpghs.com] Task-30" Exception in thread "ActiveMQ BrokerService[ppm.prod.dc2.adpghs.com] Task-74" java.lang.OutOfMemoryError: unable to create new native thread</span></code></pre></td></tr></table></div></figure>


<p>Since this is on a production server you need to recreate it in a testing environment. Since I&rsquo;m partial to vagrant I stand up 4 agent nodes and a master via pe-build vagrant plugin. My Vagrantfile looks something like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># -*- mode: ruby -*-</span>
</span><span class='line'><span class="c1"># vi: set ft=ruby :</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Vagrantfile API/syntax version. Don&#39;t touch unless you know what you&#39;re doing!</span>
</span><span class='line'><span class="no">VAGRANTFILE_API_VERSION</span> <span class="o">=</span> <span class="s2">&quot;2&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="no">VAGRANTFILE_API_VERSION</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;centos-64-x64-nocm&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box_url</span> <span class="o">=</span> <span class="s2">&quot;http://puppet-vagrant-boxes.puppetlabs.com/centos-64-x64-fusion503-nocm.box&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">pe_build</span><span class="o">.</span><span class="n">version</span>       <span class="o">=</span> <span class="s1">&#39;3.1.0&#39;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">pe_build</span><span class="o">.</span><span class="n">download_root</span> <span class="o">=</span> <span class="s1">&#39;https://s3.amazonaws.com/pe-builds/released&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">## Master</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="ss">:master</span> <span class="k">do</span> <span class="o">|</span><span class="n">master</span><span class="o">|</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="ss">:vmware_fusion</span> <span class="k">do</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span>
</span><span class='line'>      <span class="n">v</span><span class="o">.</span><span class="n">vmx</span><span class="o">[</span><span class="s2">&quot;memsize&quot;</span><span class="o">]</span>  <span class="o">=</span> <span class="s2">&quot;4096&quot;</span>
</span><span class='line'>      <span class="n">v</span><span class="o">.</span><span class="n">vmx</span><span class="o">[</span><span class="s2">&quot;numvcpus&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;4&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;10.10.100.100&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;master.puppetlabs.vm&#39;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:hosts</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:pe_bootstrap</span> <span class="k">do</span> <span class="o">|</span><span class="n">pe</span><span class="o">|</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">role</span> <span class="o">=</span> <span class="ss">:master</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;service iptables stop&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">## agent 1</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="ss">:agent1</span> <span class="k">do</span> <span class="o">|</span><span class="n">agent</span><span class="o">|</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="ss">:vmware_fusion</span>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;10.10.100.111&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;agent1.puppetlabs.vm&#39;</span>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:hosts</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:pe_bootstrap</span> <span class="k">do</span> <span class="o">|</span><span class="n">pe</span><span class="o">|</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">role</span>   <span class="o">=</span>  <span class="ss">:agent</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">master</span> <span class="o">=</span> <span class="s1">&#39;master.puppetlabs.vm&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">## agent 2</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="ss">:agent2</span> <span class="k">do</span> <span class="o">|</span><span class="n">agent</span><span class="o">|</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="ss">:vmware_fusion</span>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;10.10.100.112&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;agent2.puppetlabs.vm&#39;</span>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:hosts</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:pe_bootstrap</span> <span class="k">do</span> <span class="o">|</span><span class="n">pe</span><span class="o">|</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">role</span>   <span class="o">=</span>  <span class="ss">:agent</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">master</span> <span class="o">=</span> <span class="s1">&#39;master.puppetlabs.vm&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">## agent 3</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="ss">:agent3</span> <span class="k">do</span> <span class="o">|</span><span class="n">agent</span><span class="o">|</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="ss">:vmware_fusion</span>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;10.10.100.113&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;agent3.puppetlabs.vm&#39;</span>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:hosts</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:pe_bootstrap</span> <span class="k">do</span> <span class="o">|</span><span class="n">pe</span><span class="o">|</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">role</span>   <span class="o">=</span>  <span class="ss">:agent</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">master</span> <span class="o">=</span> <span class="s1">&#39;master.puppetlabs.vm&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">## agent 4</span>
</span><span class='line'>   <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="ss">:agent4</span> <span class="k">do</span> <span class="o">|</span><span class="n">agent</span><span class="o">|</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="ss">:vmware_fusion</span> <span class="k">do</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span>
</span><span class='line'>      <span class="n">v</span><span class="o">.</span><span class="n">vmx</span><span class="o">[</span><span class="s2">&quot;memsize&quot;</span><span class="o">]</span>  <span class="o">=</span> <span class="s2">&quot;1024&quot;</span>
</span><span class='line'>      <span class="n">v</span><span class="o">.</span><span class="n">vmx</span><span class="o">[</span><span class="s2">&quot;numvcpus&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;2&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;10.10.100.114&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;agent4.puppetlabs.vm&#39;</span>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:hosts</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:pe_bootstrap</span> <span class="k">do</span> <span class="o">|</span><span class="n">pe</span><span class="o">|</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">role</span> <span class="o">=</span> <span class="ss">:agent</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">master</span> <span class="o">=</span> <span class="s1">&#39;master.puppetlabs.vm&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This error occured on an ActiveMQ install that works as the message que for a 1000 node deployment of puppet agents. To get terminology straight here, we have puppet agents and AMQ agents running on these 1000 nodes. They&rsquo;re all qued from a singular AMQ broker.</p>

<p>My first impression was that this error may be caused by having 1000 agents pinging a single AMQ broker, which is limited to 800 via fds instances.</p>

<p>I check locally on my test master:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master vagrant<span class="o">]</span><span class="c"># pgrep -f pe-activemq</span>
</span><span class='line'>1271
</span><span class='line'><span class="o">[</span>root@master vagrant<span class="o">]</span><span class="c"># cat /proc/1271/limits | grep files</span>
</span><span class='line'>Max open files            1024                 4096                 files
</span></code></pre></td></tr></table></div></figure>


<p>My soft limit is 1024 open files, and after rando .jars and logs and stuff that really feels like more around 800. So this is on the money, as far as what the docs say for ActiveMQ servers per broker.</p>

<h3>How am I going to recreate what a 1000 node enviro looks like?</h3>

<p>I&rsquo;m limited to my laptop, 16GB of memory, and I&rsquo;m too lazy to stand up 1000 instances in AWS (and to poor). So an attempt has to be made to recreate this memory error on my 5 nodes running locally.</p>

<p>Given the above information, I start open a shell, and ssh into my master:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master vagrant<span class="o">]</span><span class="c"># echo -n &quot;Max open files=3:3&quot; &gt; /proc/1271/limits</span>
</span><span class='line'><span class="o">[</span>root@master vagrant<span class="o">]</span><span class="c"># cat /proc/1271/limits | grep files</span>
</span><span class='line'>Max open files            3                    3                    files
</span></code></pre></td></tr></table></div></figure>


<p>Why 3? Because:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master vagrant<span class="o">]</span><span class="c"># ls /proc/1271/fd | wc -l</span>
</span><span class='line'>6
</span></code></pre></td></tr></table></div></figure>


<p>So a quick &lsquo;service pe-activemq restart&rsquo; and bang&hellip;</p>

<p>Oh shit, new PID, new proc instance. Damnit. I have to figure out something else to fake the resource limits here.</p>

<p>Since ulimit commands are shell-bound I can ssh into the master from another shell and run:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">[</span><span class="n">root</span><span class="vi">@master</span> <span class="n">vagrant</span><span class="o">]</span><span class="c1"># ulimit -n 10</span>
</span><span class='line'><span class="o">[</span><span class="n">root</span><span class="vi">@master</span> <span class="n">vagrant</span><span class="o">]</span><span class="c1"># service pe-activemq restart</span>
</span><span class='line'><span class="sr">/etc/ini</span><span class="n">t</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="ss">functions</span><span class="p">:</span> <span class="n">redirection</span> <span class="ss">error</span><span class="p">:</span> <span class="n">cannot</span> <span class="n">duplicate</span> <span class="ss">fd</span><span class="p">:</span> <span class="no">Invalid</span> <span class="n">argument</span>
</span><span class='line'><span class="no">Stopping</span> <span class="n">pe</span><span class="o">-</span><span class="ss">activemq</span><span class="p">:</span>                                      <span class="o">[</span>  <span class="no">OK</span>  <span class="o">]</span>
</span><span class='line'><span class="no">Starting</span> <span class="n">pe</span><span class="o">-</span><span class="ss">activemq</span><span class="p">:</span>                                      <span class="o">[</span>  <span class="no">OK</span>  <span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>The trick here is getting close enough to the lowest possible resource limits with out getting the</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bash: start_pipeline: pgrp pipe: Too many open files
</span><span class='line'>/bin/sh: error while loading shared libraries: libtinfo.so.5: cannot open shared object file: Error 24</span></code></pre></td></tr></table></div></figure>


<p>error.</p>

<p>3 was actually too low, so I ran with 10 and was able to run a restart. You have to account for other files that may be bound to the PID instance, like logs and .jars since this is a bunch of java. And as everyone knows, Java is basically the pig of programming languages.</p>

<p>So 10 fds worked and activemq has restarted. Let&rsquo;s look at my logs to see what I&rsquo;ve got:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>INFO   | jvm 5    | 2014/03/13 04:46:13 | Error: Exception thrown by the agent : java.rmi.server.ExportException: Listen failed on port: 0; nested exception is:
</span><span class='line'>INFO   | jvm 5    | 2014/03/13 04:46:13 |     java.net.SocketException: Too many open files</span></code></pre></td></tr></table></div></figure>


<p>That isn&rsquo;t what I wanted to see. I am looking for heap memory errors. So this clearly demonstrates it&rsquo;s not an fds constraint at the filesystem level. Time to move on to other possibilities.</p>

<h3>Possible Culprits</h3>

<ol>
<li><p>The JVM</p>

<ul>
<li>Consider increasing the total heap memory available to the broker JVM</li>
<li>Consider reducing the default JVM stack size of each thread using -xss</li>
<li>If your broker is embedded ensure the hostiong JVM has appropriate heap and stack sizes.</li>
</ul>
</li>
<li><p>The broker</p>

<ul>
<li>Broker memory is not JVM memory, it&rsquo;s only a constraint &ndash; the broker manages it&rsquo;s own memory.</li>
<li>Setting appropriate systemUsage memory: <a href="http://activemq.apache.org/producer-flow-control.html#ProducerFlowControl-Systemusage">http://activemq.apache.org/producer-flow-control.html#ProducerFlowControl-Systemusage</a></li>
<li>Hard limits exist on the number of agents a single broker can handle due to file descriptors and other hard system resources</li>
</ul>
</li>
</ol>


<h3>Solutions</h3>

<p>Check your log for current JVM heap size:</p>

<pre><code>INFO   | jvm 1    | 2014/02/26 12:47:04 |   Heap sizes: current=506816k  free=487246k  max=506816k
</code></pre>

<p>Try bumping this up to 1GB in</p>

<pre><code> /etc/puppetlabs/activemq/wrapper.conf
</code></pre>

<p>If you still get</p>

<pre><code>INFO   | jvm 1    | 2014/02/26 12:47:38 | Exception in thread "ActiveMQBrokerService[ppm.prod.dc2.adpghs.com] Task-58" java.lang.OutOfMemoryError: unable to create new native thread 
</code></pre>

<p>in your</p>

<pre><code>/var/log/pe-activemq/wrapper.log
</code></pre>

<p>then throttle up your systemUsage in</p>

<pre><code>/etc/puppetlabs/activemq/activemq.xml
</code></pre>

<p>per <a href="http://activemq.apache.org/producer-flow-control.html#ProducerFlowControl-Systemusage">this guideline</a></p>

<h3>Hard Limits of AMQ</h3>

<p>If you still get OOM errors you may be at a hard limit for agents per broker. ActiveMQ uses the amqPersistenceAdapter by default for persistent messages. Unfortunately, this persistence adapter (as well as the kahaPersistenceAdapter) opens a file descriptor for each queue. When creating large numbers of queues, you&rsquo;ll quickly run into the limit for your OS.</p>

<p>However, your logs will not register a OOM error as above, they&rsquo;ll show</p>

<pre><code>ERROR  | wrapper  | 2014/03/13 03:32:39 | JVM exited while loading the application.
INFO   | jvm 4    | 2014/03/13 03:32:39 | Error: Exception thrown by the agent : java.rmi.server.ExportException: Listen failed on port: 0; nested exception is:
INFO   | jvm 4    | 2014/03/13 03:32:39 | java.net.SocketException: Too many open files
</code></pre>

<p>If that is your error your could try upping the limit on file descripters per process. You can do something similar to what I did above or <a href="http://tinyurl.com/o9qs2f">Google for your OS</a>.</p>

<p>At this point if none of the above resolved the issues you should try standing up a second broker, especially if you&rsquo;re running more than 1000 agents on a single broker instance.</p>

<p>You can read more about <a href="http://activemq.apache.org/networks-of-brokers.html">standing up networks of brokers</a> and also <a href="http://activemq.apache.org/performance.html">AMQ performance</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Extracting JSON from Puppet YAML Report]]></title>
    <link href="httpL://www.jeffmalnick.com/blog/2014/01/17/extracting-json-from-puppet-yaml-report/"/>
    <updated>2014-01-17T06:55:04-08:00</updated>
    <id>httpL://www.jeffmalnick.com/blog/2014/01/17/extracting-json-from-puppet-yaml-report</id>
    <content type="html"><![CDATA[<h3>YAML &ndash;> JSON via Puppet Gen&#8217;ed YAML</h3>

<p>In a follow up to the post below, I started thinking about ways to generate a D3 readable JSON on the fly from the puppet generated YAML. I started by using a parser from the node library &lsquo;js-yaml&rsquo;. My YAML format looked like this:</p>

<figure class='code'><figcaption><span>last_puppet_run.yaml</span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'>  <span class="l-Scalar-Plain">metrics</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resources</span><span class="p-Indicator">:</span> <span class="kt">!ruby</span><span class="l-Scalar-Plain">/object:Puppet::Util::Metric</span>
</span><span class='line'>      <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">resources</span>
</span><span class='line'>      <span class="l-Scalar-Plain">label</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Resources</span>
</span><span class='line'>      <span class="l-Scalar-Plain">values</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">total</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Total</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">197</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">skipped</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Skipped</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">6</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">failed</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Failed</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">failed_to_restart</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="s">&quot;Failed</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">restart&quot;</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">restarted</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Restarted</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">changed</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Changed</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">out_of_sync</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="s">&quot;Out</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">sync&quot;</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">scheduled</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Scheduled</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'><span class="nn">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>My original stab at parsing this YAML failed when using the js-yaml node library. This was due to the fact that this is Puppet YAML &ndash; it was generated by a ruby class denoted at the top of the file:</p>

<figure class='code'><figcaption><span>last_puppet_run.yaml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="err">   </span><span class="l-Scalar-Plain">resources</span><span class="p-Indicator">:</span> <span class="kt">!ruby</span><span class="l-Scalar-Plain">/object:Puppet::Util::Metric</span>
</span></code></pre></td></tr></table></div></figure>


<p>So the way to parse this file into a JSON would have to be done using a ruby script where I could import the &lsquo;puppet&rsquo; class directly so the YAML lib would know how to read this particular file. I thought this would be as simple as:</p>

<figure class='code'><figcaption><span>test.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;puppet&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;yaml&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;json&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">datajson</span> <span class="o">=</span> <span class="s1">&#39;report.json&#39;</span>
</span><span class='line'><span class="n">datafile</span>  <span class="o">=</span> <span class="s1">&#39;last_run_report.yaml&#39;</span>
</span><span class='line'><span class="n">yaml</span> <span class="o">=</span> <span class="no">YAML</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span>
</span><span class='line'><span class="n">json</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">to_json</span>
</span><span class='line'><span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">datajson</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span> <span class="n">json</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>What I didn&rsquo;t count on was serialization.</p>

<h3>Serialization</h3>

<p>What would you expect that output to be? I&rsquo;ll give you one clue, it did look like a JSON&hellip; sorta:</p>

<figure class='code'><figcaption><span>report.json </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span><span class="nt">&quot;metrics&quot;</span><span class="p">:{</span><span class="nt">&quot;resources&quot;</span><span class="p">:</span><span class="s2">&quot;#&lt;Puppet::Util::Metric:0x007f8fb8cda088&gt;&quot;</span><span class="p">,</span><span class="nt">&quot;time&quot;</span><span class="p">:</span><span class="s2">&quot;#&lt;Puppet::Util::Metric:0x007f8fb8cd80f8&gt;&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:</span><span class="s2">&quot;#&lt;Puppet::Util::Metric:0x007f8fb8ce1608&gt;&quot;</span><span class="p">,</span><span class="nt">&quot;events&quot;</span><span class="p">:</span><span class="s2">&quot;#&lt;Puppet::Util::Metric:0x007f8fb8ce0eb0&gt;&quot;</span><span class="p">},</span><span class="nt">&quot;logs&quot;</span><span class="p">:[</span><span class="s2">&quot;Finished catalog run in 5.57 seconds&quot;</span><span class="p">],</span><span class="nt">&quot;resource_statuses&quot;</span><span class="p">:{</span><span class="nt">&quot;Schedule[daily]&quot;</span><span class="p">:</span><span class="s2">&quot;#&lt;Puppet::Resource::Status:0x007f8fb8ceaaf0&gt;&quot;</span><span class="p">,</span><span class="nt">&quot;Schedule[monthly]&quot;</span><span class="p">:</span><span class="s2">&quot;#&lt;Puppet::Resource::Status:0x007f8fb8ce84f8&gt;&quot;</span><span class="p">,</span><span class="nt">&quot;Schedule[hourly]&quot;</span><span class="p">:</span>
</span></code></pre></td></tr></table></div></figure>


<p>What&rsquo;s happening here? What happened to all our nice data, all of the sudden it&rsquo;s not human friendly anymore. This data is serialized, it&rsquo;s a by-product of using &lsquo;.to_json&rsquo; which is akin to saying &lsquo;JSON::dump(datafile)&rsquo;.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[test]]></title>
    <link href="httpL://www.jeffmalnick.com/blog/2014/01/13/test/"/>
    <updated>2014-01-13T09:35:57-08:00</updated>
    <id>httpL://www.jeffmalnick.com/blog/2014/01/13/test</id>
    <content type="html"><![CDATA[
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Puppet Run Vis]]></title>
    <link href="httpL://www.jeffmalnick.com/blog/2014/01/06/puppet-run-vis/"/>
    <updated>2014-01-06T00:00:00-08:00</updated>
    <id>httpL://www.jeffmalnick.com/blog/2014/01/06/puppet-run-vis</id>
    <content type="html"><![CDATA[<h3>D3 Visualization for a Puppet Run</h3>

<p>One of the common complaints with puppet, especially puppet enterprise (PE) is that it does not scale as one would hope. In example, the PE console. EVERY NODE must report to the console in PE. So, if, for example, you&rsquo;re a sysadmin working with 10,000+ or even 1,000+ PE nodes you&rsquo;re going to have a crazy busy console.</p>

<p>To make this problem more managable a visualization is necessary &ndash; until humans start developing USB ports for their brains. Here I propose one such way to manage this using D3 as the visualization tool and the post-run YAML log from PuppetDB.</p>

<p>The main issue here is in developing such a debugging tool I would hope to alliviate and not add to the already cumbersome way console manages 1000&rsquo;s of nodes. The tool should scale to &lsquo;n&rsquo; number of nodes &ndash; if there are 10 or 10,000,000 nodes I want this tool to be able to help the user troubleshoot errors on three axes:</p>

<pre><code>* Time - the time the error occured in the context of the run
* Error type - red for failure, orange for warning, green for successful
* Resource Invovled - the resource that either failued, generated warning or was successful. 
</code></pre>

<p>So in my mind, I have this layout which actually involved a couple layers:</p>

<pre><code>* View 1 - Circular graph; inner circle represents precentage of nodes with failures in red; mid circle is percentage of nodes with warnings in orange; outer circle is percentage of nodes with no errors in green.
* View 2 - Click on red area of graph; transition to new circular graph of same circumfrance; starting at 12 o'clock and moving clockwise around the graph is time, each 360 rotation starts a new level; each level is denoted by the number of failures; each failure's area or degrees of circumfrance is the precentage of nodes with that error. 
    * In eaxmple: if you have a 5 errors over 50 nodes, each with 10 instances of those 5 errors the area of the graph that the error takes up would be equally distributed through out the circle starting at time -0 at 12 o'clock moving clockwise around the circle (ok maybe a tarus now) until a equal number of levels has been reached once the center of the circle or tarus has been reached.
* View 3 - same as 2 but for warnings (orange).
* View 4 - same as 2 but for successes or no error (green).
</code></pre>

<p>Something similar to this: <a href="http://xliberation.com/parse/colortable/parsed3.html">http://xliberation.com/parse/colortable/parsed3.html</a></p>

<p>The initial view is simple, it is a ratio of nodes in three categories of &ldquo;has failures (center, red)&rdquo;, &ldquo;has warnings (mid circle, orange)&rdquo; and &ldquo;has no errors (outter circle, green)&rdquo;.</p>

<p>How do we deal with nodes with errors, warnings and successes? We lop them into the lowest common denomenator: if it has successes and warnings it goes to the warning loop; if it has successes warnings and errors it goes to error loop; if it has successes and errors it goes to error.</p>

<p>Our lowest common denomenator is the fact that we are only concerned with nodes that have errors or warnings, if it&rsquo;s successful that&rsquo;s great, we want to see it but errors are the what we are debugging.</p>

<h3>&lsquo;n&rsquo; scalability</h3>

<p>It needs to happen.</p>

<p>Humans are bad at abstracting long lists. I mean, &ldquo;node so-and-so had error this-and-that&rdquo; for 10,000,000 lines isn&rsquo;t so helpful. Sure, &ldquo;&mdash;trace&rdquo; or &ldquo;&mdash;debug&rdquo; is helpful, but ITSALOTOFLINESOFCODE&#8221;.</p>

<p>Humans can abstract information on more levels than &ldquo;line 1, 2,3&hellip;.&lsquo;n&rsquo;&rdquo;. We have 5 complete senses (for most of us!) so we should leverage a few more than textual abstractions of code. Color, shapes, area graphs; abstracting the run levels of a puppet run into &ldquo;zooms&rdquo;. These are all available to us.</p>

<h3>D3</h3>

<p>D3 is a javascript lib that talks directly to the DOM to quickly and efficiently create interactive scalable vector graphics.</p>

<p>What?</p>

<p>It means it can run in the PE console with little overhead, take it&rsquo;s datasets from the parsed YAML in PuppetDB via some savvy js-yaml action and run in basically any browser.</p>

<p>All you need to know is it&rsquo;s super rad.. and more importantly, proven.</p>

<h3>HOW DO WE PARSE THE YAML</h3>

<p>js-yaml, maybe. Or some other YAML to JSON converter that we can get arrays of data out of the YAML from for our JS D3 vis. That isn&rsquo;t so difficult.</p>

<p>Our PuppetDB YAML looks a little like this (for an example, I&rsquo;m using the first couple lines):</p>

<figure class='code'><figcaption><span>last_puppet_run.yaml</span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span> <span class="kt">!ruby</span><span class="l-Scalar-Plain">/object:Puppet::Transaction::Report</span>
</span><span class='line'><span class="l-Scalar-Plain">metrics</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="l-Scalar-Plain">resources</span><span class="p-Indicator">:</span> <span class="kt">!ruby</span><span class="l-Scalar-Plain">/object:Puppet::Util::Metric</span>
</span><span class='line'><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">resources</span>
</span><span class='line'><span class="l-Scalar-Plain">label</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Resources</span>
</span><span class='line'><span class="l-Scalar-Plain">values</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">total</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Total</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">85</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">skipped</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Skipped</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">failed</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Failed</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">1</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">failed_to_restart</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="s">&quot;Failed</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">restart&quot;</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">restarted</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Restarted</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">changed</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Changed</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">out_of_sync</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="s">&quot;Out</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">sync&quot;</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">1</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">scheduled</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Scheduled</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">0</span>
</span></code></pre></td></tr></table></div></figure>


<p>A converstion of this file to JSON would output something like:</p>

<figure class='code'><figcaption><span>last_puppet_run.json </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;metrics&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;resources&quot;</span><span class="p">:</span> <span class="s2">&quot;!ruby/object:Puppet::Util::Metric&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;!ruby/sym executed_command&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Events&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;values&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="s2">&quot;- total&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;Total&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;- failure&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;Failure&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;- success&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;Success&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="mi">0</span>
</span><span class='line'>  <span class="p">],</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This was encoded to JSON via: <a href="https://npmjs.org/package/yamljs">https://npmjs.org/package/yamljs</a></p>

<pre><code>yaml2json last_run_report.yaml --pretty
</code></pre>

<h3>First steps to building the vis</h3>

<p>Start with an NGINX server running on localhost:8888 serving up the /www directory from my github.com/puppetlabs/banyan.</p>

<p>Then I start with figuring out how the heck D3 works. Well, luckily for me it&rsquo;s pretty simple. You start by defining some CSS elements for the vis. In my case, I wanted to simply see how I would grab data from the YAML, parsed to JSON and push it into D3.</p>

<p>Let&rsquo;s start small:</p>

<figure class='code'><figcaption><span>index.html </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="cp">&lt;!DOCTYPE html&gt;</span>
</span><span class='line'><span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;head&gt;</span>
</span><span class='line'>        <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;title&gt;</span>D3 Test Visualization for PE Run<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/head&gt;</span>
</span><span class='line'>  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;style&gt;</span>
</span><span class='line'>  <span class="nc">.chart</span> <span class="nt">div</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">font</span><span class="o">:</span> <span class="m">10px</span> <span class="k">sans-serif</span><span class="p">;</span>
</span><span class='line'>  <span class="k">background-color</span><span class="o">:</span> <span class="nb">steelblue</span><span class="p">;</span>
</span><span class='line'>  <span class="k">text-align</span><span class="o">:</span> <span class="k">right</span><span class="p">;</span>
</span><span class='line'>  <span class="k">padding</span><span class="o">:</span> <span class="m">3px</span><span class="p">;</span>
</span><span class='line'>  <span class="k">margin</span><span class="o">:</span> <span class="m">1px</span><span class="p">;</span>
</span><span class='line'>  <span class="k">color</span><span class="o">:</span> <span class="nb">white</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nt">&lt;/style&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This initializes a bar chart and the colors, alignment and all the other CSS crap that will be used over and over again in the SVG. I&rsquo;ll use .chart as a CSS div element below.</p>

<p>Then we need to tell the DOM that we&rsquo;re going to be using D3.js in our HTML script tags:</p>

<figure class='code'><figcaption><span>index.html </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;http://d3js.org/d3.v3.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ok, phew, that was rough right? Right. Because I&rsquo;m an ops guy and this dev shit is for the&hellip;</p>

<p>Anyways back to the meat of the index.html, our D3 script.</p>

<p>Let&rsquo;s declare the script tags and initialize some vars that we&rsquo;ll use in the test code:</p>

<figure class='code'><figcaption><span>index.html </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'> <span class="nt">&lt;body&gt;</span>
</span><span class='line'>        <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        var data;
</span><span class='line'>        var eval_time;
</span><span class='line'>        var draw_this = new Array();
</span></code></pre></td></tr></table></div></figure>


<p>Now lets parse that JSON I created from before via the YAML puppet_run_report. D3 is SO RAD that it ships with a nice JSON importer called &lsquo;d3.json&rsquo;. We&rsquo;re going to use it here to grab the &lsquo;evaluation_time&rsquo; metric from the parsed YAML (now a JSON) and push it into an array that we will eventually use to draw a bar representing this metric.</p>

<figure class='code'><figcaption><span>index.html </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>d3.json(&quot;last_run_report.json&quot;, function(error,json){
</span><span class='line'>          data = json;
</span><span class='line'>          eval_time = data.evaluation_time;
</span><span class='line'>          draw_this.push(eval_time);
</span></code></pre></td></tr></table></div></figure>


<p>Yep, that easy. Pretty rad right? Right.</p>

<p>Now the fun part, let&rsquo;s draw some scalable vector graphics (from here on out referred to by their much less type consuming name &lsquo;svg&rsquo;):</p>

<figure class='code'><figcaption><span>index.html </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>         var x = d3.scale.linear()
</span><span class='line'>              .domain([0, d3.max(draw_this)])
</span><span class='line'>              .range([0, 420]);
</span><span class='line'>
</span><span class='line'>          d3.select(&quot;.chart&quot;)
</span><span class='line'>              .selectAll(&quot;div&quot;)
</span><span class='line'>              .data(draw_this)
</span><span class='line'>              .enter().append(&quot;div&quot;)
</span><span class='line'>              .style(&quot;width&quot;, function(d) { return x(d) + &quot;px&quot;; })
</span><span class='line'>              .text(&quot;Evaluation Time&quot;);
</span><span class='line'>              //.text(function(d) { return d; });
</span><span class='line'>      });         
</span><span class='line'>        <span class="nt">&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>I start by telling D3 to scale the graph along the &lsquo;x&rsquo; axis because eventually I&rsquo;ll have other bars and I don&rsquo;t want this thing getting out of control, since I am a control freak.</p>

<p>Then we use the ever-so-awesome d3.select. The .select method is great, you could basically script an entire index.html with .select. What&rsquo;s actually happening here is .select is D3&rsquo;s way of saying, &ldquo;Hey DOM, here&rsquo;s a CSS selector, give me the first element match&rdquo;.</p>

<p>You can do .select(&ldquo;body&rdquo;), .select(&ldquo;marquee&rdquo;) (if you&rsquo;re hella adventurous) or if you want to have access to all the DOM elements .selectAll().</p>

<p>I selected my div.chart that I defined earlier, as this is the CSS style I want to push onto my silly bar graph. So all data elements iterated over in .data() will use this style. Notice how .style is automagically added to the DOM for .select() to use down here? That&rsquo;s super cool.</p>

<p>Then we pass my earlier defined array draw_this to .data(). .data is a holder for our soon to be iterated stuff. The magic happens when we use .enter, and wrap our div append in it.</p>

<p>Anytime you bind data to an element (in this case we&rsquo;re binding the array draw_this) you need to use .enter(). We don&rsquo;t actually have any DOM elements for div yet, but we need a placeholder for our data (or whatever data-element binding you might have). .enter() makes this placeholder &ndash; it says, &ldquo;hey I have this data, does the DOM have this data?&rdquo;. If the DOM is like, &ldquo;hell no I have no such data.&rdquo; Then .enter() creates a placeholder for that data.</p>

<p>Don&rsquo;t conflate data with DOM elements. In this example we&rsquo;re passing 1 data value (there only exists one data value in draw_this for now). .enter() will make sure we have placeholder <div> elements to put our data into since they do not exist. So .enter() in this example is making one <div> element PLACEHOLDER (all problems in computer science can be solved by enough levels of abstraction!).</p>

<p>It passes a REFERENCE of this placeholder to the next thing in the chain, in this case an append of <div> which actually inserts our elements into the DOM. We then apply our CSS style to a bar that we defined earlier and does some scaling math so when we have more bars later it won&rsquo;t get out of control and bang, we have a DIV representing our data.</p>

<p>So far our index.html looks like this:</p>

<figure class='code'><figcaption><span>index.html </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="cp">&lt;!DOCTYPE html&gt;</span>
</span><span class='line'><span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;head&gt;</span>
</span><span class='line'>        <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;title&gt;</span>D3 Test Visualization for PE Run<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/head&gt;</span>
</span><span class='line'>  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;style&gt;</span>
</span><span class='line'>  <span class="nc">.chart</span> <span class="nt">div</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">font</span><span class="o">:</span> <span class="m">10px</span> <span class="k">sans-serif</span><span class="p">;</span>
</span><span class='line'>  <span class="k">background-color</span><span class="o">:</span> <span class="nb">steelblue</span><span class="p">;</span>
</span><span class='line'>  <span class="k">text-align</span><span class="o">:</span> <span class="k">right</span><span class="p">;</span>
</span><span class='line'>  <span class="k">padding</span><span class="o">:</span> <span class="m">3px</span><span class="p">;</span>
</span><span class='line'>  <span class="k">margin</span><span class="o">:</span> <span class="m">1px</span><span class="p">;</span>
</span><span class='line'>  <span class="k">color</span><span class="o">:</span> <span class="nb">white</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nt">&lt;/style&gt;</span>
</span><span class='line'>  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;chart&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
</span><span class='line'>  
</span><span class='line'>  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;http://d3js.org/d3.v3.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>    <span class="nt">&lt;body&gt;</span>
</span><span class='line'>        <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      
</span><span class='line'>        <span class="kd">var</span> <span class="nx">data</span><span class="p">;</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">eval_time</span><span class="p">;</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">draw_this</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">d3</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="s2">&quot;last_run_report.json&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span><span class="nx">json</span><span class="p">){</span>
</span><span class='line'>          <span class="nx">data</span> <span class="o">=</span> <span class="nx">json</span><span class="p">;</span>
</span><span class='line'>          <span class="nx">eval_time</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">evaluation_time</span><span class="p">;</span>
</span><span class='line'>          <span class="c1">//alert(eval_time);</span>
</span><span class='line'>          <span class="nx">draw_this</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">eval_time</span><span class="p">);</span>
</span><span class='line'>          
</span><span class='line'>          <span class="c1">//draw something</span>
</span><span class='line'>          <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">()</span>
</span><span class='line'>              <span class="p">.</span><span class="nx">domain</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">draw_this</span><span class="p">)])</span>
</span><span class='line'>              <span class="p">.</span><span class="nx">range</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">420</span><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'>          <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;.chart&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">draw_this</span><span class="p">)</span>
</span><span class='line'>              <span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">x</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span> <span class="p">})</span>
</span><span class='line'>              <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">;</span> <span class="p">});</span>
</span><span class='line'>      <span class="p">});</span>          
</span><span class='line'>        <span class="nt">&lt;/script&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/body&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>OMG IT&rsquo;S SO AWESOME!
<img src="httpL://www.jeffmalnick.com/images/small_example.tiff" title="awesome" alt="images"></p>
]]></content>
  </entry>
  
</feed>
