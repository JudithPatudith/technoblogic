
<!DOCTYPE HTML>
<html>
<head>
	<script data-cfasync="false" type="text/javascript" src="//use.typekit.net/axj3cfp.js"></script>
	<script data-cfasync="false" type="text/javascript">try{Typekit.load();}catch(e){}</script>
	<meta charset="utf-8">
	<title>a techy blog  | JP</title>

<meta name="author" content="Jeff"> 

<meta name="description" content="See subtitle."> <meta name="keywords" content="">

	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="JP" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/stylesheets/font-awesome.min.css" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script type="text/javascript" src="/javascripts/jquery.fancybox.pack.js"></script>

<script language="Javascript" type="text/javascript">
$(document).ready(
  function() {
    (function($) {
      $(".fancybox[data-content-id]").each(function() {
        this.href = $(this).data('content-id');
      });
      $(".fancybox").fancybox({
        beforeLoad: function() {
          var el, 
              id = $(this.element).data('title-id');

          if (id) {
            el = $('#' + id);

            if (el.length) {
              this.title = el.html();
            }
          }
          if ($(this).data('content')) {
            this.content = $(this).data('content');
          }
        },
        helpers: {
          title: {
            type: 'inside'
          }
        }
      });
    })(jQuery);
  }
);
</script>

	
</head>



<body>
	<header id="header" class="inner"><h1><a href="/">JP</a></h1>
<h4>a techy blog</h4>
<nav id="main-nav"><ul>
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/about">About</a></li>
	<li><a href="/blog/resume">Resume</a></li>
	<li><a href="/archives">Archive</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul>
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/about">About</a></li>
	<li><a href="/blog/resume">Resume</a></li>
	<li><a href="/archives">Archive</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:httpL://www.jeffmalnick.com">
			</form>
		</div>
	</div>
</nav>


</header>

	<div id="content" class="inner">


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/02/20/why-devops-isnt-a-job-its-a-culture/">
		
			Why DevOps Isn&#8217;t a Job, It&#8217;s a Culture</a>
	</h2>
	<div class="entry-content">
		<p>DevOps is not a job, it&rsquo;s a culture. DevOps is a shift in how you decide to manage, deploy, develop, monitor, and interact with your application code and your infrastructure as a whole. DevOps is a holistic approach to enacting the now bankrupt term &ldquo;agile&rdquo; as a method of development and operations engineering in an organization.</p>

<p>At SRC:CLR we have a culture of DevOps that puts me face-to-face with developers everyday. At many companies the &lsquo;DevOps&rsquo; team never sees another dev. In fact, they may not see another operations person either. Usually, when you hear the term &lsquo;DevOps team&rsquo;, that means it&rsquo;s just another siloed group of people in a company, usually focused on automating infrastructure.</p>

<p>At SRC:CLR we roll DevOps in the way it was meant to be rolled: me, &lsquo;Mr. DevOps&rsquo;, sits shoulder to shoulder with our devs. No partitions, no separate team. When we get a Dir. of Engineering I&rsquo;ll be reporting to him, the same as our devs. Our operations are tightly coupled with the development of our code. That coupling ensures everyone is on a flat playing field, pushing towards the same goal.</p>

<p>How does this affect operations and development at SRC:CLR? It&rsquo;s the feedback loop stupid &ndash; it&rsquo;s continuous integration of ideas and knowledge of our application and our infrastructure. It creates synergy between how we architect our applications and how we automate and deploy our infrastructure.</p>

<p>True story: last week we had a hard time diagnosing why one of our main services was crashing. At first we thought it was Tomcat not having enough heap space. That helped but didn&rsquo;t fix it from continuing to silently crash. We enabled more robust logging but ended up with massive amounts of java spring output that we started grepping through.</p>

<p>Not useful.</p>

<p>I started looking at the process and realized our current monitoring system wasn&rsquo;t robust. We were using a mixture of New Relic for application and systems monitoring with CloudWatch from AWS. New Relic didn&rsquo;t have any logging data and what we wanted to find was correlation between the generated logs at failure and the process crashing. We didn&rsquo;t have a robust tool to look at the log data.</p>

<p>I started looking at hosted solutions: SumoLogic, Librato + Logstash, loggly. In the end our developers and I agreed that even though Librato has AMAZING graphing capabilities that offloading our logs to a hosted solution was insecure at best. We needed to stand up a solution in our private VPC.</p>

<p>After that lunch meeting I went back to the drawing board and started piecing together some Puppet code around Elasticsearch, Logstash and Kibana that I had started the previous week. In an hour I had an ELK + Redis stack up and running that was pulling down unfiltered log data from the node running the service which was crashing.</p>

<p>If you&rsquo;ve never graphed logging data you&rsquo;re not doing it right.</p>

<p>One of the lead devs on our platform started looking at the graphing output. A lot of it was health checks from HaProxy. Not a problem, I can filter that out on the node using &lsquo;drop{}&rsquo; in logstash. Next up was creating a lot of data on the node. We ran some queries against the service and started looking at the data that was coming in.</p>

<p>Having an interactive face to our logging data in the Kibana dashboard is invaluable. We can find correlations between crashes (on timestamps) and generated logging output. We can use that data to create alerts that go off before the process crashes.</p>

<p>At the end of the day I&rsquo;m an automation guru. The infrastructure that I automate is tightly coupled with our code. Since I have the skills to bring to life the data that the developers generate (in this case logging data) I can help alleviate stress on our infrastructure, create a more performate and stable platform and enable deep insights to how code responds in a fully integrated environment.</p>

<p>This transparency between the code development process and how deployed code behaves is core to DevOps culture. My job is about creating feedback loops for our development team so when things break in a deployed environment we can intelligently respond and iterate faster and smarter.</p>

<p>I can do this in a fully secure VPC or I can develop other methodologies in less secure hosted solutions. Either way, at the end of my day it&rsquo;s my job to ensure we have <code>uptime</code>. By far the best way to achieve that is to embed me in the middle of the development process, enabling fast iteration and seamless feedback between the development and operations ends of the deployment process.</p>

<p>That&rsquo;s why DevOps isn&rsquo;t a job, it&rsquo;s a process in which everyone in engineering participates. DevOps might be in my title as an employee but what it truly represents is SRC:CLR&rsquo;s commitment to blurring the lines between development and operations, enhancing feedback loops in both directions. This ensures more security, higher performance and better &#8220;uptime&#8220;`.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-02-20T07:22:08-08:00" pubdate data-updated="true">Feb 20<span>th</span>, 2015</time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/02/08/puppet-s3/">
		
			Puppet-s3 & Continuous Integration With Puppet, Jenkins and AWS</a>
	</h2>
	<div class="entry-content">
		<p>The (puppet-s3)[<a href="https://www.github.com/malnick/puppet-s3">https://www.github.com/malnick/puppet-s3</a>] module.</p>

<p>Usage:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">s3</span> <span class="p">{</span> <span class="s1">&#39;/path/to/file/on/my/local/filesystem&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="c1"># Required paramters:</span>
</span><span class='line'>    <span class="k">ensure</span>              <span class="o">=&gt;</span> <span class="n">present</span><span class="p">,</span>
</span><span class='line'>    <span class="n">source</span>              <span class="o">=&gt;</span> <span class="s1">&#39;/bucket/path/to/object&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">access_key_id</span>       <span class="o">=&gt;</span> <span class="s1">&#39;mysecret&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">secret_access_key</span>   <span class="o">=&gt;</span> <span class="s1">&#39;anothersecret&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="c1"># Optional parameters:</span>
</span><span class='line'>    <span class="n">region</span>              <span class="o">=&gt;</span> <span class="s1">&#39;us-west-1&#39;</span><span class="p">,</span> <span class="c1"># Defaults to us-east-1</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Overview</h2>

<p>Puppet s3 is my response to the need for secure downloads from S3 via Puppet. At SRC:CLR we use IAM authentication for S3 downloads. This piece of Puppet allows us to build out
our Jenkins continuous integration hook between the build and deployment process.</p>

<p>Currently the S3 type is only <em>psudo-idempotent</em>. What does that mean? It means <code>exists()?</code> actually pulls down the specified object to compare to the one on disk via a
tempfile. Then, if it returns false, <code>create()</code> pulls it down again.</p>

<p>Yes, this is horribly inefficient.</p>

<p>Yes, performance falls.</p>

<p>Yes, I plan on changing it in the near future.</p>

<h2>The Longview</h2>

<p>The reason we needed this provider is to enable us to pull S3 objects using our IAM authentication. But that is one small step towards our larger goal of fully integrating our Jenkins build
pipeline with our Puppet deployed AWS infrastructure.</p>

<p>To fully realize this integration we needed a way to pull the S3 zip file that is our built application, from S3. Jenkins deposits this zip file for us.</p>

<p>Then, Puppet compares the version number on S3 with the version number on disk. If greater, it pulls the new version.</p>

<h2>The Pipeline</h2>

<p>The pipeline from <code>git push</code> to <code>puppet agent -t</code> looks like this:</p>

<ol>
<li>A PR is submitted in Github and human eyes do a final check on the code.</li>
<li>If the human check passes, a manual merge to master is invoked.</li>
<li>A human manually runs a Jenkins build for either QA or Production environments. Lets assume this is a production deployment for this example.</li>
<li>The Jenkins build:

<ol>
<li>Runs Java tests</li>
<li>If the tests pass, builds a Java Jar.</li>
<li>Places this jar on S3 as: <code>our_app_${version}.zip</code> Let&rsquo;s assume $version is 3.2.1</li>
<li>Sends a HTTP POST to our Puppet Master with the following JSON:</li>
</ol>
</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="err">&#39;environment&#39;:&#39;production&#39;,</span>
</span><span class='line'>    <span class="err">&#39;role&#39;:&#39;application_backend&#39;,</span>
</span><span class='line'>    <span class="err">&#39;version&#39;:&#39;3.2.1&#39;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>A webhook running on our Puppet Master parses the POST and does the following:</p>

<ol>
<li>Edits the hieradata file at <code>/etc/puppetlabs/puppet/environments/${environment}/roles/${role}.yaml</code> to replace the value of key <code>profiles::sc_services::application_backend::version</code> with
the value sent in the POST: 3.2.1. $environment and $role are also inserted in the $path above to make a fully qualified path.</li>
<li>Commits this yaml data file locally and pushes it back up to our Puppet control repo.</li>
<li>It then invokes MCO as:</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">su</span> <span class="o">-</span> <span class="n">peadmin</span> <span class="o">-</span><span class="n">c</span> <span class="err">&#39;</span><span class="n">mco</span> <span class="n">puppet</span> <span class="n">runonce</span> <span class="o">-</span><span class="n">F</span> <span class="n">role</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="n">role</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Where $role is our role sent in the POST</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-02-08T15:29:47-08:00" pubdate data-updated="true">Feb 8<span>th</span>, 2015</time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/02/06/puppet-webhook/">
		
			Puppet-webhook</a>
	</h2>
	<div class="entry-content">
		<h1>puppet-webhook</h1>

<p>Have you ever needed to implement a simple REST API call to another service after a puppet run or during?</p>

<p>Well now you can!</p>

<p>This module contains a <code>http</code> type which can be ensureed to GET or POST. At the time of this writing the POST route has not been completed, however the GET route is implemnted as:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">http</span> <span class="p">{</span> <span class="s1">&#39;the_route&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="k">ensure</span>  <span class="o">=&gt;</span> <span class="n">get</span><span class="p">,</span>
</span><span class='line'>    <span class="n">fqdn</span>    <span class="o">=&gt;</span> <span class="s1">&#39;your.domain.com&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">port</span>    <span class="o">=&gt;</span> <span class="s1">&#39;6969&#39;</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This construction will essentially execute:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">curl</span> <span class="ss">http</span><span class="p">:</span><span class="sr">//</span><span class="n">your</span><span class="o">.</span><span class="n">domain</span><span class="o">.</span><span class="n">com</span><span class="p">:</span><span class="mi">6969</span><span class="o">/</span><span class="n">the_route</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Real world example</h3>

<p>Ok great, now we have an access point to the ruby HTTP lib from Puppet. Now what? Well, eventually you&rsquo;ll be able to do something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">http</span> <span class="p">{</span> <span class="s1">&#39;my_api&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="k">ensure</span>  <span class="o">=&gt;</span> <span class="n">post</span><span class="p">,</span>
</span><span class='line'>    <span class="n">fqdn</span>    <span class="o">=&gt;</span> <span class="s1">&#39;your.domain.com&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">port</span>    <span class="o">=&gt;</span> <span class="s1">&#39;6969&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">data</span>    <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>        <span class="s1">&#39;my_key&#39;</span>        <span class="o">=&gt;</span> <span class="s1">&#39;some_value&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;another_key&#39;</span>   <span class="o">=&gt;</span> <span class="vg">$:</span><span class="ss">:some_fact</span><span class="p">,</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>    <span class="n">header</span>  <span class="o">=&gt;</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span> <span class="c1"># or maybe javascript? or whatever your hook expects...</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that&rsquo;s a more complex example. What if all I want to do is execute a puppet run on my haproxy node after new nodes come up behind it?</p>

<p>Sure, there are a lot of ways we could accomplish this. I think the agreed upon way would be to use mCollective. mCollective is great since it rolls on Apache&rsquo;s ActiveMQ message bus. What that means is mCollective is <strong>asynchronous</strong> in messsaging. In other words, if we set up a webhook on our haproxy node to run <code>puppet agent -t</code> whenever a route recieves a GET request. However, we&rsquo;d end up having a race condition on the puppet process itself; if puppet is already running when a new node comes up it will fail to implement the call to run puppet on the haproxy node since that call is synchronous.</p>

<p>mCollective&rsquo;s AMQ bus allows us to stick a message on the bus to run puppet if it can&rsquo;t execute puppet right away, like when the puppet process is already running and the lock file exists.</p>

<p>So, the question remains: how do I execute a puppet run on our haproxy node, in order to get its fresh external resources (haproxy members) when new nodes come up?</p>

<p>Well, we could have a run stage at the end of our role (for the new node which will be a haproxy member)  manifest for the class containing our <code>http</code> resource:</p>

<p>Given a role of <code>haproxy_member_backend_service</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="ss">roles</span><span class="p">:</span><span class="ss">:haproxy_member_backend_service</span> <span class="p">{</span>
</span><span class='line'>    <span class="n">stage</span> <span class="p">{</span> <span class="s1">&#39;last&#39;</span><span class="p">:</span>
</span><span class='line'>        <span class="n">requires</span> <span class="o">=&gt;</span> <span class="no">Stage</span><span class="o">[</span><span class="s1">&#39;main&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">#... a bunch of code</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">class</span> <span class="p">{</span> <span class="s1">&#39;profiles::update_loadbalancer&#39;</span><span class="p">:</span>
</span><span class='line'>        <span class="n">stage</span> <span class="o">=&gt;</span> <span class="s1">&#39;last&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>&hellip;and a update_loadbalancer profiles like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="ss">profiles</span><span class="p">:</span><span class="ss">:update_loadbalancer</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">http</span> <span class="p">{</span> <span class="s1">&#39;update_loadbalancer&#39;</span><span class="p">:</span>
</span><span class='line'>        <span class="k">ensure</span>  <span class="o">=&gt;</span> <span class="n">get</span><span class="p">,</span>
</span><span class='line'>        <span class="n">port</span>    <span class="o">=&gt;</span> <span class="s1">&#39;6969&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="n">fqdn</span>    <span class="o">=&gt;</span> <span class="s1">&#39;my.puppetmaster.com&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can implement a webhook profile that is included in our puppetmaster module (or role, if your puppetmaster doesn&rsquo;t need a lot of configuration like mine) like this (which uses the handy <code>webhook::listener</code> defined type) to build out a dynamically generated sinatra server:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="ss">puppetmaster</span><span class="p">:</span><span class="ss">:webhook</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">include</span> <span class="n">webhook</span>
</span><span class='line'>    <span class="ss">webhook</span><span class="p">:</span><span class="ss">:listener</span> <span class="p">{</span><span class="s1">&#39;puppet&#39;</span><span class="p">:</span>
</span><span class='line'>        <span class="n">port</span> <span class="o">=&gt;</span> <span class="s1">&#39;6969&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="n">routes</span>            <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>            <span class="s1">&#39;kick_haproxy_app_internal&#39;</span>  <span class="o">=&gt;</span> <span class="p">{</span>
</span><span class='line'>                <span class="s1">&#39;method&#39;</span>  <span class="o">=&gt;</span> <span class="s1">&#39;get&#39;</span><span class="p">,</span>
</span><span class='line'>                <span class="s1">&#39;command&#39;</span> <span class="o">=&gt;</span> <span class="s2">&quot;su - peadmin -c &#39;mco puppet runonce -F role=haproxy_app_internal&#39;&quot;</span>
</span><span class='line'>            <span class="p">},</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>That <code>webhook::listener</code> builds a sinatra server at <code>/usr/local/bin/webhook_puppet/</code>. It looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;rack&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;sinatra&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;webrick&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;logger&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Global vars</span>
</span><span class='line'><span class="no">LOGDIR</span>              <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;/../logs&#39;</span>
</span><span class='line'><span class="no">SERVER_LOGFILE</span>  <span class="o">=</span> <span class="no">LOGDIR</span> <span class="o">+</span> <span class="s1">&#39;/server.log&#39;</span>
</span><span class='line'><span class="no">SESSION_LOG</span>         <span class="o">=</span> <span class="no">LOGDIR</span> <span class="o">+</span> <span class="s1">&#39;/session.log&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Reset some envs</span>
</span><span class='line'><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;HOME&#39;</span><span class="o">]</span>     <span class="o">=</span> <span class="s1">&#39;/root&#39;</span>
</span><span class='line'><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;PATH&#39;</span><span class="o">]</span>     <span class="o">=</span> <span class="s1">&#39;/sbin:/usr/sbin:/bin:/usr/bin:/opt/puppet/bin&#39;</span>
</span><span class='line'><span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;RACK_ENV&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;production&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Implement an access log for robust logging of user info and access and git output</span>
</span><span class='line'><span class="no">LOG</span> <span class="o">=</span> <span class="no">Logger</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">SESSION_LOG</span><span class="p">)</span>
</span><span class='line'><span class="no">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting session log at </span><span class="si">#{</span><span class="no">SESSION_LOG</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'><span class="no">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Setting server log at </span><span class="si">#{</span><span class="no">SERVER_LOGFILE</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Server options</span>
</span><span class='line'><span class="n">opts</span> <span class="o">=</span> <span class="p">{</span>
</span><span class='line'>    <span class="ss">:Port</span>               <span class="o">=&gt;</span> <span class="mi">6969</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">:Logger</span>             <span class="o">=&gt;</span> <span class="ss">WEBrick</span><span class="p">:</span><span class="ss">:Log</span><span class="o">::</span><span class="kp">new</span><span class="p">(</span><span class="no">SERVER_LOGFILE</span><span class="p">,</span> <span class="ss">WEBrick</span><span class="p">:</span><span class="ss">:Log</span><span class="o">::</span><span class="no">DEBUG</span><span class="p">),</span>
</span><span class='line'>    <span class="ss">:ServerType</span>         <span class="o">=&gt;</span> <span class="ss">WEBrick</span><span class="p">:</span><span class="ss">:Daemon</span><span class="p">,</span>
</span><span class='line'>    <span class="ss">:SSLEnable</span>          <span class="o">=&gt;</span> <span class="kp">false</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Server</span> <span class="o">&lt;</span> <span class="ss">Sinatra</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="n">get</span> <span class="s1">&#39;/kick_haproxy_app_internal&#39;</span> <span class="k">do</span>
</span><span class='line'>        <span class="no">IO</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s2">&quot;su - peadmin -c &#39;mco puppet runonce -F role=haproxy_app_internal&#39;&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">output</span><span class="o">|</span>
</span><span class='line'>            <span class="n">output</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span> <span class="no">LOG</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="o">.</span><span class="n">chomp</span><span class="p">)</span> <span class="k">end</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>    <span class="n">not_found</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">halt</span> <span class="mi">404</span><span class="p">,</span> <span class="s1">&#39;You shall not pass! (page not found)&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="ss">Rack</span><span class="p">:</span><span class="ss">:Handler</span><span class="o">::</span><span class="no">WEBrick</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="no">Server</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">server</span><span class="o">|</span>
</span><span class='line'>    <span class="o">[</span><span class="ss">:INT</span><span class="p">,</span> <span class="ss">:TERM</span><span class="o">].</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">sig</span><span class="o">|</span> <span class="nb">trap</span><span class="p">(</span><span class="n">sig</span><span class="p">)</span> <span class="p">{</span> <span class="n">server</span><span class="o">.</span><span class="n">stop</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can add as many routes as you&rsquo;d like to the <code>routes</code> parameter in the <code>webhook::listener</code> define. It&rsquo;s great for quickly building and codifying your API infrastructure. For now, it only works with very simple things like &lsquo;I need to run this arbitrary command on a box on POST or GET&rsquo;, but I&rsquo;m going to build it out with more complex routes as defautls such as:</p>

<ul>
<li>Accept a POST from jenkins with the <code>environmnent</code>, <code>role</code> and <code>version</code> of a given build. Based on that post, update the hiera data as needed and re-run puppet on the box that is assigned the <code>role</code> in the given <code>environmnent</code>.</li>
</ul>


<p>With a route like that you can setup a CI hook from your build environment in Jenkins (using any of the HTTP plugins for Jenkins) with Puppet very easily.</p>

<h3>&hellip;back to the point &hellip;</h3>

<p>So now we have this webhook running on our Puppet Master. The webhook accepts a route at <code>http://mymaster.com:6969/kick_haproxy_app_internal</code> and upon receiving a GET request it will execute an mCollective command to <code>puppet runonce</code> on the node whose <code>$::role</code> fact matches <code>haproxy_app_internal</code>. If you guessed that <code>haproxy_app_internal</code> is the role for our internal loadbalancer then congrats, you&rsquo;ve won nothing but please come back and play again.</p>

<p>At the end of our role manifest for the node which will be a <code>balancermember</code> behind this loadbalancer we have set up a run stage that excutes last, which leverages the <code>http</code> resource, ensured to GET at the specified route to the webhook running on our master. Now, when nodes assined that role <code>haproxy_member_backend_service</code> come up, they kick our webhook on the master which generates an asynchronous call on mCollective to hick the loadbalancer which pulls down the exported <code>balancermember</code> resources.</p>

<p>THIS IS AMAZING IF YOU&rsquo;RE RUNNING AWS AUTOSCALING GROUPS</p>

<p>I&rsquo;m not sure why that needed to be in all caps. Maybe you&rsquo;ll understand if you have haproxy running in front of an autoscaling group, you&rsquo;ll realize why I&rsquo;M SO EXCITED.</p>

<h3>Where I&rsquo;m going to take this&hellip;</h3>

<p>I&rsquo;m going to add the above mentioned route for Jenkins as an optional default. That route is the glue that ties in how we execute puppet runs via MCO when new builds are pushed down the pipeline. The flow would look something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">On</span> <span class="n">my</span><span class="o">.</span><span class="n">jenkins</span><span class="o">.</span><span class="n">com</span><span class="p">,</span> <span class="n">final</span> <span class="n">build</span> <span class="n">process</span> <span class="ss">is</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">POST</span> <span class="n">my</span><span class="o">.</span><span class="n">puppetmaster</span><span class="o">.</span><span class="n">com</span> <span class="p">{</span>
</span><span class='line'>        <span class="s1">&#39;environment&#39;</span>   <span class="o">=</span> <span class="s1">&#39;production&#39;</span><span class="p">,</span>
</span><span class='line'>        <span class="s1">&#39;role           = &#39;</span><span class="n">some_micro_service_backend</span><span class="s1">&#39;,</span>
</span><span class='line'><span class="s1">        &#39;</span><span class="n">version</span>        <span class="o">=</span> <span class="s1">&#39;2.1.4&#39;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="no">On</span> <span class="n">my</span><span class="o">.</span><span class="n">puppetmaster</span><span class="o">.</span><span class="n">com</span><span class="p">,</span> <span class="n">upon</span> <span class="n">receiving</span> <span class="no">POST</span> <span class="n">from</span> <span class="n">my</span><span class="o">.</span><span class="n">jenkins</span><span class="o">.</span><span class="n">com</span> <span class="n">with</span> <span class="n">the</span> <span class="n">above</span> <span class="ss">JSON</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'>    <span class="mi">1</span><span class="o">.</span> <span class="no">Update</span> <span class="n">hieradata</span> <span class="n">at</span> <span class="sr">/etc/</span><span class="n">puppetlabs</span><span class="o">/</span><span class="n">puppet</span><span class="o">/</span><span class="n">environments</span><span class="o">/</span><span class="c1">#{environment}/roles/#{role}.yaml </span>
</span><span class='line'>    <span class="n">with</span> <span class="n">the</span> <span class="n">correct</span> <span class="c1">#{version} from jenkins.</span>
</span><span class='line'>    <span class="mi">2</span><span class="o">.</span> <span class="no">Commit</span> <span class="n">the</span> <span class="kp">new</span> <span class="n">version</span> <span class="ow">and</span> <span class="n">push</span> <span class="n">back</span> <span class="n">up</span> <span class="n">to</span> <span class="n">our</span> <span class="n">control</span> <span class="n">repo</span> <span class="n">where</span> <span class="n">hieradata</span> <span class="n">dir</span> <span class="n">actually</span> <span class="n">resides</span><span class="o">.</span>
</span><span class='line'>    <span class="mi">3</span><span class="o">.</span> <span class="ss">Execute</span><span class="p">:</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">mco</span> <span class="n">puppet</span> <span class="n">runonce</span> <span class="o">-</span><span class="n">F</span> <span class="s1">&#39;role=#{role}&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Boom, we just implemented and end-to-end CI chain from our Jenkins build process, which updated our Puppet Master with the new version of the micro service, which pushed the version to git, and ran puppet on the node whose role matches the micro service being updated.</p>

<p>In our infrastructure the profile for the micro service executes a <code>s3file</code> resource to pull down the build which matches:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">s3file</span> <span class="p">{</span> <span class="s1">&#39;micro_service_${version}:</span>
</span><span class='line'><span class="s1">    path    =&gt; &#39;</span><span class="o">/</span><span class="n">some</span><span class="o">/</span><span class="n">bucket</span><span class="o">/</span><span class="err">&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="k">ensure</span>  <span class="o">=&gt;</span> <span class="n">latest</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>When the node consuming the <code>mco puppet runonce</code> publication runs puppet, that profile ensures we get the latest revision of our code. d</p>

<p>&#8220;`puppet-webhook&#8220;&#8220; is available at:</p>

<p>github.com/malnick/puppet-webhook.git</p>

<p>^^ your milage may vary.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2015-02-06T06:52:36-08:00" pubdate data-updated="true">Feb 6<span>th</span>, 2015</time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/12/23/using-dns-for-applying-roles-to-nodes-in-puppet/">
		
			DNS-based Role Classification</a>
	</h2>
	<div class="entry-content">
		<p>The first place you&rsquo;d probably look for developing a role-based hiera layer is probably a fact-based role. Facts are great, they allow you to execute code on a node and generate dynamic information about your infrastructure. You could go ahead and do this very easily if you have solid domain naming mechanisms.</p>

<p>For example, your load balancer might always start with <code>lb-p-dc.domain.prd.int</code> and your app nodes might always start with <code>app-p-dc.domain.prd.int</code> or something like that.</p>

<p>But in reality, domain names are never really this elegant. So the reality is you need to have a better, more resolute way to figure out what role each node has.</p>

<p>You could, at this point, go the route of external facts. External facts are cool because they can be provisioned via a pxe-boot script as a simple txt file with key value pairs. However, now you have to manage and ensure this <strong>very important</strong> piece of infrastructure code is in place properly on each node. If someone deletes this fact, you have to have some configuration management magic to ensure it gets put back in place since external facts don&rsquo;t pluginsync.</p>

<h3>DNS-based role classification</h3>

<p>You can however implement some DNS magic. DNS has specific resources that include more than just a mapping of IP addresses to domains. Domains can have TXT resources associated with them. So let&rsquo;s assume your load balancer, <code>lb-p-dc.domain.prd.int</code>, has a TXT resource associated with it in DNS. Now we can write a fact that looks up that TXT resource.</p>

<p>That fact might look something like:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;resolv&#39;</span>
</span><span class='line'><span class="no">Facter</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="s1">&#39;role&#39;</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">setcode</span> <span class="k">do</span>
</span><span class='line'>      <span class="c1"># Get hostname based on fqdn fact</span>
</span><span class='line'>      <span class="n">hostname</span> <span class="o">=</span> <span class="no">Facter</span><span class="o">.</span><span class="n">value</span><span class="p">(</span><span class="ss">:fqdn</span><span class="p">)</span>
</span><span class='line'>      <span class="c1"># Get a new DNS resolver object pointed at our nameserver i</span>
</span><span class='line'>      <span class="n">stupid</span> <span class="o">=</span> <span class="ss">Resolv</span><span class="p">:</span><span class="ss">:DNS</span><span class="o">.</span><span class="n">new</span> <span class="c1"># Defaults to /etc/resolv.conf on linux envs</span>
</span><span class='line'>      <span class="c1"># Get a TXT DNS resource for the host</span>
</span><span class='line'>      <span class="n">this</span> <span class="o">=</span> <span class="n">stupid</span><span class="o">.</span><span class="n">getresource</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="ss">Resolv</span><span class="p">:</span><span class="ss">:DNS</span><span class="o">::</span><span class="ss">Resource</span><span class="p">:</span><span class="ss">:IN</span><span class="o">::</span><span class="no">TXT</span><span class="p">)</span>
</span><span class='line'>      <span class="c1"># .strings is the value of the txt resource and it&#39;s an array since you can have many txt resources</span>
</span><span class='line'>      <span class="n">this</span><span class="o">.</span><span class="n">strings</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span>
</span><span class='line'>          <span class="c1"># Get the role txt resource</span>
</span><span class='line'>          <span class="k">if</span> <span class="n">r</span> <span class="o">=~</span> <span class="sr">/^role/</span>
</span><span class='line'>              <span class="c1"># Split it on = for the last part which is the value of the role</span>
</span><span class='line'>              <span class="n">role</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="c1"># If role never got set it&#39;s because /^role never matched, so let&#39;s set this to unknown</span>
</span><span class='line'>      <span class="k">unless</span> <span class="n">role</span>
</span><span class='line'>          <span class="n">role</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="c1"># Return the role</span>
</span><span class='line'>      <span class="n">role</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Hey, that&rsquo;s pretty neat. So this little fact executes on the node on agent runs. Does a lookup in DNS for the TXT resource. Finds that TXT resource and returns the role type. If no TXT resource that matches /^role/ is found, it returns an &lsquo;unknown&rsquo; role.</p>

<p>Now you can implement that <code>role/%{::role}</code> layer in hiera like you always wanted! Yay!</p>

<h3>Why this isn&rsquo;t secure</h3>

<p>Buzz kill ahead!</p>

<p>This fact is only somewhat secure. Since this isn&rsquo;t a secure fact, like clientcert, it can be overridden on the command line like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">FACTER_role</span><span class="o">=</span><span class="n">application</span> <span class="n">puppet</span> <span class="n">agent</span> <span class="o">-</span><span class="n">t</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, whoever got on your subnet with your puppet master can easily pull down your application node&rsquo;s configuration. SSH keys, private keys, whatever other private information you might have as part of the configuration for this node.</p>

<p>(Ok, maybe not quite as simple as that if you don&rsquo;t auto-authenticate your nodes. However, if one node in the infrastructure that is authenticated to the Puppet Master CA get&rsquo;s taken over a smart attacker could do a puppet run with the role type for every other node in the infrastructure and get a lot of data out of it.)</p>

<h3>The fix</h3>

<p>The best way to fix this issue is to get the DNS TXT resource using a secure fact like $::clientcert. Then pass this fact into a function that will execute on the master to do the DNS lookup for you.</p>

<p>For example, your function instanciation migth look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MyClass</span> <span class="p">(</span>
</span><span class='line'>  <span class="vg">$role</span> <span class="o">=</span> <span class="n">role_resolver</span><span class="p">(</span><span class="vg">$:</span><span class="ss">:clientcert</span><span class="p">),</span>
</span><span class='line'><span class="p">){</span>
</span><span class='line'><span class="o">.</span><span class="n">.</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then your function <code>role_resolver()</code> might look like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;resolv&#39;</span>
</span><span class='line'><span class="k">module</span> <span class="nn">Puppet::Parser::Functions</span>
</span><span class='line'>  <span class="n">newfunction</span><span class="p">(</span><span class="ss">:role_resolver</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="ss">:rvalue</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">args</span><span class="o">|</span>
</span><span class='line'>      <span class="n">hostname</span> <span class="o">=</span> <span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
</span><span class='line'>      <span class="n">stupid</span> <span class="o">=</span> <span class="ss">Resolv</span><span class="p">:</span><span class="ss">:DNS</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>      <span class="n">this</span> <span class="o">=</span> <span class="n">stupid</span><span class="o">.</span><span class="n">getresource</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="ss">Resolv</span><span class="p">:</span><span class="ss">:DNS</span><span class="o">::</span><span class="ss">Resource</span><span class="p">:</span><span class="ss">:IN</span><span class="o">::</span><span class="no">TXT</span><span class="p">)</span>
</span><span class='line'>      <span class="n">this</span><span class="o">.</span><span class="n">strings</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span>
</span><span class='line'>          <span class="k">if</span> <span class="n">r</span> <span class="o">=~</span> <span class="sr">/^role/</span>
</span><span class='line'>              <span class="n">role</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;=&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="k">unless</span> <span class="n">role</span>
</span><span class='line'>          <span class="n">role</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="n">role</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, since you&rsquo;re using a trusted, secure fact $::clientcert you are most certain that your lookup in DNS will be for the node that is checking in and nothing else. This is both secure as well as a fast, trusted way to get role classification from your current DNS system.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-12-23T16:49:37-08:00" pubdate data-updated="true">Dec 23<span>rd</span>, 2014</time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/11/03/hiera-template/">
		
			Hiera-template</a>
	</h2>
	<div class="entry-content">
		<p>Every time we create a new profile, or update a profile, we have to update our hiera data. This process is error prone and time consuming. Hiera leverages almost any data interchange format (in fact I&rsquo;d bet if you can write the backend for it, it&rsquo;ll support it). The writing of that data can easily be automated, so a tool to write the data files for us was an obvious decision.</p>

<p><a href="https://github.com/malnick/hiera-template">hiera-template</a> is still in its infancy, and will eventually become a much larger part of our workflow. The main goal of this tool, however, remains the same: automate the generation of our hiera data files from our profile classes.</p>

<p>hiera-template is up in Rubygems, but be forewarned, it is VERY much still in BETA. Your mileage will vary and your bug reporting is appreciated.</p>

<h3>Install</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>gem install hiera-template</span></code></pre></td></tr></table></div></figure>


<h3>Usage</h3>

<p>hiera-template accepts a single path to a profile as an argument. It can be a local or fully qualified path.</p>

<p>By default, hiera-template will store all processed yaml&rsquo;s in <code>~/.hiera-template/templates/${profile_name}-${hierarchy_level}-template.yaml</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span> <span class="nv">$confdir</span>/modules/profiles/manifests
</span><span class='line'>hiera-template company_frontend.pp
</span></code></pre></td></tr></table></div></figure>


<p>The above will create a baseline hiera data file from all the explicit hiera() lookups in the profile. Yes, you read that right, it will not work on non-explicit hiera() lookups. That will be a feature down the road. For now, the following like-lines will be parsed:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vg">$myvar</span> <span class="o">=</span> <span class="n">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::company_frontend::myvar&#39;</span><span class="p">),</span>
</span></code></pre></td></tr></table></div></figure>


<p>That line will be written to a yaml file as:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">profiles::company_frontend::myvar</span><span class="p-Indicator">:</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Hierarchy Keys</h3>

<p>hiera-template uses <code>#[keys]</code> in the profile to determine what part of the hierarchy the data resides.</p>

<p>Given the following:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="ss">profiles</span><span class="p">:</span><span class="ss">:csx_frontend_base</span><span class="p">(</span>
</span><span class='line'>  <span class="c1">#[node]</span>
</span><span class='line'>  <span class="vg">$csx_db_name</span>                          <span class="o">=</span> <span class="n">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::csx_frontend_base::csx_db_name&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="vg">$csx_db_user</span>                          <span class="o">=</span> <span class="n">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::csx_frontend_base::csx_db_user&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="vg">$csx_db_password_hash</span>                 <span class="o">=</span> <span class="n">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::csx_frontend_base::csx_db_password_hash&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="c1">#[datacenter]</span>
</span><span class='line'>  <span class="vg">$csx_db_host</span>                          <span class="o">=</span> <span class="n">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::csx_frontend_base::csx_db_host&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="vg">$csx_db_driverclassname</span>               <span class="o">=</span> <span class="n">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::csx_frontend_base::csx_db_driverclassname&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="vg">$csx_db_url</span>                           <span class="o">=</span> <span class="n">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::csx_frontend_base::csx_db_url&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="vg">$csx_db_password</span>                      <span class="o">=</span> <span class="n">hiera</span><span class="p">(</span><span class="s1">&#39;profiles::csx_frontend_base::csx_db_password&#39;</span><span class="p">),</span>
</span></code></pre></td></tr></table></div></figure>


<p>hiera-template will create two yaml files in <code>~/.hiera-template/templates</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">csx_frontend_base</span><span class="o">-</span><span class="n">node</span><span class="o">-</span><span class="n">template</span><span class="o">.</span><span class="n">yaml</span>
</span><span class='line'><span class="n">csx_frontend_base</span><span class="o">-</span><span class="n">datacenter</span><span class="o">-</span><span class="n">template</span><span class="o">.</span><span class="n">yaml</span>
</span></code></pre></td></tr></table></div></figure>


<p>Those templates contain all the keys for the given profile. You can <code>cat *-node-template.yaml &gt; my.new.node.yaml</code> or <code>cat *-datacenter-template.yaml &gt;&gt; out_dc.yaml</code> to create or append the keys to data files. Then, all you need to do is fill in your values.</p>

<h3>Upcoming</h3>

<p>Since writing in data can be so error prone, and hiera is by it&rsquo;s nature hard to debug, a tool ensures your data written to your data files is the same as what is declared in your profiles &ndash; on the flip side, it&rsquo;ll propogate your errors from the profile data declarations to the data file. Either way, you&rsquo;re automating it!</p>

<p>To help write the values to the data files I&rsquo;ll up adding a feature to populate, so you don&rsquo;t have to worry about all that new-fangled white space that YAML loves to hate you for. Populate will prompt your for each value and write it in automatically, so you don&rsquo;t have to open vim: you&rsquo;re prompted with the key, and you type in the value. Done deal.</p>

<h3>Debugging</h3>

<p>Currently, this tool is not hardened by any means. And like everyone else, I can&rsquo;t stay on top of everything. So if you&rsquo;re using it, hit me up with bug reports. There is a <code>-D</code> option to run at debugger level, and I tried to make it obvious what is going on. That&rsquo;s no substitution for reading <code>/lib/template.rb</code> if you get a stack trace though. It&rsquo;s a very simple tool, and right now everything lives in <code>template.rb</code> so it should be easy to figure out.</p>

<h3>Known issues:</h3>

<ol>
<li>It will break if you have other comments in the hiera look up declarations other than keys</li>
<li>It will not work on implicit lookups, you need hiera()</li>
<li>It&rsquo;ll probably be buggy, but have fun and support it if you find it useful</li>
</ol>


		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-11-03T05:02:03-08:00" pubdate data-updated="true">Nov 3<span>rd</span>, 2014</time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/10/31/the-benefits-of-being-sheep/">
		
			The Benefits of Being Sheep</a>
	</h2>
	<div class="entry-content">
		<p>Sometimes we have to check our ego&rsquo;s. This post is a completely opinionated piece on why following community practice is a best practice. Sometimes people refer to this as being &ldquo;sheep&rdquo;.</p>

<p>Communities exist to support people. In our community, we support each other on IRC, by commenting on tickets we have interest in, and by BBC&rsquo;s and email lists. We also have friends who call on us to help them in their daily work, answer questions about why this error or that warning are flashing across their screens, or the best way to get around a known bug. We help each other becuase we&rsquo;re all on a mission to build and leverage technology to do the shit work for us. However, when that technology breaks, it&rsquo;s the community that we commonly go back to, asking questions, seeking answers.</p>

<p>The other day a colleague asked me why I use explicit hiera() lookups in my code. He made a lot of very sound points: it&rsquo;s messy, automatic data bindings already do this for us, it&rsquo;s clearer if you just assume the data is coming from hiera&hellip; I agreed with all of them, yet I still use the explicit lookup in my profiles. Why?</p>

<p>I do this because everyone else does this, it&rsquo;s a community best practice. His response was, well sure, we can all be sheep. Ah yes, sheep. Let&rsquo;s side track on that topic for a second. Why do sheep travel in packs and follow each other? They do it because when a preditor shows up, they can work as a group to confuse it, and possibly save each other. They work together for the common good.</p>

<p>In our line of work we need the community. Why use a tool like Puppet or Chef, an open source, community supported framework, if you&rsquo;re just going to tuck the best practices away in your pocket becuase you feel like it doesn&rsquo;t suit you? If that was your intent all along, you might as well roll your own CM tool. Oh wait, rolling your own tool sounds really hard? Ok then use the open source tool chain. And when you get that error about hiera not finding data in one of your 50 profiles, but you know the data is in hiera and you can&rsquo;t figure out what&rsquo;s going on, where do you turn? IRC, BBC, email lists, jira, etc&hellip; and when you put your code down in those forums and everyone see&rsquo;s you&rsquo;re not explicitly looking up the values, it&rsquo;s then someone asks &ldquo;Is this a fresh node?&rdquo; &ldquo;sure is!&rdquo; you say &ldquo;Maybe the operations person who provisioned puppet turned off automatic data bindings&hellip;&rdquo; &ndash; that turns out to be the case&hellip; or any number of other possible scenarios that might prevent hiera from getting a value.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-10-31T06:44:08-07:00" pubdate data-updated="true">Oct 31<span>st</span>, 2014</time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/10/29/the-proxy-module/">
		
			The Proxy Module</a>
	</h2>
	<div class="entry-content">
		<p>In puppet land there are a lot of different phrases and keywords that float around: &ldquo;atomic modules&rdquo;, &ldquo;Roles and Profiles&rdquo;, &ldquo;wrapper modules&rdquo;.</p>

<p>This post disects these terms and others, and proposes a new type of site-specific, not-quite-a-wrapper module and not-quite-an-atomic module called the &ldquo;Proxy Module&rdquo;.</p>

<h2>It&rsquo;s about solutions</h2>

<p>We have a number of custom apt stores in our infrastrcture. In order to provision both our apt repos and our apt clients to our custom PPA&rsquo;s and Sources, we wrote a profile called apt_client_config and apt_repo.pp. These profiles lived in the profiles module, naturally. However, since they were called from profiles, we had several instances where another module being called from that profile also depended on apt. In which case, we would run into duplicate dependencies, looped graphs, and all the other expected outcomes of using a module whose bits and pieces are needed by many other modules, at such a high level of abstraction.</p>

<p>The solution was to create a proxy module. This module would wrap up just the pieces of apt that needed to be instanciated at the profile level. So, instead of running apt-based profiles in run stages at the profile level, we would run our proxy module to apt that ran just the defines we needed. These defines would be fed data from hiera via create_resources(). In this way, the proxy module differs from an atommic one &ndash; it&rsquo;s still wrapping up another module, but since it&rsquo;s so site-specific, we omit the params.pp. We don&rsquo;t want this module to &ldquo;work out of the box&rdquo;, we want it to fail if it doesn&rsquo;t get our site-specific from hiera.</p>

<h2>The implementation</h2>

<p>The init.pp for our apt proxy module, named cs_apt (since we&rsquo;re Connect Solutions):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Class: cs_apt</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># Parameters:</span>
</span><span class='line'><span class="c1"># [*always_update*]</span>
</span><span class='line'><span class="c1"># boolean value to determine if apt-get update should be run every time the</span>
</span><span class='line'><span class="c1"># class is instantiated</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># [*ppas*]</span>
</span><span class='line'><span class="c1"># Hash of type apt::ppa to add to host</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># [*purge_sources_list*]</span>
</span><span class='line'><span class="c1"># Boolean value to determine if sources should be purged from host. True for</span>
</span><span class='line'><span class="c1"># FedRAMP</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># [*purge_sources_list_d*]</span>
</span><span class='line'><span class="c1"># Boolean value to determin if source.d/* should be purged from host.</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># [*sources*]</span>
</span><span class='line'><span class="c1"># Hash of type apt::source to add new ppa sources to host</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># Requires:</span>
</span><span class='line'><span class="c1"># n/a</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># Sample Usage:</span>
</span><span class='line'><span class="c1"># See README.md</span>
</span><span class='line'><span class="k">class</span> <span class="n">cs_apt</span> <span class="p">(</span>
</span><span class='line'>  <span class="vg">$always_update</span>      <span class="o">=</span> <span class="n">hiera</span><span class="p">(</span><span class="s1">&#39;cs_apt::always_update&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="vg">$ppas</span>           <span class="o">=</span> <span class="n">hiera</span><span class="p">(</span><span class="s1">&#39;cs_apt::ppas&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="vg">$purge_sources_list</span>     <span class="o">=</span> <span class="n">hiera</span><span class="p">(</span><span class="s1">&#39;cs_apt::purge_sources_list&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="vg">$purge_sources_list_d</span>   <span class="o">=</span> <span class="n">hiera</span><span class="p">(</span><span class="s1">&#39;cs_apt::purge_sources_list_d&#39;</span><span class="p">),</span>
</span><span class='line'>  <span class="vg">$sources</span>        <span class="o">=</span> <span class="n">hiera</span><span class="p">(</span><span class="s1">&#39;cs_apt::sources&#39;</span><span class="p">),</span>
</span><span class='line'><span class="p">)</span> <span class="p">{</span>
</span><span class='line'><span class="k">case</span> <span class="vg">$:</span><span class="ss">:osfamily</span> <span class="p">{</span>
</span><span class='line'><span class="s1">&#39;debian&#39;</span> <span class="p">:</span> <span class="p">{}</span>
</span><span class='line'><span class="ss">default</span><span class="p">:</span> <span class="p">{</span> <span class="nb">fail</span><span class="p">(</span><span class="s2">&quot;${::osfamily} is not supported with module&quot;</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="n">validate_bool</span><span class="p">(</span><span class="vg">$always_update</span><span class="p">)</span>
</span><span class='line'><span class="n">validate_bool</span><span class="p">(</span><span class="vg">$purge_sources_list</span><span class="p">)</span>
</span><span class='line'><span class="n">validate_bool</span><span class="p">(</span><span class="vg">$purge_sources_list_d</span><span class="p">)</span>
</span><span class='line'><span class="k">if</span> <span class="vg">$ppas</span> <span class="p">{</span>
</span><span class='line'><span class="n">validate_hash</span><span class="p">(</span><span class="vg">$ppas</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">if</span> <span class="vg">$sources</span> <span class="p">{</span>
</span><span class='line'><span class="n">validate_hash</span><span class="p">(</span><span class="vg">$sources</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1"># Update repo cache and purge sources is necessary</span>
</span><span class='line'><span class="k">class</span> <span class="p">{</span> <span class="s1">&#39;::apt&#39;</span><span class="p">:</span>
</span><span class='line'><span class="n">always_apt_update</span> <span class="o">=&gt;</span> <span class="vg">$always_update</span><span class="p">,</span>
</span><span class='line'><span class="n">purge_sources_list</span> <span class="o">=&gt;</span> <span class="vg">$purge_sources_list</span><span class="p">,</span>
</span><span class='line'><span class="n">purge_sources_list_d</span> <span class="o">=&gt;</span> <span class="vg">$purge_sources_list_d</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">if</span> <span class="vg">$ppas</span> <span class="p">{</span>
</span><span class='line'><span class="n">create_resources</span><span class="p">(</span><span class="s1">&#39;::apt::ppa&#39;</span><span class="p">,</span> <span class="vg">$ppas</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="k">if</span> <span class="vg">$sources</span> <span class="p">{</span>
</span><span class='line'><span class="n">create_resources</span><span class="p">(</span><span class="s1">&#39;::cs_apt::source&#39;</span><span class="p">,</span> <span class="vg">$sources</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1"># vim: ts=2 sw=2</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then in our profiles, to configure an apt source, we simply</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-10-29T20:50:15-07:00" pubdate data-updated="true">Oct 29<span>th</span>, 2014</time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/10/07/streamlining-puppet-dev-part-duce-branch-the-enviro/">
		
			Streamlining Puppet Dev Part Duce: Branch the Enviro</a>
	</h2>
	<div class="entry-content">
		<p>Most companies don&rsquo;t have a single monolithic application, today most applications evolve out of lots of atomic services: thus, service oriented architecture.</p>

<p>What this means for your development environment is that you end up having many different applications, which is many cases are atomic services and in other cases are a conglomeration of services. Either way, you end up with a need for many dev environments.</p>

<p>At Connect Solutions we have several environments that require infrastructure development. The main ones are our custom load balancer (we call it MTLB), our Connect Cluster, CQ, and our Connect Experience applications.</p>

<p>In order to streamline our dev process with Puppet we created a repo called &lsquo;puppet-dev-enviro&rsquo; that deploys VM&rsquo;s with Vagrant and manages what modules you want to test via Rake &amp; r10k.</p>

<p>For any given envio we like to mirror what it looks like in prod as best we can. Therefore, any enviro always uses the version of puppet we run in prod on a separate Puppet Master, then the nodes that make of the rest of the enviro.</p>

<p>A simple example, theMTLB enviro deploys a Puppet Master and an MTLB load balancer node.</p>

<h2>Enviro Management</h2>

<p>Since we have so many enviros we branch the &lsquo;puppet-dev-enviro&rsquo; repo for each one. So if you&rsquo;re testing MTLB code the workflow looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">cd</span> <span class="n">puppet</span><span class="o">-</span><span class="n">dev</span><span class="o">-</span><span class="n">enviro</span>
</span><span class='line'><span class="n">git</span> <span class="n">checkout</span> <span class="n">mtlb</span>
</span><span class='line'><span class="no">MONO</span><span class="o">=</span><span class="kp">true</span> <span class="n">rake</span> <span class="n">deploy</span>
</span></code></pre></td></tr></table></div></figure>


<p>Those first two commands are pretty straight forward. However, the deploy command probably needs some explanation. I wrote this task to streamline our development pipeline. It&rsquo;s main functionality is to read from a subdirectory called puppet and a file called the Puppetfile.</p>

<p>You might be familiar with the Puppetfile concept if you&rsquo;ve used Puppet Librarian or r10k. In this task, I actually invoke r10k locally on the Puppetfile to pull down all the modules listed in it to puppet/modules. In the case of Connect Solutions, we&rsquo;re currently in the process of moving our legacy puppet module structure from a monolithic one to their own atomic repos. This isn&rsquo;t complete yet, so the MONO=true env variable envokes a subcommand in deploy to rip out all the sub-modules of this monolithic repo and place them in puppet/modules.</p>

<p>&lsquo;Deploy&rsquo; also supports hiera data management by checking for our <code>puppet-configuration</code> repo in the puppet/modules directory. If it&rsquo;s listed in the Puppetfile this repo will be present here. If so, it moves all the data from puppet-configuration into puppet/data.</p>

<p>Both <code>puppet/modueles</code> and <code>puppet/data</code> are shared with the puppet master VM deploed with Vagrant. As a Vagrant post-provisioning step I blow away the <code>/etc/puppetlabs/puppet/modules</code>, <code>/etc/puppetlabs/puppet/data</code> directories and sym link the shared modules and data directories out of <code>/tmp</code>.</p>

<h4>The Deploy Task</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">desc</span> <span class="s1">&#39;Deploying modules form Puppetfile and booting master and agent VMs&#39;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:deploy</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Building out Puppet module directory...&quot;</span>
</span><span class='line'>  <span class="n">confdir</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span>
</span><span class='line'>  <span class="c1"># Check directory structure:</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Checking for puppet/modules...&quot;</span>
</span><span class='line'>  <span class="k">unless</span> <span class="no">Dir</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/modules&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;puppet/modules not found, creating.&quot;</span>
</span><span class='line'>    <span class="no">Dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/modules&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Checking for puppet/data...&quot;</span>
</span><span class='line'>  <span class="k">unless</span> <span class="no">Dir</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/data&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;puppet/data not found, creating.&quot;</span>
</span><span class='line'>    <span class="no">Dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/data&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">moduledir</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/modules&quot;</span>
</span><span class='line'>  <span class="n">puppetfile</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/Puppetfile&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Placing modules in </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Using Puppetfile at </span><span class="si">#{</span><span class="n">puppetfile</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;PUPPETFILE=</span><span class="si">#{</span><span class="n">puppetfile</span><span class="si">}</span><span class="s2"> PUPPETFILE_DIR=</span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2"> /usr/bin/r10k puppetfile install&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">abort</span> <span class="s1">&#39;Failed to build out Puppet module directory. Exiting...&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">if</span> <span class="no">Dir</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">/puppet-configuration/&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Detected puppet data repo, copying contents to </span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/data&quot;</span>
</span><span class='line'>      <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;cp -Rv </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">/puppet-configuration/* </span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/data/&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s2">&quot;Failed to move puppet-configuration&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">mono</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Moving modules out of monolithic dir </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">/puppet-modules to </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;mv </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">/puppet-modules/* </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s2">&quot;Failed to move modules from monolithic repo to </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Bringing up vagrant machines&quot;</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vagrant up --provider virtualbox&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">abort</span> <span class="s1">&#39;Vagrant up failed. Exiting...&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Vagrant Machines Up Successfully</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This structure allows us to play around with the module code on the fly from the host VM, with our own dotfiles and local editing or preferred pipelines. For example, I am a heavy Vim user, however, a lot of my colleagues are Sublime text users. You can choose what method best suites you and not be beholden to who provisioned the VM .box file beforehand.</p>

<p>For large code-base changes, i.e., developing an entireley new topic branch, this pipeline allows seamless integration with git and enables better version control management. An example workflow would be:</p>

<ol>
<li>Open two screen or tmux sessions</li>
<li>In one session cd into <code>/path/to/monolithic/puppet-modules/test-mod/manifests</code></li>
<li>In the other session cd into <code>/path/to/puppet-dev-enviro</code></li>
<li>In <code>puppet-dev-enviro</code>:

<ol>
<li>git checkout my-enviro</li>
<li>update <code>puppet/Puppetfile</code> and <code>`puppet/manifests/site.pp</code></li>
</ol>
</li>
</ol>


<p>puppet/Puppetfile:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="s1">&#39;puppet-modules&#39;</span><span class="p">,</span> <span class="ss">:git</span> <span class="o">=&gt;</span> <span class="n">git</span><span class="vi">@github</span><span class="o">.</span><span class="n">com</span><span class="ss">:connectsolutions</span><span class="o">/</span><span class="n">puppet</span><span class="o">-</span><span class="n">modules</span><span class="s1">&#39;, :ref =&gt; &#39;</span><span class="n">my</span><span class="o">-</span><span class="n">topic</span><span class="o">-</span><span class="n">branch</span><span class="s1">&#39;</span>
</span><span class='line'><span class="s1">&#39;</span><span class="n">puppet</span><span class="o">-</span><span class="n">configuration</span><span class="s1">&#39;, :git =&gt; git@github.com:connectsolutions/puppet-configuration&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>puppet/manifests/site.pp:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">node</span> <span class="err">&#39;</span><span class="n">my</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">dev</span><span class="sb">` {</span>
</span><span class='line'><span class="sb"> include my::class</span>
</span><span class='line'><span class="sb">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>DEPLOY: In <code>puppet-dev-enviro</code> run <code>MONO=true rake deploy</code></p>

<p>This will now pull down and configure the environment for the VM&rsquo;s. When finished, all the puppet data and modules will be live on the master VM.</p>

<h3>Enviro-Specific Vagrantfile</h3>

<p>One step I&rsquo;ve skipped here however is making a git-branch for my-enviro. That&rsquo;s a completely different step but mainly involves updateing the Vagrantfile with the neccessary VM information. I won&rsquo;t cover that here since that is specific to every enviro the same way Puppet code is speciic to each module. I will however share what stays the same between most Vagrantfiles in each enviro and that is the Master VM configuration block:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="no">VAGRANTFILE_API_VERSION</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;ubuntuamd64&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box_url</span> <span class="o">=</span> <span class="s2">&quot;https://cloud-images.ubuntu.com/vagrant/precise/current/precise-server-cloudimg-amd64-vagrant-disk1.box&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">pe_build</span><span class="o">.</span><span class="n">download_root</span> <span class="o">=</span> <span class="s1">&#39;https://s3.amazonaws.com/pe-builds/released/:version&#39;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">pe_build</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;3.3.0&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">forward_agent</span>  <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="ss">:master</span> <span class="k">do</span> <span class="o">|</span><span class="n">master</span><span class="o">|</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="ss">:virtualbox</span> <span class="k">do</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span>
</span><span class='line'>      <span class="n">v</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="mi">2048</span>
</span><span class='line'>  <span class="n">v</span><span class="o">.</span><span class="n">cpus</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;10.28.126.141&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;master.dev&#39;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:hosts</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:pe_bootstrap</span> <span class="k">do</span> <span class="o">|</span><span class="n">pe</span><span class="o">|</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">role</span> <span class="o">=</span> <span class="ss">:master</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;puppet/modules&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/modules&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;puppet/manifests&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/manifests&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;puppet/data&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/data&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;puppet/filestore&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/filestore&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;puppet/&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/puppet&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;rm -rf /etc/puppetlabs/puppet/modules/ &amp;&amp; ln -s /tmp/modules/ /etc/puppetlabs/puppet/&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;rm -rf /etc/puppetlabs/puppet/manifests/ &amp;&amp; ln -s /tmp/manifests/ /etc/puppetlabs/puppet/&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;rm -rf /etc/puppetlabs/puppet/data &amp;&amp; ln -s /tmp/data/ /etc/puppetlabs/puppet/&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;ln -s /tmp/filestore/ /etc/puppetlabs/puppet/&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;rm /etc/puppetlabs/puppet/hiera.yaml &amp;&amp; ln -s /tmp/puppet/hiera.yaml /etc/puppetlabs/puppet/hiera.yaml&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;ln -s /tmp/puppet/fileserver.conf /etc/puppetlabs/puppet/fileserver.conf&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Code Test &ndash;> Develop Pipeline</h3>

<p>Once the VM&rsquo;s are up and running you can ssh into the VM under test and run <code>puppet agent -t</code>. If everything went as planned the agent will get a catlog from the master and start configuring itself. If you&rsquo;re like me, it didn&rsquo;t work on the first try. Now we need to update our code-base.</p>

<p>In the screen or tmux session that is CD&#8217;ed to your <code>puppet-modules</code> directory go into the manifests dir of the code in question. Edit that code or make whatever changes are needed for further testing.</p>

<p>Keep in mind we are working on our <code>my-topic-branch</code> branch of the <code>puppet-modules</code> repo. So when we&rsquo;re done making the local changes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git add my-class.pp
</span><span class='line'>git commit -m <span class="s2">&quot;I made changes&quot;</span>
</span><span class='line'>git push origin my-topic-branch
</span></code></pre></td></tr></table></div></figure>


<p>Then in the other screen window that&rsquo;s in the <code>puppet-dev-enviro</code> directory run:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nv">MONO</span><span class="o">=</span><span class="nb">true </span>rake pull
</span></code></pre></td></tr></table></div></figure>


<p>This runs only r10k and the workflow neccessary to pull down the new Puppet code. It is a heavy operation if you have a LOT of code in that Puppetfile. We haven&rsquo;t ran into an issue with that yet however for our individual test enviros. The :pull task looks like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">desc</span> <span class="s1">&#39;Pull down modules in Puppetfile&#39;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:pull</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;This will blow away everything in puppet/modules. Are you sure you want to continue? [y/n]&quot;</span>
</span><span class='line'>  <span class="n">ans</span> <span class="o">=</span> <span class="no">STDIN</span><span class="o">.</span><span class="n">gets</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">ans</span> <span class="o">=~</span> <span class="sr">/^y/</span>
</span><span class='line'>      <span class="n">confdir</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span>
</span><span class='line'>      <span class="n">moduledir</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/modules&quot;</span>
</span><span class='line'>      <span class="n">puppetfile</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/Puppetfile&quot;</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Pulling down new modules in </span><span class="si">#{</span><span class="n">puppetfile</span><span class="si">}</span><span class="s2"> to </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;PUPPETFILE=</span><span class="si">#{</span><span class="n">puppetfile</span><span class="si">}</span><span class="s2"> PUPPETFILE_DIR=</span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2"> /usr/bin/r10k puppetfile install&quot;</span><span class="p">)</span>
</span><span class='line'>          <span class="nb">abort</span> <span class="s1">&#39;Failed to build out Puppet module directory. Exiting...&#39;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;New modules successfully pulled down&quot;</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">mono</span>
</span><span class='line'>          <span class="nb">puts</span> <span class="s2">&quot;Moving modules out of monolithic dir </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">/puppet-modules to </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>          <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;mv </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">/puppet-modules/* </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="nb">abort</span> <span class="s2">&quot;Failed to move modules from monolithic repo to </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="k">if</span> <span class="no">Dir</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">/puppet-configuration/&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;cp -Rv </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">/puppet-configuration/* </span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/data/&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="nb">abort</span> <span class="s2">&quot;Failed to move puppet-configuration&quot;</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>  <span class="k">else</span> <span class="nb">puts</span> <span class="s2">&quot;Exiting...&quot;</span>
</span><span class='line'>      <span class="nb">exit</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now you have new code in your master VM, run <code>puppet agent -t</code> again on your agent.</p>

<h3>Wait a minute!</h3>

<p>Some will say, &ldquo;This is more work than before. Now I have this extra git step!&rdquo;. Yup, that&rsquo;s right, you&rsquo;re forced to commit your changes to your own topic branch before you test on your local machine. Yes, this isn&rsquo;t good for doing work on the airplane. Granted, this test enviro as it currently stands isn&rsquo;t designed for the latter, it&rsquo;s designed towards <strong><em>seamless collaboration</em></strong>.</p>

<p>What do I mean by that? I mean, I don&rsquo;t want to have the conversation with a colleage at 4PM on a Thursday night that goes like this: &ldquo;Hey, I need to collaborate on your code. Can you push it to a topic branch in git for me?&rdquo; &ldquo;Sure, I&rsquo;ll do that as soon as I get home tonight after picking up the kids and making dinner.&rdquo; &ldquo;Great!&rdquo; &hellip; The following day: &ldquo;So hey, I REALLY wanted to test out that code we need in prod by this afternoon last night, but I never saw a push for your branch.&rdquo; &ldquo;Yeah, sorry, I got caught up in stuff. You know, life!&rdquo;.</p>

<p>That &lsquo;extra&rsquo; git step ensures all the development steps are being tracked, and anyone at anytime can spin up this environmnet with the exact same Puppetfile and site.pp configuration and get similar testing results.</p>

<p>Some day, I&rsquo;ll put together a local-only development environment but for now this is not the purpose of what we&rsquo;ve created here.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-10-07T14:31:39-07:00" pubdate data-updated="true">Oct 7<span>th</span>, 2014</time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/08/31/arbitrary-commandline-functions-for-mco/">
		
			Arbitrary Commandline Functions for MCO</a>
	</h2>
	<div class="entry-content">
		<p>mCollective is a funny tool. The idea behind it is obvious and great: a message bus for node orchestration. But the API and underpinnings are often a black box for many Puppet noobs and even other automation professionals. They mostly stick to the Puppet Enterprise Live Management console to interact with the mCollective back-end, never <code>su peadmin</code> and running a few <code>mco $some_application -F $some_fact</code>.</p>

<p>The truth is, MCO is a powerful backend for orchestration. It gets a bad name because the performance isn&rsquo;t there sometimes, especially at scale. Not to dive into a rabbit hole, but that&rsquo;s often due to user error: 1 broker running over 1000&rsquo;s of nodes; the ActiveMQ JVM being improperly tuned; bad layer 1  (yup, it can be that simple).</p>

<p>One thing about MCO that is true is the API is hard to get through. It makes sense once you get under the hood, and especially after reading through other agents and DDl&rsquo;s but what if all you want is a simple way to run an arbitrary commandline argument on some remote node with MCO? If you don&rsquo;t know what you&rsquo;re doing that could take a while; if you know what you&rsquo;re doing, you still have the write the code.</p>

<p>Well, since MCO runs through an API we can actually architect templates for this exact task, for both the data description language file and the agent ruby script.</p>

<p>Let&rsquo;s start with a basic DDL that will inform an agent running this arbitary command:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">metadata</span> <span class="ss">:name</span>        <span class="o">=&gt;</span> <span class="s1">&#39;&lt;%= @action_name %&gt;&#39;</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:description</span> <span class="o">=&gt;</span> <span class="s1">&#39;&lt;%= @description %&gt;&#39;</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:author</span>      <span class="o">=&gt;</span> <span class="s1">&#39;&lt;%= (@author_name+&#39;</span> <span class="s1">&#39;+ @author_email).strip %&gt;&#39;</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:license</span>     <span class="o">=&gt;</span> <span class="s1">&#39;&lt;%= @license %&gt;&#39;</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:version</span>     <span class="o">=&gt;</span> <span class="s1">&#39;&lt;%= @version %&gt;&#39;</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:url</span>         <span class="o">=&gt;</span> <span class="s1">&#39;&lt;%= @project_url %&gt;&#39;</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:timeout</span>     <span class="o">=&gt;</span> <span class="o">&lt;</span><span class="sx">%= @timeout %&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="sx">action &quot;run&quot;, :description =</span><span class="o">&gt;</span> <span class="s1">&#39;&lt;%= @description %&gt;&#39;</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">display</span> <span class="ss">:always</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">output</span> <span class="ss">:status</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:description</span> <span class="o">=&gt;</span> <span class="s2">&quot;The exit code of the script&quot;</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:display_as</span>  <span class="o">=&gt;</span> <span class="s2">&quot;Return Value&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">output</span> <span class="ss">:out</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:description</span> <span class="o">=&gt;</span> <span class="s2">&quot;The output of the script on stdout&quot;</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:display_as</span>  <span class="o">=&gt;</span> <span class="s2">&quot;Output Channel&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">output</span> <span class="ss">:err</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:description</span> <span class="o">=&gt;</span> <span class="s2">&quot;The output of the script on stderr&quot;</span><span class="p">,</span>
</span><span class='line'>         <span class="ss">:display_as</span>  <span class="o">=&gt;</span> <span class="s2">&quot;Error Channel&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Just a quick shout out to Jeremy Adams who wrote <a href="https://forge.puppetlabs.com/jpadams/runyer">this</a> very ERB template for his Runyer module which does what this rake task does but in Puppet code.</p>

<p>So we&rsquo;ve templated out the basic DDL for the agent. We&rsquo;ve included some metadata and output &ndash; arbitary commands usually just need to be ran without input, for instance <code>df -h</code> and returns the mounted volumes and data about them. That could be handy in orchestration. If we wanted to we could add some inputs here, for example, if we wanted to pass in an arbitrary input to a command. I&rsquo;m not interested in that here, just basic output from a command.</p>

<p>Let&rsquo;s build out the ruby script to run this command:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">MCollective</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Agent</span>
</span><span class='line'>    <span class="k">class</span> <span class="o">&lt;</span><span class="sx">%= @action_name.capitalize %&gt;&lt;RPC::Agent</span>
</span><span class='line'><span class="sx">      activate_when do</span>
</span><span class='line'><span class="sx">        &lt;%=</span> <span class="vi">@activate_condition</span> <span class="sx">%&gt; </span>
</span><span class='line'><span class="sx">      end</span>
</span><span class='line'>
</span><span class='line'><span class="sx">      action &quot;run&quot; do</span>
</span><span class='line'><span class="sx">        command = &#39;&lt;%= (@cmd_prefix+&#39; &#39;+@command).strip %&gt;</span><span class="err">&#39;</span>
</span><span class='line'>        <span class="n">reply</span><span class="o">[</span><span class="ss">:status</span><span class="o">]</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">command</span><span class="p">,</span><span class="ss">:stdout</span> <span class="o">=&gt;</span> <span class="ss">:out</span><span class="p">,</span> <span class="ss">:stderr</span> <span class="o">=&gt;</span> <span class="ss">:err</span><span class="p">,</span> <span class="ss">:chomp</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Our arbitary command only has 1 action. It&rsquo;s that simple. We run the command and push our output to the ouputs in the command.</p>

<p>Now let&rsquo;s look at the Rakefile that actually runs this. For me, I store most of my Rakefiles as <code>*.task</code> in <code>~/.rake</code> so I can run them anywhere with <code>rake -g</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Rakefile to create MCO agents and associated DDL</span>
</span><span class='line'><span class="c1"># Author: Jeff Malnick</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">get_agent_template</span><span class="p">()</span>
</span><span class='line'>  <span class="n">template</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;rb.erb&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">get_ddl_template</span><span class="p">()</span>
</span><span class='line'>  <span class="n">template</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="s2">&quot;ddl.erb&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">McoAgent</span>
</span><span class='line'>  <span class="nb">require</span> <span class="s1">&#39;erb&#39;</span>
</span><span class='line'>  <span class="kp">attr_accessor</span> <span class="ss">:command</span><span class="p">,</span> <span class="ss">:template</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">template</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
</span><span class='line'>      <span class="vi">@command</span>        <span class="o">=</span> <span class="n">command</span>
</span><span class='line'>      <span class="vi">@template</span>       <span class="o">=</span> <span class="n">template</span>
</span><span class='line'>      <span class="vi">@action_name</span>        <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>      <span class="vi">@cmd_prefix</span>     <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>      <span class="vi">@activate_condition</span>     <span class="o">=</span> <span class="kp">false</span>
</span><span class='line'>      <span class="vi">@author_name</span>        <span class="o">=</span> <span class="s1">&#39;anonymous&#39;</span>
</span><span class='line'>      <span class="vi">@author_email</span>       <span class="o">=</span> <span class="s1">&#39;anonym@us&#39;</span>
</span><span class='line'>          <span class="vi">@license</span>            <span class="o">=</span> <span class="s1">&#39;Apache v2&#39;</span>
</span><span class='line'>      <span class="vi">@version</span>            <span class="o">=</span> <span class="s1">&#39;1.0&#39;</span>
</span><span class='line'>          <span class="vi">@project_url</span>        <span class="o">=</span> <span class="s1">&#39;http://www.puppetlabs.com&#39;</span>
</span><span class='line'>      <span class="vi">@timeout</span>            <span class="o">=</span> <span class="mi">15</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">render</span><span class="p">()</span>
</span><span class='line'>      <span class="no">ERB</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@template</span><span class="p">)</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="nb">binding</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
</span><span class='line'>      <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</span><span class='line'>          <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">render</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">task</span> <span class="ss">:mco_cmd</span> <span class="k">do</span>
</span><span class='line'>  
</span><span class='line'>  <span class="n">command</span> <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;command&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Creating mco agent and data description file for </span><span class="si">#{</span><span class="n">command</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Create Agent .rb File</span>
</span><span class='line'>  <span class="n">agent</span> <span class="o">=</span> <span class="no">McoAgent</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">get_agent_template</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
</span><span class='line'>  <span class="n">agent</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span><span class="p">,</span> <span class="s2">&quot;mco_agents&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">command</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="si">}</span><span class="s2">.rb&quot;</span><span class="p">))</span>
</span><span class='line'>  <span class="n">ddl</span> <span class="o">=</span> <span class="no">McoAgent</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">get_ddl_template</span><span class="p">,</span> <span class="n">command</span><span class="p">)</span>
</span><span class='line'>  <span class="n">ddl</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span><span class="p">,</span> <span class="s2">&quot;mco_agents&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">command</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="si">}</span><span class="s2">.ddl&quot;</span><span class="p">))</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Path to agent: &quot;</span><span class="p">,</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span><span class="p">,</span> <span class="s2">&quot;mco_agents&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">command</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="si">}</span><span class="s2">.rb&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Path to ddl: &quot;</span><span class="p">,</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span><span class="p">,</span> <span class="s2">&quot;mco_agents&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">command</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="si">}</span><span class="s2">.ddl&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, I wrote my Class into the Rakefile itself. It wasn&rsquo;t long and let me have some clarity, so there wasn&rsquo;t a need to break it out.</p>

<p>The McoAgent Class accepts two attributes, command and template. Pass it a command and a template, for me I have a couple of def&rsquo;s that do this for the agent and ddl respectavely, and it builds out the ERB for us. My init def just declares the variables that we want available to our templates and we&rsquo;re good to go &ndash; the rest is accomplished via the ERB library.</p>

<p>The entire project repo is available <a href="https://github.com/malnick/rake_tasks/tree/master/mco_create_agent">here</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-08-31T08:16:59-07:00" pubdate data-updated="true">Aug 31<span>st</span>, 2014</time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/08/03/deploying-box-files-from-virtualbox-for-vagrant/">
		
			Deploying .box Files From VirtualBox for Vagrant</a>
	</h2>
	<div class="entry-content">
		<p>There are several tools available that streamline the production of the .box format for Vagrant from any open virtualization format (OVF).</p>

<ol>
<li><a href="www.packer.io">Packer</a>
Enables you to boot a given image from an easy to build template. You can provision the machine using many types of configuration management tools such as Puppet and Chef, and run post-installer scritps for anything else.</li>
</ol>


<p>The Templates are easy to use and you can push out a .box file from Packer directly.</p>

<ol>
<li><a href="https://github.com/jedi4ever/veewee">Veewee</a>
Easily converts an ISO to VM formats. Kinda like Packer but not, so Packer made <a href="http://www.packer.io/docs/templates/veewee-to-packer.html">this</a> tool to solve that problem.</li>
</ol>


<h2>My own tool</h2>

<p>Jeff, why would you ever build your own tool when so many others exist? Because I hate troubleshooting other peoples tools. If you&rsquo;ve ever used Packer for anything serious, you could empathize/understand why I want to build my own tool.</p>

<p>What do I want to do?</p>

<ol>
<li>Easily turn any VirtualBox registered VM on my host machine into a .box file and add it to Vagrant.</li>
<li>Deploy it in 1 command.</li>
</ol>


<h2>Architecture</h2>

<p>A Rakefile that calls to sub .task files in a subdir to create then build out the machine.</p>

<p>The top level Rakefile will allocate class variables such as directory strucutre, arrays and hashes used by the lower .task files. It will allocate ENV variables, in particular <code>VM_USER</code> and <code>VM_PASSWORD</code> to be used by the lower .tasks. It will also ensure all environment dependencies such as gems and programs are installed properly.</p>

<h2>Rakefile</h2>

<p>We&rsquo;ll start with the top level Rakefile and work our way down:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">begin</span>
</span><span class='line'>  <span class="nb">require</span> <span class="s1">&#39;rake&#39;</span>
</span><span class='line'>  <span class="nb">require</span> <span class="s1">&#39;expect&#39;</span>
</span><span class='line'>  <span class="nb">require</span> <span class="s1">&#39;net/ssh&#39;</span>
</span><span class='line'><span class="k">rescue</span> <span class="no">LoadError</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Error during load, running bundler&quot;</span>
</span><span class='line'>  <span class="nb">system</span><span class="p">(</span><span class="s1">&#39;bundler&#39;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Load the subtasks</span>
</span><span class='line'><span class="no">Dir</span><span class="o">[</span><span class="s1">&#39;tasks/*.rake&#39;</span><span class="o">].</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span> <span class="nb">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Set top level dir for sub level rake tasks</span>
</span><span class='line'><span class="vi">@cwd</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">__FILE__</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Ensure we have some deps</span>
</span><span class='line'><span class="n">gems</span> <span class="o">=</span> <span class="sx">%w(net-ssh)</span>
</span><span class='line'><span class="n">gems</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">g</span><span class="o">|</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;gem list --local -q --no-versions --no-details </span><span class="si">#{</span><span class="n">g</span><span class="si">}</span><span class="s2"> | egrep &#39;^</span><span class="si">#{</span><span class="n">g</span><span class="si">}</span><span class="s2">$&#39; &gt; /dev/null 2&gt;&amp;1&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">g</span><span class="si">}</span><span class="s2"> gem not found, installing...&quot;</span>
</span><span class='line'>      <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;gem install </span><span class="si">#{</span><span class="n">g</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>          <span class="nb">abort</span> <span class="s2">&quot;Failed to install gem: </span><span class="si">#{</span><span class="n">g</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nb">exec</span> <span class="o">=</span> <span class="sx">%w(vboxmanage)</span>
</span><span class='line'><span class="nb">exec</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="nb">p</span><span class="o">|</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;which </span><span class="si">#{</span><span class="nb">p</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s2">&quot;Failed to find the executable &#39;</span><span class="si">#{</span><span class="nb">p</span><span class="si">}</span><span class="s2">&#39;, please make sure it&#39;s installed.&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">namespace</span> <span class="ss">:vm</span> <span class="k">do</span>
</span><span class='line'>  <span class="ss">Rake</span><span class="p">:</span><span class="ss">:Task</span><span class="o">[</span><span class="s1">&#39;create&#39;</span><span class="o">].</span><span class="n">execute</span>
</span><span class='line'>  <span class="ss">Rake</span><span class="p">:</span><span class="ss">:Task</span><span class="o">[</span><span class="s1">&#39;build&#39;</span><span class="o">].</span><span class="n">execute</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>The comments are self explanitory. We do some basic enviro checks, declare some class variables and load up the subtask files.</p>

<p>Since this is <em>my</em> tool I can do whatever I want. This is going to be a super streamlined process, I only need it to work with VirtualBox so I don&rsquo;t need to get too crazy. I can basically rely on the <code>vboxmanage</code> command line tool to interact with the VM.</p>

<p><strong><em>DISCLAIMER:</em></strong> I originally was going to leverage the <a href="http://net-ssh.github.io">Net::SSH</a> ruby library to run all my post-processing on the VM. I needed some way to SCP scripts to the VM and execute them. Originally I used <code>vboxmanage</code> to get the IP address of the VM, then <code>Net::SSH</code> to SCP and execute commands. I had some methods all worked out for this, but then I ralized this needed to work on the VirtualBox NAT&#8217;ed network.</p>

<p>Ouch.</p>

<p>It would not reliably get a proper IP address and I also needed to do some fancy reverse SSH tunneling to SCP and execute with <code>Net::SSH</code>. I struggled with this for an hour or two and realized my desire to use all Ruby libs to do this interaction was going to be more trouble than it was worth. I instead decided to use the <code>vboxmanage</code> subset of tools that will actually copy data to the VM and execute the data. I re-wrote my copy and execute methods but still kept the <a href="https://github.com/malnick/create-vagrant-box/blob/master/extras/netssh_test.rb">Net::SSH code for later reference</a> since it&rsquo;s super handy.</p>

<h2>Create</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/bin/ruby</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;rake&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;expect&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;net/ssh&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">desc</span> <span class="s1">&#39;Build a Vagrant box from a vBox VM&#39;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:create</span> <span class="k">do</span>
</span><span class='line'>  <span class="c1"># Vars </span>
</span><span class='line'>  <span class="vi">@vmhash</span>     <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>  <span class="vi">@vmname</span>     <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;VM_NAME&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="vi">@vmuser</span>     <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;VM_USER&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="vi">@vmpwd</span>      <span class="o">=</span> <span class="no">ENV</span><span class="o">[</span><span class="s1">&#39;VM_PWD&#39;</span><span class="o">]</span>
</span><span class='line'>  <span class="n">guestiso</span> <span class="o">=</span> <span class="s1">&#39;4.3.8&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Get the guest edition ISO</span>
</span><span class='line'>  <span class="n">vboxexists</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@cwd</span><span class="si">}</span><span class="s2">/VBoxGuestAdditions_</span><span class="si">#{</span><span class="n">guestiso</span><span class="si">}</span><span class="s2">.iso&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">!</span> <span class="n">vboxexists</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Would you like to install the defualt version of guest editions? [</span><span class="si">#{</span><span class="n">guestiso</span><span class="si">}</span><span class="s2">] [y/n]&quot;</span>
</span><span class='line'>      <span class="n">installdefault</span> <span class="o">=</span> <span class="no">STDIN</span><span class="o">.</span><span class="n">gets</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">installdefault</span> <span class="o">=~</span> <span class="sr">/^y/</span>      
</span><span class='line'>          <span class="nb">puts</span> <span class="s2">&quot;Ok, downloading vBox guest editions version </span><span class="si">#{</span><span class="n">guestiso</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>          <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;wget http://download.virtualbox.org/virtualbox/4.3.8/VBoxGuestAdditions_</span><span class="si">#{</span><span class="n">guestiso</span><span class="si">}</span><span class="s2">.iso&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="nb">puts</span> <span class="s2">&quot;Something broke downloading the guest editions iso.&quot;</span>
</span><span class='line'>              <span class="nb">puts</span> <span class="s1">&#39;This may break the building of the box later, continue? [y/n]&#39;</span>
</span><span class='line'>              <span class="n">cont</span> <span class="o">=</span> <span class="no">STDIN</span><span class="o">.</span><span class="n">gets</span>
</span><span class='line'>              <span class="k">if</span> <span class="n">cont</span> <span class="o">=~</span><span class="sr">/^n/</span>
</span><span class='line'>                  <span class="nb">abort</span> <span class="s1">&#39;Aborting.&#39;</span>
</span><span class='line'>              <span class="k">end</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>          <span class="nb">puts</span> <span class="s2">&quot;Which version would you like to use? [x.x.x]&quot;</span>
</span><span class='line'>          <span class="n">installversion</span> <span class="o">=</span> <span class="no">STDIN</span><span class="o">.</span><span class="n">gets</span>
</span><span class='line'>          <span class="nb">puts</span> <span class="s2">&quot;Ok, downloading vBox guest edition version </span><span class="si">#{</span><span class="n">installversion</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>          <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;wget http://download.virtualbox.org/virtualbox/4.3.8/VBoxGuestAdditions_</span><span class="si">#{</span><span class="n">installversion</span><span class="si">}</span><span class="s2">.iso&quot;</span><span class="p">)</span>
</span><span class='line'>                  <span class="nb">puts</span> <span class="s2">&quot;Something broke downloading http://download.virtualbox.org/virtualbox/4.3.8/VBoxGuestAdditions_</span><span class="si">#{</span><span class="n">installversion</span><span class="si">}</span><span class="s2">.iso&quot;</span>
</span><span class='line'>              <span class="nb">puts</span> <span class="s1">&#39;This may break the buidling of the box later, continue? [y/n]&#39;</span>
</span><span class='line'>              <span class="n">cont</span> <span class="o">=</span> <span class="no">STDIN</span><span class="o">.</span><span class="n">gets</span>
</span><span class='line'>              <span class="k">if</span> <span class="n">cont</span> <span class="o">=~</span> <span class="sr">/^n/</span>
</span><span class='line'>                  <span class="nb">abort</span> <span class="s2">&quot;Aborting.&quot;</span>
</span><span class='line'>              <span class="k">end</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Create a hash of vBox VMs</span>
</span><span class='line'>      <span class="n">num</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class='line'>      <span class="n">vms</span> <span class="o">=</span> <span class="no">IO</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">&#39;vboxmanage list vms&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">vms</span><span class="o">.</span><span class="n">readlines</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="nb">name</span><span class="o">|</span>
</span><span class='line'>          <span class="vi">@vmhash</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">num</span><span class="p">,</span><span class="nb">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">chomp</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">chomp</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reverse</span><span class="p">)</span>
</span><span class='line'>          <span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="o">+</span><span class="mi">1</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># how many vm&#39;s do we have available?</span>
</span><span class='line'>      <span class="vi">@vmhash</span><span class="o">.</span><span class="n">each_with_index</span> <span class="p">{</span><span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>          <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="vi">@vmhash</span><span class="o">.</span><span class="n">length</span> <span class="o">-</span> <span class="mi">1</span>
</span><span class='line'>              <span class="vi">@vmmax</span> <span class="o">=</span> <span class="n">i</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Method to find if VM_NAME matches our hash listing</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">findvm</span><span class="p">()</span>
</span><span class='line'>          <span class="vi">@vmhash</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">|</span>
</span><span class='line'>              <span class="nb">test</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">chomp</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">chomp</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reverse</span>
</span><span class='line'>              <span class="k">return</span> <span class="n">v</span> <span class="k">if</span> <span class="vi">@vmname</span> <span class="o">=~</span> <span class="sr">/test/</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>          <span class="kp">nil</span>
</span><span class='line'>      <span class="k">end</span>      
</span><span class='line'>
</span><span class='line'>      <span class="c1"># If a VM_NAME was given, don&#39;t list them but check to make sure it&#39;s a good name</span>
</span><span class='line'>      <span class="k">if</span> <span class="o">!</span> <span class="vi">@vmname</span>
</span><span class='line'>          <span class="nb">puts</span> <span class="s2">&quot;Which vBox VM would you like to vagrantize? [1-</span><span class="si">#{</span><span class="vi">@vmmax</span><span class="si">}</span><span class="s2">]&quot;</span>
</span><span class='line'>          <span class="vi">@vmhash</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">#{</span><span class="n">v</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">}</span>
</span><span class='line'>          <span class="n">vmcreate</span> <span class="o">=</span> <span class="no">STDIN</span><span class="o">.</span><span class="n">gets</span><span class="o">.</span><span class="n">chomp</span><span class="o">.</span><span class="n">to_i</span>
</span><span class='line'>          <span class="n">vmax</span> <span class="o">=</span> <span class="vi">@vmmax</span>
</span><span class='line'>          <span class="k">until</span> <span class="n">vmcreate</span><span class="o">.</span><span class="n">between?</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">.</span><span class="n">to_i</span><span class="p">)</span>
</span><span class='line'>              <span class="nb">puts</span> <span class="s2">&quot;Range check&quot;</span>
</span><span class='line'>              <span class="nb">puts</span> <span class="s2">&quot;Please select an integer between 1 and </span><span class="si">#{</span><span class="vi">@vmmax</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>              <span class="n">vmcreate</span> <span class="o">=</span> <span class="no">STDIN</span><span class="o">.</span><span class="n">gets</span><span class="o">.</span><span class="n">chomp</span><span class="o">.</span><span class="n">to_i</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>          <span class="vi">@vmname</span> <span class="o">=</span> <span class="vi">@vmhash</span><span class="o">[</span><span class="n">vmcreate</span><span class="o">]</span>
</span><span class='line'>          <span class="ss">Rake</span><span class="p">:</span><span class="ss">:Task</span><span class="o">[</span><span class="s1">&#39;build&#39;</span><span class="o">].</span><span class="n">execute</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>          <span class="k">if</span> <span class="n">findvm</span>
</span><span class='line'>              <span class="vi">@vmname</span> <span class="o">=</span> <span class="n">findvm</span>
</span><span class='line'>              <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2"> found with actual name: </span><span class="si">#{</span><span class="n">vmname</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>              <span class="ss">Rake</span><span class="p">:</span><span class="ss">:Task</span><span class="o">[</span><span class="s1">&#39;build&#39;</span><span class="o">].</span><span class="n">execute</span>
</span><span class='line'>          <span class="k">else</span>
</span><span class='line'>              <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2"> not found, available vm&#39;s for building are:&quot;</span>
</span><span class='line'>              <span class="vi">@vmhash</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">k</span><span class="si">}</span><span class="s2">: </span><span class="si">#{</span><span class="n">v</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">}</span>
</span><span class='line'>              <span class="nb">puts</span> <span class="s2">&quot;Which VM would you like to use? [1-</span><span class="si">#{</span><span class="vi">@vmmax</span><span class="si">}</span><span class="s2">]&quot;</span>
</span><span class='line'>              <span class="n">vmcreate</span> <span class="o">=</span> <span class="no">STDIN</span><span class="o">.</span><span class="n">gets</span><span class="o">.</span><span class="n">chomp</span><span class="o">.</span><span class="n">to_i</span>
</span><span class='line'>              <span class="n">vmax</span> <span class="o">=</span> <span class="vi">@vmmax</span>
</span><span class='line'>              <span class="k">until</span> <span class="n">vmcreate</span><span class="o">.</span><span class="n">between?</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">.</span><span class="n">to_i</span><span class="p">)</span>
</span><span class='line'>                  <span class="nb">puts</span> <span class="s2">&quot;Please select an integer between 1 and </span><span class="si">#{</span><span class="vi">@vmmax</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>                  <span class="n">vmcreate</span> <span class="o">=</span> <span class="no">STDIN</span><span class="o">.</span><span class="n">gets</span><span class="o">.</span><span class="n">chomp</span><span class="o">.</span><span class="n">to_i</span>
</span><span class='line'>              <span class="k">end</span>
</span><span class='line'>              <span class="vi">@vmname</span> <span class="o">=</span> <span class="vi">@vmhash</span><span class="o">[</span><span class="n">vmcreate</span><span class="o">]</span>
</span><span class='line'>              <span class="ss">Rake</span><span class="p">:</span><span class="ss">:Task</span><span class="o">[</span><span class="s1">&#39;build&#39;</span><span class="o">].</span><span class="n">execute</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li><p>Check for vBox guest editions locally: I needed to make sure I had guest editions locally, if I didn&rsquo;t I would prompt to download the most recent release or give myself the option to install a different version.</p></li>
<li><p>Get a list of all the registered VirtualBox VM&rsquo;s on the host: Get the list, create a hash that I can easily choose from with a numbered key.</p></li>
<li><p>Override the previous step if the <code>VM_NAME</code> ENV was given at runtime, ensure this matches with an actual VM registered in the list anyways.</p></li>
<li><p>Run <code>``Rake::Task['build'].excute</code></p></li>
</ol>


<h2>Build</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">desc</span> <span class="s1">&#39;Build the vBox VM with Vagrant parameters&#39;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:build</span> <span class="k">do</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">vmrunning?</span> <span class="p">()</span>
</span><span class='line'>      <span class="k">if</span> <span class="nb">system</span><span class="p">(</span><span class="s1">&#39;vboxmanage list runningvms&#39;</span><span class="p">)</span>
</span><span class='line'>          <span class="n">runningvms</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>          <span class="n">vmproc</span> <span class="o">=</span> <span class="no">IO</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">&#39;vboxmanage list runningvms &gt; /dev/null&#39;</span><span class="p">)</span>
</span><span class='line'>          <span class="n">vmproc</span><span class="o">.</span><span class="n">readlines</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">runningvms</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">v</span><span class="p">)}</span>
</span><span class='line'>          <span class="n">runningvms</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span>
</span><span class='line'>              <span class="k">if</span> <span class="n">v</span> <span class="o">=~</span> <span class="sr">/&quot;</span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="sr">&quot;/</span>
</span><span class='line'>                  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">v</span><span class="si">}</span><span class="s2"> is running.&quot;</span>
</span><span class='line'>                  <span class="kp">true</span>
</span><span class='line'>              <span class="k">else</span>
</span><span class='line'>                  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">v</span><span class="si">}</span><span class="s2"> is not running.&quot;</span>
</span><span class='line'>                  <span class="kp">nil</span> 
</span><span class='line'>              <span class="k">end</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>          <span class="nb">puts</span> <span class="s2">&quot;No VMs are found running via [vboxmanage list runningvms]&quot;</span>
</span><span class='line'>          <span class="nb">exit</span> <span class="mi">1</span>          
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">vminfo</span><span class="p">()</span>
</span><span class='line'>      <span class="vi">@vmdata</span> <span class="o">=</span> <span class="no">IO</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s2">&quot;VBoxManage guestproperty enumerate </span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">vmcp</span><span class="p">(</span><span class="n">locpath</span><span class="p">)</span>
</span><span class='line'>      <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vboxmanage guestcontrol </span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2"> copyto </span><span class="si">#{</span><span class="n">locpath</span><span class="si">}</span><span class="s2"> /root/ --username </span><span class="si">#{</span><span class="vi">@vmuser</span><span class="si">}</span><span class="s2"> --password </span><span class="si">#{</span><span class="vi">@vmpwd</span><span class="si">}</span><span class="s2"> --domain 0755 --verbose&quot;</span><span class="p">)</span>
</span><span class='line'>          <span class="nb">abort</span> <span class="s2">&quot;Failed to copy </span><span class="si">#{</span><span class="n">locpath</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">vmexec</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
</span><span class='line'>      <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vboxmanage guestcontrol </span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2"> exec --image </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2"> --username </span><span class="si">#{</span><span class="vi">@vmuser</span><span class="si">}</span><span class="s2"> --password </span><span class="si">#{</span><span class="vi">@vmpwd</span><span class="si">}</span><span class="s2"> --verbose --wait-stdout&quot;</span><span class="p">)</span>
</span><span class='line'>          <span class="nb">abort</span> <span class="s2">&quot;Failed to run </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2"> on guest machine&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Successfully executed </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  
</span><span class='line'>  <span class="k">def</span> <span class="nf">vmexec_with_args</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</span><span class='line'>      <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vboxmanage guestcontrol </span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2"> exec --image </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2"> --username </span><span class="si">#{</span><span class="vi">@vmuser</span><span class="si">}</span><span class="s2"> --password </span><span class="si">#{</span><span class="vi">@vmpwd</span><span class="si">}</span><span class="s2"> --verbose --wait-stdout -- </span><span class="si">#{</span><span class="n">args</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>          <span class="nb">abort</span> <span class="s2">&quot;Failed to run </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2"> on guest machine&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Successfully executed </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;-----&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Vagrantizing </span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1"># Start the VM</span>
</span><span class='line'>  <span class="n">start</span> <span class="o">=</span> <span class="no">IO</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s2">&quot;vboxmanage startvm </span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="vi">@proc_id</span> <span class="o">=</span> <span class="n">start</span><span class="o">.</span><span class="n">pid</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Process ID for VM: </span><span class="si">#{</span><span class="vi">@proc_id</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Waiting to bring up machine...&quot;</span>
</span><span class='line'>  <span class="nb">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># The main loop</span>
</span><span class='line'>  <span class="k">while</span> <span class="n">vmrunning?</span>
</span><span class='line'>      <span class="c1"># Get VM IP Address</span>
</span><span class='line'>      <span class="n">vminfo</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">line</span><span class="o">|</span>
</span><span class='line'>          <span class="k">if</span> <span class="n">line</span> <span class="o">=~</span> <span class="sr">/IP/</span>
</span><span class='line'>              <span class="n">arry</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="vi">@vmip</span> <span class="o">=</span> <span class="n">arry</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="o">.</span><span class="n">strip</span><span class="o">.</span><span class="n">chomp</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Waiting for VM to become ready...&quot;</span>
</span><span class='line'>      <span class="nb">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Copy scripts dir to a locally accessible place</span>
</span><span class='line'>      <span class="n">scripts</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">[</span><span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@cwd</span><span class="si">}</span><span class="s2">/scripts/*.sh&quot;</span><span class="o">]</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Script dir: </span><span class="si">#{</span><span class="n">scripts</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="n">scripts</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">s</span><span class="o">|</span>
</span><span class='line'>          <span class="nb">puts</span> <span class="s2">&quot;Copying </span><span class="si">#{</span><span class="n">s</span><span class="si">}</span><span class="s2"> to VM...&quot;</span>
</span><span class='line'>          <span class="n">vmcp</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      
</span><span class='line'>      <span class="n">geiso</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">[</span><span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@cwd</span><span class="si">}</span><span class="s2">/*.iso&quot;</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Copy guest editions over</span>
</span><span class='line'>      <span class="n">geiso</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">iso</span><span class="o">|</span>
</span><span class='line'>          <span class="nb">puts</span> <span class="s2">&quot;Copying </span><span class="si">#{</span><span class="n">iso</span><span class="si">}</span><span class="s2"> to VM...&quot;</span>
</span><span class='line'>          <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vboxmanage guestcontrol </span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2"> copyto </span><span class="si">#{</span><span class="n">iso</span><span class="si">}</span><span class="s2"> /root/ --username </span><span class="si">#{</span><span class="vi">@vmuser</span><span class="si">}</span><span class="s2"> --password </span><span class="si">#{</span><span class="vi">@vmpwd</span><span class="si">}</span><span class="s2"> --domain 0755 --verbose&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="nb">abort</span> <span class="s2">&quot;Failed to copy </span><span class="si">#{</span><span class="n">iso</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">vmexec_with_args</span><span class="p">(</span><span class="s2">&quot;/bin/chmod&quot;</span><span class="p">,</span> <span class="s2">&quot;0755 /root/vagrant.sh&quot;</span><span class="p">)</span> 
</span><span class='line'>      <span class="n">vmexec_with_args</span><span class="p">(</span><span class="s2">&quot;/bin/chmod&quot;</span><span class="p">,</span> <span class="s2">&quot;0755 /root/vboxguest.sh&quot;</span><span class="p">)</span>   
</span><span class='line'>      <span class="n">vmexec_with_args</span><span class="p">(</span><span class="s2">&quot;/bin/chmod&quot;</span><span class="p">,</span> <span class="s2">&quot;0755 /root/compact.sh&quot;</span><span class="p">)</span> 
</span><span class='line'>      <span class="n">vmexec</span><span class="p">(</span><span class="s1">&#39;/root/vagrant.sh&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">vmexec</span><span class="p">(</span><span class="s1">&#39;/root/vboxguest.sh&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">vmexec</span><span class="p">(</span><span class="s1">&#39;/root/compact.sh&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># </span>
</span><span class='line'>      <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vboxmanage controlvm </span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2"> poweroff&quot;</span><span class="p">)</span>
</span><span class='line'>          <span class="nb">abort</span> <span class="s1">&#39;Failed to shutdown vm&#39;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Waiting for VM to shutdown.&quot;</span>
</span><span class='line'>      <span class="nb">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;Packing vm...&quot;</span>
</span><span class='line'>      <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vagrant package --base </span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>                <span class="nb">abort</span> <span class="s2">&quot;Failed to package the vm.&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;All done.&quot;</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;-----&quot;</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;VM package available at:&quot;</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@cwd</span><span class="si">}</span><span class="s2">/package.box&quot;</span>
</span><span class='line'>      <span class="nb">exit</span> <span class="mi">0</span>
</span><span class='line'>      <span class="c1">#Process.kill(@proc_id) and exit 0</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Package the box up</span>
</span><span class='line'>  <span class="c1"># vagrant package --output centos-6.5-x86_64.box --base centos-6.5-x86_64 &lt;-- example.</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, that first method is what I&rsquo;m going to wrap this entire program in &ndash; as long as the VM is running, lets copy some scripts to it, ensure they can be executed, then execute them.</p>

<h3>vmrunning?()</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">vmrunning?</span> <span class="p">()</span>
</span><span class='line'>  <span class="k">if</span> <span class="nb">system</span><span class="p">(</span><span class="s1">&#39;vboxmanage list runningvms&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">runningvms</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>      <span class="n">vmproc</span> <span class="o">=</span> <span class="no">IO</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s1">&#39;vboxmanage list runningvms &gt; /dev/null&#39;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">vmproc</span><span class="o">.</span><span class="n">readlines</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">runningvms</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">v</span><span class="p">)}</span>
</span><span class='line'>      <span class="n">runningvms</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span>
</span><span class='line'>          <span class="k">if</span> <span class="n">v</span> <span class="o">=~</span> <span class="sr">/&quot;</span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="sr">&quot;/</span>
</span><span class='line'>              <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">v</span><span class="si">}</span><span class="s2"> is running.&quot;</span>
</span><span class='line'>              <span class="kp">true</span>
</span><span class='line'>          <span class="k">else</span>
</span><span class='line'>              <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">v</span><span class="si">}</span><span class="s2"> is not running.&quot;</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">end</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;No VMs are found running via [vboxmanage list runningvms]&quot;</span>
</span><span class='line'>      <span class="nb">exit</span> <span class="mi">1</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Pop open a vboxmanage process to list out the running VM&rsquo;s, ensure our VM exists there.</p>

<h3>vminfo()</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">vminfo</span><span class="p">()</span>
</span><span class='line'>  <span class="vi">@vmdata</span> <span class="o">=</span> <span class="no">IO</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s2">&quot;VBoxManage guestproperty enumerate </span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Super simple, use vbox manage to get a listing of VM data using <code>guestproperty enumerate</code>. I used the <code>.readlines</code> method so I could iterate it into an array easily.</p>

<h3>vmcp(locpath)</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">vmcp</span><span class="p">(</span><span class="n">locpath</span><span class="p">)</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vboxmanage guestcontrol </span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2"> copyto </span><span class="si">#{</span><span class="n">locpath</span><span class="si">}</span><span class="s2"> /root/ --username </span><span class="si">#{</span><span class="vi">@vmuser</span><span class="si">}</span><span class="s2"> --password </span><span class="si">#{</span><span class="vi">@vmpwd</span><span class="si">}</span><span class="s2"> --domain 0755 --verbose&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s2">&quot;Failed to copy </span><span class="si">#{</span><span class="n">locpath</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Use the guestcontrol command for vboxmanage to copy stuff from my host to the guest. Copies it to <code>/root</code> by default.</p>

<h3>vmexec(cmd)</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">vmexec</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vboxmanage guestcontrol </span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2"> exec --image </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2"> --username </span><span class="si">#{</span><span class="vi">@vmuser</span><span class="si">}</span><span class="s2"> --password </span><span class="si">#{</span><span class="vi">@vmpwd</span><span class="si">}</span><span class="s2"> --verbose --wait-stdout&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s2">&quot;Failed to run </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2"> on guest machine&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Successfully executed </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Execute commands without arguments on the guest VM. Handy for running my scripts after I copy them over or changing file permissions.</p>

<h3>vmexec_with_args(cmd, args)</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">vmexec_with_args</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vboxmanage guestcontrol </span><span class="si">#{</span><span class="vi">@vmname</span><span class="si">}</span><span class="s2"> exec --image </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2"> --username </span><span class="si">#{</span><span class="vi">@vmuser</span><span class="si">}</span><span class="s2"> --password </span><span class="si">#{</span><span class="vi">@vmpwd</span><span class="si">}</span><span class="s2"> --verbose --wait-stdout -- </span><span class="si">#{</span><span class="n">args</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s2">&quot;Failed to run </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2"> on guest machine&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Successfully executed </span><span class="si">#{</span><span class="n">cmd</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Do the exec with arguments if needed.</p>

<h2>Execute some scripts on the VM, exit, package the .box</h2>

<p>The rest of the script is pretty straight forward. I drop into my <code>unless vmrunning?()</code> loop, copy over my scripts, run some <code>chmod</code> commands and execute them.</p>

<p>The scripts setup the Vagrant user and environmnent then install vBox Guest Editions and shutdown the VM once the scripts complete.</p>

<p>Then it&rsquo;s simply a matter of using the <code>vagrant package --base</code> command on the box <strong><em>with the correct box timecode attached to it</em></strong>. (that last bit is completely undocumented).</p>

<h2>Complete Project</h2>

<p><a href="https://github.com/malnick/create-vagrant-box/">Available Here</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-08-03T17:22:54-07:00" pubdate data-updated="true">Aug 3<span>rd</span>, 2014</time></div>
	


	
</div></article>

<nav id="pagenavi">
    
    
        <a href="/blog/page/2/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav></div>
	<footer id="footer" class="inner">Copyright &copy; 2015

    Jeff

<br>
Powered by Octopress.
</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






</body>
</html>
