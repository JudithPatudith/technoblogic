
<!DOCTYPE HTML>
<html>
<head>
	<script data-cfasync="false" type="text/javascript" src="//use.typekit.net/axj3cfp.js"></script>
	<script data-cfasync="false" type="text/javascript">try{Typekit.load();}catch(e){}</script>
	<meta charset="utf-8">
	<title>a techy blog  | JP</title>

<meta name="author" content="Jeff"> 

<meta name="description" content="See subtitle."> <meta name="keywords" content="">

	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="JP" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/stylesheets/font-awesome.min.css" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script type="text/javascript" src="/javascripts/jquery.fancybox.pack.js"></script>

<script language="Javascript" type="text/javascript">
$(document).ready(
  function() {
    (function($) {
      $(".fancybox[data-content-id]").each(function() {
        this.href = $(this).data('content-id');
      });
      $(".fancybox").fancybox({
        beforeLoad: function() {
          var el, 
              id = $(this.element).data('title-id');

          if (id) {
            el = $('#' + id);

            if (el.length) {
              this.title = el.html();
            }
          }
          if ($(this).data('content')) {
            this.content = $(this).data('content');
          }
        },
        helpers: {
          title: {
            type: 'inside'
          }
        }
      });
    })(jQuery);
  }
);
</script>

	
</head>



<body>
	<header id="header" class="inner"><h1><a href="/">JP</a></h1>
<h4>a techy blog</h4>
<nav id="main-nav"><ul>
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/about">About</a></li>
	<li><a href="/blog/resume">Resume</a></li>
	<li><a href="/archives">Archive</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul>
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/about">About</a></li>
	<li><a href="/blog/resume">Resume</a></li>
	<li><a href="/archives">Archive</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:httpL://www.jeffmalnick.com">
			</form>
		</div>
	</div>
</nav>


</header>

	<div id="content" class="inner">


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/07/14/managing-git-repos-over-jump-hosts-using-persistant-sockets/">
		
			Managing Git Repos Over Jump Hosts Using Persistant Sockets</a>
	</h2>
	<div class="entry-content">
		<p>I was recently helping a customer who had a somewhat complicated git workflow to production. All their Puppet code was in a locally accessible Gitlab server which was used by all the Automation dev&rsquo;s to develop, test and push to.</p>

<p>However, their integration and production environments were located behind a jumphost which also required a custom VPN connection.</p>

<p>The problem was that this deployment relied on <a href="https://github.com/adrienthebo/r10k">r10k</a> and the Puppet master needed access to the Gitlab server to create the local environments in both integration and eventually production.</p>

<p>Enabling a streamlined process to move the Gitlab codebase from our dev area into the corralled VM behind the jumphost was needed.</p>

<p>This workflow involves several steps:</p>

<ol>
<li>Connect NA Client VPN to Jumphost</li>
<li>SSH to Jumphost and enter auth credentials</li>
<li>SSH into yum repo server behind jumphost</li>
<li>Enter in yum repo auth credentials</li>
<li>scp your data &ndash; many ways to skin that cat, all are somewhat complicated</li>
</ol>


<h2>Automate with persistant SSH sockets</h2>

<p>I decided to write a SSH script which will do this, and I wanted to ensure we didn&rsquo;t fall into &lsquo;password&rsquo; hell and have to enter in a new password every time. I had heard you could do this by using the &lsquo;ControlMaster&rsquo; SSH param in SSH_config, open a persistant socket, and reuse it as needed. If I could enable this over a jumphost was another question but I gave it a shot.</p>

<ol>
<li><p>Create a persistant socket to jumphost with tunnel on localhost through the jumphost, pushing traffic from port 22 &ndash;> 5000</p>

<pre><code> ssh -o 'ControlMaster auto' -o 'ControlPath ~/.ssh/jump.sock' -N -f -L 5000:[git_repo_ip]:22 root@[jumphost_ip]
</code></pre></li>
<li><p>Create a direct persistant socket to the integration or production Gitlab server on localhost tunnel</p>

<pre><code> ssh -o 'ControlMaster auto' -o 'ControlPath ~/.ssh/git.sock' -N -f root@localhost -p 5000
</code></pre></li>
<li><p>CP arbitrary documents easily</p>

<p> scp -o &lsquo;ControlPath ~/.ssh/yum.sock&rsquo; -P 5000 $filepath root@localhost:/tmp/</p></li>
<li><p>SSH (no password required once socket is created!)</p>

<pre><code> ssh -S ~/.ssh/yum.sock root@localhost -p 5000
</code></pre></li>
<li><p>To destroy the sockets you need to do the yum repo first and jump second</p>

<pre><code> ssh -S ~/.ssh/yum.sock -O exit root@localhost &amp;&amp; ssh -S ~/.ssh/jump.sock -O exit root@172.20.100.11
</code></pre></li>
</ol>


<h2>A quick script</h2>

<p>Now that I can create persistant sockets I wrote a script to SSH into the local git, run <code>rake::restore</code>, scp the backup to my host, scp the backup from my host into the integration git over the jumphost connection, and run rake::restore.</p>

<ol>
<li>Check to ensure I&rsquo;m connected to the correct VPN Gateway</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="nb">test</span> <span class="o">-</span><span class="n">e</span> <span class="o">~</span><span class="sr">/.ssh || { echo &quot;Create an ssh dir&quot;; exit 1; }</span>
</span><span class='line'>
</span><span class='line'><span class="sr"> VPNENV=`echo $(naclient status | awk &#39;NR==4&#39; | cut -d: -f2)`</span>
</span><span class='line'><span class="sr"> VPNREMOTE=&quot;data_center&quot;</span>
</span><span class='line'><span class="sr"> LOCALGIT=&quot;10.10.100.100&quot;</span>
</span><span class='line'><span class="sr"> INTGIT=&quot;172.24.100.10&quot;</span>
</span><span class='line'><span class="sr"> JUMPHOST=&quot;172.20.100.11&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="sr"> if [ &quot;$VPNENV&quot; == &quot;$VPNREMOTE&quot; ]</span>
</span><span class='line'><span class="sr"> then</span>
</span><span class='line'><span class="sr">     echo &quot;Connected to $VPNENV&quot;</span>
</span><span class='line'><span class="sr"> </span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>Build the sockets</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="n">echo</span> <span class="s2">&quot;Connecting to local git:&quot;</span>
</span><span class='line'>  <span class="n">ssh</span> <span class="o">-</span><span class="n">o</span> <span class="s1">&#39;ControlMaster auto&#39;</span> <span class="o">-</span><span class="n">o</span> <span class="s1">&#39;ControlPath ~/.ssh/LOCALGIT.sock&#39;</span> <span class="o">-</span><span class="n">N</span> <span class="o">-</span><span class="n">f</span> <span class="n">root</span><span class="err">@</span><span class="vg">$LOCALGIT</span>
</span><span class='line'>  <span class="n">echo</span> <span class="s2">&quot;Connecting to jumphost:&quot;</span>
</span><span class='line'>  <span class="n">ssh</span> <span class="o">-</span><span class="n">o</span> <span class="s1">&#39;ControlMaster auto&#39;</span> <span class="o">-</span><span class="n">o</span> <span class="s1">&#39;ControlPath ~/.ssh/jump.sock&#39;</span> <span class="o">-</span><span class="n">N</span> <span class="o">-</span><span class="n">f</span> <span class="o">-</span><span class="n">L</span> <span class="vg">$PORT</span><span class="p">:</span><span class="vg">$INTGIT</span><span class="p">:</span><span class="mi">22</span> <span class="n">root</span><span class="err">@</span><span class="vg">$JUMPHOST</span>
</span><span class='line'>  <span class="n">echo</span> <span class="s2">&quot;Connecting to git in integration:&quot;</span>
</span><span class='line'>  <span class="n">ssh</span> <span class="o">-</span><span class="n">o</span> <span class="s1">&#39;ControlMaster auto&#39;</span> <span class="o">-</span><span class="n">o</span> <span class="s1">&#39;ControlPath ~/.ssh/intgit.sock&#39;</span> <span class="o">-</span><span class="n">o</span> <span class="s1">&#39;UserKnownHostsFile /dev/null&#39;</span> <span class="o">-</span><span class="n">N</span> <span class="o">-</span><span class="n">f</span> <span class="n">root</span><span class="vi">@localhost</span> <span class="o">-</span><span class="nb">p</span> <span class="vg">$PORT</span>  
</span><span class='line'>  
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>Use the sockets for SSH and SCP</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="n">ssh</span> <span class="o">-</span><span class="n">S</span> <span class="o">~</span><span class="sr">/.ssh/</span><span class="no">LOCALGIT</span><span class="o">.</span><span class="n">sock</span> <span class="n">root</span><span class="err">@</span><span class="vg">$LOCALGIT</span> <span class="n">gitlab</span><span class="o">-</span><span class="n">rake</span> <span class="ss">gitlab</span><span class="p">:</span><span class="ss">backup</span><span class="p">:</span><span class="n">create</span>
</span><span class='line'>  <span class="n">ssh</span> <span class="o">-</span><span class="n">S</span> <span class="o">~</span><span class="sr">/.ssh/</span><span class="no">LOCALGIT</span><span class="o">.</span><span class="n">sock</span> <span class="n">root</span><span class="err">@</span><span class="vg">$LOCALGIT</span> <span class="s2">&quot;$(typeset -f); stagelatest&quot;</span>
</span><span class='line'>  
</span></code></pre></td></tr></table></div></figure>


<p>A note before moving on about the &lsquo;stagelatest&rsquo; function. I had a complicated command that I didn&rsquo;t want to toss into the SSH line, so I wrote a fuction and ran the <code>$(typeset -f)</code> command to make that function available on the remote SSH shell executing the commands. The function looked like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="n">stagelatest</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="no">LATESTBAK</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">ls</span> <span class="o">-</span><span class="n">t</span> <span class="sr">/var/o</span><span class="n">pt</span><span class="o">/</span><span class="n">gitlab</span><span class="o">/</span><span class="n">backups</span><span class="o">/</span> <span class="o">|</span> <span class="n">head</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>  <span class="n">rm</span> <span class="sr">/tmp/</span><span class="mi">1111111111</span><span class="n">_gitlab_backup</span><span class="o">.</span><span class="n">tar</span>
</span><span class='line'>  <span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="sr">/var/o</span><span class="n">pt</span><span class="o">/</span><span class="n">gitlab</span><span class="o">/</span><span class="n">backups</span><span class="o">/</span><span class="vg">$LATESTBAK</span> <span class="sr">/tmp/</span><span class="mi">1111111111</span><span class="n">_gitlab_backup</span><span class="o">.</span><span class="n">tar</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span></code></pre></td></tr></table></div></figure>


<p>Continuing with our SCP and SSH commands:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="n">scp</span> <span class="o">-</span><span class="n">o</span> <span class="s1">&#39;ControlPath ~/.ssh/LOCALGIT.sock&#39;</span> <span class="n">root</span><span class="err">@</span><span class="vg">$LOCALGIT</span><span class="ss">:/</span><span class="n">tmp</span><span class="o">/</span><span class="mi">1111111111</span><span class="n">_gitlab_backup</span><span class="o">.</span><span class="n">tar</span> <span class="sr">/tmp/</span>
</span><span class='line'>  <span class="n">scp</span> <span class="o">-</span><span class="n">o</span> <span class="s1">&#39;ControlPath ~/.ssh/intgit.sock&#39;</span> <span class="o">-</span><span class="n">P</span> <span class="vg">$PORT</span> <span class="sr">/tmp/</span><span class="mi">1111111111</span><span class="n">_gitlab_backup</span><span class="o">.</span><span class="n">tar</span> <span class="n">root</span><span class="vi">@localhost</span><span class="ss">:/</span><span class="n">var</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">gitlab</span><span class="o">/</span><span class="n">backups</span>
</span><span class='line'>  <span class="n">ssh</span> <span class="o">-</span><span class="n">S</span> <span class="o">~</span><span class="sr">/.ssh/in</span><span class="n">tgit</span><span class="o">.</span><span class="n">sock</span> <span class="n">root</span><span class="vi">@localhost</span> <span class="o">-</span><span class="nb">p</span> <span class="vg">$PORT</span> <span class="no">BACKUP</span><span class="o">=</span><span class="mi">1111111111</span> <span class="n">gitlab</span><span class="o">-</span><span class="n">rake</span> <span class="ss">gitlab</span><span class="p">:</span><span class="ss">backup</span><span class="p">:</span><span class="n">restore</span> <span class="o">&lt;&lt;&lt;</span> <span class="n">yes</span>
</span><span class='line'>  
</span></code></pre></td></tr></table></div></figure>


<h2>The final script</h2>

<p>My final script includes a cleanup() function that is exectued via <code>trap</code> and at the end of the script on a good run. Cleaning up the sockets and ensuring nothing is left is always good practice.</p>

<p>I also modified my SSH commands to not use the known_hosts file. This way I could reuse the tunnle on localhost:5000 to other jumphost connections inside the corralled integration or production environments. Had I used the known_hosts file every time and not pipped it to <code>/dev/null</code>, everytime I reused localhost:5000 to tunnel to a new server behind the jumphost the public key would change and SSH would think someone is trying to do something funny.</p>

<p>I also include some more logic to really make sure that the rake::restore should run on the integration/production gitlab server. Nerver hurts to double check!</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/bin/bash</span>
</span><span class='line'><span class="n">cleanup</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">echo</span> <span class="s2">&quot;Cleaning up sockets and exiting&quot;</span>
</span><span class='line'>  <span class="nb">test</span> <span class="o">-</span><span class="n">e</span> <span class="o">~</span><span class="sr">/.ssh/</span><span class="no">LOCALGIT</span><span class="o">.</span><span class="n">sock</span> <span class="o">&amp;&amp;</span> <span class="n">ssh</span> <span class="o">-</span><span class="n">S</span> <span class="o">~</span><span class="sr">/.ssh/</span><span class="no">LOCALGIT</span><span class="o">.</span><span class="n">sock</span> <span class="o">-</span><span class="n">O</span> <span class="nb">exit</span> <span class="n">root</span><span class="err">@</span><span class="vg">$GITLAB</span>
</span><span class='line'>  <span class="nb">test</span> <span class="o">-</span><span class="n">e</span> <span class="o">~</span><span class="sr">/.ssh/in</span><span class="n">tgit</span><span class="o">.</span><span class="n">sock</span> <span class="o">&amp;&amp;</span> <span class="n">ssh</span> <span class="o">-</span><span class="n">S</span> <span class="o">~</span><span class="sr">/.ssh/in</span><span class="n">tgit</span><span class="o">.</span><span class="n">sock</span> <span class="o">-</span><span class="n">O</span> <span class="nb">exit</span> <span class="n">root</span><span class="vi">@localhost</span>
</span><span class='line'>  <span class="nb">test</span> <span class="o">-</span><span class="n">e</span> <span class="o">~</span><span class="sr">/.ssh/</span><span class="n">jump</span><span class="o">.</span><span class="n">sock</span> <span class="o">&amp;&amp;</span> <span class="n">ssh</span> <span class="o">-</span><span class="n">S</span> <span class="o">~</span><span class="sr">/.ssh/</span><span class="n">jump</span><span class="o">.</span><span class="n">sock</span> <span class="o">-</span><span class="n">O</span> <span class="nb">exit</span> <span class="n">root</span><span class="err">@</span><span class="vg">$JUMPHOST</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="vg">$@</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nb">trap</span> <span class="n">cleanup</span> <span class="no">SIGHUP</span> <span class="no">SIGINT</span> <span class="no">SIGTERM</span>
</span><span class='line'>
</span><span class='line'><span class="n">stagelatest</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="no">LATESTBAK</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">ls</span> <span class="o">-</span><span class="n">t</span> <span class="sr">/var/o</span><span class="n">pt</span><span class="o">/</span><span class="n">gitlab</span><span class="o">/</span><span class="n">backups</span><span class="o">/</span> <span class="o">|</span> <span class="n">head</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>  <span class="n">rm</span> <span class="sr">/tmp/</span><span class="mi">1111111111</span><span class="n">_gitlab_backup</span><span class="o">.</span><span class="n">tar</span>
</span><span class='line'>  <span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="sr">/var/o</span><span class="n">pt</span><span class="o">/</span><span class="n">gitlab</span><span class="o">/</span><span class="n">backups</span><span class="o">/</span><span class="vg">$LATESTBAK</span> <span class="sr">/tmp/</span><span class="mi">1111111111</span><span class="n">_gitlab_backup</span><span class="o">.</span><span class="n">tar</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">getport</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="no">PORT</span><span class="o">=</span><span class="err">$</span><span class="p">((</span> <span class="vg">$RANDOM</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">+</span> <span class="mi">5000</span> <span class="p">))</span>
</span><span class='line'>  <span class="no">CHECK</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">netstat</span> <span class="o">-</span><span class="n">an</span> <span class="o">|</span><span class="n">grep</span> <span class="no">LISTEN</span> <span class="o">|</span> <span class="n">egrep</span> <span class="s2">&quot;[.:]${PORT}</span><span class="se">\s</span><span class="s2">&quot;</span> <span class="o">&gt;</span> <span class="sr">/dev/nu</span><span class="n">ll</span><span class="p">;</span> <span class="n">echo</span> <span class="vg">$?</span><span class="p">)</span>
</span><span class='line'>  <span class="k">while</span> <span class="o">[[</span> <span class="s2">&quot;$CHECK&quot;</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">]]</span>
</span><span class='line'>  <span class="k">do</span>
</span><span class='line'>      <span class="n">echo</span> <span class="s2">&quot;Port: $PORT is in use by another process, choosing another port.&quot;</span>
</span><span class='line'>      <span class="no">PORT</span><span class="o">=</span><span class="err">$</span><span class="p">((</span> <span class="vg">$RANDOM</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">+</span> <span class="n">port</span> <span class="p">))</span>
</span><span class='line'>
</span><span class='line'>      <span class="no">CHECK</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">netstat</span> <span class="o">-</span><span class="n">an</span> <span class="o">|</span><span class="n">grep</span> <span class="no">LISTEN</span> <span class="o">|</span> <span class="n">egrep</span> <span class="s2">&quot;[.:]$PORT</span><span class="se">\s</span><span class="s2">&quot;</span> <span class="o">&gt;</span> <span class="sr">/dev/nu</span><span class="n">ll</span><span class="p">;</span> <span class="n">echo</span> <span class="vg">$?</span><span class="p">)</span>
</span><span class='line'>  <span class="n">done</span>
</span><span class='line'>  <span class="n">echo</span> <span class="s2">&quot;Setting port to $PORT&quot;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="n">getport</span>
</span><span class='line'>
</span><span class='line'><span class="nb">test</span> <span class="o">-</span><span class="n">e</span> <span class="o">~</span><span class="sr">/.ssh || { echo &quot;Create an ssh dir&quot;; exit 1; }</span>
</span><span class='line'>
</span><span class='line'><span class="sr">VPNENV=`echo $(naclient status | awk &#39;NR==4&#39; | cut -d: -f2)`</span>
</span><span class='line'><span class="sr">VPNREMOTE=&quot;data_center&quot;</span>
</span><span class='line'><span class="sr">LOCALGIT=&quot;10.10.100.100&quot;</span>
</span><span class='line'><span class="sr">INTGIT=&quot;172.24.100.10&quot;</span>
</span><span class='line'><span class="sr">JUMPHOST=&quot;172.20.100.11&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">if [ &quot;$VPNENV&quot; == &quot;$VPNREMOTE&quot; ]</span>
</span><span class='line'><span class="sr">then</span>
</span><span class='line'><span class="sr"> echo &quot;Connected to $VPNENV&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="sr"> echo &quot;Connecting to local git:&quot;</span>
</span><span class='line'><span class="sr"> ssh -o &#39;ControlMaster auto&#39; -o &#39;ControlPath ~/</span><span class="o">.</span><span class="n">ssh</span><span class="o">/</span><span class="no">LOCALGIT</span><span class="o">.</span><span class="n">sock</span><span class="s1">&#39; -N -f root@$LOCALGIT </span>
</span><span class='line'><span class="s1"> echo &quot;Connecting to jumphost:&quot;</span>
</span><span class='line'><span class="s1"> ssh -o &#39;</span><span class="no">ControlMaster</span> <span class="n">auto</span><span class="s1">&#39; -o &#39;</span><span class="no">ControlPath</span> <span class="o">~</span><span class="sr">/.ssh/</span><span class="n">jump</span><span class="o">.</span><span class="n">sock</span><span class="s1">&#39; -N -f -L $PORT:$INTGIT:22 root@$JUMPHOST</span>
</span><span class='line'><span class="s1"> echo &quot;Connecting to git in integration:&quot;</span>
</span><span class='line'><span class="s1"> ssh -o &#39;</span><span class="no">ControlMaster</span> <span class="n">auto</span><span class="s1">&#39; -o &#39;</span><span class="no">ControlPath</span> <span class="o">~</span><span class="sr">/.ssh/in</span><span class="n">tgit</span><span class="o">.</span><span class="n">sock</span><span class="s1">&#39; -o &#39;</span><span class="no">UserKnownHostsFile</span> <span class="sr">/dev/nu</span><span class="n">ll</span><span class="s1">&#39; -N -f root@localhost -p $PORT</span>
</span><span class='line'>
</span><span class='line'><span class="s1"> # SSH LOCALGIT and run rake backup, scp latest backup to host </span>
</span><span class='line'><span class="s1"> echo &quot;Running gitlab:backup:create&quot;</span>
</span><span class='line'><span class="s1"> ssh -S ~/.ssh/LOCALGIT.sock root@$LOCALGIT gitlab-rake gitlab:backup:create</span>
</span><span class='line'><span class="s1"> echo &quot;Staging backup in /tmp&quot;</span>
</span><span class='line'><span class="s1"> ssh -S ~/.ssh/LOCALGIT.sock root@$LOCALGIT &quot;$(typeset -f); stagelatest&quot;</span>
</span><span class='line'><span class="s1"> echo &quot;Copying over from lab git to localhost&quot;</span>
</span><span class='line'><span class="s1"> scp -o &#39;</span><span class="no">ControlPath</span> <span class="o">~</span><span class="sr">/.ssh/</span><span class="no">LOCALGIT</span><span class="o">.</span><span class="n">sock</span><span class="s1">&#39; root@$LOCALGIT:/tmp/1111111111_gitlab_backup.tar /tmp/</span>
</span><span class='line'><span class="s1"> echo &quot;Copying lab git backup from localhost to integration git server&quot;</span>
</span><span class='line'><span class="s1"> scp -o &#39;</span><span class="no">ControlPath</span> <span class="o">~</span><span class="sr">/.ssh/in</span><span class="n">tgit</span><span class="o">.</span><span class="n">sock</span><span class="err">&#39;</span> <span class="o">-</span><span class="n">P</span> <span class="vg">$PORT</span> <span class="sr">/tmp/</span><span class="mi">1111111111</span><span class="n">_gitlab_backup</span><span class="o">.</span><span class="n">tar</span> <span class="n">root</span><span class="vi">@localhost</span><span class="ss">:/</span><span class="n">var</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">gitlab</span><span class="o">/</span><span class="n">backups</span>
</span><span class='line'>  <span class="n">echo</span> <span class="s2">&quot;Would you like to run restore on the integration server now?&quot;</span>
</span><span class='line'>  <span class="n">read</span> <span class="n">restore</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">[[</span> <span class="vg">$restore</span> <span class="o">=~</span> <span class="o">^</span><span class="n">y</span> <span class="o">]]</span>
</span><span class='line'>  <span class="k">then</span>
</span><span class='line'>      <span class="n">echo</span> <span class="s2">&quot;Running restore on integration git server&quot;</span>
</span><span class='line'>      <span class="n">ssh</span> <span class="o">-</span><span class="n">S</span> <span class="o">~</span><span class="sr">/.ssh/in</span><span class="n">tgit</span><span class="o">.</span><span class="n">sock</span> <span class="n">root</span><span class="vi">@localhost</span> <span class="o">-</span><span class="nb">p</span> <span class="vg">$PORT</span> <span class="no">BACKUP</span><span class="o">=</span><span class="mi">1111111111</span> <span class="n">gitlab</span><span class="o">-</span><span class="n">rake</span> <span class="ss">gitlab</span><span class="p">:</span><span class="ss">backup</span><span class="p">:</span><span class="n">restore</span> <span class="o">&lt;&lt;&lt;</span> <span class="n">yes</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>      <span class="n">echo</span> <span class="s2">&quot;Not running restore&quot;</span>
</span><span class='line'>      <span class="n">echo</span> <span class="s2">&quot;Backup located at /var/opt/gitlab/backups/1111111111_gitlab_backup.tar&quot;</span>
</span><span class='line'>      <span class="n">echo</span> <span class="s2">&quot;-----&quot;</span>
</span><span class='line'>      <span class="n">echo</span> <span class="s2">&quot;To backup manually run:&quot;</span>
</span><span class='line'>      <span class="n">echo</span> <span class="s2">&quot;BACKUP=1111111111_gitlab_backup.tar gitlab-rake gitlab:backup:restore&quot;</span>
</span><span class='line'>  <span class="n">fi</span>
</span><span class='line'>  <span class="n">cleanup</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">echo</span> <span class="s2">&quot;VPN Enviro not correct, connected to: $VPNENV&quot;</span>
</span><span class='line'>  <span class="n">echo</span> <span class="s2">&quot;Check VPN connection to data_center, or start NA Client&quot;</span>
</span><span class='line'>  <span class="n">cleanup</span> <span class="mi">1</span>
</span><span class='line'><span class="n">fi</span>
</span></code></pre></td></tr></table></div></figure>


<p>The final script can be pulled down from <a href="https://github.com/malnick/scripts/blob/master/connect.sh">my github account</a>.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-07-14T07:09:09-07:00" pubdate data-updated="true">Jul 14<span>th</span>, 2014</time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/06/24/a-simple-nagios-docker-plugin/">
		
			A Simple Nagios Docker Plugin</a>
	</h2>
	<div class="entry-content">
		<p>Docker is an amazing tool with a lot great functional command line interfaces. A typical docker deployment might have a webapp running inside a container. In order to observe the beahvior of this container you might want to setup a Nagios plugin to monitor log output.</p>

<p>To do this I am going to do the following:</p>

<ol>
<li>Deploy an Ubuntu Precise VM on 10.10.33.2 via Vagrant</li>
<li>Provsion the VM with Puppet using the Vagrant Puppet provisioner:

<ol>
<li>Installs docker using garethr-docker</li>
<li>Installs the training/webapp image</li>
<li>Runs the container using an exec</li>
<li>Installs nagios and my ruby plugin to monitor the docker service and the training/webapp image for the following:

<ol>
<li>Is the docker command available?</li>
<li>Is the webapp running?

<ul>
<li>Ensures webapp is running on <code>localhost:5000</code></li>
<li>Checks the log for 404 errors and sends warnings if so</li>
<li>Counts the errors for each URL with a 404 and outputs the count and URL which has the highest hit count</li>
<li>test the above by trying <code>10.10.33.2:5000/test</code> over and over again</li>
</ul>
</li>
</ol>
</li>
</ol>
</li>
</ol>


<h2>The Vagrantfile</h2>

<p>I start with a basic Vagrantfile to deploy an Ubuntu Precise VM:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="s2">&quot;virtualbox&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span>
</span><span class='line'>  <span class="n">v</span><span class="o">.</span><span class="n">customize</span> <span class="o">[</span><span class="s2">&quot;modifyvm&quot;</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">&quot;--memory&quot;</span><span class="p">,</span> <span class="mi">1024</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="ss">:nagios</span> <span class="k">do</span> <span class="o">|</span><span class="n">deploy</span><span class="o">|</span>
</span><span class='line'>  <span class="n">deploy</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;precise64&quot;</span>
</span><span class='line'>  <span class="n">deploy</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s2">&quot;nagios.server.dev&quot;</span>
</span><span class='line'>  <span class="n">deploy</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box_url</span> <span class="o">=</span> <span class="s2">&quot;http://files.vagrantup.com/precise64.box&quot;</span>
</span><span class='line'>  <span class="n">deploy</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;modules&quot;</span><span class="p">,</span> <span class="s2">&quot;/etc/puppet/modules&quot;</span>
</span><span class='line'>  <span class="n">deploy</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;manifests&quot;</span><span class="p">,</span> <span class="s2">&quot;/etc/puppet/manifests&quot;</span>
</span><span class='line'>  <span class="n">deploy</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;10.10.33.2&quot;</span> <span class="c1"># Define static IP once dev completes</span>
</span><span class='line'>  <span class="n">deploy</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:puppet</span><span class="p">,</span> <span class="ss">:module_path</span> <span class="o">=&gt;</span> <span class="s2">&quot;modules&quot;</span><span class="p">,</span> <span class="ss">:manifests_path</span> <span class="o">=&gt;</span> <span class="s2">&quot;manifests&quot;</span><span class="p">,</span> <span class="ss">:manifest_file</span> <span class="o">=&gt;</span> <span class="s2">&quot;deploy_nagios.pp&quot;</span>
</span><span class='line'>   <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Puppet Provisioner</h2>

<p>In order to provision the VM on boot I used the Puppet provisioner which ships with Vagrant. For testing purposes I like to sync my manifests and modules directory to the VM. Usually I run a bash script before provisioning with Puppet to install from the Puppet Labs apt or yum repos, however for this project that wasn&rsquo;t neccessary as the goal is to have a quickly bootable dev environment for my Nagios server and Docker container.</p>

<p>The <code>deploy_nagios.pp</code> manifest looks like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Deploy docker and an Ubuntu image to play with</span>
</span><span class='line'><span class="k">class</span> <span class="p">{</span><span class="s1">&#39;docker&#39;</span><span class="p">:}</span>
</span><span class='line'><span class="ss">docker</span><span class="p">:</span><span class="ss">:image</span> <span class="p">{</span> <span class="s1">&#39;training/webapp&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="nb">require</span> <span class="o">=&gt;</span> <span class="no">Class</span><span class="o">[</span><span class="s1">&#39;docker&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1"># Super hero hack to run the docker image... see readme for why.</span>
</span><span class='line'><span class="c1"># Also, in no way is this idempotent, if it&#39;s running it&#39;ll fail.</span>
</span><span class='line'><span class="nb">exec</span> <span class="p">{</span> <span class="s1">&#39;/usr/bin/docker run -d -p 5000:5000 training/webapp python app.py&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="nb">require</span> <span class="o">=&gt;</span> <span class="ss">Docker</span><span class="p">:</span><span class="ss">:Image</span><span class="o">[</span><span class="s1">&#39;training/webapp&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">#docker::run { &#39;webapp&#39;:</span>
</span><span class='line'><span class="c1">#  image   =&gt; &#39;ubuntu&#39;,</span>
</span><span class='line'><span class="c1">#  command =&gt; &#39;/bin/echo test&#39;,</span>
</span><span class='line'><span class="c1">#  require =&gt; Docker::Image[&#39;training/webapp&#39;],</span>
</span><span class='line'><span class="c1">#}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Update this thing</span>
</span><span class='line'><span class="nb">exec</span> <span class="p">{</span> <span class="s1">&#39;/usr/bin/apt-get update&#39;</span><span class="p">:}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Install nagios </span>
</span><span class='line'><span class="k">class</span> <span class="p">{</span> <span class="s1">&#39;nagios&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="nb">require</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="no">Exec</span><span class="o">[</span><span class="s1">&#39;/usr/bin/apt-get update&#39;</span><span class="o">]</span><span class="p">,</span><span class="no">Class</span><span class="o">[</span><span class="s1">&#39;docker&#39;</span><span class="o">]]</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Get my plugin on the system correctly</span>
</span><span class='line'><span class="ss">nagios</span><span class="p">:</span><span class="ss">:plugin</span> <span class="p">{</span> <span class="s1">&#39;docker_status&#39;</span><span class="p">:</span>
</span><span class='line'>   <span class="n">source</span> <span class="o">=&gt;</span> <span class="s1">&#39;nagios/nagios-plugins/docker_status.rb&#39;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># WARNING: TOTAL HACK PLEASE DON&#39;T JUDGE ME</span>
</span><span class='line'><span class="nb">exec</span> <span class="p">{</span> <span class="s1">&#39;/bin/echo &quot;command[docker_status]=/usr/lib/nagios/plugins/docker_status&quot; &gt;&gt; /etc/nagios/nrpe.cfg&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="nb">require</span> <span class="o">=&gt;</span> <span class="no">File</span><span class="o">[</span><span class="s1">&#39;/etc/nagios/nrpe.cfg&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>  <span class="n">notify</span> <span class="o">=&gt;</span> <span class="no">Service</span><span class="o">[</span><span class="s1">&#39;nrpe&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Ensure docker and nagios are in the same group</span>
</span><span class='line'><span class="nb">exec</span> <span class="p">{</span><span class="s1">&#39;/usr/sbin/usermod -a -G docker nagios&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="nb">require</span> <span class="o">=&gt;</span> <span class="no">Class</span><span class="o">[</span><span class="s1">&#39;nagios&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>  <span class="n">notify</span>  <span class="o">=&gt;</span> <span class="no">Service</span><span class="o">[</span><span class="s1">&#39;nrpe&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="ss">nagios</span><span class="p">:</span><span class="ss">:command</span> <span class="p">{</span> <span class="s1">&#39;docker_status&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="n">command_line</span> <span class="o">=&gt;</span> <span class="s1">&#39;$USER1$/check_nrpe -H $HOSTADDRESS$ -c docker_status&#39;</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Set the nagiosadmin password </span>
</span><span class='line'><span class="nb">exec</span> <span class="p">{</span> <span class="s1">&#39;/usr/bin/htpasswd -cb /etc/nagios3/htpasswd.users nagiosadmin nagiosadmin&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="nb">require</span> <span class="o">=&gt;</span> <span class="no">Class</span><span class="o">[</span><span class="s1">&#39;nagios&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># I wrote my plugin in Ruby so lets make sure the VM has it. </span>
</span><span class='line'><span class="n">package</span> <span class="p">{</span> <span class="s1">&#39;ruby1.9.1&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="k">ensure</span> <span class="o">=&gt;</span> <span class="n">present</span><span class="p">,</span>
</span><span class='line'>  <span class="nb">require</span> <span class="o">=&gt;</span> <span class="no">Class</span><span class="o">[</span><span class="s1">&#39;nagios&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Yup, I had a couple of hero hacks in there to get around some issues with the <code>docker::run</code> define. That define should work, but  kept failing with a very odd &lsquo;&lt;&lt; is not a {}:hash&rsquo; error. I grep&#8217;ed through the module to try and find where this was coming from and I think it&rsquo;s a heredoc within a function for the define. I still need to look into it. I ran an exec after the image is downloaded to get around this problem.</p>

<p>I also hero hacked the update to the <code>nrpe.cfg</code> file as the Nagios module I used didn&rsquo;t make it clearly evident how or if it did this.</p>

<p>&hellip; In no way do any of these hacks make me an &ldquo;inpatient&rdquo; person.</p>

<h2>The Nagios Plugin</h2>

<p>Recall my plugin should monitor:</p>

<ol>
<li>Is the docker command available?</li>
<li>Is the webapp running?

<ul>
<li>Ensures webapp is running on <code>localhost:5000</code></li>
<li>Checks the log for 404 errors and sends warnings if so</li>
<li>Counts the errors for each URL with a 404 and outputs the count and URL which has the highest hit count</li>
<li>test the above by trying <code>10.10.33.2:5000/test</code> over and over again</li>
</ul>
</li>
</ol>


<h3>Let&rsquo;s break it down</h3>

<h4>Nagios Basics:</h4>

<p>First, let&rsquo;s define some basic outputs for the Nagios API. Since Nagios is only looking for specific exit codes from any given script we define those as methods here first.</p>

<pre><code>0 = OK
1 = Shit is potentially hitting the fan
2 = Shit is hitting the fan
3 = Unknown shit is happening
</code></pre>

<h4>The first part of my Plugin defines these:</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/bin/ruby</span>
</span><span class='line'><span class="c1"># Checks the docker status command for number of running containers</span>
</span><span class='line'><span class="c1"># Ensures the docker container is running by checking that the socket exists</span>
</span><span class='line'><span class="c1"># </span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Define some helper methods for Nagios with appropriate exit codes</span>
</span><span class='line'><span class="k">def</span> <span class="nf">ok</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;OK - </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="mi">0</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">critical</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Critical - </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="mi">2</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">warning</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Warning - </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="mi">1</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">unknown</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Unknown - </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="mi">3</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Check to ensure docker is installed</h4>

<p>Now let&rsquo;s check to ensure Docker is installed, we can use a simple <code>system()</code> method which returns exit codes only:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">docker_installed</span><span class="p">()</span>
</span><span class='line'>  <span class="k">if</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;which docker &gt; /dev/null&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">webapp_status</span><span class="p">()</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>      <span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Docker isn&#39;t installed&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Yup, it&rsquo;s that easy, <code>which docker</code> will return &lsquo;0&rsquo; or &lsquo;false&rsquo; if it does not find the command and &lsquo;1&rsquo; or &lsquo;true&rsquo; if a path to the command is found. This isn&rsquo;t the most robust check ever, but for now it&rsquo;s enough to move on. Since all my other def&rsquo;s work on the <code>docker</code> face and it&rsquo;s sub commands I need to ensure this is present before doing anything else.</p>

<h4>Check the webapp status</h4>

<p>First, I want to make sure the webapp is running on the VM on a specific port. I&rsquo;m going to use a <code>netstat</code> command and <code>awk</code> to return the process running on port 5000:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">webapp_status</span><span class="p">()</span>
</span><span class='line'>  <span class="c1"># Ensure the webapp is running on localhost:5000</span>
</span><span class='line'>  <span class="n">webapp_run</span> <span class="o">=</span> <span class="sb">`netstat -anp | grep 5000 | awk &#39;{print $7}&#39; | cut -d/ -f2`</span>
</span><span class='line'>  <span class="n">should_be</span>   <span class="o">=</span> <span class="s2">&quot;docker&quot;</span>
</span><span class='line'>  <span class="n">webapp_run</span><span class="o">.</span><span class="n">chomp!</span><span class="o">.</span><span class="n">strip!</span>
</span></code></pre></td></tr></table></div></figure>


<p>This should return this this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@nagios:/home/vagrant# netstat -anp | grep 5000 | awk <span class="s1">&#39;{print $7}&#39;</span> | cut -d/ -f2
</span><span class='line'>docker
</span></code></pre></td></tr></table></div></figure>


<p>Then we pass this into some basic &lsquo;if&rsquo; logic:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="k">if</span> <span class="n">webapp_run</span> <span class="o">==</span> <span class="n">should_be</span>
</span><span class='line'>      <span class="c1"># Check to ensure there are no 404 errors in the log</span>
</span><span class='line'>      <span class="n">check_this</span> <span class="o">=</span> <span class="s2">&quot;docker logs $(docker ps -l | awk &#39;{print $1}&#39; | awk &#39;{if (NR == 2){print $0}}&#39;) 2&gt;&amp;1 | grep 404 | awk &#39;{print $7}&#39; | sort | uniq -c&quot;</span>
</span><span class='line'>      <span class="n">check</span> <span class="o">=</span> <span class="nb">system</span><span class="p">(</span><span class="n">check_this</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">check</span>
</span><span class='line'>          <span class="no">IO</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="n">check_this</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">io</span><span class="o">|</span>
</span><span class='line'>              <span class="n">line</span>  <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">readlines</span>
</span><span class='line'>              <span class="n">errors</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>              <span class="n">line</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">this</span><span class="o">|</span>
</span><span class='line'>                  <span class="n">number</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>                  <span class="n">url</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>                  <span class="n">errors</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>   
</span><span class='line'>              <span class="k">end</span>  
</span><span class='line'>              <span class="n">max_value</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">max</span>
</span><span class='line'>              <span class="n">max_key</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span><span class="o">==</span><span class="n">max_value</span> <span class="p">}</span><span class="o">.</span><span class="n">keys</span>  
</span><span class='line'>              <span class="k">case</span> <span class="n">max_value</span><span class="o">.</span><span class="n">to_i</span> <span class="o">&gt;</span> <span class="mi">20</span>
</span><span class='line'>                  <span class="k">when</span> <span class="kp">false</span>
</span><span class='line'>                      <span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">max_value</span><span class="si">}</span><span class="s2"> 404 Errors at localhost</span><span class="si">#{</span><span class="n">max_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>                  <span class="k">when</span> <span class="kp">true</span>
</span><span class='line'>                      <span class="n">critical</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">max_value</span><span class="si">}</span><span class="s2"> 404 Errors at localhost</span><span class="si">#{</span><span class="n">max_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="k">end</span>
</span><span class='line'>          <span class="k">end</span>  
</span></code></pre></td></tr></table></div></figure>


<p>Lot&rsquo;s of things are happening there.</p>

<p>1st, if &lsquo;docker&rsquo; is the output of the webapp status command we drop into another loop. This loop runs a <code>check_this</code> command that is derived from the <code>docker log</code> face. That particular face feeds the output from a sys-log-like to the terminals stdin.</p>

<p>But first, <code>docker logs</code> needs to have the process hash of the container you want to query, so I run a <code>docker ps -l</code> and <code>awk</code> for the hash of the process I want.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@nagios:/home/vagrant# docker ps -l
</span><span class='line'>CONTAINER ID        IMAGE                    COMMAND             CREATED             STATUS              PORTS                    NAMES
</span><span class='line'>c968cced9f32        training/webapp:latest   python app.py       33 minutes ago      Up 33 minutes       0.0.0.0:5000-&gt;5000/tcp   berserk_pare
</span></code></pre></td></tr></table></div></figure>


<p>This would definitely break if you had many containers running.</p>

<p>So anyways, if we have that hash we can now pass it to <code>docker logs</code> like I did in the ruby script like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">root</span><span class="vi">@nagios</span><span class="ss">:/</span><span class="n">home</span><span class="o">/</span><span class="n">vagrant</span><span class="c1"># docker logs c968cced9f32</span>
</span><span class='line'> <span class="o">*</span> <span class="no">Running</span> <span class="n">on</span> <span class="ss">http</span><span class="p">:</span><span class="sr">//</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="p">:</span><span class="mi">5000</span><span class="o">/</span>
</span></code></pre></td></tr></table></div></figure>


<p>Tight.</p>

<p>Now that I have access to the log from the webapp I can grep URL&rsquo;s which have 404 errors, add those to a hash as k,v&rsquo;s and then iterate over the hash for the key with the largest value.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">IO</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="n">check_this</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">io</span><span class="o">|</span>
</span><span class='line'>  <span class="n">line</span>  <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">readlines</span>
</span><span class='line'>  <span class="n">errors</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>  <span class="n">line</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">this</span><span class="o">|</span>
</span><span class='line'>      <span class="n">number</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>      <span class="n">url</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>      <span class="n">errors</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>   
</span><span class='line'>  <span class="k">end</span>  
</span><span class='line'>  <span class="n">max_value</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">max</span>
</span><span class='line'>  <span class="n">max_key</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span><span class="o">==</span><span class="n">max_value</span> <span class="p">}</span><span class="o">.</span><span class="n">keys</span>  
</span></code></pre></td></tr></table></div></figure>


<p>Now I can use that key&rsquo;s value to hit my <code>warning</code> or <code>critical</code> methods.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">case</span> <span class="n">max_value</span><span class="o">.</span><span class="n">to_i</span> <span class="o">&gt;</span> <span class="mi">20</span>
</span><span class='line'><span class="k">when</span> <span class="kp">false</span>
</span><span class='line'>  <span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">max_value</span><span class="si">}</span><span class="s2"> 404 Errors at localhost</span><span class="si">#{</span><span class="n">max_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">when</span> <span class="kp">true</span>
</span><span class='line'>  <span class="n">critical</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">max_value</span><span class="si">}</span><span class="s2"> 404 Errors at localhost</span><span class="si">#{</span><span class="n">max_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Of course, the end to this giant loop of loops does&hellip;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>     <span class="k">else</span>
</span><span class='line'>          <span class="n">ok</span><span class="p">(</span><span class="s2">&quot;Docker &amp; Webapp are in good shape!&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>      <span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Webapp is not running on localhost:5000&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>&hellip; and finally start it</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">docker_installed</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>My entire script looks like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Full </span>
</span><span class='line'><span class="c1">#!/usr/bin/ruby</span>
</span><span class='line'><span class="c1"># Checks the docker status command for number of running containers</span>
</span><span class='line'><span class="c1"># Ensures the docker container is running by checking that the socket exists</span>
</span><span class='line'><span class="c1"># </span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Define some helper methods for Nagios with appropriate exit codes</span>
</span><span class='line'><span class="k">def</span> <span class="nf">ok</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;OK - </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="mi">0</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">critical</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Critical - </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="mi">2</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">warning</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Warning - </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="mi">1</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">unknown</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Unknown - </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="mi">3</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Check to ensure docker is installed</span>
</span><span class='line'><span class="k">def</span> <span class="nf">docker_installed</span><span class="p">()</span>
</span><span class='line'>  <span class="k">if</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;which docker &gt; /dev/null&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">webapp_status</span><span class="p">()</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>      <span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Docker isn&#39;t installed&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">webapp_status</span><span class="p">()</span>
</span><span class='line'>  <span class="c1"># Ensure the webapp is running on localhost:5000</span>
</span><span class='line'>  <span class="n">webapp_run</span> <span class="o">=</span> <span class="sb">`netstat -anp | grep 5000 | awk &#39;{print $7}&#39; | cut -d/ -f2`</span>
</span><span class='line'>  <span class="n">should_be</span>   <span class="o">=</span> <span class="s2">&quot;docker&quot;</span>
</span><span class='line'>  <span class="n">webapp_run</span><span class="o">.</span><span class="n">chomp!</span><span class="o">.</span><span class="n">strip!</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">webapp_run</span> <span class="o">==</span> <span class="n">should_be</span>
</span><span class='line'>      <span class="c1"># Check to ensure there are no 404 errors in the log</span>
</span><span class='line'>      <span class="n">check_this</span> <span class="o">=</span> <span class="s2">&quot;docker logs $(docker ps -l | awk &#39;{print $1}&#39; | awk &#39;{if (NR == 2){print $0}}&#39;) 2&gt;&amp;1 | grep 404 | awk &#39;{print $7}&#39; | sort | uniq -c&quot;</span>
</span><span class='line'>      <span class="n">check</span> <span class="o">=</span> <span class="nb">system</span><span class="p">(</span><span class="n">check_this</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">check</span>
</span><span class='line'>          <span class="no">IO</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="n">check_this</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">io</span><span class="o">|</span>
</span><span class='line'>              <span class="n">line</span>  <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">readlines</span>
</span><span class='line'>              <span class="n">errors</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>              <span class="n">line</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">this</span><span class="o">|</span>
</span><span class='line'>                  <span class="n">number</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>                  <span class="n">url</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>                  <span class="n">errors</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>   
</span><span class='line'>              <span class="k">end</span>  
</span><span class='line'>              <span class="n">max_value</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">max</span>
</span><span class='line'>              <span class="n">max_key</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span><span class="o">==</span><span class="n">max_value</span> <span class="p">}</span><span class="o">.</span><span class="n">keys</span>  
</span><span class='line'>              <span class="k">case</span> <span class="n">max_value</span><span class="o">.</span><span class="n">to_i</span> <span class="o">&gt;</span> <span class="mi">20</span>
</span><span class='line'>                  <span class="k">when</span> <span class="kp">false</span>
</span><span class='line'>                      <span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">max_value</span><span class="si">}</span><span class="s2"> 404 Errors at localhost</span><span class="si">#{</span><span class="n">max_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>                  <span class="k">when</span> <span class="kp">true</span>
</span><span class='line'>                      <span class="n">critical</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">max_value</span><span class="si">}</span><span class="s2"> 404 Errors at localhost</span><span class="si">#{</span><span class="n">max_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="k">end</span>
</span><span class='line'>          <span class="k">end</span>  
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>          <span class="n">ok</span><span class="p">(</span><span class="s2">&quot;Docker &amp; Webapp are in good shape!&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>      <span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Webapp is not running on localhost:5000&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">docker_installed</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>




		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-06-24T12:19:43-07:00" pubdate data-updated="true">Jun 24<span>th</span>, 2014</time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/06/03/continuous-integration-with-puppet-code/">
		
			Continuous Integration With Puppet Code</a>
	</h2>
	<div class="entry-content">
		<iframe src="http://www.slideshare.net/slideshow/embed_code/35435020" width="427" height="356" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px 1px 0; margin-bottom:5px; max-width: 100%;" allowfullscreen> </iframe>


<p> <div style="margin-bottom:5px"> <strong> <a href="https://www.slideshare.net/malnick/continuous-integration-withpuppet" title="Continuous integration with_puppet" target="_blank">Continuous integration with_puppet</a> </strong> from <strong><a href="http://www.slideshare.net/malnick" target="_blank">malnick</a></strong> </div></p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-06-03T07:54:12-07:00" pubdate data-updated="true">Jun 3<span>rd</span>, 2014</time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/05/29/packer-templates-and-vmware/">
		
			Packer Templates &amp; VMWare</a>
	</h2>
	<div class="entry-content">
		<h2>tl;dr</h2>

<p>There&rsquo;s not a lot of docs on Packer and the logging can be tricky to find sometimes depending on the vm you&rsquo;re booting (which provider backs it). If you&rsquo;re using VMWare and you&rsquo;re booting centos the <code>guest_os_type</code> key needs to be set appropriatly.</p>

<p>Some people seem to think this can be $anything that sounds reasonable (I did!) and there is no documentation on what should actually go there (as of writing this, Google was sparce). So if you have a doubt on what the <code>guest_os_type</code> value should be the best bet is to <code>$ diff</code> it with an already existing <code>*.your_vm_type</code> (&lsquo;vmx&rsquo;, &lsquo;ovf&rsquo;, et cetera).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cat centos65-puppetmaster.json | grep -i guest_os_type
</span><span class='line'>    <span class="s2">&quot;guest_os_type&quot;</span>: <span class="s2">&quot;centos-65&quot;</span>,
</span></code></pre></td></tr></table></div></figure>


<p>However, if I query an already built <code>*.vmx</code> this is incorrect:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cat master2.vmx | grep -i guestos
</span><span class='line'>   <span class="nv">guestos</span> <span class="o">=</span> <span class="s2">&quot;redhat&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>For CentOS at least, your <code>guest_os_type</code> value should be set to <code>redhat</code>.</p>

<h2>Back Story</h2>

<p>This week I was working with a customer to automate the deployment of some VM&rsquo;s to vSphere. This deployment is replaceing some current scripts and manually configured templates. Actually, a lot of scripts and manually configured templates.</p>

<p>The long and the short of it, me and my team decided to implement Vagrant and Packer to push out pre-written Packer templates to vSphere via Vagrant&rsquo;s vSphere plugin using the VMWare provider.</p>

<p>After scripting the json for this node I ran <code>packer build centos65.json</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">==</span>&gt; vmware-iso: Downloading or copying <span class="nv">ISO</span>
</span><span class='line'><span class="o">==</span>&gt; vmware-iso: Downloading or copying ISO
</span><span class='line'>vmware-iso: Downloading or copying: http://mirrors.kernel.org/centos/6.5/isos/x86_64/CentOS-6.5
</span><span class='line'><span class="o">==</span>&gt; vmware-iso: Creating virtual machine <span class="nv">disk</span>
</span><span class='line'><span class="o">==</span>&gt; vmware-iso: Building and writing VMX <span class="nv">file</span>
</span><span class='line'><span class="o">==</span>&gt; vmware-iso: Starting HTTP server on port <span class="nv">8582</span>
</span><span class='line'><span class="o">==</span>&gt; vmware-iso: Starting virtual machine...
</span><span class='line'><span class="o">==</span>&gt; vmware-iso: Error starting VM: VMware error:
</span><span class='line'><span class="o">==</span>&gt; vmware-iso: Deleting output directory...
</span><span class='line'>Build <span class="s1">&#39;vmware-iso&#39;</span> errored: Error starting VM: VMware error:
</span><span class='line'><span class="o">==</span>&gt; Some builds didn<span class="err">&#39;</span>t <span class="nb">complete </span>successfully and had errors:
</span><span class='line'>--&gt; vmware-iso: Error starting VM: VMware error:
</span><span class='line'>
</span><span class='line'><span class="o">==</span>&gt; Builds finished but no artifacts were created.
</span></code></pre></td></tr></table></div></figure>


<p>The vm booted into fusion and opened but failed in <code>vmrun</code>. How did I know that was the issue?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>grep -r vmrun /var/log/*
</span><span class='line'>system.log:May 29 05:30:32 bohr vmrun<span class="o">[</span>13249<span class="o">]</span>: com.vmware.fusion.78704: Invalid argument
</span><span class='line'>... <span class="c"># lots of other crap </span>
</span></code></pre></td></tr></table></div></figure>


<p>BUT WHAT ARGUMENT???</p>

<p>After digging around I found that logging for this issue was sketchy at best. Syslog, <code>/var/tmp/vmware</code>, the <code>guest_os_type</code> key needs to have an appropriate value (i.e., arugment from syslog):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cat centos65-puppetmaster.json | grep -i guest_os_type
</span><span class='line'>    <span class="s2">&quot;guest_os_type&quot;</span>: <span class="s2">&quot;centos-65&quot;</span>,
</span></code></pre></td></tr></table></div></figure>


<p>However, if I query an already built <code>*.vmx</code> this is incorrect:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cat master2.vmx | grep -i guestos
</span><span class='line'>   <span class="nv">guestos</span> <span class="o">=</span> <span class="s2">&quot;redhat&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>After changing the k,v in the json template and running <code>packer build</code> the vmrun command ran successfully.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-05-29T12:19:53-07:00" pubdate data-updated="true">May 29<span>th</span>, 2014</time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/05/16/r10k-control-repos/">
		
			R10k: Control Repos</a>
	</h2>
	<div class="entry-content">
		<p>This document explains the architecture and deployment of a control repository for syncing multiple puppet environments, their associated puppet code (modules) and their assocaited data (hiera). This document does not review how to deploy r10k, however that is discussed in relevant detail <a href="https://github.com/puppetlabs/prosvcs-malnick/blob/master/README.md#deploy-git-r10k-and-stuff">here</a>.</p>

<h2>What is a control repo?</h2>

<p>A control repository stores a Puppetfile and hiera data (hiera.yaml and hieradata/).</p>

<h3>What does it contain?</h3>

<pre><code>hieradata/
Puppetfile
</code></pre>

<p>It is also common to have a <code>hiera.yaml</code> in the control repo. However <a href="http://www.jeffmalnick.com/blog/2014/05/15/hiera-and-r10k/">for many reasons</a> I don&rsquo;t believe this is a good idea. It can lead to confusing issues with branching of the file that is only consulted once for it&rsquo;s <code>$datadir</code> path and is not used on a per environment basis &ndash; it&rsquo;s loaded once from <code>$confdir</code> during the <em>hiera()</em> call and is not consulted on a per environment basis (e.g. <code>$confdir/environments/$environments/hiera.yaml</code> <strong>is not used</strong> during the <em>hiera()</em> lookup, only <code>$confdir/hiera.yaml</code> is used).</p>

<h2>How does it work?</h2>

<p>The control repo is placed in a monolithic git repository.</p>

<p>The repository can have one or more topic branches that are used by r10k to sync to local Puppet environments.</p>

<h3>Configuration for Puppet code &amp; Hiera data sync via r10k</h3>

<p>Details on how to deploy a gitlab repo and assocaited topic branching for r10k sync are <a href="https://github.com/puppetlabs/prosvcs-malnick/blob/master/README.md#deploy-git-r10k-and-stuff">here</a>.</p>

<p>Place a Puppetfile in <code>$confdir/Puppetfile</code>.</p>

<p>Populate your Puppetfile with what ever crap you need.</p>

<p>In <code>$confdir</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git init
</span><span class='line'>git remote add origin git@whatever.com:your_name/control_repo.git
</span><span class='line'>git branch -m master production
</span><span class='line'>git add Puppetfile
</span><span class='line'>git add hiera.yaml <span class="c"># r10k really doesn&#39;t need this but we&#39;ll add it anyways. </span>
</span><span class='line'>git add hieradata/
</span><span class='line'>git push -u origin production:production <span class="c"># or whatever branch, maybe production?</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Configure hiera.yaml for dynamic environments</h3>

<p><strong>NOTE</strong>: the hiera.yaml is only loaded from <code>$confdir/hiera.yaml</code> on each puppet run, this means even though you&rsquo;ll have a hiera.yaml in <code>$confdir/environments/$environment/</code> those are not actually consulted, only the $confdir hiera.yaml is used &ndash; therefore, <strong><em>you can not have hierarchies per environment</em></strong>. Since the <code>$datadir</code> is environment aware that namespace is filled at run time, and consults the specific environment datadir <code>$confdir/environments/$environment/hieradata/</code>.</p>

<p>Your hiera.yaml needs to have a <code>datadir</code> configured for dynamic lookup so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="l-Scalar-Plain">:backends</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">yaml</span>
</span><span class='line'><span class="l-Scalar-Plain">:hierarchy</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="s">&quot;%{clientcert}&quot;</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="s">&quot;%{environment}&quot;</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">global</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">:yaml</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">:datadir</span><span class="p-Indicator">:</span> <span class="s">&#39;/etc/puppetlabs/puppet/environments/%{::environment}/hieradata&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Branching your Puppetfile</h3>

<p>For example, assuming you already have a master or production branch:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vi Puppetfile
</span></code></pre></td></tr></table></div></figure>


<p>&hellip;add some git modules etc&hellip;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git checkout -b development
</span><span class='line'>git push origin development:development
</span><span class='line'>git commit -am Puppetfile
</span><span class='line'>r10k deploy environment -pv
</span></code></pre></td></tr></table></div></figure>


<p>Now you have a new topic branch &lsquo;development&rsquo; and a new Puppet environment in <code>$confdir/environments/development</code>.</p>

<h3>Branching your hiera data</h3>

<p>Our <code>development</code> branch needs it&rsquo;s own data too:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span> <span class="nv">$confdir</span>/hieradata
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>modify K,V&rsquo;s in <code>whatever.yaml</code></li>
<li>modify other K,V&rsquo;s as needed for your development environment</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git branch <span class="c"># check your branch, make sure it&#39;s still development</span>
</span><span class='line'>git commit -am hieradata
</span><span class='line'>git push
</span><span class='line'>r10k deploy environment -pv
</span></code></pre></td></tr></table></div></figure>


<p>Check <code>$confdir/environments/development/hieradata</code></p>

<h2>Testing</h2>

<h3>Configuration files for r10k, hiera, puppet:</h3>

<h4>/etc/r10k.yaml</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@master hieradata<span class="o">]</span><span class="c"># cat /etc/r10k.yaml</span>
</span><span class='line'>:cachedir: /var/cache/r10k
</span><span class='line'>:sources:
</span><span class='line'>  puppet:
</span><span class='line'>    remote: <span class="s2">&quot;git@10.10.100.111:user/control_repo.git&quot;</span>
</span><span class='line'>    basedir: /etc/puppetlabs/puppet/environments
</span><span class='line'>    prefix: <span class="nb">false</span>
</span><span class='line'>:purgedirs:
</span><span class='line'>  - <span class="s2">&quot;&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h4>/etc/puppetlabs/puppet/puppet.conf</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> cat /etc/puppetlabs/puppet/puppet.conf
</span><span class='line'><span class="o">[</span>main<span class="o">]</span>
</span><span class='line'><span class="nv">certname</span> <span class="o">=</span> master.puppetlabs.vm
</span><span class='line'><span class="nv">dns_alt_names</span> <span class="o">=</span> master.puppetlabs.vm,puppet
</span><span class='line'><span class="nv">vardir</span> <span class="o">=</span> /var/opt/lib/pe-puppet
</span><span class='line'><span class="nv">logdir</span> <span class="o">=</span> /var/log/pe-puppet
</span><span class='line'><span class="nv">rundir</span> <span class="o">=</span> /var/run/pe-puppet
</span><span class='line'><span class="nv">modulepath</span> <span class="o">=</span> /etc/puppetlabs/puppet/environments/<span class="nv">$environment</span>/modules:/opt/puppet/share/puppet/modules
</span><span class='line'><span class="nv">server</span> <span class="o">=</span> master.puppetlabs.vm
</span><span class='line'><span class="nv">user</span>  <span class="o">=</span> pe-puppet
</span><span class='line'><span class="nv">group</span> <span class="o">=</span> pe-puppet
</span><span class='line'><span class="nv">archive_files</span> <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'><span class="nv">archive_file_server</span> <span class="o">=</span> master.puppetlabs.vm
</span><span class='line'><span class="c"># cut [master] &amp; [agent] sections, $modulepath above is the important config key here.</span>
</span></code></pre></td></tr></table></div></figure>


<h4>/etc/puppetlabs/puppet/hiera.yaml</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> cat hiera.yaml
</span><span class='line'>---
</span><span class='line'>:backends:
</span><span class='line'>  - yaml
</span><span class='line'>:hierarchy:
</span><span class='line'>  - <span class="s2">&quot;%{clientcert}&quot;</span>
</span><span class='line'>  - <span class="s2">&quot;%{environment}&quot;</span>
</span><span class='line'>  - global
</span><span class='line'>:yaml:
</span><span class='line'>  :datadir: <span class="s1">&#39;/etc/puppetlabs/puppet/environmets/%{environment}/hieradata&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h4>/etc/puppetlabs/puppet/Puppetfile</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span><span class="c"># cat Puppetfile</span>
</span><span class='line'><span class="c"># mod, &lt;module name&gt;, &lt;version or tag&gt;, &lt;source&gt;</span>
</span><span class='line'>forge <span class="s2">&quot;http://forge.puppetlabs.com&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Modules from the Puppet Forge</span>
</span><span class='line'>mod <span class="s2">&quot;puppetlabs/stdlib&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;puppetlabs/apache&quot;</span>, <span class="s2">&quot;0.11.0&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;puppetlabs/pe_gem&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;puppetlabs/mysql&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;puppetlabs/firewall&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;puppetlabs/vcsrepo&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;puppetlabs/git&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;puppetlabs/inifile&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;zack/r10k&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;gentoo/portage&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;thias/vsftpd&quot;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c"># Modules from Github using various references</span>
</span><span class='line'>mod <span class="s2">&quot;wordpress&quot;</span>,
</span><span class='line'>  :git <span class="o">=</span>&gt; <span class="s2">&quot;git://github.com/hunner/puppet-wordpress.git&quot;</span>,
</span><span class='line'>  :ref <span class="o">=</span>&gt; <span class="s1">&#39;0.4.0&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Testing the Puppet Master <code>master.puppetlabs.vm:$confdir/</code>:</h3>

<h4>Our topic branches:</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> git branch
</span><span class='line'>  development
</span><span class='line'>* production
</span><span class='line'>  staging
</span></code></pre></td></tr></table></div></figure>


<h4>For the given topic branch above, production, let&rsquo;s look at our hieradata in <code>$confdir/hieradata</code>:</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> <span class="nb">pwd</span>
</span><span class='line'>/etc/puppetlabs/puppet/hieradata
</span><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> ls
</span><span class='line'>agent1.puppetlabs.vm.yaml  agent2.puppetlabs.vm.yaml  agent3.puppetlabs.vm.yaml  master.puppetlabs.vm.yaml
</span></code></pre></td></tr></table></div></figure>


<h4>and for each of these files we have the same K,V:</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> cat master.puppetlabs.vm.yaml
</span><span class='line'>---
</span><span class='line'>message: <span class="s2">&quot;%{fqdn} is running in environment %{environment}&quot;</span>
</span><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> cat agent1.puppetlabs.vm.yaml
</span><span class='line'>---
</span><span class='line'>message: <span class="s2">&quot;%{fqdn} is running in environment %{environment}&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Now let&rsquo;s switch over to our development branch and compare:</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> git checkout development
</span><span class='line'>Switched to branch <span class="s1">&#39;development&#39;</span>
</span><span class='line'>root@master hieradata<span class="o">]</span> <span class="nb">pwd</span>
</span><span class='line'>/etc/puppetlabs/puppet/hieradata
</span><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> ls
</span><span class='line'>agent1.puppetlabs.vm.yaml  agent2.puppetlabs.vm.yaml  agent3.puppetlabs.vm.yaml  master.puppetlabs.vm.yaml
</span><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> cat agent1.puppetlabs.vm.yaml
</span><span class='line'>---
</span><span class='line'>message: <span class="s2">&quot;%{fqdn} is running in environment %{environment}&quot;</span>
</span><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> cat master.puppetlabs.vm.yaml
</span><span class='line'>---
</span><span class='line'>message: <span class="s2">&quot;%{fqdn} is running in environment %{environment}&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Sync everything up with r10k so we can test:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> r10k deploy environment -pv
</span><span class='line'><span class="o">[</span>R10K::Task::Deployment::DeployEnvironments - INFO<span class="o">]</span> Loading environments from all sources
</span><span class='line'><span class="o">[</span>R10K::Task::Environment::Deploy - NOTICE<span class="o">]</span> Deploying environment staging
</span><span class='line'><span class="o">[</span>R10K::Task::Puppetfile::Sync - INFO<span class="o">]</span> Loading modules from Puppetfile into queue
</span><span class='line'><span class="o">[</span>R10K::Task::Environment::Deploy - NOTICE<span class="o">]</span> Deploying environment production
</span><span class='line'><span class="o">[</span>R10K::Task::Puppetfile::Sync - INFO<span class="o">]</span> Loading modules from Puppetfile into queue
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying wordpress into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying vsftpd into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying portage into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying r10k into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying inifile into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying git into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying vcsrepo into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying firewall into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying mysql into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying pe_gem into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying apache into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying stdlib into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Environment::Deploy - NOTICE<span class="o">]</span> Deploying environment master
</span><span class='line'><span class="o">[</span>R10K::Task::Puppetfile::Sync - INFO<span class="o">]</span> Loading modules from Puppetfile into queue
</span><span class='line'><span class="o">[</span>R10K::Task::Environment::Deploy - NOTICE<span class="o">]</span> Deploying environment development
</span><span class='line'><span class="o">[</span>R10K::Task::Puppetfile::Sync - INFO<span class="o">]</span> Loading modules from Puppetfile into queue
</span><span class='line'><span class="o">[</span>R10K::Task::Deployment::PurgeEnvironments - INFO<span class="o">]</span> Purging stale environments from /etc/puppetlabs/puppet/environments
</span></code></pre></td></tr></table></div></figure>


<p>Since there is a <code>%{certname}.yaml</code> for the master we can do a quick check on the command line that we&rsquo;re accessing the correct data:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> git checkout production
</span><span class='line'>Already on <span class="s1">&#39;production&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> puppet apply -e <span class="s2">&quot;notice(hiera(message))&quot;</span>
</span><span class='line'>Notice: Scope<span class="o">(</span>Class<span class="o">[</span>main<span class="o">])</span>: master.puppetlabs.vm is running in environment production
</span><span class='line'>Notice: Compiled catalog <span class="k">for </span>master.puppetlabs.vm in environment production in 0.06 seconds
</span><span class='line'>Notice: Finished catalog run in 0.24 seconds
</span><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>$fqdn</code> and <code>$environment</code> values were correctly filled in. <strong>Note</strong> that this is a poor test since my data files are essentially all the same, <code>$environment</code> will always match it&rsquo;s environment and <code>$fqdn</code> will always match it&rsquo;s fqdn &ndash;  we could be grabbing this value from anywhere. So Let&rsquo;s try with hard coded values:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> <span class="nb">pwd</span>
</span><span class='line'>/etc/puppetlabs/puppet/hieradata
</span><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> git branch
</span><span class='line'>  development
</span><span class='line'>* production
</span><span class='line'>  staging
</span><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> cat master.puppetlabs.vm.yaml
</span><span class='line'>---
</span><span class='line'>message: <span class="s2">&quot;I&#39;m hard coding this value: environment production, master.puppetlabs.vm.yaml&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now push your new data for production branch up to gitlab</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span><span class="c"># git add hieradata/</span>
</span><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span><span class="c"># git commit -m &quot;hieradata hard coded&quot;</span>
</span><span class='line'><span class="o">[</span>production 3a58e49<span class="o">]</span> hieradata hard coded
</span><span class='line'> 1 files changed, 1 insertions<span class="o">(</span>+<span class="o">)</span>, 1 deletions<span class="o">(</span>-<span class="o">)</span>
</span><span class='line'> <span class="o">[</span>root@master puppet<span class="o">]</span><span class="c"># git push</span>
</span><span class='line'> Counting objects: 7, <span class="k">done</span>.
</span><span class='line'> Delta compression using up to 4 threads.
</span><span class='line'> Compressing objects: 100% <span class="o">(</span>4/4<span class="o">)</span>, <span class="k">done</span>.
</span><span class='line'> Writing objects: 100% <span class="o">(</span>4/4<span class="o">)</span>, 399 bytes, <span class="k">done</span>.
</span><span class='line'> Total 4 <span class="o">(</span>delta 2<span class="o">)</span>, reused 0 <span class="o">(</span>delta 0<span class="o">)</span>
</span><span class='line'> To git@10.10.100.111:user/control_repo.git
</span><span class='line'>    1b240c6..3a58e49  production -&gt; production
</span></code></pre></td></tr></table></div></figure>


<p>and sync r10k</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span><span class="c"># r10k deploy environment -pv</span>
</span><span class='line'><span class="o">[</span>R10K::Task::Deployment::DeployEnvironments - INFO<span class="o">]</span> Loading environments from all sources
</span><span class='line'><span class="o">[</span>R10K::Task::Environment::Deploy - NOTICE<span class="o">]</span> Deploying environment staging
</span><span class='line'><span class="o">[</span>R10K::Task::Puppetfile::Sync - INFO<span class="o">]</span> Loading modules from Puppetfile into queue
</span><span class='line'><span class="o">[</span>R10K::Task::Environment::Deploy - NOTICE<span class="o">]</span> Deploying environment production
</span><span class='line'><span class="o">[</span>R10K::Task::Puppetfile::Sync - INFO<span class="o">]</span> Loading modules from Puppetfile into queue
</span><span class='line'><span class="c"># ommitting other output ...</span>
</span></code></pre></td></tr></table></div></figure>


<p>and test for the correct hard coded K,V</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span><span class="c"># puppet apply -e &quot;notice(hiera(message))&quot;</span>
</span><span class='line'>Notice: Scope<span class="o">(</span>Class<span class="o">[</span>main<span class="o">])</span>: I<span class="err">&#39;</span>m hard coding this value: environment production, master.puppetlabs.vm.yaml
</span><span class='line'>Notice: Compiled catalog <span class="k">for </span>master.puppetlabs.vm in environment production in 0.05 seconds
</span><span class='line'>Notice: Finished catalog run in 0.26 seconds
</span></code></pre></td></tr></table></div></figure>


<p>YAY!</p>

<h4>And again on the development branch</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> <span class="nb">pwd</span>
</span><span class='line'>/etc/puppetlabs/puppet/hieradata
</span><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> git branch
</span><span class='line'>* development
</span><span class='line'>  production
</span><span class='line'>  staging
</span><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> cat hieradata/master.puppetlabs.vm.yaml
</span><span class='line'>---
</span><span class='line'>message: <span class="s2">&quot;I&#39;m hard coding this value: environment development, master.puppetlabs.vm.yaml&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Push our new hieradata for <code>development</code> to gitlab:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> git add hieradata/
</span><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> git commit -m <span class="s2">&quot;hieradata hard coded&quot;</span>
</span><span class='line'><span class="o">[</span>development 2873db5<span class="o">]</span> hieradata hard coded
</span><span class='line'> 1 files changed, 1 insertions<span class="o">(</span>+<span class="o">)</span>, 1 deletions<span class="o">(</span>-<span class="o">)</span>
</span><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> git push
</span><span class='line'>Counting objects: 7, <span class="k">done</span>.
</span><span class='line'>Delta compression using up to 4 threads.
</span><span class='line'>Compressing objects: 100% <span class="o">(</span>4/4<span class="o">)</span>, <span class="k">done</span>.
</span><span class='line'>Writing objects: 100% <span class="o">(</span>4/4<span class="o">)</span>, 398 bytes, <span class="k">done</span>.
</span><span class='line'>Total 4 <span class="o">(</span>delta 2<span class="o">)</span>, reused 0 <span class="o">(</span>delta 0<span class="o">)</span>
</span><span class='line'>To git@10.10.100.111:user/control_repo.git
</span><span class='line'>   08e249b..2873db5  development -&gt; development
</span></code></pre></td></tr></table></div></figure>


<p>andthen sync with r10k</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span><span class="c"># r10k deploy environment -pv</span>
</span><span class='line'><span class="o">[</span>R10K::Task::Deployment::DeployEnvironments - INFO<span class="o">]</span> Loading environments from all sources
</span><span class='line'><span class="o">[</span>R10K::Task::Environment::Deploy - NOTICE<span class="o">]</span> Deploying environment staging
</span><span class='line'><span class="o">[</span>R10K::Task::Puppetfile::Sync - INFO<span class="o">]</span> Loading modules from Puppetfile into queue
</span><span class='line'><span class="o">[</span>R10K::Task::Environment::Deploy - NOTICE<span class="o">]</span> Deploying environment production
</span><span class='line'><span class="o">[</span>R10K::Task::Puppetfile::Sync - INFO<span class="o">]</span> Loading modules from Puppetfile into queue
</span><span class='line'><span class="c"># ommitted the other output...</span>
</span></code></pre></td></tr></table></div></figure>


<p>and test with the <code>--environment development</code> switch</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span><span class="c"># puppet apply -e &quot;notice(hiera(message))&quot; --environment development</span>
</span><span class='line'>Notice: Scope<span class="o">(</span>Class<span class="o">[</span>main<span class="o">])</span>: I<span class="err">&#39;</span>m hard coding this value: environment development, master.puppetlabs.vm.yaml
</span><span class='line'>Notice: Compiled catalog <span class="k">for </span>master.puppetlabs.vm in environment development in 0.05 seconds
</span><span class='line'>Notice: Finished catalog run in 0.25 seconds
</span></code></pre></td></tr></table></div></figure>


<p>`</p>

<p>We can also do a quick one time environment run with the <code>--environment</code> flag:</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-05-16T12:34:33-07:00" pubdate data-updated="true">May 16<span>th</span>, 2014</time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/05/15/hiera-and-r10k/">
		
			Why I Don&#8217;t Place a hiera.yaml in My CR</a>
	</h2>
	<div class="entry-content">
		<p>Here&rsquo;s a really good reason. First off, unless your hiera.yaml is super complicated, then it probably doesn&rsquo;t need to be in version control. However, for a lot of deployments you need it in VC, but not in your control repo (i.e., the one that r10k will access for Puppetfile, hieradata and build our corrosponding enviros for on your master).</p>

<p>No, place that hiera.yaml in it&rsquo;s own VC repo.</p>

<p>I had a control repo with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Puppetfile
</span><span class='line'>hieradata/
</span><span class='line'>hiera.yaml</span></code></pre></td></tr></table></div></figure>


<p>and I kept running in to this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@master hieradata]# puppet apply -e "notice(hiera(message))"
</span><span class='line'>Error: Could not find data item message in any Hiera data file and no default supplied at line 1 on node master.puppetlabs.vm</span></code></pre></td></tr></table></div></figure>


<p>This was a very simple test to see if my <code>production</code> environment was grabbing the correct data via a message K,V in <code>$confdir/environments/production/hieradata/master.puppetlabs.vm.yaml</code> .</p>

<p>Check out the &mdash;debug</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Debug: hiera(): Hiera YAML backend starting
</span><span class='line'>Debug: hiera(): Looking up message in YAML backend
</span><span class='line'>Debug: hiera(): Looking for data source master.puppetlabs.vm
</span><span class='line'>Debug: hiera(): Cannot find datafile /etc/puppetlabs/puppet/environmets/production/hieradata/master.puppetlabs.vm.yaml, skipping
</span><span class='line'>Debug: hiera(): Looking for data source production
</span><span class='line'>Debug: hiera(): Cannot find datafile /etc/puppetlabs/puppet/environmets/production/hieradata/production.yaml, skipping
</span><span class='line'>Debug: hiera(): Looking for data source global
</span><span class='line'>Debug: hiera(): Cannot find datafile /etc/puppetlabs/puppet/environmets/production/hieradata/global.yaml, skipping</span></code></pre></td></tr></table></div></figure>


<p>So I copied the <code>datafile</code> path and redirected it to a diff along with a &#8220;`$(pwd) while in the /etc/puppetlabs/puppet/environments/production/hieradata directory:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@master hieradata]# diff &lt;(echo "/etc/puppetlabs/puppet/environmets/production/hieradata/") &lt;(echo "$(pwd)")
</span><span class='line'>1c1
</span><span class='line'>&lt; /etc/puppetlabs/puppet/environmets/production/hieradata/
</span><span class='line'>---
</span><span class='line'>&gt; /etc/puppetlabs/puppet/environments/production/hieradata</span></code></pre></td></tr></table></div></figure>


<p>So the <code>$datadir</code> path in hiera.yaml</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@master puppet]# cat hiera.yaml | grep datadir
</span><span class='line'>  :datadir: '/etc/puppetlabs/puppet/environmets/%{environment}/hieradata'</span></code></pre></td></tr></table></div></figure>


<p>is indeed missing that f-ing &lsquo;n&rsquo;. Why? Because this was the second time this happened to me today.</p>

<p>Really? The second time? Really. The second fucking time.</p>

<p>I previously committed hiera.yaml along with hieradata/ and my Puppetfile to branch production. I tested it and came across this problem. Did the same test to figure out the correct path and updated hiera.yaml.</p>

<p>However, hiera.yaml was also in my development and staging branches. I didn&rsquo;t update those. So here I was again doing tests on development data for Puppet and <strong>boom</strong> my shit&rsquo;s broken again.</p>

<p>Since hiera.yaml is only used singularly on a puppet run, i.e., it&rsquo;s not consulted on a per environment basis, you only need one copy of it, and that&rsquo;s the one in your puppet $confdir. Having it scattered to the winds with r10k in the control repo does not give you any extra functionality (yet, someday we might make it enviro aware, but currently is not the case).</p>

<p>So if you&rsquo;re going to run your hiera.yaml into a VCS then do it in it&rsquo;s own monolithic repo. You can symlink it into the $confdir for Puppet.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-05-15T16:12:36-07:00" pubdate data-updated="true">May 15<span>th</span>, 2014</time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/05/04/continous-integration-hooks-with-r10k-and-puppet/">
		
			Continous Integration Hooks With R10k &amp; Puppet</a>
	</h2>
	<div class="entry-content">
		<p>A week ago I was modifiying a webhook to run r10k on push to a git repository. The goal here was to sync up r10k everytime a push was made to the repo. However, in doing so I found that the <a href="https://github.com/acidprime/r10k/blob/master/templates/usr/local/bin/webhook.erb">current</a> hook didn&rsquo;t take advantage of deploying a specific puppet environmnet, and instead runs a full r10k sync across all topic branchs and thus all puppet environments.</p>

<p>I figured the first place to start was modifying the <a href="https://github.com/acidprime/r10k/blob/master/templates/usr/local/bin/webhook.erb#L35">&lsquo;post&rsquo;</a> method:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">post</span> <span class="s1">&#39;/payload&#39;</span> <span class="k">do</span>
</span><span class='line'>      <span class="c1">#protected!</span>
</span><span class='line'>      <span class="n">deploy</span><span class="p">()</span>
</span><span class='line'>    <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p> to parse the json sent by git (in this case I was integrating with gitlab) for the <a href="http://demo.gitlab.com/help/web_hooks">ref branch</a>. So the &lsquo;post&rsquo; hook now looks like <a href="https://github.com/malnick/r10k/blob/master/templates/usr/local/bin/webhook.erb#L52">this</a>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">post</span> <span class="s1">&#39;/payload&#39;</span> <span class="k">do</span>
</span><span class='line'>    <span class="c1">#protected!</span>
</span><span class='line'>    <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">rewind</span>  <span class="c1"># in case someone already read it</span>
</span><span class='line'>    <span class="n">data</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">read</span>
</span><span class='line'>    <span class="n">branch</span> <span class="o">=</span> <span class="n">data</span><span class="o">[</span><span class="s1">&#39;ref&#39;</span><span class="o">].</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>    <span class="s2">&quot;ref branch: </span><span class="si">#{</span><span class="n">branch</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="c1">#deploy(refs)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>So the #branch effectively is our puppet environment that we want to pass to the r10k mcollective agent so we can deploy a specific puppet enviro and not sync across all topic branches/enviros. This will make it lightweight.</p>

<p>However, I ran into a blocker in the mcollective r10k agent itself. I want to pass this argument to it so I can sync all r10k nodes at once from this hook based on the ref branch the current r10k <a href="https://github.com/acidprime/r10k/blob/master/files/agent/r10k.rb#L28">agent</a> does not accept any arugments and only syncs across all topic branches using the &lsquo;syncronize&rsquo; method.</p>

<p>In order to pass this ref branch in and leverage &lsquo;r10k deploy environmnet #{topic_branch}&rsquo; as I&rsquo;m attempting here the agent will need to be modified to parse the argument.</p>

<p><a href="https://github.com/acidprime/r10k/blob/master/files/agent/r10k.rb#L28">Zach&rsquo;s current r10k agent</a> is pretty good, so we&rsquo;ll stick to modifying that (at this point I handed over the agent writing to a colleague Andrew Brader since I was sent to a training site and he had a week/time to modifying the mco agent):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>     <span class="k">def</span> <span class="nf">run_cmd</span><span class="p">(</span><span class="n">action</span><span class="p">,</span><span class="n">path</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>        <span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>        <span class="n">git</span>  <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;/usr/bin/env&#39;</span><span class="p">,</span> <span class="s1">&#39;git&#39;</span><span class="o">]</span>
</span><span class='line'>        <span class="n">r10k</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;/usr/bin/env&#39;</span><span class="p">,</span> <span class="s1">&#39;r10k&#39;</span><span class="o">]</span>
</span><span class='line'>        <span class="k">case</span> <span class="n">action</span>
</span><span class='line'>        <span class="k">when</span> <span class="s1">&#39;push&#39;</span><span class="p">,</span><span class="s1">&#39;pull&#39;</span><span class="p">,</span><span class="s1">&#39;status&#39;</span>
</span><span class='line'>          <span class="n">cmd</span> <span class="o">=</span> <span class="n">git</span>
</span><span class='line'>          <span class="n">cmd</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;push&#39;</span>   <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;push&#39;</span>
</span><span class='line'>          <span class="n">cmd</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;pull&#39;</span>   <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;pull&#39;</span>
</span><span class='line'>          <span class="n">cmd</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;status&#39;</span> <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;status&#39;</span>
</span><span class='line'>          <span class="n">reply</span><span class="o">[</span><span class="ss">:status</span><span class="o">]</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="ss">:stderr</span> <span class="o">=&gt;</span> <span class="ss">:error</span><span class="p">,</span> <span class="ss">:stdout</span> <span class="o">=&gt;</span> <span class="ss">:output</span><span class="p">,</span> <span class="ss">:chomp</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">:cwd</span> <span class="o">=&gt;</span> <span class="n">path</span> <span class="p">)</span>
</span><span class='line'>        <span class="k">when</span> <span class="s1">&#39;cache&#39;</span><span class="p">,</span><span class="s1">&#39;environment&#39;</span><span class="p">,</span><span class="s1">&#39;module&#39;</span><span class="p">,</span><span class="s1">&#39;synchronize&#39;</span><span class="p">,</span><span class="s1">&#39;sync&#39;</span><span class="p">,</span> <span class="s1">&#39;deploy_all&#39;</span>
</span><span class='line'>          <span class="n">cmd</span> <span class="o">=</span> <span class="n">r10k</span>
</span><span class='line'>          <span class="n">cmd</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;cache&#39;</span>       <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;cache&#39;</span>
</span><span class='line'>          <span class="n">cmd</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;synchronize&#39;</span> <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;synchronize&#39;</span> <span class="ow">or</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;sync&#39;</span>
</span><span class='line'>          <span class="n">cmd</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;environment&#39;</span> <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;environment&#39;</span>
</span><span class='line'>          <span class="n">cmd</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;module&#39;</span>      <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;module&#39;</span>
</span><span class='line'>          <span class="n">cmd</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;deploy&#39;</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;environment&#39;</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;-p&#39;</span> <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;deploy_all&#39;</span>
</span><span class='line'>          <span class="n">reply</span><span class="o">[</span><span class="ss">:status</span><span class="o">]</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="ss">:stderr</span> <span class="o">=&gt;</span> <span class="ss">:error</span><span class="p">,</span> <span class="ss">:stdout</span> <span class="o">=&gt;</span> <span class="ss">:output</span><span class="p">,</span> <span class="ss">:chomp</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
</span><span class='line'>        <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>In order to parse the topic branch from the hook we need to add a method, which Andrew did <a href="https://github.com/abrader/r10k/blob/master/files/agent/r10k.rb#L59">here</a>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>      <span class="k">def</span> <span class="nf">deploy_only_cmd</span><span class="p">(</span><span class="n">r10k_env</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>        <span class="n">output</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>        <span class="n">r10k</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;/usr/bin/env&#39;</span><span class="p">,</span> <span class="s1">&#39;r10k&#39;</span><span class="o">]</span>
</span><span class='line'>        <span class="n">cmd</span> <span class="o">=</span> <span class="n">r10k</span>
</span><span class='line'>        <span class="n">cmd</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;deploy&#39;</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;environment&#39;</span> <span class="o">&lt;&lt;</span> <span class="n">r10k_env</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;-p&#39;</span>
</span><span class='line'>        <span class="n">reply</span><span class="o">[</span><span class="ss">:status</span><span class="o">]</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">deploy_only_cmd</span><span class="p">,</span> <span class="ss">:stderr</span> <span class="o">=&gt;</span> <span class="ss">:error</span><span class="p">,</span> <span class="ss">:stdout</span> <span class="o">=&gt;</span> <span class="ss">:output</span><span class="p">,</span> <span class="ss">:chomp</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Testing the new hook &amp; agent</h3>

<p>&hellip; to be updated shortly&hellip;</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-05-04T07:47:05-07:00" pubdate data-updated="true">May 4<span>th</span>, 2014</time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/04/19/puppet-types-understanding-parameters-and-properties/">
		
			Puppet Types: Understanding Parameters and Properties</a>
	</h2>
	<div class="entry-content">
		<p>When starting out with Types and Providers for Puppet it&rsquo;s common to misunderstand when something is a <em>Parameter</em> and when something is a <em>Property</em>.</p>

<h3><strong>Properties</strong></h3>

<p>Properties are anything that will <strong>modify</strong> a resource. In other words, attributes of a type that will change how that resource type exists on your system. A property is a charactaristic of a resource. A property does not change what a resource is, which is where the confusion usually begins.</p>

<p>For example, let&rsquo;s take the file resource (anyone who has had the opportunity of taking Extending Puppet for Developers might find this redundant).</p>

<pre><code>file {'/tmp/test':
    ensure   =&gt; file,
    path     =&gt; '/tmp/test', # $namevar
    owner    =&gt; 'root',
    group    =&gt; 'root',
    checksum =&gt; 'md5',
    content  =&gt; 'foo',
    }
</code></pre>

<p>Any ideas which attributes are parameters and which are properties? Let&rsquo;s start with</p>

<pre><code>ensure =&gt; file,
</code></pre>

<p>The &lsquo;ensure&rsquo; attribute is actually created by the &lsquo;ensurable&rsquo; method from the Puppet::Type class. Any attribute calling &lsquo;ensurable&rsquo; gets the default &lsquo;present&#8217;and &#8216;absent&rsquo; values telling the type to call from the provider &lsquo;exists?()&rsquo; then based on output from &lsquo;exists?&rsquo; evaluates &lsquo;creates()&rsquo; or &lsquo;destroy()&rsquo;.</p>

<p>Ensure modifies the resource, but does not change the definition of what that resource is to the system, therefore ensure is a property.</p>

<p>Other properties of file are</p>

<pre><code>owner
group
content
</code></pre>

<p>Content? Yes, content. On a file system the content of the file does not define the file, the <em>$path</em> to the file is the definition of a file. Therefore content is just a charactaristic of that file, making that attribute a property as well.</p>

<h3><strong>Parameters</strong></h3>

<p>Parameters are used by Puppet to provision the resource onto the system. Parameters are resource attributes that can be retrieved and are used to create, or define the resource as it exists on the system.</p>

<pre><code>path =&gt; '/tmp/testing',
</code></pre>

<p>For example, the $namevar of the the file resource is the $path. That&rsquo;s because the $path of a file defines the resource on the system. You can query the path of a file, however if you change the path of a file you define an entierly new file. Therefore, $path is a parameter.</p>

<p>Another parameter of file would the checksum attribute. The checksum type is used when determining whether to replace a file’s contents. If your md5 checksum does not match the md5 checksum of the file on the system your file will be created; if it does match your file will not be updated if it exists; if it doesn&rsquo;t exist if will be provisioned. Checksum defines what the file should look like on the system; it&rsquo;s used by Puppet to provision the file but not stored as part of the file resource.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-04-19T08:30:28-07:00" pubdate data-updated="true">Apr 19<span>th</span>, 2014</time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/03/20/brief-intro-to-puppetizing-stig-compliance/">
		
			Brief Intro to Puppetizing STIG Compliance</a>
	</h2>
	<div class="entry-content">
		<p>STIG is a methodology for the implementation of security compliance across heterogeneous operating systems. Every OS has a specific STIG. The STIG for a given OS is maintained and distributed by the Defense Information Systems Agency (DISA). Current STIGs can be found on the <a href="http://iase.disa.mil/stigs/">DISA website</a>.</p>

<p>Puppet is an excellent tool for bringing machines into STIG compliance. At my previous job I was in <a href="https://github.com/malnick/do_debian_stig/blob/master/do_debian_stig.sh">shell script hell</a> until we spun up a POS master and started writing a STIG module that worked across all OS&rsquo;s we supported (14 linux distros, 30 territorial sys admins, ~250 nodes).</p>

<p>In doing a STIG module for puppet it’s best to just work from Cat 1 down. 1 &amp; 2 offenses are pretty big, 3 &amp; 4 are usually minor security patches and can be overlooked if you’re time crunched. Staying on top of the false positives and keeping your module up to date with actual security implementation is the biggest hurdle.</p>

<p>This document is a general guideline from my experience in implementing STIG compliance measures.</p>

<h3>Basic STIG Process</h3>

<ol>
<li><p>Go to the DISA site and download the STIG for the appropriate OS</p></li>
<li><p>Do some sort of benchmark scan on a base OS:</p>

<ul>
<li>I used retina (which is awful) scans that were preloaded with the appropriate <a href="http://www.public.navy.mil/spawar/Atlantic/ProductsServices/Pages/SCAP.aspx">Security Content Automation Protocol (SCAP)</a> documents (.xml files, see below).</li>
<li> You can also get SCAP benchmarks on the DISA site for the appropriate OS listed with the STIG benchmarks (see below on SCAP)</li>
</ul>
</li>
<li><p>Take retina report with categorized vulnerabilities and start writing puppet modules &ndash; oh wait, just kidding! first you’ll need to:</p>

<ol type="a">
<li> Check for false positives &ndash; in most cases the OS provider is way ahead of the game, and simply running ‘apt-get update’ or ‘yum update’ will take care of 80% of the vulnerabilities on the box. STIG guidelines are notoriously behind the OS and will have LOTS of false positives. Most of your time will be spent accounting for what is actually a vulnerability and what is actually already patched by the OS provider.</li>
</ol>
</li>
<li><p>What vulnerabilities are left after cross correlating with security patches are what you have to develop specified puppet classes for, this is actually the easy part.</p></li>
</ol>


<p>A really good resource for this is the <a href="https://fedorahosted.org/aqueduct/wiki/RhelStigProcess">Aqueduct Project</a> at Fedora. They’re really good about staying on top of the recent STIG process and also maintaining a set puppet module for STIGing RHEL boxes (or at least they used to, not sure what their status is now. A recent look shows they&rsquo;re only on RHEL 5 so&hellip;).</p>

<h3>SCAP</h3>

<p>The Security <a href="http://scap.nist.gov">Content Automation Protocol (SCAP)</a> is a protocol developed by the NSA puppet branch of government known as NIST for implementing IT security measures. Some parts of the protocol can be useful in scanning tools such as retina since the XML format for the vulnerability index are standardized.</p>

<p>For example, when you are on the DISA site looking at the current STIG for a specific OS there will be a download button for &lsquo;SCAP Benchmarks&rsquo;. This is a .zip of several .xml&rsquo;s that contain:</p>

<p><a href="http://scap.nist.gov/specifications/cpe/">Common Platform Enumeration (CPE)</a> files for describing and identifying classes of applications, operating systems, and hardware devices present among an enterprise&rsquo;s computing assets.</p>

<p><a href="http://oval.mitre.org">Open Vulnerability and Assessment Language (OVAL)</a> for assessing and reporting upon the rachine state.</p>

<p><a href="http://scap.nist.gov/specifications/xccdf/index.html">Extensible Configuration Checklist Description Format (XCCDF)</a> which is a structured collection of security configuration rules for some set of target systems.</p>

<p>&hellip; and maybe some other random ones as well.</p>

<p>This is a document in motion so I&rsquo;ll be adding more here, feel free to add as you find information as well.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-03-20T10:01:05-07:00" pubdate data-updated="true">Mar 20<span>th</span>, 2014</time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/03/20/rspec-testing-puppet-enterprise-modules/">
		
			How to Install Rspec-Puppet on Puppet Enterprise</a>
	</h2>
	<div class="entry-content">
		<p>If you&rsquo;re getting into rspec testing for your manifests you might already know this:  Puppet Enterprise has it&rsquo;s own gem environment. This is a quick post on how to install rspec-puppet to your PE gem environment.</p>

<p>If you&rsquo;re new to rspec-puppet check out <a href="www.rspec-puppet.com">this great site</a> for a brief on installing (except if you&rsquo;re on PE, then follow the install below). rspec-puppet.com also has a great tutorial to get your up and running.</p>

<h3>Installing rspec-puppet on Puppet Enterprise</h3>

<p>If you&rsquo;ve already installed rspec-puppet via system gem you will get this error on rspec-puppet-init:</p>

<pre><code>[root@master users]# rspec-puppet-init 
/usr/lib/ruby/site_ruby/1.8/rubygems/custom_require.rb:31:in `gem_original_require': no such file to load -- puppet (LoadError)
</code></pre>

<p>If you&rsquo;ve already installed rspec-puppet vis system gem:</p>

<pre><code>$ /usr/bin/gem uninstall rspec-puppet
</code></pre>

<p>Once system rspec-puppet is removed:</p>

<pre><code>$ /opt/puppet/bin/gem install rspec-puppet
</code></pre>

<p>Then to init a new puppet rspec enviro in your $moduledir:</p>

<pre><code>$ /opt/puppet/bin/rspec-puppet-init
</code></pre>

<p>This should build:</p>

<pre><code>+ spec/
+ spec/classes/
+ spec/defines/
+ spec/functions/
+ spec/hosts/
+ spec/fixtures/
+ spec/fixtures/manifests/
+ spec/fixtures/modules/
+ spec/fixtures/modules/users/
+ spec/fixtures/manifests/site.pp
+ spec/fixtures/modules/users/manifests
+ spec/fixtures/modules/users/lib
+ spec/spec_helper.rb
+ Rakefile
</code></pre>

<h3>Installing PE-Specific Gems using PE-Gem Provider</h3>

<p><a href="https://github.com/puppetlabs/puppetlabs-pe_gem">puppetlabs/pe_gem</a> has the provider for pe_gem so you can simply:</p>

<pre><code>package { 'json':
    ensure   =&gt; present,
    provider =&gt; pe_gem,
    }
</code></pre>

<p>That&rsquo;s it!</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-03-20T09:42:50-07:00" pubdate data-updated="true">Mar 20<span>th</span>, 2014</time></div>
	


	
</div></article>

<nav id="pagenavi">
    
    
        <a href="/blog/page/2/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav></div>
	<footer id="footer" class="inner">Copyright &copy; 2014

    Jeff

<br>
Powered by Octopress.
</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






</body>
</html>
