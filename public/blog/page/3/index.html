
<!DOCTYPE HTML>
<html>
<head>
	<script data-cfasync="false" type="text/javascript" src="//use.typekit.net/axj3cfp.js"></script>
	<script data-cfasync="false" type="text/javascript">try{Typekit.load();}catch(e){}</script>
	<meta charset="utf-8">
	<title>a techy blog  | JP</title>

<meta name="author" content="Jeff"> 

<meta name="description" content="See subtitle."> <meta name="keywords" content="">

	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="JP" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/stylesheets/font-awesome.min.css" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script type="text/javascript" src="/javascripts/jquery.fancybox.pack.js"></script>

<script language="Javascript" type="text/javascript">
$(document).ready(
  function() {
    (function($) {
      $(".fancybox[data-content-id]").each(function() {
        this.href = $(this).data('content-id');
      });
      $(".fancybox").fancybox({
        beforeLoad: function() {
          var el, 
              id = $(this.element).data('title-id');

          if (id) {
            el = $('#' + id);

            if (el.length) {
              this.title = el.html();
            }
          }
          if ($(this).data('content')) {
            this.content = $(this).data('content');
          }
        },
        helpers: {
          title: {
            type: 'inside'
          }
        }
      });
    })(jQuery);
  }
);
</script>

	
</head>



<body>
	<header id="header" class="inner"><h1><a href="/">JP</a></h1>
<h4>a techy blog</h4>
<nav id="main-nav"><ul>
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/about">About</a></li>
	<li><a href="/blog/resume">Resume</a></li>
	<li><a href="/archives">Archive</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul>
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/about">About</a></li>
	<li><a href="/blog/resume">Resume</a></li>
	<li><a href="/archives">Archive</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:httpL://www.jeffmalnick.com">
			</form>
		</div>
	</div>
</nav>


</header>

	<div id="content" class="inner">


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/04/19/puppet-types-understanding-parameters-and-properties/">
		
			Puppet Types: Understanding Parameters and Properties</a>
	</h2>
	<div class="entry-content">
		<p>When starting out with Types and Providers for Puppet it&rsquo;s common to misunderstand when something is a <em>Parameter</em> and when something is a <em>Property</em>.</p>

<h3><strong>Properties</strong></h3>

<p>Properties are anything that will <strong>modify</strong> a resource. In other words, attributes of a type that will change how that resource type exists on your system. A property is a charactaristic of a resource. A property does not change what a resource is, which is where the confusion usually begins.</p>

<p>For example, let&rsquo;s take the file resource (anyone who has had the opportunity of taking Extending Puppet for Developers might find this redundant).</p>

<pre><code>file {'/tmp/test':
    ensure   =&gt; file,
    path     =&gt; '/tmp/test', # $namevar
    owner    =&gt; 'root',
    group    =&gt; 'root',
    checksum =&gt; 'md5',
    content  =&gt; 'foo',
    }
</code></pre>

<p>Any ideas which attributes are parameters and which are properties? Let&rsquo;s start with</p>

<pre><code>ensure =&gt; file,
</code></pre>

<p>The &lsquo;ensure&rsquo; attribute is actually created by the &lsquo;ensurable&rsquo; method from the Puppet::Type class. Any attribute calling &lsquo;ensurable&rsquo; gets the default &lsquo;present&#8217;and &#8216;absent&rsquo; values telling the type to call from the provider &lsquo;exists?()&rsquo; then based on output from &lsquo;exists?&rsquo; evaluates &lsquo;creates()&rsquo; or &lsquo;destroy()&rsquo;.</p>

<p>Ensure modifies the resource, but does not change the definition of what that resource is to the system, therefore ensure is a property.</p>

<p>Other properties of file are</p>

<pre><code>owner
group
content
</code></pre>

<p>Content? Yes, content. On a file system the content of the file does not define the file, the <em>$path</em> to the file is the definition of a file. Therefore content is just a charactaristic of that file, making that attribute a property as well.</p>

<h3><strong>Parameters</strong></h3>

<p>Parameters are used by Puppet to provision the resource onto the system. Parameters are resource attributes that can be retrieved and are used to create, or define the resource as it exists on the system.</p>

<pre><code>path =&gt; '/tmp/testing',
</code></pre>

<p>For example, the $namevar of the the file resource is the $path. That&rsquo;s because the $path of a file defines the resource on the system. You can query the path of a file, however if you change the path of a file you define an entierly new file. Therefore, $path is a parameter.</p>

<p>Another parameter of file would the checksum attribute. The checksum type is used when determining whether to replace a file’s contents. If your md5 checksum does not match the md5 checksum of the file on the system your file will be created; if it does match your file will not be updated if it exists; if it doesn&rsquo;t exist if will be provisioned. Checksum defines what the file should look like on the system; it&rsquo;s used by Puppet to provision the file but not stored as part of the file resource.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-04-19T08:30:28-07:00" pubdate data-updated="true">Apr 19<span>th</span>, 2014</time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/03/20/brief-intro-to-puppetizing-stig-compliance/">
		
			Brief Intro to Puppetizing STIG Compliance</a>
	</h2>
	<div class="entry-content">
		<p>STIG is a methodology for the implementation of security compliance across heterogeneous operating systems. Every OS has a specific STIG. The STIG for a given OS is maintained and distributed by the Defense Information Systems Agency (DISA). Current STIGs can be found on the <a href="http://iase.disa.mil/stigs/">DISA website</a>.</p>

<p>Puppet is an excellent tool for bringing machines into STIG compliance. At my previous job I was in <a href="https://github.com/malnick/do_debian_stig/blob/master/do_debian_stig.sh">shell script hell</a> until we spun up a POS master and started writing a STIG module that worked across all OS&rsquo;s we supported (14 linux distros, 30 territorial sys admins, ~250 nodes).</p>

<p>In doing a STIG module for puppet it’s best to just work from Cat 1 down. 1 &amp; 2 offenses are pretty big, 3 &amp; 4 are usually minor security patches and can be overlooked if you’re time crunched. Staying on top of the false positives and keeping your module up to date with actual security implementation is the biggest hurdle.</p>

<p>This document is a general guideline from my experience in implementing STIG compliance measures.</p>

<h3>Basic STIG Process</h3>

<ol>
<li><p>Go to the DISA site and download the STIG for the appropriate OS</p></li>
<li><p>Do some sort of benchmark scan on a base OS:</p>

<ul>
<li>I used retina (which is awful) scans that were preloaded with the appropriate <a href="http://www.public.navy.mil/spawar/Atlantic/ProductsServices/Pages/SCAP.aspx">Security Content Automation Protocol (SCAP)</a> documents (.xml files, see below).</li>
<li> You can also get SCAP benchmarks on the DISA site for the appropriate OS listed with the STIG benchmarks (see below on SCAP)</li>
</ul>
</li>
<li><p>Take retina report with categorized vulnerabilities and start writing puppet modules &ndash; oh wait, just kidding! first you’ll need to:</p>

<ol type="a">
<li> Check for false positives &ndash; in most cases the OS provider is way ahead of the game, and simply running ‘apt-get update’ or ‘yum update’ will take care of 80% of the vulnerabilities on the box. STIG guidelines are notoriously behind the OS and will have LOTS of false positives. Most of your time will be spent accounting for what is actually a vulnerability and what is actually already patched by the OS provider.</li>
</ol>
</li>
<li><p>What vulnerabilities are left after cross correlating with security patches are what you have to develop specified puppet classes for, this is actually the easy part.</p></li>
</ol>


<p>A really good resource for this is the <a href="https://fedorahosted.org/aqueduct/wiki/RhelStigProcess">Aqueduct Project</a> at Fedora. They’re really good about staying on top of the recent STIG process and also maintaining a set puppet module for STIGing RHEL boxes (or at least they used to, not sure what their status is now. A recent look shows they&rsquo;re only on RHEL 5 so&hellip;).</p>

<h3>SCAP</h3>

<p>The Security <a href="http://scap.nist.gov">Content Automation Protocol (SCAP)</a> is a protocol developed by the NSA puppet branch of government known as NIST for implementing IT security measures. Some parts of the protocol can be useful in scanning tools such as retina since the XML format for the vulnerability index are standardized.</p>

<p>For example, when you are on the DISA site looking at the current STIG for a specific OS there will be a download button for &lsquo;SCAP Benchmarks&rsquo;. This is a .zip of several .xml&rsquo;s that contain:</p>

<p><a href="http://scap.nist.gov/specifications/cpe/">Common Platform Enumeration (CPE)</a> files for describing and identifying classes of applications, operating systems, and hardware devices present among an enterprise&rsquo;s computing assets.</p>

<p><a href="http://oval.mitre.org">Open Vulnerability and Assessment Language (OVAL)</a> for assessing and reporting upon the rachine state.</p>

<p><a href="http://scap.nist.gov/specifications/xccdf/index.html">Extensible Configuration Checklist Description Format (XCCDF)</a> which is a structured collection of security configuration rules for some set of target systems.</p>

<p>&hellip; and maybe some other random ones as well.</p>

<p>This is a document in motion so I&rsquo;ll be adding more here, feel free to add as you find information as well.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-03-20T10:01:05-07:00" pubdate data-updated="true">Mar 20<span>th</span>, 2014</time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/03/20/rspec-testing-puppet-enterprise-modules/">
		
			How to Install Rspec-Puppet on Puppet Enterprise</a>
	</h2>
	<div class="entry-content">
		<p>If you&rsquo;re getting into rspec testing for your manifests you might already know this:  Puppet Enterprise has it&rsquo;s own gem environment. This is a quick post on how to install rspec-puppet to your PE gem environment.</p>

<p>If you&rsquo;re new to rspec-puppet check out <a href="www.rspec-puppet.com">this great site</a> for a brief on installing (except if you&rsquo;re on PE, then follow the install below). rspec-puppet.com also has a great tutorial to get your up and running.</p>

<h3>Installing rspec-puppet on Puppet Enterprise</h3>

<p>If you&rsquo;ve already installed rspec-puppet via system gem you will get this error on rspec-puppet-init:</p>

<pre><code>[root@master users]# rspec-puppet-init 
/usr/lib/ruby/site_ruby/1.8/rubygems/custom_require.rb:31:in `gem_original_require': no such file to load -- puppet (LoadError)
</code></pre>

<p>If you&rsquo;ve already installed rspec-puppet vis system gem:</p>

<pre><code>$ /usr/bin/gem uninstall rspec-puppet
</code></pre>

<p>Once system rspec-puppet is removed:</p>

<pre><code>$ /opt/puppet/bin/gem install rspec-puppet
</code></pre>

<p>Then to init a new puppet rspec enviro in your $moduledir:</p>

<pre><code>$ /opt/puppet/bin/rspec-puppet-init
</code></pre>

<p>This should build:</p>

<pre><code>+ spec/
+ spec/classes/
+ spec/defines/
+ spec/functions/
+ spec/hosts/
+ spec/fixtures/
+ spec/fixtures/manifests/
+ spec/fixtures/modules/
+ spec/fixtures/modules/users/
+ spec/fixtures/manifests/site.pp
+ spec/fixtures/modules/users/manifests
+ spec/fixtures/modules/users/lib
+ spec/spec_helper.rb
+ Rakefile
</code></pre>

<h3>Installing PE-Specific Gems using PE-Gem Provider</h3>

<p><a href="https://github.com/puppetlabs/puppetlabs-pe_gem">puppetlabs/pe_gem</a> has the provider for pe_gem so you can simply:</p>

<pre><code>package { 'json':
    ensure   =&gt; present,
    provider =&gt; pe_gem,
    }
</code></pre>

<p>That&rsquo;s it!</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-03-20T09:42:50-07:00" pubdate data-updated="true">Mar 20<span>th</span>, 2014</time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/03/17/tls-slash-ssl-dh-cipher-padding-bug-in-activemq/">
		
			TLS/SSL DH Cipher Padding Bug in ActiveMQ</a>
	</h2>
	<div class="entry-content">
		<h3>Update</h3>

<p>As of March 18 it appears that Oracle has implemented a fix in their release of <a href="http://www.oracle.com/technetwork/java/javase/8train-relnotes-latest-2153846.html">JDK and Java Standard Edition version 8</a> and it&rsquo;s assocaited <a href="http://docs.oracle.com/javase/8/docs/technotes/guides/security/enhancements-8.html">security extensions</a>:</p>

<p>&ldquo;Support stronger ephemeral DH keys in the SunJSSE provider: Make ephemeral DH key match the length of the certificate key during SSL/TLS handshaking in the SunJSSE provider. A new system property, jdk.tls.ephemeralDHKeySize, is defined to customize the ephemeral DH key sizes. The minimum acceptable DH key size is 1024 bits, except for exportable cipher suites or legacy mode (jdk.tls.ephemeralDHKeySize=legacy). See Customizing Size of Ephemeral DH Keys and RFE 6956398.&rdquo;</p>

<hr />

<p>In helping a client with an ActiveMQ issue in Puppet Enterprise I recently stumbled across this line in their wrapper log:</p>

<pre><code>INFO | jvm 1 | 2014/02/26 12:47:20 | WARN | Transport Connection to: tcp://ip.removed:49867 failed: javax.net.ssl.SSLHandshake
Exception: Invalid Padding length: 239
</code></pre>

<p>The client thought this may have been exacberating a JVM memory problem, however I found it actually is a not related but in and of itself it&rsquo;s own  bug in the Java Security Extensions for Diffe-Helman cipher implementation over SSL.</p>

<p>We have seen similar issues in JDK 1.7x security extensions in other Java-powered backends for Puppet Enterprise such as <a href="http://projects.puppetlabs.com/issues/19884">PuppetDB</a>. It has also been documented on the <a href="https://issues.apache.org/jira/browse/APLO-287">Apache ActiveMQ ticket board</a> and the <a href="https://community.oracle.com/message/11001587">Oracle community</a> board.</p>

<p>The issue is dependant on:</p>

<pre><code>* OpenJDK Runtime Environment (PE Java 1.7.0.19) 
* Linux OS's (so far my testing is on CentOS 6x) 
* TLS_DHE_RSA_WITH_AES_128_CBC_SHA Cipher
* openssl-1.0.0-27.el6_4.2.x86_64
</code></pre>

<p>To sum up the problem, every few hundred messages that are encrypted over SSL or TLS using DH ciphers the client gets a handshake exception. The exception is caused by a faulty SSL packet.</p>

<h3>Oracle&rsquo;s Solution</h3>

<p><a href="http://bugs.java.com/bugdatabase/view_bug.do?bug_id=8013059">A ticket was submitted</a> to Java bugs and was set &ldquo;resolved&rdquo; on 2013-10-25. However, and this is a big however, their resolution is, &ldquo;In order to have reliable TLS handshakes, Diffie Hellman key exchanges must be disabled.&rdquo;</p>

<p>I personally don&rsquo;t like this resolution since DH keys are sometimes neccessary, and in terms of security is superior to standard RSA ciphers. DH ciphers provide perfect forward secrecy. That means even if the private key is compromised you can not decrypt past data. Ciper suites which use DHE-RSA-AES128-SHA all implement the slower, more secure ephemeral DH crypto &ndash; it&rsquo;s ephemeral since new random numbers that generate the key are used each time. This is also why it&rsquo;s slower. However, it&rsquo;s also harder to run a selected clear text attack on EDH since the private key is used for only authentication and use an independant method to agree on a shared secret &ndash; standard RSA ciphers employ the private key for both auth and encryption for better performance in exchange for not providing perfect forward secrecy.</p>

<p>You may now chime in with your own conspiracy theories as to why Oracle would settle for solving this cyrpto issue by simply using a less secure cipher &ndash; does the NSA not want Java applications, which function as the backbone to a great deal of web traffic, encrypting data with perfect forward secrecy?</p>

<h3>Workaround in AMQ</h3>

<p>Since there is no good way to get around this problem in JDK 1.7x security extensions you have two choices:</p>

<pre><code>1. Live with the error in approx. 5% of the SSL traffic
2. Run SSL with a non-DH or DHE cipher  
</code></pre>

<h4>Door #1</h4>

<p>Example, you&rsquo;ve got an AMQ broker administering messaging for 1000+ AMQ agents in a live management setup in Puppet Enterprise you&rsquo;ll see this error a lot, and it may (warning, assumption) degrade live management performance in such a large deployment.</p>

<p>If you can live with either seeing this error 5% of the time or you can live with the hit in performance sticking it out with DH can still work.</p>

<h4>Door #2</h4>

<p>You need the performance or are a stickler for perfect SSL key exchange.</p>

<p>A possible solution would be modifying the transportConnector in /etc/puppetlabs/activemq/activemq.xml:</p>

<pre><code>&lt;transportConnector name="openwire" uri="ssl://0.0.0.0:61616"/&gt;
&lt;!-- Puppet mcollective_enable_stomp_ssl=true
&lt;transportConnector name="stomp+ssl" uri="stomp+ssl://0.0.0.0:61613"/&gt;\
</code></pre>

<p>With the transport.enabledCipherSuites embedded:</p>

<pre><code>ssl://localhost:61616?transport.enabledCipherSuites=SSL_RSA_WITH_3DES_EDE_CBC_SHA
</code></pre>

<p>The SSL_RSA_WITH_3DES_EDE_CBC_SHA is non-DH cipher versus the  SSL_DH_anon_WITH_3DES_EDE_CBC_SHA which I think is what AMQ currently uses.</p>

<p>Note syntax:</p>

<pre><code>ssl://…?socket.enabledCipherSuites=THE_CIPHER # for agents 
</code></pre>

<p>and</p>

<pre><code>ssl://…?transport.enabledCipherSuites=THE_CIPHER # for brokers 
</code></pre>

<p>More information about this can be found on the <a href="https://activemq.apache.org/ssl-transport-reference.html">AMQ reference page</a></p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-03-17T16:23:11-07:00" pubdate data-updated="true">Mar 17<span>th</span>, 2014</time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/03/12/debugging-activemq-jvm-heap-memory-errors/">
		
			Debugging ActiveMQ JVM Heap Memory Errors</a>
	</h2>
	<div class="entry-content">
		<h2>This just happened:</h2>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>INFO   | jvm 1    | 2014/03/11 16:12:34 | Exception in thread "ActiveMQ BrokerService[ppm.prod.dc2.adpghs.com] Task-79" Exception in thread "ActiveMQ BrokerService[ppm.prod.dc2.adpghs.com] Task-101" Exception in thread "ActiveMQ BrokerService[ppm.prod.dc2.adpghs.com] Task-87" Exception in thread "ActiveMQ BrokerService[ppm.prod.dc2.adpghs.com] Task-30" Exception in thread "ActiveMQ BrokerService[ppm.prod.dc2.adpghs.com] Task-74" java.lang.OutOfMemoryError: unable to create new native thread</span></code></pre></td></tr></table></div></figure>


<p>Since this is on a production server you need to recreate it in a testing environment. Since I&rsquo;m partial to vagrant I stand up 4 agent nodes and a master via pe-build vagrant plugin. My Vagrantfile looks something like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># -*- mode: ruby -*-</span>
</span><span class='line'><span class="c1"># vi: set ft=ruby :</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Vagrantfile API/syntax version. Don&#39;t touch unless you know what you&#39;re doing!</span>
</span><span class='line'><span class="no">VAGRANTFILE_API_VERSION</span> <span class="o">=</span> <span class="s2">&quot;2&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="no">VAGRANTFILE_API_VERSION</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;centos-64-x64-nocm&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box_url</span> <span class="o">=</span> <span class="s2">&quot;http://puppet-vagrant-boxes.puppetlabs.com/centos-64-x64-fusion503-nocm.box&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">pe_build</span><span class="o">.</span><span class="n">version</span>       <span class="o">=</span> <span class="s1">&#39;3.1.0&#39;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">pe_build</span><span class="o">.</span><span class="n">download_root</span> <span class="o">=</span> <span class="s1">&#39;https://s3.amazonaws.com/pe-builds/released&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">## Master</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="ss">:master</span> <span class="k">do</span> <span class="o">|</span><span class="n">master</span><span class="o">|</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="ss">:vmware_fusion</span> <span class="k">do</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span>
</span><span class='line'>      <span class="n">v</span><span class="o">.</span><span class="n">vmx</span><span class="o">[</span><span class="s2">&quot;memsize&quot;</span><span class="o">]</span>  <span class="o">=</span> <span class="s2">&quot;4096&quot;</span>
</span><span class='line'>      <span class="n">v</span><span class="o">.</span><span class="n">vmx</span><span class="o">[</span><span class="s2">&quot;numvcpus&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;4&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;10.10.100.100&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;master.puppetlabs.vm&#39;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:hosts</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:pe_bootstrap</span> <span class="k">do</span> <span class="o">|</span><span class="n">pe</span><span class="o">|</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">role</span> <span class="o">=</span> <span class="ss">:master</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;service iptables stop&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">## agent 1</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="ss">:agent1</span> <span class="k">do</span> <span class="o">|</span><span class="n">agent</span><span class="o">|</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="ss">:vmware_fusion</span>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;10.10.100.111&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;agent1.puppetlabs.vm&#39;</span>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:hosts</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:pe_bootstrap</span> <span class="k">do</span> <span class="o">|</span><span class="n">pe</span><span class="o">|</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">role</span>   <span class="o">=</span>  <span class="ss">:agent</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">master</span> <span class="o">=</span> <span class="s1">&#39;master.puppetlabs.vm&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">## agent 2</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="ss">:agent2</span> <span class="k">do</span> <span class="o">|</span><span class="n">agent</span><span class="o">|</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="ss">:vmware_fusion</span>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;10.10.100.112&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;agent2.puppetlabs.vm&#39;</span>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:hosts</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:pe_bootstrap</span> <span class="k">do</span> <span class="o">|</span><span class="n">pe</span><span class="o">|</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">role</span>   <span class="o">=</span>  <span class="ss">:agent</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">master</span> <span class="o">=</span> <span class="s1">&#39;master.puppetlabs.vm&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">## agent 3</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="ss">:agent3</span> <span class="k">do</span> <span class="o">|</span><span class="n">agent</span><span class="o">|</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="ss">:vmware_fusion</span>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;10.10.100.113&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;agent3.puppetlabs.vm&#39;</span>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:hosts</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:pe_bootstrap</span> <span class="k">do</span> <span class="o">|</span><span class="n">pe</span><span class="o">|</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">role</span>   <span class="o">=</span>  <span class="ss">:agent</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">master</span> <span class="o">=</span> <span class="s1">&#39;master.puppetlabs.vm&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">## agent 4</span>
</span><span class='line'>   <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="ss">:agent4</span> <span class="k">do</span> <span class="o">|</span><span class="n">agent</span><span class="o">|</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="ss">:vmware_fusion</span> <span class="k">do</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span>
</span><span class='line'>      <span class="n">v</span><span class="o">.</span><span class="n">vmx</span><span class="o">[</span><span class="s2">&quot;memsize&quot;</span><span class="o">]</span>  <span class="o">=</span> <span class="s2">&quot;1024&quot;</span>
</span><span class='line'>      <span class="n">v</span><span class="o">.</span><span class="n">vmx</span><span class="o">[</span><span class="s2">&quot;numvcpus&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;2&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;10.10.100.114&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;agent4.puppetlabs.vm&#39;</span>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:hosts</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:pe_bootstrap</span> <span class="k">do</span> <span class="o">|</span><span class="n">pe</span><span class="o">|</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">role</span> <span class="o">=</span> <span class="ss">:agent</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">master</span> <span class="o">=</span> <span class="s1">&#39;master.puppetlabs.vm&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This error occured on an ActiveMQ install that works as the message que for a 1000 node deployment of puppet agents. To get terminology straight here, we have puppet agents and AMQ agents running on these 1000 nodes. They&rsquo;re all qued from a singular AMQ broker.</p>

<p>My first impression was that this error may be caused by having 1000 agents pinging a single AMQ broker, which is limited to 800 via fds instances.</p>

<p>I check locally on my test master:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master vagrant<span class="o">]</span><span class="c"># pgrep -f pe-activemq</span>
</span><span class='line'>1271
</span><span class='line'><span class="o">[</span>root@master vagrant<span class="o">]</span><span class="c"># cat /proc/1271/limits | grep files</span>
</span><span class='line'>Max open files            1024                 4096                 files
</span></code></pre></td></tr></table></div></figure>


<p>My soft limit is 1024 open files, and after rando .jars and logs and stuff that really feels like more around 800. So this is on the money, as far as what the docs say for ActiveMQ servers per broker.</p>

<h3>How am I going to recreate what a 1000 node enviro looks like?</h3>

<p>I&rsquo;m limited to my laptop, 16GB of memory, and I&rsquo;m too lazy to stand up 1000 instances in AWS (and to poor). So an attempt has to be made to recreate this memory error on my 5 nodes running locally.</p>

<p>Given the above information, I start open a shell, and ssh into my master:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master vagrant<span class="o">]</span><span class="c"># echo -n &quot;Max open files=3:3&quot; &gt; /proc/1271/limits</span>
</span><span class='line'><span class="o">[</span>root@master vagrant<span class="o">]</span><span class="c"># cat /proc/1271/limits | grep files</span>
</span><span class='line'>Max open files            3                    3                    files
</span></code></pre></td></tr></table></div></figure>


<p>Why 3? Because:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master vagrant<span class="o">]</span><span class="c"># ls /proc/1271/fd | wc -l</span>
</span><span class='line'>6
</span></code></pre></td></tr></table></div></figure>


<p>So a quick &lsquo;service pe-activemq restart&rsquo; and bang&hellip;</p>

<p>Oh shit, new PID, new proc instance. Damnit. I have to figure out something else to fake the resource limits here.</p>

<p>Since ulimit commands are shell-bound I can ssh into the master from another shell and run:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">[</span><span class="n">root</span><span class="vi">@master</span> <span class="n">vagrant</span><span class="o">]</span><span class="c1"># ulimit -n 10</span>
</span><span class='line'><span class="o">[</span><span class="n">root</span><span class="vi">@master</span> <span class="n">vagrant</span><span class="o">]</span><span class="c1"># service pe-activemq restart</span>
</span><span class='line'><span class="sr">/etc/ini</span><span class="n">t</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="ss">functions</span><span class="p">:</span> <span class="n">redirection</span> <span class="ss">error</span><span class="p">:</span> <span class="n">cannot</span> <span class="n">duplicate</span> <span class="ss">fd</span><span class="p">:</span> <span class="no">Invalid</span> <span class="n">argument</span>
</span><span class='line'><span class="no">Stopping</span> <span class="n">pe</span><span class="o">-</span><span class="ss">activemq</span><span class="p">:</span>                                      <span class="o">[</span>  <span class="no">OK</span>  <span class="o">]</span>
</span><span class='line'><span class="no">Starting</span> <span class="n">pe</span><span class="o">-</span><span class="ss">activemq</span><span class="p">:</span>                                      <span class="o">[</span>  <span class="no">OK</span>  <span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>The trick here is getting close enough to the lowest possible resource limits with out getting the</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>bash: start_pipeline: pgrp pipe: Too many open files
</span><span class='line'>/bin/sh: error while loading shared libraries: libtinfo.so.5: cannot open shared object file: Error 24</span></code></pre></td></tr></table></div></figure>


<p>error.</p>

<p>3 was actually too low, so I ran with 10 and was able to run a restart. You have to account for other files that may be bound to the PID instance, like logs and .jars since this is a bunch of java. And as everyone knows, Java is basically the pig of programming languages.</p>

<p>So 10 fds worked and activemq has restarted. Let&rsquo;s look at my logs to see what I&rsquo;ve got:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>INFO   | jvm 5    | 2014/03/13 04:46:13 | Error: Exception thrown by the agent : java.rmi.server.ExportException: Listen failed on port: 0; nested exception is:
</span><span class='line'>INFO   | jvm 5    | 2014/03/13 04:46:13 |     java.net.SocketException: Too many open files</span></code></pre></td></tr></table></div></figure>


<p>That isn&rsquo;t what I wanted to see. I am looking for heap memory errors. So this clearly demonstrates it&rsquo;s not an fds constraint at the filesystem level. Time to move on to other possibilities.</p>

<h3>Possible Culprits</h3>

<ol>
<li><p>The JVM</p>

<ul>
<li>Consider increasing the total heap memory available to the broker JVM</li>
<li>Consider reducing the default JVM stack size of each thread using -xss</li>
<li>If your broker is embedded ensure the hostiong JVM has appropriate heap and stack sizes.</li>
</ul>
</li>
<li><p>The broker</p>

<ul>
<li>Broker memory is not JVM memory, it&rsquo;s only a constraint &ndash; the broker manages it&rsquo;s own memory.</li>
<li>Setting appropriate systemUsage memory: <a href="http://activemq.apache.org/producer-flow-control.html#ProducerFlowControl-Systemusage">http://activemq.apache.org/producer-flow-control.html#ProducerFlowControl-Systemusage</a></li>
<li>Hard limits exist on the number of agents a single broker can handle due to file descriptors and other hard system resources</li>
</ul>
</li>
</ol>


<h3>Solutions</h3>

<p>Check your log for current JVM heap size:</p>

<pre><code>INFO   | jvm 1    | 2014/02/26 12:47:04 |   Heap sizes: current=506816k  free=487246k  max=506816k
</code></pre>

<p>Try bumping this up to 1GB in</p>

<pre><code> /etc/puppetlabs/activemq/wrapper.conf
</code></pre>

<p>If you still get</p>

<pre><code>INFO   | jvm 1    | 2014/02/26 12:47:38 | Exception in thread "ActiveMQBrokerService[ppm.prod.dc2.adpghs.com] Task-58" java.lang.OutOfMemoryError: unable to create new native thread 
</code></pre>

<p>in your</p>

<pre><code>/var/log/pe-activemq/wrapper.log
</code></pre>

<p>then throttle up your systemUsage in</p>

<pre><code>/etc/puppetlabs/activemq/activemq.xml
</code></pre>

<p>per <a href="http://activemq.apache.org/producer-flow-control.html#ProducerFlowControl-Systemusage">this guideline</a></p>

<h3>Hard Limits of AMQ</h3>

<p>If you still get OOM errors you may be at a hard limit for agents per broker. ActiveMQ uses the amqPersistenceAdapter by default for persistent messages. Unfortunately, this persistence adapter (as well as the kahaPersistenceAdapter) opens a file descriptor for each queue. When creating large numbers of queues, you&rsquo;ll quickly run into the limit for your OS.</p>

<p>However, your logs will not register a OOM error as above, they&rsquo;ll show</p>

<pre><code>ERROR  | wrapper  | 2014/03/13 03:32:39 | JVM exited while loading the application.
INFO   | jvm 4    | 2014/03/13 03:32:39 | Error: Exception thrown by the agent : java.rmi.server.ExportException: Listen failed on port: 0; nested exception is:
INFO   | jvm 4    | 2014/03/13 03:32:39 | java.net.SocketException: Too many open files
</code></pre>

<p>If that is your error your could try upping the limit on file descripters per process. You can do something similar to what I did above or <a href="http://tinyurl.com/o9qs2f">Google for your OS</a>.</p>

<p>At this point if none of the above resolved the issues you should try standing up a second broker, especially if you&rsquo;re running more than 1000 agents on a single broker instance.</p>

<p>You can read more about <a href="http://activemq.apache.org/networks-of-brokers.html">standing up networks of brokers</a> and also <a href="http://activemq.apache.org/performance.html">AMQ performance</a>.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-03-12T21:08:06-07:00" pubdate data-updated="true">Mar 12<span>th</span>, 2014</time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/01/17/extracting-json-from-puppet-yaml-report/">
		
			Extracting JSON From Puppet YAML Report</a>
	</h2>
	<div class="entry-content">
		<h3>YAML &ndash;> JSON via Puppet Gen&#8217;ed YAML</h3>

<p>In a follow up to the post below, I started thinking about ways to generate a D3 readable JSON on the fly from the puppet generated YAML. I started by using a parser from the node library &lsquo;js-yaml&rsquo;. My YAML format looked like this:</p>

<figure class='code'><figcaption><span>last_puppet_run.yaml</span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'>  <span class="l-Scalar-Plain">metrics</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="l-Scalar-Plain">resources</span><span class="p-Indicator">:</span> <span class="kt">!ruby</span><span class="l-Scalar-Plain">/object:Puppet::Util::Metric</span>
</span><span class='line'>      <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">resources</span>
</span><span class='line'>      <span class="l-Scalar-Plain">label</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Resources</span>
</span><span class='line'>      <span class="l-Scalar-Plain">values</span><span class="p-Indicator">:</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">total</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Total</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">197</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">skipped</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Skipped</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">6</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">failed</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Failed</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">failed_to_restart</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="s">&quot;Failed</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">restart&quot;</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">restarted</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Restarted</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">changed</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Changed</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">out_of_sync</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="s">&quot;Out</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">sync&quot;</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'>        <span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">scheduled</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Scheduled</span>
</span><span class='line'>          <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'><span class="nn">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>My original stab at parsing this YAML failed when using the js-yaml node library. This was due to the fact that this is Puppet YAML &ndash; it was generated by a ruby class denoted at the top of the file:</p>

<figure class='code'><figcaption><span>last_puppet_run.yaml </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="err">   </span><span class="l-Scalar-Plain">resources</span><span class="p-Indicator">:</span> <span class="kt">!ruby</span><span class="l-Scalar-Plain">/object:Puppet::Util::Metric</span>
</span></code></pre></td></tr></table></div></figure>


<p>So the way to parse this file into a JSON would have to be done using a ruby script where I could import the &lsquo;puppet&rsquo; class directly so the YAML lib would know how to read this particular file. I thought this would be as simple as:</p>

<figure class='code'><figcaption><span>test.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;puppet&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;yaml&#39;</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;json&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">datajson</span> <span class="o">=</span> <span class="s1">&#39;report.json&#39;</span>
</span><span class='line'><span class="n">datafile</span>  <span class="o">=</span> <span class="s1">&#39;last_run_report.yaml&#39;</span>
</span><span class='line'><span class="n">yaml</span> <span class="o">=</span> <span class="no">YAML</span><span class="o">.</span><span class="n">load_file</span><span class="p">(</span><span class="n">datafile</span><span class="p">)</span>
</span><span class='line'><span class="n">json</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">to_json</span>
</span><span class='line'><span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">datajson</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span> <span class="n">json</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>What I didn&rsquo;t count on was serialization.</p>

<h3>Serialization</h3>

<p>What would you expect that output to be? I&rsquo;ll give you one clue, it did look like a JSON&hellip; sorta:</p>

<figure class='code'><figcaption><span>report.json </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span><span class="nt">&quot;metrics&quot;</span><span class="p">:{</span><span class="nt">&quot;resources&quot;</span><span class="p">:</span><span class="s2">&quot;#&lt;Puppet::Util::Metric:0x007f8fb8cda088&gt;&quot;</span><span class="p">,</span><span class="nt">&quot;time&quot;</span><span class="p">:</span><span class="s2">&quot;#&lt;Puppet::Util::Metric:0x007f8fb8cd80f8&gt;&quot;</span><span class="p">,</span><span class="nt">&quot;changes&quot;</span><span class="p">:</span><span class="s2">&quot;#&lt;Puppet::Util::Metric:0x007f8fb8ce1608&gt;&quot;</span><span class="p">,</span><span class="nt">&quot;events&quot;</span><span class="p">:</span><span class="s2">&quot;#&lt;Puppet::Util::Metric:0x007f8fb8ce0eb0&gt;&quot;</span><span class="p">},</span><span class="nt">&quot;logs&quot;</span><span class="p">:[</span><span class="s2">&quot;Finished catalog run in 5.57 seconds&quot;</span><span class="p">],</span><span class="nt">&quot;resource_statuses&quot;</span><span class="p">:{</span><span class="nt">&quot;Schedule[daily]&quot;</span><span class="p">:</span><span class="s2">&quot;#&lt;Puppet::Resource::Status:0x007f8fb8ceaaf0&gt;&quot;</span><span class="p">,</span><span class="nt">&quot;Schedule[monthly]&quot;</span><span class="p">:</span><span class="s2">&quot;#&lt;Puppet::Resource::Status:0x007f8fb8ce84f8&gt;&quot;</span><span class="p">,</span><span class="nt">&quot;Schedule[hourly]&quot;</span><span class="p">:</span>
</span></code></pre></td></tr></table></div></figure>


<p>What&rsquo;s happening here? What happened to all our nice data, all of the sudden it&rsquo;s not human friendly anymore. This data is serialized, it&rsquo;s a by-product of using &lsquo;.to_json&rsquo; which is akin to saying &lsquo;JSON::dump(datafile)&rsquo;.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-01-17T06:55:04-08:00" pubdate data-updated="true">Jan 17<span>th</span>, 2014</time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/01/13/test/">
		
			Test</a>
	</h2>
	<div class="entry-content">
		

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-01-13T09:35:57-08:00" pubdate data-updated="true">Jan 13<span>th</span>, 2014</time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/01/06/puppet-run-vis/">
		
			Puppet Run Vis</a>
	</h2>
	<div class="entry-content">
		<h3>D3 Visualization for a Puppet Run</h3>

<p>One of the common complaints with puppet, especially puppet enterprise (PE) is that it does not scale as one would hope. In example, the PE console. EVERY NODE must report to the console in PE. So, if, for example, you&rsquo;re a sysadmin working with 10,000+ or even 1,000+ PE nodes you&rsquo;re going to have a crazy busy console.</p>

<p>To make this problem more managable a visualization is necessary &ndash; until humans start developing USB ports for their brains. Here I propose one such way to manage this using D3 as the visualization tool and the post-run YAML log from PuppetDB.</p>

<p>The main issue here is in developing such a debugging tool I would hope to alliviate and not add to the already cumbersome way console manages 1000&rsquo;s of nodes. The tool should scale to &lsquo;n&rsquo; number of nodes &ndash; if there are 10 or 10,000,000 nodes I want this tool to be able to help the user troubleshoot errors on three axes:</p>

<pre><code>* Time - the time the error occured in the context of the run
* Error type - red for failure, orange for warning, green for successful
* Resource Invovled - the resource that either failued, generated warning or was successful. 
</code></pre>

<p>So in my mind, I have this layout which actually involved a couple layers:</p>

<pre><code>* View 1 - Circular graph; inner circle represents precentage of nodes with failures in red; mid circle is percentage of nodes with warnings in orange; outer circle is percentage of nodes with no errors in green.
* View 2 - Click on red area of graph; transition to new circular graph of same circumfrance; starting at 12 o'clock and moving clockwise around the graph is time, each 360 rotation starts a new level; each level is denoted by the number of failures; each failure's area or degrees of circumfrance is the precentage of nodes with that error. 
    * In eaxmple: if you have a 5 errors over 50 nodes, each with 10 instances of those 5 errors the area of the graph that the error takes up would be equally distributed through out the circle starting at time -0 at 12 o'clock moving clockwise around the circle (ok maybe a tarus now) until a equal number of levels has been reached once the center of the circle or tarus has been reached.
* View 3 - same as 2 but for warnings (orange).
* View 4 - same as 2 but for successes or no error (green).
</code></pre>

<p>Something similar to this: <a href="http://xliberation.com/parse/colortable/parsed3.html">http://xliberation.com/parse/colortable/parsed3.html</a></p>

<p>The initial view is simple, it is a ratio of nodes in three categories of &ldquo;has failures (center, red)&rdquo;, &ldquo;has warnings (mid circle, orange)&rdquo; and &ldquo;has no errors (outter circle, green)&rdquo;.</p>

<p>How do we deal with nodes with errors, warnings and successes? We lop them into the lowest common denomenator: if it has successes and warnings it goes to the warning loop; if it has successes warnings and errors it goes to error loop; if it has successes and errors it goes to error.</p>

<p>Our lowest common denomenator is the fact that we are only concerned with nodes that have errors or warnings, if it&rsquo;s successful that&rsquo;s great, we want to see it but errors are the what we are debugging.</p>

<h3>&lsquo;n&rsquo; scalability</h3>

<p>It needs to happen.</p>

<p>Humans are bad at abstracting long lists. I mean, &ldquo;node so-and-so had error this-and-that&rdquo; for 10,000,000 lines isn&rsquo;t so helpful. Sure, &ldquo;&mdash;trace&rdquo; or &ldquo;&mdash;debug&rdquo; is helpful, but ITSALOTOFLINESOFCODE&#8221;.</p>

<p>Humans can abstract information on more levels than &ldquo;line 1, 2,3&hellip;.&lsquo;n&rsquo;&rdquo;. We have 5 complete senses (for most of us!) so we should leverage a few more than textual abstractions of code. Color, shapes, area graphs; abstracting the run levels of a puppet run into &ldquo;zooms&rdquo;. These are all available to us.</p>

<h3>D3</h3>

<p>D3 is a javascript lib that talks directly to the DOM to quickly and efficiently create interactive scalable vector graphics.</p>

<p>What?</p>

<p>It means it can run in the PE console with little overhead, take it&rsquo;s datasets from the parsed YAML in PuppetDB via some savvy js-yaml action and run in basically any browser.</p>

<p>All you need to know is it&rsquo;s super rad.. and more importantly, proven.</p>

<h3>HOW DO WE PARSE THE YAML</h3>

<p>js-yaml, maybe. Or some other YAML to JSON converter that we can get arrays of data out of the YAML from for our JS D3 vis. That isn&rsquo;t so difficult.</p>

<p>Our PuppetDB YAML looks a little like this (for an example, I&rsquo;m using the first couple lines):</p>

<figure class='code'><figcaption><span>last_puppet_run.yaml</span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span> <span class="kt">!ruby</span><span class="l-Scalar-Plain">/object:Puppet::Transaction::Report</span>
</span><span class='line'><span class="l-Scalar-Plain">metrics</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="l-Scalar-Plain">resources</span><span class="p-Indicator">:</span> <span class="kt">!ruby</span><span class="l-Scalar-Plain">/object:Puppet::Util::Metric</span>
</span><span class='line'><span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">resources</span>
</span><span class='line'><span class="l-Scalar-Plain">label</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Resources</span>
</span><span class='line'><span class="l-Scalar-Plain">values</span><span class="p-Indicator">:</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">total</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Total</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">85</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">skipped</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Skipped</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">failed</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Failed</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">1</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">failed_to_restart</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="s">&quot;Failed</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">restart&quot;</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">restarted</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Restarted</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">changed</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Changed</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">out_of_sync</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="s">&quot;Out</span><span class="nv"> </span><span class="s">of</span><span class="nv"> </span><span class="s">sync&quot;</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">1</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">scheduled</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Scheduled</span>
</span><span class='line'><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">0</span>
</span></code></pre></td></tr></table></div></figure>


<p>A converstion of this file to JSON would output something like:</p>

<figure class='code'><figcaption><span>last_puppet_run.json </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;metrics&quot;</span><span class="p">:</span> <span class="kc">null</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;resources&quot;</span><span class="p">:</span> <span class="s2">&quot;!ruby/object:Puppet::Util::Metric&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;!ruby/sym executed_command&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Events&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="nt">&quot;values&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>    <span class="s2">&quot;- total&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;Total&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;- failure&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;Failure&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;- success&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="s2">&quot;Success&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="mi">0</span>
</span><span class='line'>  <span class="p">],</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This was encoded to JSON via: <a href="https://npmjs.org/package/yamljs">https://npmjs.org/package/yamljs</a></p>

<pre><code>yaml2json last_run_report.yaml --pretty
</code></pre>

<h3>First steps to building the vis</h3>

<p>Start with an NGINX server running on localhost:8888 serving up the /www directory from my github.com/puppetlabs/banyan.</p>

<p>Then I start with figuring out how the heck D3 works. Well, luckily for me it&rsquo;s pretty simple. You start by defining some CSS elements for the vis. In my case, I wanted to simply see how I would grab data from the YAML, parsed to JSON and push it into D3.</p>

<p>Let&rsquo;s start small:</p>

<figure class='code'><figcaption><span>index.html </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="cp">&lt;!DOCTYPE html&gt;</span>
</span><span class='line'><span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;head&gt;</span>
</span><span class='line'>        <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;title&gt;</span>D3 Test Visualization for PE Run<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/head&gt;</span>
</span><span class='line'>  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;style&gt;</span>
</span><span class='line'>  <span class="nc">.chart</span> <span class="nt">div</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">font</span><span class="o">:</span> <span class="m">10px</span> <span class="k">sans-serif</span><span class="p">;</span>
</span><span class='line'>  <span class="k">background-color</span><span class="o">:</span> <span class="nb">steelblue</span><span class="p">;</span>
</span><span class='line'>  <span class="k">text-align</span><span class="o">:</span> <span class="k">right</span><span class="p">;</span>
</span><span class='line'>  <span class="k">padding</span><span class="o">:</span> <span class="m">3px</span><span class="p">;</span>
</span><span class='line'>  <span class="k">margin</span><span class="o">:</span> <span class="m">1px</span><span class="p">;</span>
</span><span class='line'>  <span class="k">color</span><span class="o">:</span> <span class="nb">white</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nt">&lt;/style&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>This initializes a bar chart and the colors, alignment and all the other CSS crap that will be used over and over again in the SVG. I&rsquo;ll use .chart as a CSS div element below.</p>

<p>Then we need to tell the DOM that we&rsquo;re going to be using D3.js in our HTML script tags:</p>

<figure class='code'><figcaption><span>index.html </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;http://d3js.org/d3.v3.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ok, phew, that was rough right? Right. Because I&rsquo;m an ops guy and this dev shit is for the&hellip;</p>

<p>Anyways back to the meat of the index.html, our D3 script.</p>

<p>Let&rsquo;s declare the script tags and initialize some vars that we&rsquo;ll use in the test code:</p>

<figure class='code'><figcaption><span>index.html </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'> <span class="nt">&lt;body&gt;</span>
</span><span class='line'>        <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        var data;
</span><span class='line'>        var eval_time;
</span><span class='line'>        var draw_this = new Array();
</span></code></pre></td></tr></table></div></figure>


<p>Now lets parse that JSON I created from before via the YAML puppet_run_report. D3 is SO RAD that it ships with a nice JSON importer called &lsquo;d3.json&rsquo;. We&rsquo;re going to use it here to grab the &lsquo;evaluation_time&rsquo; metric from the parsed YAML (now a JSON) and push it into an array that we will eventually use to draw a bar representing this metric.</p>

<figure class='code'><figcaption><span>index.html </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>d3.json(&quot;last_run_report.json&quot;, function(error,json){
</span><span class='line'>          data = json;
</span><span class='line'>          eval_time = data.evaluation_time;
</span><span class='line'>          draw_this.push(eval_time);
</span></code></pre></td></tr></table></div></figure>


<p>Yep, that easy. Pretty rad right? Right.</p>

<p>Now the fun part, let&rsquo;s draw some scalable vector graphics (from here on out referred to by their much less type consuming name &lsquo;svg&rsquo;):</p>

<figure class='code'><figcaption><span>index.html </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>         var x = d3.scale.linear()
</span><span class='line'>              .domain([0, d3.max(draw_this)])
</span><span class='line'>              .range([0, 420]);
</span><span class='line'>
</span><span class='line'>          d3.select(&quot;.chart&quot;)
</span><span class='line'>              .selectAll(&quot;div&quot;)
</span><span class='line'>              .data(draw_this)
</span><span class='line'>              .enter().append(&quot;div&quot;)
</span><span class='line'>              .style(&quot;width&quot;, function(d) { return x(d) + &quot;px&quot;; })
</span><span class='line'>              .text(&quot;Evaluation Time&quot;);
</span><span class='line'>              //.text(function(d) { return d; });
</span><span class='line'>      });         
</span><span class='line'>        <span class="nt">&lt;/script&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>I start by telling D3 to scale the graph along the &lsquo;x&rsquo; axis because eventually I&rsquo;ll have other bars and I don&rsquo;t want this thing getting out of control, since I am a control freak.</p>

<p>Then we use the ever-so-awesome d3.select. The .select method is great, you could basically script an entire index.html with .select. What&rsquo;s actually happening here is .select is D3&rsquo;s way of saying, &ldquo;Hey DOM, here&rsquo;s a CSS selector, give me the first element match&rdquo;.</p>

<p>You can do .select(&ldquo;body&rdquo;), .select(&ldquo;marquee&rdquo;) (if you&rsquo;re hella adventurous) or if you want to have access to all the DOM elements .selectAll().</p>

<p>I selected my div.chart that I defined earlier, as this is the CSS style I want to push onto my silly bar graph. So all data elements iterated over in .data() will use this style. Notice how .style is automagically added to the DOM for .select() to use down here? That&rsquo;s super cool.</p>

<p>Then we pass my earlier defined array draw_this to .data(). .data is a holder for our soon to be iterated stuff. The magic happens when we use .enter, and wrap our div append in it.</p>

<p>Anytime you bind data to an element (in this case we&rsquo;re binding the array draw_this) you need to use .enter(). We don&rsquo;t actually have any DOM elements for div yet, but we need a placeholder for our data (or whatever data-element binding you might have). .enter() makes this placeholder &ndash; it says, &ldquo;hey I have this data, does the DOM have this data?&rdquo;. If the DOM is like, &ldquo;hell no I have no such data.&rdquo; Then .enter() creates a placeholder for that data.</p>

<p>Don&rsquo;t conflate data with DOM elements. In this example we&rsquo;re passing 1 data value (there only exists one data value in draw_this for now). .enter() will make sure we have placeholder <div> elements to put our data into since they do not exist. So .enter() in this example is making one <div> element PLACEHOLDER (all problems in computer science can be solved by enough levels of abstraction!).</p>

<p>It passes a REFERENCE of this placeholder to the next thing in the chain, in this case an append of <div> which actually inserts our elements into the DOM. We then apply our CSS style to a bar that we defined earlier and does some scaling math so when we have more bars later it won&rsquo;t get out of control and bang, we have a DIV representing our data.</p>

<p>So far our index.html looks like this:</p>

<figure class='code'><figcaption><span>index.html </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'><span class="cp">&lt;!DOCTYPE html&gt;</span>
</span><span class='line'><span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">&quot;en&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;head&gt;</span>
</span><span class='line'>        <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;title&gt;</span>D3 Test Visualization for PE Run<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/head&gt;</span>
</span><span class='line'>  <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">&quot;utf-8&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>  <span class="nt">&lt;style&gt;</span>
</span><span class='line'>  <span class="nc">.chart</span> <span class="nt">div</span> <span class="p">{</span>
</span><span class='line'>  <span class="k">font</span><span class="o">:</span> <span class="m">10px</span> <span class="k">sans-serif</span><span class="p">;</span>
</span><span class='line'>  <span class="k">background-color</span><span class="o">:</span> <span class="nb">steelblue</span><span class="p">;</span>
</span><span class='line'>  <span class="k">text-align</span><span class="o">:</span> <span class="k">right</span><span class="p">;</span>
</span><span class='line'>  <span class="k">padding</span><span class="o">:</span> <span class="m">3px</span><span class="p">;</span>
</span><span class='line'>  <span class="k">margin</span><span class="o">:</span> <span class="m">1px</span><span class="p">;</span>
</span><span class='line'>  <span class="k">color</span><span class="o">:</span> <span class="nb">white</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nt">&lt;/style&gt;</span>
</span><span class='line'>  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;chart&quot;</span><span class="nt">&gt;&lt;/div&gt;</span>
</span><span class='line'>  
</span><span class='line'>  <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;http://d3js.org/d3.v3.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>    <span class="nt">&lt;body&gt;</span>
</span><span class='line'>        <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      
</span><span class='line'>        <span class="kd">var</span> <span class="nx">data</span><span class="p">;</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">eval_time</span><span class="p">;</span>
</span><span class='line'>        <span class="kd">var</span> <span class="nx">draw_this</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>        <span class="nx">d3</span><span class="p">.</span><span class="nx">json</span><span class="p">(</span><span class="s2">&quot;last_run_report.json&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">error</span><span class="p">,</span><span class="nx">json</span><span class="p">){</span>
</span><span class='line'>          <span class="nx">data</span> <span class="o">=</span> <span class="nx">json</span><span class="p">;</span>
</span><span class='line'>          <span class="nx">eval_time</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">evaluation_time</span><span class="p">;</span>
</span><span class='line'>          <span class="c1">//alert(eval_time);</span>
</span><span class='line'>          <span class="nx">draw_this</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">eval_time</span><span class="p">);</span>
</span><span class='line'>          
</span><span class='line'>          <span class="c1">//draw something</span>
</span><span class='line'>          <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">()</span>
</span><span class='line'>              <span class="p">.</span><span class="nx">domain</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">draw_this</span><span class="p">)])</span>
</span><span class='line'>              <span class="p">.</span><span class="nx">range</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">420</span><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'>          <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;.chart&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">draw_this</span><span class="p">)</span>
</span><span class='line'>              <span class="p">.</span><span class="nx">enter</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">x</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;px&quot;</span><span class="p">;</span> <span class="p">})</span>
</span><span class='line'>              <span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">d</span><span class="p">;</span> <span class="p">});</span>
</span><span class='line'>      <span class="p">});</span>          
</span><span class='line'>        <span class="nt">&lt;/script&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/body&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>OMG IT&rsquo;S SO AWESOME!
<img src="/images/small_example.tiff" title="awesome" alt="images"></p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-01-06T00:00:00-08:00" pubdate data-updated="true"></time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/01/03/the-need-to-a-replication-provider/">
		
			The Need for a Replication Provider</a>
	</h2>
	<div class="entry-content">
		<h3>Why we need a replication provider for puppet</h3>

<p>I&rsquo;ve been using puppet for over a year now. I started using it at the request of a friend who wanted a simple, one-liner command to boot his e-commerce platform on Vagrant VM&rsquo;s for dev and eventually production. I was impressed by the simplicity, the software defined server-state was easy to create through the elegant package, resource, service workflow. It wasn&rsquo;t very long that we found other more advanced needs for Puppet.</p>

<p>One of these needs was booting multiple MySQL server slaves on a single host machine to replicate various MySQL masters. The masters were any one of the customers currently using this e-commerce platform. The distributed nature of the servers and the cost-benefit of running a single slave server (a beefy host nonetheless) for all of them presented a few challenges.</p>

<p>First off, nobody wants to be a sysadmin. This company was small in terms of manpower and everyone was already in a DevOps role, but who wants to sit around running &ldquo;CHANGE MASTER TO&rdquo;&hellip; all day? Not your python dev that&rsquo;s for sure. So we decided it was best to build out a Puppet module that can run on the slave and master hosts that would:</p>

<ol>
<li>Boot multiple MySQL slaves on one host</li>
<li>Dump the master MySQL DB and scp to the slave (once the slave was provisioned)</li>
<li>Import the scp&#8217;ed DB to the slave and start replication from the correct binlog position</li>
</ol>


<p>Simple right? Yeah&hellip; right.</p>

<p>Let&rsquo;s cut the chase: how many lines of puppet code did it take for me to write a unique mysql slave instance onto a host?</p>

<p>167</p>

<p>For each slave I needed to provision:</p>

<ul>
<li>/var/lib/mysql_instance#</li>
<li>/var/log/mysql_instance#</li>
<li>/etc/mysql_instance#</li>
<li>/etc/mysql_instance#/my.cnf</li>
<li>Customize that my.cnf for the instance</li>
</ul>


<p>Which looks like standard Puppet fun:</p>

<figure class='code'><figcaption><span>slave.pp </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># All SQL instances get their own directories:</span>
</span><span class='line'><span class="n">file</span> <span class="p">{</span> <span class="s2">&quot;/var/lib/mysql${slave_server_id}&quot;</span><span class="p">:</span>
</span><span class='line'>      <span class="k">ensure</span>        <span class="o">=&gt;</span> <span class="n">directory</span><span class="p">,</span>
</span><span class='line'>      <span class="n">recurse</span>        <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
</span><span class='line'>      <span class="n">owner</span>        <span class="o">=&gt;</span> <span class="s1">&#39;mysql&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="n">group</span>        <span class="o">=&gt;</span> <span class="s1">&#39;mysql&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'><span class="n">file</span> <span class="p">{</span> <span class="s2">&quot;/var/log/mysql${slave_server_id}&quot;</span><span class="p">:</span>
</span><span class='line'>      <span class="k">ensure</span>        <span class="o">=&gt;</span> <span class="n">directory</span><span class="p">,</span>
</span><span class='line'>      <span class="n">recurse</span>        <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
</span><span class='line'>      <span class="n">owner</span>        <span class="o">=&gt;</span> <span class="s1">&#39;mysql&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="n">group</span>        <span class="o">=&gt;</span> <span class="s1">&#39;mysql&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># All SQL instances get their own /etc and cnf:</span>
</span><span class='line'><span class="n">file</span> <span class="p">{</span> <span class="s2">&quot;/etc/mysql${slave_server_id}&quot;</span><span class="p">:</span>
</span><span class='line'>      <span class="k">ensure</span>        <span class="o">=&gt;</span> <span class="n">directory</span><span class="p">,</span>
</span><span class='line'>      <span class="n">recurse</span>        <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
</span><span class='line'>      <span class="n">owner</span>        <span class="o">=&gt;</span> <span class="s1">&#39;mysql&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="n">group</span>        <span class="o">=&gt;</span> <span class="s1">&#39;mysql&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'><span class="n">file</span> <span class="p">{</span> <span class="s2">&quot;my${slave_server_id}.cnf&quot;</span><span class="p">:</span>
</span><span class='line'>      <span class="k">ensure</span>         <span class="o">=&gt;</span> <span class="n">file</span><span class="p">,</span>
</span><span class='line'>      <span class="n">path</span>        <span class="o">=&gt;</span> <span class="s2">&quot;/etc/mysql${slave_server_id}/my${slave_server_id}.cnf&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="n">mode</span>        <span class="o">=&gt;</span> <span class="mo">0644</span><span class="p">,</span>
</span><span class='line'>      <span class="n">owner</span>         <span class="o">=&gt;</span> <span class="s1">&#39;mysql&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="n">group</span>         <span class="o">=&gt;</span> <span class="s1">&#39;mysql&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="n">content</span>        <span class="o">=&gt;</span> <span class="n">template</span><span class="p">(</span><span class="s1">&#39;replicate/my.cnf.multi.erb&#39;</span><span class="p">),</span>
</span><span class='line'>      <span class="nb">require</span>        <span class="o">=&gt;</span> <span class="no">File</span><span class="o">[</span><span class="s2">&quot;/etc/mysql${slave_server_id}&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>      <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then I needed to boot a DB with the datadir, and from that point on it was, well, you know, a bash script basically with a million exec statements:</p>

<figure class='code'><figcaption><span>slave.pp </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Prepare DB:</span>
</span><span class='line'><span class="nb">exec</span> <span class="p">{</span> <span class="s2">&quot;${name} Initialize Database&quot;</span><span class="p">:</span>
</span><span class='line'>      <span class="n">path</span>        <span class="o">=&gt;</span> <span class="s1">&#39;/usr/bin:/bin&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="n">command</span>        <span class="o">=&gt;</span> <span class="s2">&quot;mysql_install_db --user=mysql --datadir=/var/lib/mysql${slave_server_id}&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nb">require</span>        <span class="o">=&gt;</span> <span class="o">[</span><span class="no">File</span><span class="o">[</span><span class="s2">&quot;/var/lib/mysql${slave_server_id}&quot;</span><span class="o">]</span><span class="p">,</span><span class="no">File</span><span class="o">[</span><span class="s2">&quot;/var/log/mysql${slave_server_id}&quot;</span><span class="o">]]</span><span class="p">,</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Start SQL instance:</span>
</span><span class='line'><span class="nb">exec</span>  <span class="p">{</span> <span class="s2">&quot;$ {name} Spin up SQL Server&quot;</span> <span class="p">:,</span><span class="n">ca</span>
</span><span class='line'>      <span class="n">path</span>        <span class="o">=&gt;</span> <span class="s1">&#39;/bin:/usr/bin:&#39;</span><span class="p">,</span>
</span><span class='line'>      <span class="n">command</span>        <span class="o">=&gt;</span> <span class="s2">&quot;mysqld_safe --defaults-file=/etc/mysql${slave_server_id}/my${slave_server_id}.cnf &amp;&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nb">require</span>        <span class="o">=&gt;</span> <span class="o">[</span><span class="no">Exec</span><span class="o">[</span><span class="s2">&quot;${name} Initialize Database&quot;</span><span class="o">]</span><span class="p">,</span><span class="no">File</span><span class="o">[</span><span class="s2">&quot;my${slave_server_id}.cnf&quot;</span><span class="o">]]</span><span class="p">,</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Execute CHANGE MASTER TO - TODO: add if conditional for with password mysql commands</span>
</span><span class='line'><span class="c1"># Grant slave user priviledges if without password:</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="vg">$mysql_root_password</span> <span class="o">==</span> <span class="s2">&quot;false&quot;</span><span class="p">{</span>
</span><span class='line'>      <span class="nb">exec</span>  <span class="p">{</span> <span class="s2">&quot;$ {name} grant privledges&quot;</span> <span class="p">:,</span><span class="n">ca</span>
</span><span class='line'>              <span class="n">command</span>                <span class="o">=&gt;</span> <span class="s2">&quot;$mysql_cmd_root_without_pwd $mysql_socket --execute=</span><span class="se">\&quot;</span><span class="s2">GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO &#39;$mysql_replication_user&#39;@&#39;$slave_ip&#39; IDENTIFIED BY &#39;$mysql_replication_password&#39;;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span class='line'>              <span class="no">Require</span>                 <span class="o">=&gt;</span>  <span class="no">Exec</span> <span class="o">[</span> <span class="s2">&quot;$ {name} Spin up SQL server&quot;</span> <span class="o">]</span><span class="p">,</span><span class="n">ca</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="nb">exec</span> <span class="p">{</span><span class="s2">&quot;stop ${name}&quot;</span><span class="p">:</span>
</span><span class='line'>              <span class="n">command</span>                <span class="o">=&gt;</span> <span class="s2">&quot;$mysql_cmd_root_without_pwd $mysql_socket --execute=</span><span class="se">\&quot;</span><span class="s2">STOP SLAVE;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span class='line'>              <span class="nb">require</span>                <span class="o">=&gt;</span> <span class="no">Exec</span><span class="o">[</span><span class="s2">&quot;grant ${name} privledges&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>      <span class="nb">exec</span> <span class="p">{</span><span class="s2">&quot;master info for ${name}&quot;</span><span class="p">:</span>
</span><span class='line'>              <span class="n">command</span>        <span class="o">=&gt;</span> <span class="s2">&quot;$mysql_cmd_root_without_pwd $mysql_socket --execute=</span><span class="se">\&quot;</span><span class="s2">CHANGE MASTER TO MASTER_HOST=&#39;$master_host&#39;,MASTER_USER=&#39;$mysql_replication_user&#39;,MASTER_PASSWORD=&#39;$mysql_replication_password&#39;,MASTER_LOG_FILE=&#39;$master_log_file&#39;,MASTER_LOG_POS=$master_log_pos;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span class='line'>              <span class="nb">require</span>        <span class="o">=&gt;</span> <span class="no">Exec</span><span class="o">[</span><span class="s2">&quot;stop ${name}&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>      <span class="nb">exec</span> <span class="p">{</span><span class="s2">&quot;start ${name} instnace on server&quot;</span><span class="p">:</span>
</span><span class='line'>              <span class="n">command</span>                <span class="o">=&gt;</span> <span class="s2">&quot;$mysql_cmd_root_without_pwd $mysql_socket --execute=</span><span class="se">\&quot;</span><span class="s2">START SLAVE;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span class='line'>              <span class="nb">require</span>                <span class="o">=&gt;</span> <span class="no">Exec</span><span class="o">[</span><span class="s2">&quot;master info for ${name}&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>      <span class="nb">exec</span>  <span class="p">{</span> <span class="s2">&quot;$ {name} restart server&quot;</span> <span class="p">:,</span><span class="n">ca</span>
</span><span class='line'>              <span class="n">command</span>        <span class="o">=&gt;</span> <span class="s2">&quot;/usr/bin/mysqladmin -S /var/run/mysqld/mysqld${slave_server_id}.sock stop;</span>
</span><span class='line'><span class="s2">                                     /usr/bin/mysqladmin -S /var/run/mysqld/mysqld${slave_server_id}.sock start&quot;</span><span class="p">,</span>
</span><span class='line'>              <span class="nb">require</span>        <span class="o">=&gt;</span> <span class="no">Exec</span><span class="o">[</span><span class="s2">&quot;start ${name} instnace on server&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>              <span class="n">notify</span>        <span class="o">=&gt;</span> <span class="ss">Replicate</span><span class="p">:</span><span class="ss">:Import</span><span class="o">[</span><span class="s2">&quot;Import ${import} onto ${name}&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>              <span class="p">}</span>
</span><span class='line'>   <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>But WHAT IF THEY&rsquo;RE CRAZY AND HAVE NO PASSWORD????</p>

<p>I made other commands for that too&hellip;</p>

<figure class='code'><figcaption><span>slave.pp </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">if</span> <span class="vg">$mysql_root_password</span> <span class="o">!=</span> <span class="s2">&quot;false&quot;</span><span class="p">{</span>
</span><span class='line'><span class="nb">exec</span>  <span class="p">{</span> <span class="s2">&quot;$ {name} grant privledges&quot;</span> <span class="p">:,</span><span class="n">ca</span>
</span><span class='line'>      <span class="n">command</span>                <span class="o">=&gt;</span> <span class="s2">&quot;$mysql_cmd_root_with_pwd $mysql_socket --execute=</span><span class="se">\&quot;</span><span class="s2">GRANT REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO &#39;$mysql_replication_user&#39;@&#39;$slave_ip&#39; IDENTIFIED BY &#39;$mysql_replication_password&#39;;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="no">Require</span>                 <span class="o">=&gt;</span>  <span class="no">Exec</span> <span class="o">[</span> <span class="s2">&quot;$ {name} Spin up SQL server&quot;</span> <span class="o">]</span><span class="p">,</span><span class="n">ca</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nb">exec</span> <span class="p">{</span><span class="s2">&quot;stop ${name}&quot;</span><span class="p">:</span>
</span><span class='line'>      <span class="n">command</span>                <span class="o">=&gt;</span> <span class="s2">&quot;$mysql_cmd_root_with_pwd $mysql_socket --execute=</span><span class="se">\&quot;</span><span class="s2">STOP SLAVE;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nb">require</span>                <span class="o">=&gt;</span> <span class="no">Exec</span><span class="o">[</span><span class="s2">&quot;grant ${name} privledges&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'><span class="nb">exec</span> <span class="p">{</span><span class="s2">&quot;master info for ${name}&quot;</span><span class="p">:</span>
</span><span class='line'>      <span class="n">command</span>        <span class="o">=&gt;</span> <span class="s2">&quot;$mysql_cmd_root_with_pwd $mysql_socket --execute=</span><span class="se">\&quot;</span><span class="s2">CHANGE MASTER TO MASTER_HOST=&#39;$master_host&#39;,MASTER_USER=&#39;$mysql_replication_user&#39;,MASTER_PASSWORD=&#39;$mysql_replication_password&#39;,MASTER_LOG_FILE=&#39;$master_log_file&#39;,MASTER_LOG_POS=$master_log_pos;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nb">require</span>        <span class="o">=&gt;</span> <span class="no">Exec</span><span class="o">[</span><span class="s2">&quot;stop ${name}&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'><span class="nb">exec</span> <span class="p">{</span><span class="s2">&quot;start ${name} instnace on server&quot;</span><span class="p">:</span>
</span><span class='line'>      <span class="n">command</span>                <span class="o">=&gt;</span> <span class="s2">&quot;$mysql_cmd_root_with_pwd $mysql_socket --execute=</span><span class="se">\&quot;</span><span class="s2">START SLAVE;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nb">require</span>                <span class="o">=&gt;</span> <span class="no">Exec</span><span class="o">[</span><span class="s2">&quot;master info for ${name}&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'><span class="nb">exec</span>  <span class="p">{</span> <span class="s2">&quot;$ {name} restart server&quot;</span> <span class="p">:,</span><span class="n">ca</span>
</span><span class='line'>      <span class="n">command</span>        <span class="o">=&gt;</span> <span class="s2">&quot;/usr/bin/mysqladmin -S /var/run/mysqld/mysqld${slave_server_id}.sock stop;</span>
</span><span class='line'><span class="s2">                             /usr/bin/mysqladmin -S /var/run/mysqld/mysqld${slave_server_id}.sock start&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nb">require</span>        <span class="o">=&gt;</span> <span class="no">Exec</span><span class="o">[</span><span class="s2">&quot;start ${name} instnace on server&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>      <span class="n">notify</span>        <span class="o">=&gt;</span> <span class="ss">Replicate</span><span class="p">:</span><span class="ss">:Import</span><span class="o">[</span><span class="s2">&quot;Import ${import} onto ${name}&quot;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>SO MANY COMMANDS!!!</p>

<p>Any post where you need to exclaim this much in caps says a lot about the code you&rsquo;re writing right? Right. That&rsquo;s a principle.</p>

<p>So this is where providers come in. In Puppet you could write this code to do this work. And I mean, that&rsquo;s what Puppet is for right? Provisioning. Yes,
that&rsquo;s true, but this isn&rsquo;t really* Puppet code, this is a bunch of exec statements, which is basically a bash script. This isn&rsquo;t very economical, it&rsquo;s
not very elegant, it&rsquo;s a lot of coding. Would it be nice if we could just:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">replicate_server</span> <span class="p">{</span> <span class="s1">&#39;master&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="n">hostname</span>             <span class="o">=&gt;</span> <span class="vg">$:</span><span class="ss">:hostname</span><span class="p">,</span>
</span><span class='line'>  <span class="n">mysql_repl_password</span> <span class="o">=&gt;</span> <span class="s2">&quot;1234&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="n">mysql_repl_user</span>      <span class="o">=&gt;</span> <span class="s2">&quot;repl&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="n">server_id</span>            <span class="o">=&gt;</span> <span class="mi">21</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>&hellip; in our provisioning manifest and not have to write this crazy defined type for each SQL slave? Because right now as it stands my slave.pp for the replicate class is
167 lines. There are, umm, a lot of other subclasses there to enable this to work. Like the master.pp, my params, some crap about dumping DB&rsquo;s and blowing out
the old ib_log files and holy shit that&rsquo;s a lot of puppeteering.</p>

<p>I would much rather have a provider that&rsquo;s pure ruby which can provision this for me. (WARNING PSUDO PROVIDER COMING).</p>

<p>Something like this for the commands (of which, as you can see from above, are crazy nuts since it&rsquo;s puppet telling bash telling mysql telling mysql instance&hellip;):</p>

<figure class='code'><figcaption><span>/ modules / replicate / lib / puppet / provider / replicate / replication.rb </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">Puppet</span><span class="p">:</span><span class="ss">:Type</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="ss">:replicate</span><span class="p">)</span><span class="o">.</span><span class="n">provide</span><span class="p">(</span><span class="ss">:replication</span><span class="p">)</span> <span class="k">do</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">#confine :osfamily =&gt; [:debian, :redhat]</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Commands </span>
</span><span class='line'>
</span><span class='line'>        <span class="n">commands</span>         <span class="ss">:mysql</span>             <span class="o">=&gt;</span> <span class="s2">&quot;/usr/bin/mysql&quot;</span>
</span><span class='line'>        <span class="n">commands</span>         <span class="ss">:mysqladmin</span>        <span class="o">=&gt;</span> <span class="s2">&quot;/usr/bin/mysqladmin&quot;</span>
</span><span class='line'>        <span class="n">commands</span>         <span class="ss">:service</span>           <span class="o">=&gt;</span> <span class="s2">&quot;/etc/init.d/mysql&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ahhhh, ok that&#8217; better than:</p>

<figure class='code'><figcaption><span>slave.pp </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="vg">$mysql_cmd_root_without_pwd</span> <span class="o">=</span> <span class="s2">&quot;/usr/bin/mysql --user=$mysql_root_user --database=$mysql_database --host=$mysql_root_local_host&quot;</span>
</span><span class='line'><span class="vg">$mysql_cmd_root_with_pwd</span>    <span class="o">=</span> <span class="s2">&quot;/usr/bin/mysql --user=$mysql_root_user --database=$mysql_database --host=$mysql_root_local_host --password=$mysql_root_password&quot;</span>
</span><span class='line'><span class="vg">$mysql_cmd_repl_with_pwd</span>    <span class="o">=</span> <span class="s2">&quot;/usr/bin/mysql --user=$mysql_replication_user --database=$mysql_database --host=$mysql_root_local_host --password=$mysql_replication_password&quot;</span>
</span><span class='line'><span class="vg">$mysql_cmd_repl_slave</span>       <span class="o">=</span> <span class="s2">&quot;/usr/bin/mysql --user=$mysql_replication_user --database=$mysql_database --host=$mysql_master_ip_address --password=$mysql_replication_password&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then we could write a out a single provider and corresponding type which defines the instance based on &ldquo;roles&rdquo; of &ldquo;master&rdquo; or &ldquo;slave&rdquo;. The provider would figure out if this host
already has a master or slave instance running on it, which my replication module &hellip; does not do .. which, you guessed it, could break a lot of stuff if you run it twice.</p>

<p>Which brings us to&hellip;</p>

<h4>A provider, when done correctly is idempotent!</h4>

<p>&hellip; and that&rsquo;s not all, if the replication provider is built-in we can use &lsquo;puppet resource replicate&rsquo; on the command line for all things replication related.</p>

<p>Let&rsquo;s say we wanted to query the master SQL instances
on this host, we could:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>$ puppet resource replicate role=master </span></code></pre></td></tr></table></div></figure>


<p>and get something like:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>replicate {"master":
</span><span class='line'>  ensure =&gt; present,
</span><span class='line'>  }</span></code></pre></td></tr></table></div></figure>


<p>if this host has a master instance running on it.</p>

<p>This is of course provided by the magic of self.instances in the provider. Here&rsquo;s some more psudo ruby of what that might look like:</p>

<figure class='code'><figcaption><span>Psudo-Provider </span></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">instances</span>
</span><span class='line'>  <span class="n">get_master_instances</span><span class="p">()</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">get_master_instances</span><span class="p">()</span>
</span><span class='line'>  <span class="n">desc</span> <span class="s2">&quot;get master info&quot;</span>
</span><span class='line'>  <span class="n">mstr_info</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>  <span class="k">begin</span>
</span><span class='line'>          <span class="n">output</span> <span class="o">=</span> <span class="sb">`mysql -NBe &quot;show master status&quot;`</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:strip</span><span class="p">)</span>
</span><span class='line'>  <span class="k">rescue</span> <span class="ss">Puppet</span><span class="p">:</span><span class="ss">:ExecutionFailure</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>              <span class="k">raise</span> <span class="ss">Puppet</span><span class="p">:</span><span class="ss">:Error</span><span class="p">,</span> <span class="s2">&quot;Oh no, execution of &#39;show master status&#39; for MySQL failed&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">mstr_info</span><span class="o">[</span><span class="ss">:ensure</span><span class="o">]</span> <span class="o">=</span> <span class="n">output</span> <span class="o">==</span> <span class="kp">nil</span> <span class="p">?</span> <span class="ss">:absent</span> <span class="p">:</span> <span class="ss">:present</span>
</span><span class='line'>  <span class="n">mstr_info</span><span class="o">[</span><span class="ss">:log_position</span><span class="o">]</span> <span class="o">=</span> <span class="n">output</span><span class="o">[</span><span class="mi">1</span><span class="o">].</span><span class="n">empty?</span> <span class="p">?</span> <span class="kp">nil</span> <span class="p">:</span> <span class="n">output</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
</span><span class='line'>  <span class="n">mstr_info</span><span class="o">[</span><span class="ss">:binlog_do_db</span><span class="o">]</span> <span class="o">=</span> <span class="n">output</span><span class="o">[</span><span class="mi">2</span><span class="o">].</span><span class="n">empty?</span> <span class="p">?</span> <span class="kp">nil</span> <span class="p">:</span> <span class="n">output</span><span class="o">[</span><span class="mi">2</span><span class="o">]</span>
</span><span class='line'>  <span class="c1">#mstr_info[:provider] = :ruby</span>
</span><span class='line'>  <span class="n">mstr_info</span><span class="o">[</span><span class="ss">:name</span><span class="o">]</span> <span class="o">=</span> <span class="ss">:binlog_do_db</span>
</span><span class='line'>  <span class="n">mstr_info</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>And return the instances.</p>

<p>Now the provider would have to be written with the duel nature of master/slave replication in mind. Unless you want to have multiple providers, one for each of the roles of master or slave.
However I think it would be easier to write it into a single provider that discriminates based on the &lsquo;role&rsquo; parameter in the type.</p>

<p>But I digress, let&rsquo;s get back to the meat of this thing.</p>

<p>The awesome thing about having a provider do this work for us is that we don&rsquo;t have to worry about all the module-related debugging, platform dependancies and none-idempotent nature of a standalone replication
module (*cough .. my replication module, which I did not write with idempotentcy in mind). We have better integration with puppet through the use of &lsquo;puppet resource&rsquo; &ndash; it inherently is far more extendable than a standalone module  and integrates well with most puppet platform distributions.
The coding for it is far more economical, and we don&rsquo;t have a psudo-bash script written into our Puppet code via exec!</p>

<p>You get to write your puppet code to do puppet stuff and let the provider/type ruby magic do it&rsquo;s work for you. It&rsquo;s a win win, now all we need to do is actually write this thing&hellip;</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-01-03T09:05:51-08:00" pubdate data-updated="true">Jan 3<span>rd</span>, 2014</time></div>
	

<div class="tags">

	<a class='category' href='/blog/categories/providers/'>providers</a>, <a class='category' href='/blog/categories/puppet/'>puppet</a>, <a class='category' href='/blog/categories/ruby/'>ruby</a>

</div>


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/01/02/blog-post-number-1/">
		
			Blog Post #1</a>
	</h2>
	<div class="entry-content">
		<p>Is this thing on?</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-01-02T10:52:00-08:00" pubdate data-updated="true">Jan 2<span>nd</span>, 2014</time></div>
	

<div class="tags">

	<a class='category' href='/blog/categories/misc/'>Misc</a>

</div>


	
</div></article>

<nav id="pagenavi">
    
        <a href="/blog/page/2/" class="prev">Prev</a>
    
    
    <div class="center"><a href="/archives">Blog Archives</a></div>
</nav></div>
	<footer id="footer" class="inner">Copyright &copy; 2015

    Jeff

<br>
Powered by Octopress.
</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






</body>
</html>
