
<!DOCTYPE HTML>
<html>
<head>
	<script data-cfasync="false" type="text/javascript" src="//use.typekit.net/axj3cfp.js"></script>
	<script data-cfasync="false" type="text/javascript">try{Typekit.load();}catch(e){}</script>
	<meta charset="utf-8">
	<title>a techy blog  | JP</title>

<meta name="author" content="Jeff"> 

<meta name="description" content="See subtitle."> <meta name="keywords" content="">

	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="JP" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<link href="/stylesheets/font-awesome.min.css" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script type="text/javascript" src="/javascripts/jquery.fancybox.pack.js"></script>

<script language="Javascript" type="text/javascript">
$(document).ready(
  function() {
    (function($) {
      $(".fancybox[data-content-id]").each(function() {
        this.href = $(this).data('content-id');
      });
      $(".fancybox").fancybox({
        beforeLoad: function() {
          var el, 
              id = $(this.element).data('title-id');

          if (id) {
            el = $('#' + id);

            if (el.length) {
              this.title = el.html();
            }
          }
          if ($(this).data('content')) {
            this.content = $(this).data('content');
          }
        },
        helpers: {
          title: {
            type: 'inside'
          }
        }
      });
    })(jQuery);
  }
);
</script>

	
</head>



<body>
	<header id="header" class="inner"><h1><a href="/">JP</a></h1>
<h4>a techy blog</h4>
<nav id="main-nav"><ul>
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/about">About</a></li>
	<li><a href="/blog/resume">Resume</a></li>
	<li><a href="/archives">Archive</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul>
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/about">About</a></li>
	<li><a href="/blog/resume">Resume</a></li>
	<li><a href="/archives">Archive</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:httpL://www.jeffmalnick.com">
			</form>
		</div>
	</div>
</nav>


</header>

	<div id="content" class="inner">


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/07/21/agile-dev-environment-for-puppet-code/">
		
			Agile Dev Environment for Puppet Code</a>
	</h2>
	<div class="entry-content">
		<p>When ever I am creating a new Puppet module or working on someone else&rsquo;s Puppet module I constantly look for ways to make more efficient the development process.</p>

<p>It may not seem like a lot of time but all those &lsquo;vagrant up&rsquo; &lsquo;vagrant destroy&rsquo; &lsquo;git pull&rsquo; &lsquo;git commit&rsquo; &lsquo;&hellip;push, branch&hellip;&rsquo; etc turn into a lot of time wasted.</p>

<p>What I need is an easy way to pull in git-based (or forge-based) modules to a VM and have them available locally to edit with my favorite editor.</p>

<p>This environment needs to satisfy these needs:</p>

<ol>
<li>I can edit my code on my host machine in my favorit editor (vim) which has all my favorite plugins</li>
<li>The code is live on the VM, sym linked from the VM to my host so I don&rsquo;t have to git push/pull to update the VM (or some other jank process)</li>
<li>I can easily deploy many modules/dependances for the code to the VM with a simple Rake command</li>
</ol>


<h2>Solution</h2>

<p>To solve this development issue I forked a loanly project from nval0. It was a basic Rakefile which was using Puppet-librarian to pull in modules from a Puppetfile.</p>

<p>The environment used:</p>

<ol>
<li>Puppet librarian for module management via Puppetfile</li>
<li>Vagrant VMs</li>
<li>Wrapped up some of the commands into a Rakefile (gem prereq&rsquo;s etc)</li>
</ol>


<p>After playing with this environment for a bit I realized some drawbacks:</p>

<ol>
<li>Puppet-librarian only worked on ruby 1.9</li>
<li>I wanted a rake task to &lsquo;deploy&rsquo; everything in the Puppetfile to sym-linked dir to the VM</li>
</ol>


<p>The first draw back was easily solved, instead of using Puppet-librarian I&rsquo;d use <a href="https://github.com/adrienthebo/r10k">r10k</a>. R10k builds off of Puppet-libarian and is most often used to map git branches for any Puppet module to local Puppet environments on a Puppet Master. However, you can use it in a similar fashion to Puppet-libarian where it only reads a Puppetfile then pulls in those modules directly. The great thing is it works on all major releases of Ruby so my dev environment will not need rbenv or another ruby environment manager.</p>

<h3>Let&rsquo;s put this together into some rake tasks:</h3>

<p>An example rake task to deploy the Puppetfile modules with r10k:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">desc</span> <span class="s1">&#39;Pull down modules in Puppetfile&#39;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:pull</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">confdir</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span>
</span><span class='line'>  <span class="n">moduledir</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/modules&quot;</span>
</span><span class='line'>  <span class="n">puppetfile</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/Puppetfile&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Pulling down new modules in </span><span class="si">#{</span><span class="n">puppetfile</span><span class="si">}</span><span class="s2"> to </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;PUPPETFILE=</span><span class="si">#{</span><span class="n">puppetfile</span><span class="si">}</span><span class="s2"> PUPPETFILE_DIR=</span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2"> /usr/bin/r10k puppetfile install&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s1">&#39;Failed to build out Puppet module directory. Exiting...&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;New modules successfully pulled down&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>This first rake task uses r10k to read the Puppetfile and pull down the modules listed in it to the module directory.</p>

<p>Let&rsquo;s link this directory into the VM via the Vagrantfile, this way we can edit the code locally on the host while having it available to run on the Master VM:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="ss">:master</span> <span class="k">do</span> <span class="o">|</span><span class="n">master</span><span class="o">|</span>
</span><span class='line'>  <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;10.10.100.100&quot;</span>
</span><span class='line'>  <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;master.puppetlabs.vm&#39;</span>
</span><span class='line'>  <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:hosts</span>
</span><span class='line'>  <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:pe_bootstrap</span> <span class="k">do</span> <span class="o">|</span><span class="n">pe</span><span class="o">|</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">role</span> <span class="o">=</span> <span class="ss">:master</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;puppet/modules&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/modules&quot;</span>
</span><span class='line'>  <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;puppet/manifests&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/manifests&quot;</span>
</span><span class='line'>  <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;service iptables stop&quot;</span>
</span><span class='line'>  <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;rm -rf /etc/puppetlabs/puppet/modules/ &amp;&amp; ln -s /tmp/modules/ /etc/puppetlabs/puppet/&quot;</span>
</span><span class='line'>  <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;rm -rf /etc/puppetlabs/puppet/manifests/ &amp;&amp; ln -s /tmp/manifests/ /etc/puppetlabs/puppet/&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Why did I use the shell provisioner to sym link /tmp/modules and /tmp/manifests to <code>$confdir/modules</code> and <code>$confdir/manifests</code>?</p>

<p>The pe_build plugin for Vagrant will provision the master using the default Puppet Enterprise installer. However, the installer will fail if any PE-related directories already exist (/opt/puppet or /etc/puppetlabs for example).
To get around this, and still have live dir&rsquo;s provisioned on the VM I couldn&rsquo;t use the vagrant <code>synced_folder</code> method since that will run before the provisioners run (vagrant needs to build the machine before running any type of configuration managment on it) &ndash; the PE installer will blow up when the plugin runs since I have to sync into /etc/puppetlabs/puppet.</p>

<p>So instead of syncing into a PE-specific PATH I sync into /tmp, and then when the provisioner finishes (provisioners are ran in order) I can sym link the PE-specific module and manifests dir&rsquo;s from /tmp.</p>

<h3>Complete Vagrantfile:</h3>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Now</span> <span class="n">we</span> <span class="n">have</span> <span class="n">a</span> <span class="no">Rakefile</span> <span class="n">that</span> <span class="n">wraps</span> <span class="n">up</span> <span class="n">some</span> <span class="n">deploy</span> <span class="n">commands</span> <span class="ow">and</span> <span class="n">a</span>
</span><span class='line'><span class="c1"># -*- mode: ruby -*-</span>
</span><span class='line'><span class="c1"># vi: set ft=ruby :</span>
</span><span class='line'><span class="c1"># Vagrantfile API/syntax version. Don&#39;t touch unless you know what you&#39;re doing!</span>
</span><span class='line'><span class="no">VAGRANTFILE_API_VERSION</span> <span class="o">=</span> <span class="s2">&quot;2&quot;</span>
</span><span class='line'><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="no">VAGRANTFILE_API_VERSION</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;centos-64-x64-vbox4210.box&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box_url</span> <span class="o">=</span> <span class="s2">&quot;http://puppet-vagrant-boxes.puppetlabs.com/centos-64-x64-vbox4210.box&quot;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">pe_build</span><span class="o">.</span><span class="n">download_root</span> <span class="o">=</span> <span class="s1">&#39;https://s3.amazonaws.com/pe-builds/released/:version&#39;</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">pe_build</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;3.2.3&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">## Master</span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="ss">:master</span> <span class="k">do</span> <span class="o">|</span><span class="n">master</span><span class="o">|</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;10.10.100.100&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;master.puppetlabs.vm&#39;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:hosts</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:pe_bootstrap</span> <span class="k">do</span> <span class="o">|</span><span class="n">pe</span><span class="o">|</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">role</span> <span class="o">=</span> <span class="ss">:master</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;puppet/modules&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/modules&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;puppet/manifests&quot;</span><span class="p">,</span> <span class="s2">&quot;/tmp/manifests&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;service iptables stop&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;rm -rf /etc/puppetlabs/puppet/modules/ &amp;&amp; ln -s /tmp/modules/ /etc/puppetlabs/puppet/&quot;</span>
</span><span class='line'>    <span class="n">master</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="s2">&quot;shell&quot;</span><span class="p">,</span> <span class="ss">inline</span><span class="p">:</span> <span class="s2">&quot;rm -rf /etc/puppetlabs/puppet/manifests/ &amp;&amp; ln -s /tmp/manifests/ /etc/puppetlabs/puppet/&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">## Agent </span>
</span><span class='line'>  <span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="ss">:agent1</span> <span class="k">do</span> <span class="o">|</span><span class="n">agent</span><span class="o">|</span>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;10.10.100.111&quot;</span>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s1">&#39;agent1.puppetlabs.vm&#39;</span>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:hosts</span>
</span><span class='line'>    <span class="n">agent</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:pe_bootstrap</span> <span class="k">do</span> <span class="o">|</span><span class="n">pe</span><span class="o">|</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">role</span>   <span class="o">=</span>  <span class="ss">:agent</span>
</span><span class='line'>      <span class="n">pe</span><span class="o">.</span><span class="n">master</span> <span class="o">=</span> <span class="s1">&#39;master.puppetlabs.vm&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now I have an easy to use Vagrantfile that can boot my master with sym linked module and manifests dirs and an agent to test on.</p>

<p>Now we need to finish out that Rakefile, adding in some dependancy checks and some tasks to setup, deploy, pull (modules on the fly) and destroy as needed:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">begin</span>
</span><span class='line'>  <span class="nb">require</span> <span class="s1">&#39;os&#39;</span>
</span><span class='line'>  <span class="nb">require</span> <span class="s1">&#39;ptools&#39;</span>
</span><span class='line'><span class="k">rescue</span> <span class="no">LoadError</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Error during requires: </span><span class="se">\t</span><span class="si">#{</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">abort</span> <span class="s2">&quot;You may be able to fix this problem by running &#39;bundle&#39;.&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">task</span> <span class="ss">:default</span> <span class="o">=&gt;</span> <span class="s1">&#39;deps&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">necessary_programs</span> <span class="o">=</span> <span class="sx">%w(VirtualBox vagrant)</span>
</span><span class='line'><span class="n">necessary_plugins</span> <span class="o">=</span> <span class="sx">%w(vagrant-auto_network vagrant-pe_build vagrant-vmware-fusion)</span>
</span><span class='line'><span class="n">necessary_gems</span> <span class="o">=</span> <span class="sx">%w(bundle r10k)</span>
</span><span class='line'>
</span><span class='line'><span class="n">desc</span> <span class="s1">&#39;Check for the environment dependencies&#39;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:deps</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s1">&#39;Checking environment dependencies...&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">printf</span> <span class="s2">&quot;Is this a POSIX OS?...&quot;</span>
</span><span class='line'>  <span class="k">unless</span> <span class="no">OS</span><span class="o">.</span><span class="n">posix?</span>
</span><span class='line'>    <span class="nb">abort</span> <span class="s1">&#39;Sorry, you need to be running Linux or OSX to use this Vagrant environment!&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;OK&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">necessary_programs</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">prog</span><span class="o">|</span>
</span><span class='line'>    <span class="nb">printf</span> <span class="s2">&quot;Checking for %s...&quot;</span><span class="p">,</span> <span class="n">prog</span>
</span><span class='line'>    <span class="k">unless</span> <span class="no">File</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="n">prog</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sorry but I didn&#39;t find require program </span><span class="se">\&#39;</span><span class="si">#{</span><span class="n">prog</span><span class="si">}</span><span class="se">\&#39;</span><span class="s2"> in your PATH.</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;OK&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">necessary_plugins</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">plugin</span><span class="o">|</span>
</span><span class='line'>    <span class="nb">printf</span> <span class="s2">&quot;Checking for vagrant plugin %s...&quot;</span><span class="p">,</span> <span class="n">plugin</span>
</span><span class='line'>    <span class="k">unless</span> <span class="sx">%x{vagrant plugin list}</span><span class="o">.</span><span class="n">include?</span> <span class="n">plugin</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sorry, I wasn&#39;t able to find the Vagrant plugin </span><span class="se">\&#39;</span><span class="si">#{</span><span class="n">plugin</span><span class="si">}</span><span class="se">\&#39;</span><span class="s2"> on your system.&quot;</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s2">&quot;You may be able to fix this by running &#39;rake setup</span><span class="se">\&#39;</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;OK&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">necessary_gems</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">gem</span><span class="o">|</span>
</span><span class='line'>    <span class="nb">printf</span> <span class="s2">&quot;Checking for Ruby gem %s...&quot;</span><span class="p">,</span> <span class="n">gem</span>
</span><span class='line'>    <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;gem list --local -q --no-versions --no-details </span><span class="si">#{</span><span class="n">gem</span><span class="si">}</span><span class="s2"> | egrep &#39;^</span><span class="si">#{</span><span class="n">gem</span><span class="si">}</span><span class="s2">$&#39; &gt; /dev/null 2&gt;&amp;1&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Sorry, I wasn&#39;t able to find the </span><span class="se">\&#39;</span><span class="si">#{</span><span class="n">gem</span><span class="si">}</span><span class="se">\&#39;</span><span class="s2"> gem on your system.&quot;</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s2">&quot;You may be able to fix this by running </span><span class="se">\&#39;</span><span class="s2">gem install </span><span class="si">#{</span><span class="n">gem</span><span class="si">}</span><span class="se">\&#39;</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;OK&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">printf</span> <span class="s2">&quot;Checking for additional gems via &#39;bundle check&#39;...&quot;</span>
</span><span class='line'>  <span class="k">unless</span> <span class="sx">%x{bundle check}</span>
</span><span class='line'>    <span class="nb">abort</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;OK&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s1">&#39;*&#39;</span> <span class="o">*</span> <span class="mi">80</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Congratulations! Everything looks a-ok.&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s1">&#39;*&#39;</span> <span class="o">*</span> <span class="mi">80</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">desc</span> <span class="s1">&#39;Install the necessary Vagrant plugins&#39;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:setup</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">necessary_plugins</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">plugin</span><span class="o">|</span>
</span><span class='line'>    <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vagrant plugin install </span><span class="si">#{</span><span class="n">plugin</span><span class="si">}</span><span class="s2"> --verbose&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s2">&quot;Install of </span><span class="si">#{</span><span class="n">plugin</span><span class="si">}</span><span class="s2"> failed. Exiting...&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">necessary_gems</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">gem</span><span class="o">|</span>
</span><span class='line'>    <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;gem install </span><span class="si">#{</span><span class="n">gem</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s2">&quot;Install of </span><span class="si">#{</span><span class="n">gem</span><span class="si">}</span><span class="s2"> failed. Exiting...&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">unless</span> <span class="sx">%x{bundle check}</span>
</span><span class='line'>    <span class="nb">system</span><span class="p">(</span><span class="s1">&#39;bundle install&#39;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">desc</span> <span class="s1">&#39;Deploying modules form Puppetfile and booting master and agent VMs&#39;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:deploy</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Building out Puppet module directory...&quot;</span>
</span><span class='line'>  <span class="n">confdir</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span>
</span><span class='line'>  <span class="n">moduledir</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/modules&quot;</span>
</span><span class='line'>  <span class="n">puppetfile</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/Puppetfile&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Placing modules in </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Using Puppetfile at </span><span class="si">#{</span><span class="n">puppetfile</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;PUPPETFILE=</span><span class="si">#{</span><span class="n">puppetfile</span><span class="si">}</span><span class="s2"> PUPPETFILE_DIR=</span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2"> /usr/bin/r10k puppetfile install&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">abort</span> <span class="s1">&#39;Failed to build out Puppet module directory. Exiting...&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Bringing up vagrant machines&quot;</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vagrant up master agent1&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">abort</span> <span class="s1">&#39;Vagrant up failed. Exiting...&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Vagrant Machines Up Successfully</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Access master at &#39;vagrant ssh master&#39; or &#39;ssh vagrant@10.10.100.100&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Password = vagrant&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;-----&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Puppet modules brought in via puppet/Puppetfile are available on the Vagrant master VM at /etc/puppetlabs/puppet/modules&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;-----&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Contact git owner for PR&#39;s &amp; bug fixes&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;-----&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Done.&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">desc</span> <span class="s1">&#39;Pull down modules in Puppetfile&#39;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:pull</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">confdir</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">.</span><span class="n">pwd</span>
</span><span class='line'>  <span class="n">moduledir</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/modules&quot;</span>
</span><span class='line'>  <span class="n">puppetfile</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">confdir</span><span class="si">}</span><span class="s2">/puppet/Puppetfile&quot;</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Pulling down new modules in </span><span class="si">#{</span><span class="n">puppetfile</span><span class="si">}</span><span class="s2"> to </span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">unless</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;PUPPETFILE=</span><span class="si">#{</span><span class="n">puppetfile</span><span class="si">}</span><span class="s2"> PUPPETFILE_DIR=</span><span class="si">#{</span><span class="n">moduledir</span><span class="si">}</span><span class="s2"> /usr/bin/r10k puppetfile install&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s1">&#39;Failed to build out Puppet module directory. Exiting...&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;New modules successfully pulled down&quot;</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="n">desc</span> <span class="s1">&#39;Destroy Vagrant Machines&#39;</span>
</span><span class='line'><span class="n">task</span> <span class="ss">:destroy</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Are you sure you want to destroy the environment? [y/n]&quot;</span>
</span><span class='line'>  <span class="no">STDOUT</span><span class="o">.</span><span class="n">flush</span>
</span><span class='line'>  <span class="n">ans</span> <span class="o">=</span> <span class="no">STDIN</span><span class="o">.</span><span class="n">gets</span><span class="o">.</span><span class="n">chomp</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">ans</span> <span class="o">=~</span> <span class="sr">/^y/</span>
</span><span class='line'>      <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;vagrant destroy -f&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s1">&#39;Aborting vagrant destroy, exiting...&#39;</span>
</span><span class='line'>  <span class="k">end</span>      
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><a href="https://github.com/malnick/puppet-module-devtest-skeleton/tree/malnick">Entire project</a> is available on git.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-07-21T12:15:51-07:00" pubdate data-updated="true">Jul 21<span>st</span>, 2014</time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/07/14/managing-git-repos-over-jump-hosts-using-persistant-sockets/">
		
			Managing Git Repos Over Jump Hosts Using Persistant Sockets</a>
	</h2>
	<div class="entry-content">
		<p>I was recently helping a customer who had a somewhat complicated git workflow to production. All their Puppet code was in a locally accessible Gitlab server which was used by all the Automation dev&rsquo;s to develop, test and push to.</p>

<p>However, their integration and production environments were located behind a jumphost which also required a custom VPN connection.</p>

<p>The problem was that this deployment relied on <a href="https://github.com/adrienthebo/r10k">r10k</a> and the Puppet master needed access to the Gitlab server to create the local environments in both integration and eventually production.</p>

<p>Enabling a streamlined process to move the Gitlab codebase from our dev area into the corralled VM behind the jumphost was needed.</p>

<p>This workflow involves several steps:</p>

<ol>
<li>Connect NA Client VPN to Jumphost</li>
<li>SSH to Jumphost and enter auth credentials</li>
<li>SSH into yum repo server behind jumphost</li>
<li>Enter in yum repo auth credentials</li>
<li>scp your data &ndash; many ways to skin that cat, all are somewhat complicated</li>
</ol>


<h2>Automate with persistant SSH sockets</h2>

<p>I decided to write a SSH script which will do this, and I wanted to ensure we didn&rsquo;t fall into &lsquo;password&rsquo; hell and have to enter in a new password every time. I had heard you could do this by using the &lsquo;ControlMaster&rsquo; SSH param in SSH_config, open a persistant socket, and reuse it as needed. If I could enable this over a jumphost was another question but I gave it a shot.</p>

<ol>
<li><p>Create a persistant socket to jumphost with tunnel on localhost through the jumphost, pushing traffic from port 22 &ndash;> 5000</p>

<pre><code> ssh -o 'ControlMaster auto' -o 'ControlPath ~/.ssh/jump.sock' -N -f -L 5000:[git_repo_ip]:22 root@[jumphost_ip]
</code></pre></li>
<li><p>Create a direct persistant socket to the integration or production Gitlab server on localhost tunnel</p>

<pre><code> ssh -o 'ControlMaster auto' -o 'ControlPath ~/.ssh/git.sock' -N -f root@localhost -p 5000
</code></pre></li>
<li><p>CP arbitrary documents easily</p>

<p> scp -o &lsquo;ControlPath ~/.ssh/yum.sock&rsquo; -P 5000 $filepath root@localhost:/tmp/</p></li>
<li><p>SSH (no password required once socket is created!)</p>

<pre><code> ssh -S ~/.ssh/yum.sock root@localhost -p 5000
</code></pre></li>
<li><p>To destroy the sockets you need to do the yum repo first and jump second</p>

<pre><code> ssh -S ~/.ssh/yum.sock -O exit root@localhost &amp;&amp; ssh -S ~/.ssh/jump.sock -O exit root@172.20.100.11
</code></pre></li>
</ol>


<h2>A quick script</h2>

<p>Now that I can create persistant sockets I wrote a script to SSH into the local git, run <code>rake::restore</code>, scp the backup to my host, scp the backup from my host into the integration git over the jumphost connection, and run rake::restore.</p>

<ol>
<li>Check to ensure I&rsquo;m connected to the correct VPN Gateway</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="nb">test</span> <span class="o">-</span><span class="n">e</span> <span class="o">~</span><span class="sr">/.ssh || { echo &quot;Create an ssh dir&quot;; exit 1; }</span>
</span><span class='line'>
</span><span class='line'><span class="sr"> VPNENV=`echo $(naclient status | awk &#39;NR==4&#39; | cut -d: -f2)`</span>
</span><span class='line'><span class="sr"> VPNREMOTE=&quot;data_center&quot;</span>
</span><span class='line'><span class="sr"> LOCALGIT=&quot;10.10.100.100&quot;</span>
</span><span class='line'><span class="sr"> INTGIT=&quot;172.24.100.10&quot;</span>
</span><span class='line'><span class="sr"> JUMPHOST=&quot;172.20.100.11&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="sr"> if [ &quot;$VPNENV&quot; == &quot;$VPNREMOTE&quot; ]</span>
</span><span class='line'><span class="sr"> then</span>
</span><span class='line'><span class="sr">     echo &quot;Connected to $VPNENV&quot;</span>
</span><span class='line'><span class="sr"> </span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>Build the sockets</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="n">echo</span> <span class="s2">&quot;Connecting to local git:&quot;</span>
</span><span class='line'>  <span class="n">ssh</span> <span class="o">-</span><span class="n">o</span> <span class="s1">&#39;ControlMaster auto&#39;</span> <span class="o">-</span><span class="n">o</span> <span class="s1">&#39;ControlPath ~/.ssh/LOCALGIT.sock&#39;</span> <span class="o">-</span><span class="n">N</span> <span class="o">-</span><span class="n">f</span> <span class="n">root</span><span class="err">@</span><span class="vg">$LOCALGIT</span>
</span><span class='line'>  <span class="n">echo</span> <span class="s2">&quot;Connecting to jumphost:&quot;</span>
</span><span class='line'>  <span class="n">ssh</span> <span class="o">-</span><span class="n">o</span> <span class="s1">&#39;ControlMaster auto&#39;</span> <span class="o">-</span><span class="n">o</span> <span class="s1">&#39;ControlPath ~/.ssh/jump.sock&#39;</span> <span class="o">-</span><span class="n">N</span> <span class="o">-</span><span class="n">f</span> <span class="o">-</span><span class="n">L</span> <span class="vg">$PORT</span><span class="p">:</span><span class="vg">$INTGIT</span><span class="p">:</span><span class="mi">22</span> <span class="n">root</span><span class="err">@</span><span class="vg">$JUMPHOST</span>
</span><span class='line'>  <span class="n">echo</span> <span class="s2">&quot;Connecting to git in integration:&quot;</span>
</span><span class='line'>  <span class="n">ssh</span> <span class="o">-</span><span class="n">o</span> <span class="s1">&#39;ControlMaster auto&#39;</span> <span class="o">-</span><span class="n">o</span> <span class="s1">&#39;ControlPath ~/.ssh/intgit.sock&#39;</span> <span class="o">-</span><span class="n">o</span> <span class="s1">&#39;UserKnownHostsFile /dev/null&#39;</span> <span class="o">-</span><span class="n">N</span> <span class="o">-</span><span class="n">f</span> <span class="n">root</span><span class="vi">@localhost</span> <span class="o">-</span><span class="nb">p</span> <span class="vg">$PORT</span>  
</span><span class='line'>  
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>Use the sockets for SSH and SCP</li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="n">ssh</span> <span class="o">-</span><span class="n">S</span> <span class="o">~</span><span class="sr">/.ssh/</span><span class="no">LOCALGIT</span><span class="o">.</span><span class="n">sock</span> <span class="n">root</span><span class="err">@</span><span class="vg">$LOCALGIT</span> <span class="n">gitlab</span><span class="o">-</span><span class="n">rake</span> <span class="ss">gitlab</span><span class="p">:</span><span class="ss">backup</span><span class="p">:</span><span class="n">create</span>
</span><span class='line'>  <span class="n">ssh</span> <span class="o">-</span><span class="n">S</span> <span class="o">~</span><span class="sr">/.ssh/</span><span class="no">LOCALGIT</span><span class="o">.</span><span class="n">sock</span> <span class="n">root</span><span class="err">@</span><span class="vg">$LOCALGIT</span> <span class="s2">&quot;$(typeset -f); stagelatest&quot;</span>
</span><span class='line'>  
</span></code></pre></td></tr></table></div></figure>


<p>A note before moving on about the &lsquo;stagelatest&rsquo; function. I had a complicated command that I didn&rsquo;t want to toss into the SSH line, so I wrote a fuction and ran the <code>$(typeset -f)</code> command to make that function available on the remote SSH shell executing the commands. The function looked like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="n">stagelatest</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="no">LATESTBAK</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">ls</span> <span class="o">-</span><span class="n">t</span> <span class="sr">/var/o</span><span class="n">pt</span><span class="o">/</span><span class="n">gitlab</span><span class="o">/</span><span class="n">backups</span><span class="o">/</span> <span class="o">|</span> <span class="n">head</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>  <span class="n">rm</span> <span class="sr">/tmp/</span><span class="mi">1111111111</span><span class="n">_gitlab_backup</span><span class="o">.</span><span class="n">tar</span>
</span><span class='line'>  <span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="sr">/var/o</span><span class="n">pt</span><span class="o">/</span><span class="n">gitlab</span><span class="o">/</span><span class="n">backups</span><span class="o">/</span><span class="vg">$LATESTBAK</span> <span class="sr">/tmp/</span><span class="mi">1111111111</span><span class="n">_gitlab_backup</span><span class="o">.</span><span class="n">tar</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  
</span></code></pre></td></tr></table></div></figure>


<p>Continuing with our SCP and SSH commands:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="n">scp</span> <span class="o">-</span><span class="n">o</span> <span class="s1">&#39;ControlPath ~/.ssh/LOCALGIT.sock&#39;</span> <span class="n">root</span><span class="err">@</span><span class="vg">$LOCALGIT</span><span class="ss">:/</span><span class="n">tmp</span><span class="o">/</span><span class="mi">1111111111</span><span class="n">_gitlab_backup</span><span class="o">.</span><span class="n">tar</span> <span class="sr">/tmp/</span>
</span><span class='line'>  <span class="n">scp</span> <span class="o">-</span><span class="n">o</span> <span class="s1">&#39;ControlPath ~/.ssh/intgit.sock&#39;</span> <span class="o">-</span><span class="n">P</span> <span class="vg">$PORT</span> <span class="sr">/tmp/</span><span class="mi">1111111111</span><span class="n">_gitlab_backup</span><span class="o">.</span><span class="n">tar</span> <span class="n">root</span><span class="vi">@localhost</span><span class="ss">:/</span><span class="n">var</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">gitlab</span><span class="o">/</span><span class="n">backups</span>
</span><span class='line'>  <span class="n">ssh</span> <span class="o">-</span><span class="n">S</span> <span class="o">~</span><span class="sr">/.ssh/in</span><span class="n">tgit</span><span class="o">.</span><span class="n">sock</span> <span class="n">root</span><span class="vi">@localhost</span> <span class="o">-</span><span class="nb">p</span> <span class="vg">$PORT</span> <span class="no">BACKUP</span><span class="o">=</span><span class="mi">1111111111</span> <span class="n">gitlab</span><span class="o">-</span><span class="n">rake</span> <span class="ss">gitlab</span><span class="p">:</span><span class="ss">backup</span><span class="p">:</span><span class="n">restore</span> <span class="o">&lt;&lt;&lt;</span> <span class="n">yes</span>
</span><span class='line'>  
</span></code></pre></td></tr></table></div></figure>


<h2>The final script</h2>

<p>My final script includes a cleanup() function that is exectued via <code>trap</code> and at the end of the script on a good run. Cleaning up the sockets and ensuring nothing is left is always good practice.</p>

<p>I also modified my SSH commands to not use the known_hosts file. This way I could reuse the tunnle on localhost:5000 to other jumphost connections inside the corralled integration or production environments. Had I used the known_hosts file every time and not pipped it to <code>/dev/null</code>, everytime I reused localhost:5000 to tunnel to a new server behind the jumphost the public key would change and SSH would think someone is trying to do something funny.</p>

<p>I also include some more logic to really make sure that the rake::restore should run on the integration/production gitlab server. Nerver hurts to double check!</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/bin/bash</span>
</span><span class='line'><span class="n">cleanup</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">echo</span> <span class="s2">&quot;Cleaning up sockets and exiting&quot;</span>
</span><span class='line'>  <span class="nb">test</span> <span class="o">-</span><span class="n">e</span> <span class="o">~</span><span class="sr">/.ssh/</span><span class="no">LOCALGIT</span><span class="o">.</span><span class="n">sock</span> <span class="o">&amp;&amp;</span> <span class="n">ssh</span> <span class="o">-</span><span class="n">S</span> <span class="o">~</span><span class="sr">/.ssh/</span><span class="no">LOCALGIT</span><span class="o">.</span><span class="n">sock</span> <span class="o">-</span><span class="n">O</span> <span class="nb">exit</span> <span class="n">root</span><span class="err">@</span><span class="vg">$GITLAB</span>
</span><span class='line'>  <span class="nb">test</span> <span class="o">-</span><span class="n">e</span> <span class="o">~</span><span class="sr">/.ssh/in</span><span class="n">tgit</span><span class="o">.</span><span class="n">sock</span> <span class="o">&amp;&amp;</span> <span class="n">ssh</span> <span class="o">-</span><span class="n">S</span> <span class="o">~</span><span class="sr">/.ssh/in</span><span class="n">tgit</span><span class="o">.</span><span class="n">sock</span> <span class="o">-</span><span class="n">O</span> <span class="nb">exit</span> <span class="n">root</span><span class="vi">@localhost</span>
</span><span class='line'>  <span class="nb">test</span> <span class="o">-</span><span class="n">e</span> <span class="o">~</span><span class="sr">/.ssh/</span><span class="n">jump</span><span class="o">.</span><span class="n">sock</span> <span class="o">&amp;&amp;</span> <span class="n">ssh</span> <span class="o">-</span><span class="n">S</span> <span class="o">~</span><span class="sr">/.ssh/</span><span class="n">jump</span><span class="o">.</span><span class="n">sock</span> <span class="o">-</span><span class="n">O</span> <span class="nb">exit</span> <span class="n">root</span><span class="err">@</span><span class="vg">$JUMPHOST</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="vg">$@</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="nb">trap</span> <span class="n">cleanup</span> <span class="no">SIGHUP</span> <span class="no">SIGINT</span> <span class="no">SIGTERM</span>
</span><span class='line'>
</span><span class='line'><span class="n">stagelatest</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="no">LATESTBAK</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">ls</span> <span class="o">-</span><span class="n">t</span> <span class="sr">/var/o</span><span class="n">pt</span><span class="o">/</span><span class="n">gitlab</span><span class="o">/</span><span class="n">backups</span><span class="o">/</span> <span class="o">|</span> <span class="n">head</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>  <span class="n">rm</span> <span class="sr">/tmp/</span><span class="mi">1111111111</span><span class="n">_gitlab_backup</span><span class="o">.</span><span class="n">tar</span>
</span><span class='line'>  <span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="sr">/var/o</span><span class="n">pt</span><span class="o">/</span><span class="n">gitlab</span><span class="o">/</span><span class="n">backups</span><span class="o">/</span><span class="vg">$LATESTBAK</span> <span class="sr">/tmp/</span><span class="mi">1111111111</span><span class="n">_gitlab_backup</span><span class="o">.</span><span class="n">tar</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">getport</span> <span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="no">PORT</span><span class="o">=</span><span class="err">$</span><span class="p">((</span> <span class="vg">$RANDOM</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">+</span> <span class="mi">5000</span> <span class="p">))</span>
</span><span class='line'>  <span class="no">CHECK</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">netstat</span> <span class="o">-</span><span class="n">an</span> <span class="o">|</span><span class="n">grep</span> <span class="no">LISTEN</span> <span class="o">|</span> <span class="n">egrep</span> <span class="s2">&quot;[.:]${PORT}</span><span class="se">\s</span><span class="s2">&quot;</span> <span class="o">&gt;</span> <span class="sr">/dev/nu</span><span class="n">ll</span><span class="p">;</span> <span class="n">echo</span> <span class="vg">$?</span><span class="p">)</span>
</span><span class='line'>  <span class="k">while</span> <span class="o">[[</span> <span class="s2">&quot;$CHECK&quot;</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">]]</span>
</span><span class='line'>  <span class="k">do</span>
</span><span class='line'>      <span class="n">echo</span> <span class="s2">&quot;Port: $PORT is in use by another process, choosing another port.&quot;</span>
</span><span class='line'>      <span class="no">PORT</span><span class="o">=</span><span class="err">$</span><span class="p">((</span> <span class="vg">$RANDOM</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">+</span> <span class="n">port</span> <span class="p">))</span>
</span><span class='line'>
</span><span class='line'>      <span class="no">CHECK</span><span class="o">=</span><span class="err">$</span><span class="p">(</span><span class="n">netstat</span> <span class="o">-</span><span class="n">an</span> <span class="o">|</span><span class="n">grep</span> <span class="no">LISTEN</span> <span class="o">|</span> <span class="n">egrep</span> <span class="s2">&quot;[.:]$PORT</span><span class="se">\s</span><span class="s2">&quot;</span> <span class="o">&gt;</span> <span class="sr">/dev/nu</span><span class="n">ll</span><span class="p">;</span> <span class="n">echo</span> <span class="vg">$?</span><span class="p">)</span>
</span><span class='line'>  <span class="n">done</span>
</span><span class='line'>  <span class="n">echo</span> <span class="s2">&quot;Setting port to $PORT&quot;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="n">getport</span>
</span><span class='line'>
</span><span class='line'><span class="nb">test</span> <span class="o">-</span><span class="n">e</span> <span class="o">~</span><span class="sr">/.ssh || { echo &quot;Create an ssh dir&quot;; exit 1; }</span>
</span><span class='line'>
</span><span class='line'><span class="sr">VPNENV=`echo $(naclient status | awk &#39;NR==4&#39; | cut -d: -f2)`</span>
</span><span class='line'><span class="sr">VPNREMOTE=&quot;data_center&quot;</span>
</span><span class='line'><span class="sr">LOCALGIT=&quot;10.10.100.100&quot;</span>
</span><span class='line'><span class="sr">INTGIT=&quot;172.24.100.10&quot;</span>
</span><span class='line'><span class="sr">JUMPHOST=&quot;172.20.100.11&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="sr">if [ &quot;$VPNENV&quot; == &quot;$VPNREMOTE&quot; ]</span>
</span><span class='line'><span class="sr">then</span>
</span><span class='line'><span class="sr"> echo &quot;Connected to $VPNENV&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="sr"> echo &quot;Connecting to local git:&quot;</span>
</span><span class='line'><span class="sr"> ssh -o &#39;ControlMaster auto&#39; -o &#39;ControlPath ~/</span><span class="o">.</span><span class="n">ssh</span><span class="o">/</span><span class="no">LOCALGIT</span><span class="o">.</span><span class="n">sock</span><span class="s1">&#39; -N -f root@$LOCALGIT </span>
</span><span class='line'><span class="s1"> echo &quot;Connecting to jumphost:&quot;</span>
</span><span class='line'><span class="s1"> ssh -o &#39;</span><span class="no">ControlMaster</span> <span class="n">auto</span><span class="s1">&#39; -o &#39;</span><span class="no">ControlPath</span> <span class="o">~</span><span class="sr">/.ssh/</span><span class="n">jump</span><span class="o">.</span><span class="n">sock</span><span class="s1">&#39; -N -f -L $PORT:$INTGIT:22 root@$JUMPHOST</span>
</span><span class='line'><span class="s1"> echo &quot;Connecting to git in integration:&quot;</span>
</span><span class='line'><span class="s1"> ssh -o &#39;</span><span class="no">ControlMaster</span> <span class="n">auto</span><span class="s1">&#39; -o &#39;</span><span class="no">ControlPath</span> <span class="o">~</span><span class="sr">/.ssh/in</span><span class="n">tgit</span><span class="o">.</span><span class="n">sock</span><span class="s1">&#39; -o &#39;</span><span class="no">UserKnownHostsFile</span> <span class="sr">/dev/nu</span><span class="n">ll</span><span class="s1">&#39; -N -f root@localhost -p $PORT</span>
</span><span class='line'>
</span><span class='line'><span class="s1"> # SSH LOCALGIT and run rake backup, scp latest backup to host </span>
</span><span class='line'><span class="s1"> echo &quot;Running gitlab:backup:create&quot;</span>
</span><span class='line'><span class="s1"> ssh -S ~/.ssh/LOCALGIT.sock root@$LOCALGIT gitlab-rake gitlab:backup:create</span>
</span><span class='line'><span class="s1"> echo &quot;Staging backup in /tmp&quot;</span>
</span><span class='line'><span class="s1"> ssh -S ~/.ssh/LOCALGIT.sock root@$LOCALGIT &quot;$(typeset -f); stagelatest&quot;</span>
</span><span class='line'><span class="s1"> echo &quot;Copying over from lab git to localhost&quot;</span>
</span><span class='line'><span class="s1"> scp -o &#39;</span><span class="no">ControlPath</span> <span class="o">~</span><span class="sr">/.ssh/</span><span class="no">LOCALGIT</span><span class="o">.</span><span class="n">sock</span><span class="s1">&#39; root@$LOCALGIT:/tmp/1111111111_gitlab_backup.tar /tmp/</span>
</span><span class='line'><span class="s1"> echo &quot;Copying lab git backup from localhost to integration git server&quot;</span>
</span><span class='line'><span class="s1"> scp -o &#39;</span><span class="no">ControlPath</span> <span class="o">~</span><span class="sr">/.ssh/in</span><span class="n">tgit</span><span class="o">.</span><span class="n">sock</span><span class="err">&#39;</span> <span class="o">-</span><span class="n">P</span> <span class="vg">$PORT</span> <span class="sr">/tmp/</span><span class="mi">1111111111</span><span class="n">_gitlab_backup</span><span class="o">.</span><span class="n">tar</span> <span class="n">root</span><span class="vi">@localhost</span><span class="ss">:/</span><span class="n">var</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">gitlab</span><span class="o">/</span><span class="n">backups</span>
</span><span class='line'>  <span class="n">echo</span> <span class="s2">&quot;Would you like to run restore on the integration server now?&quot;</span>
</span><span class='line'>  <span class="n">read</span> <span class="n">restore</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">[[</span> <span class="vg">$restore</span> <span class="o">=~</span> <span class="o">^</span><span class="n">y</span> <span class="o">]]</span>
</span><span class='line'>  <span class="k">then</span>
</span><span class='line'>      <span class="n">echo</span> <span class="s2">&quot;Running restore on integration git server&quot;</span>
</span><span class='line'>      <span class="n">ssh</span> <span class="o">-</span><span class="n">S</span> <span class="o">~</span><span class="sr">/.ssh/in</span><span class="n">tgit</span><span class="o">.</span><span class="n">sock</span> <span class="n">root</span><span class="vi">@localhost</span> <span class="o">-</span><span class="nb">p</span> <span class="vg">$PORT</span> <span class="no">BACKUP</span><span class="o">=</span><span class="mi">1111111111</span> <span class="n">gitlab</span><span class="o">-</span><span class="n">rake</span> <span class="ss">gitlab</span><span class="p">:</span><span class="ss">backup</span><span class="p">:</span><span class="n">restore</span> <span class="o">&lt;&lt;&lt;</span> <span class="n">yes</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>      <span class="n">echo</span> <span class="s2">&quot;Not running restore&quot;</span>
</span><span class='line'>      <span class="n">echo</span> <span class="s2">&quot;Backup located at /var/opt/gitlab/backups/1111111111_gitlab_backup.tar&quot;</span>
</span><span class='line'>      <span class="n">echo</span> <span class="s2">&quot;-----&quot;</span>
</span><span class='line'>      <span class="n">echo</span> <span class="s2">&quot;To backup manually run:&quot;</span>
</span><span class='line'>      <span class="n">echo</span> <span class="s2">&quot;BACKUP=1111111111_gitlab_backup.tar gitlab-rake gitlab:backup:restore&quot;</span>
</span><span class='line'>  <span class="n">fi</span>
</span><span class='line'>  <span class="n">cleanup</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">echo</span> <span class="s2">&quot;VPN Enviro not correct, connected to: $VPNENV&quot;</span>
</span><span class='line'>  <span class="n">echo</span> <span class="s2">&quot;Check VPN connection to data_center, or start NA Client&quot;</span>
</span><span class='line'>  <span class="n">cleanup</span> <span class="mi">1</span>
</span><span class='line'><span class="n">fi</span>
</span></code></pre></td></tr></table></div></figure>


<p>The final script can be pulled down from <a href="https://github.com/malnick/scripts/blob/master/connect.sh">my github account</a>.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-07-14T07:09:09-07:00" pubdate data-updated="true">Jul 14<span>th</span>, 2014</time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/06/24/a-simple-nagios-docker-plugin/">
		
			A Simple Nagios Docker Plugin</a>
	</h2>
	<div class="entry-content">
		<p>Docker is an amazing tool with a lot great functional command line interfaces. A typical docker deployment might have a webapp running inside a container. In order to observe the beahvior of this container you might want to setup a Nagios plugin to monitor log output.</p>

<p>To do this I am going to do the following:</p>

<ol>
<li>Deploy an Ubuntu Precise VM on 10.10.33.2 via Vagrant</li>
<li>Provsion the VM with Puppet using the Vagrant Puppet provisioner:

<ol>
<li>Installs docker using garethr-docker</li>
<li>Installs the training/webapp image</li>
<li>Runs the container using an exec</li>
<li>Installs nagios and my ruby plugin to monitor the docker service and the training/webapp image for the following:

<ol>
<li>Is the docker command available?</li>
<li>Is the webapp running?

<ul>
<li>Ensures webapp is running on <code>localhost:5000</code></li>
<li>Checks the log for 404 errors and sends warnings if so</li>
<li>Counts the errors for each URL with a 404 and outputs the count and URL which has the highest hit count</li>
<li>test the above by trying <code>10.10.33.2:5000/test</code> over and over again</li>
</ul>
</li>
</ol>
</li>
</ol>
</li>
</ol>


<h2>The Vagrantfile</h2>

<p>I start with a basic Vagrantfile to deploy an Ubuntu Precise VM:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Vagrant</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="s2">&quot;2&quot;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">config</span><span class="o">|</span>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="s2">&quot;virtualbox&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span>
</span><span class='line'>  <span class="n">v</span><span class="o">.</span><span class="n">customize</span> <span class="o">[</span><span class="s2">&quot;modifyvm&quot;</span><span class="p">,</span> <span class="ss">:id</span><span class="p">,</span> <span class="s2">&quot;--memory&quot;</span><span class="p">,</span> <span class="mi">1024</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">define</span> <span class="ss">:nagios</span> <span class="k">do</span> <span class="o">|</span><span class="n">deploy</span><span class="o">|</span>
</span><span class='line'>  <span class="n">deploy</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box</span> <span class="o">=</span> <span class="s2">&quot;precise64&quot;</span>
</span><span class='line'>  <span class="n">deploy</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">hostname</span> <span class="o">=</span> <span class="s2">&quot;nagios.server.dev&quot;</span>
</span><span class='line'>  <span class="n">deploy</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">box_url</span> <span class="o">=</span> <span class="s2">&quot;http://files.vagrantup.com/precise64.box&quot;</span>
</span><span class='line'>  <span class="n">deploy</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;modules&quot;</span><span class="p">,</span> <span class="s2">&quot;/etc/puppet/modules&quot;</span>
</span><span class='line'>  <span class="n">deploy</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">synced_folder</span> <span class="s2">&quot;manifests&quot;</span><span class="p">,</span> <span class="s2">&quot;/etc/puppet/manifests&quot;</span>
</span><span class='line'>  <span class="n">deploy</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">network</span> <span class="ss">:private_network</span><span class="p">,</span> <span class="ss">ip</span><span class="p">:</span> <span class="s2">&quot;10.10.33.2&quot;</span> <span class="c1"># Define static IP once dev completes</span>
</span><span class='line'>  <span class="n">deploy</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provision</span> <span class="ss">:puppet</span><span class="p">,</span> <span class="ss">:module_path</span> <span class="o">=&gt;</span> <span class="s2">&quot;modules&quot;</span><span class="p">,</span> <span class="ss">:manifests_path</span> <span class="o">=&gt;</span> <span class="s2">&quot;manifests&quot;</span><span class="p">,</span> <span class="ss">:manifest_file</span> <span class="o">=&gt;</span> <span class="s2">&quot;deploy_nagios.pp&quot;</span>
</span><span class='line'>   <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Puppet Provisioner</h2>

<p>In order to provision the VM on boot I used the Puppet provisioner which ships with Vagrant. For testing purposes I like to sync my manifests and modules directory to the VM. Usually I run a bash script before provisioning with Puppet to install from the Puppet Labs apt or yum repos, however for this project that wasn&rsquo;t neccessary as the goal is to have a quickly bootable dev environment for my Nagios server and Docker container.</p>

<p>The <code>deploy_nagios.pp</code> manifest looks like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Deploy docker and an Ubuntu image to play with</span>
</span><span class='line'><span class="k">class</span> <span class="p">{</span><span class="s1">&#39;docker&#39;</span><span class="p">:}</span>
</span><span class='line'><span class="ss">docker</span><span class="p">:</span><span class="ss">:image</span> <span class="p">{</span> <span class="s1">&#39;training/webapp&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="nb">require</span> <span class="o">=&gt;</span> <span class="no">Class</span><span class="o">[</span><span class="s1">&#39;docker&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1"># Super hero hack to run the docker image... see readme for why.</span>
</span><span class='line'><span class="c1"># Also, in no way is this idempotent, if it&#39;s running it&#39;ll fail.</span>
</span><span class='line'><span class="nb">exec</span> <span class="p">{</span> <span class="s1">&#39;/usr/bin/docker run -d -p 5000:5000 training/webapp python app.py&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="nb">require</span> <span class="o">=&gt;</span> <span class="ss">Docker</span><span class="p">:</span><span class="ss">:Image</span><span class="o">[</span><span class="s1">&#39;training/webapp&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="c1">#docker::run { &#39;webapp&#39;:</span>
</span><span class='line'><span class="c1">#  image   =&gt; &#39;ubuntu&#39;,</span>
</span><span class='line'><span class="c1">#  command =&gt; &#39;/bin/echo test&#39;,</span>
</span><span class='line'><span class="c1">#  require =&gt; Docker::Image[&#39;training/webapp&#39;],</span>
</span><span class='line'><span class="c1">#}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Update this thing</span>
</span><span class='line'><span class="nb">exec</span> <span class="p">{</span> <span class="s1">&#39;/usr/bin/apt-get update&#39;</span><span class="p">:}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Install nagios </span>
</span><span class='line'><span class="k">class</span> <span class="p">{</span> <span class="s1">&#39;nagios&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="nb">require</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="no">Exec</span><span class="o">[</span><span class="s1">&#39;/usr/bin/apt-get update&#39;</span><span class="o">]</span><span class="p">,</span><span class="no">Class</span><span class="o">[</span><span class="s1">&#39;docker&#39;</span><span class="o">]]</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Get my plugin on the system correctly</span>
</span><span class='line'><span class="ss">nagios</span><span class="p">:</span><span class="ss">:plugin</span> <span class="p">{</span> <span class="s1">&#39;docker_status&#39;</span><span class="p">:</span>
</span><span class='line'>   <span class="n">source</span> <span class="o">=&gt;</span> <span class="s1">&#39;nagios/nagios-plugins/docker_status.rb&#39;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># WARNING: TOTAL HACK PLEASE DON&#39;T JUDGE ME</span>
</span><span class='line'><span class="nb">exec</span> <span class="p">{</span> <span class="s1">&#39;/bin/echo &quot;command[docker_status]=/usr/lib/nagios/plugins/docker_status&quot; &gt;&gt; /etc/nagios/nrpe.cfg&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="nb">require</span> <span class="o">=&gt;</span> <span class="no">File</span><span class="o">[</span><span class="s1">&#39;/etc/nagios/nrpe.cfg&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>  <span class="n">notify</span> <span class="o">=&gt;</span> <span class="no">Service</span><span class="o">[</span><span class="s1">&#39;nrpe&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Ensure docker and nagios are in the same group</span>
</span><span class='line'><span class="nb">exec</span> <span class="p">{</span><span class="s1">&#39;/usr/sbin/usermod -a -G docker nagios&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="nb">require</span> <span class="o">=&gt;</span> <span class="no">Class</span><span class="o">[</span><span class="s1">&#39;nagios&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'>  <span class="n">notify</span>  <span class="o">=&gt;</span> <span class="no">Service</span><span class="o">[</span><span class="s1">&#39;nrpe&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="ss">nagios</span><span class="p">:</span><span class="ss">:command</span> <span class="p">{</span> <span class="s1">&#39;docker_status&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="n">command_line</span> <span class="o">=&gt;</span> <span class="s1">&#39;$USER1$/check_nrpe -H $HOSTADDRESS$ -c docker_status&#39;</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Set the nagiosadmin password </span>
</span><span class='line'><span class="nb">exec</span> <span class="p">{</span> <span class="s1">&#39;/usr/bin/htpasswd -cb /etc/nagios3/htpasswd.users nagiosadmin nagiosadmin&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="nb">require</span> <span class="o">=&gt;</span> <span class="no">Class</span><span class="o">[</span><span class="s1">&#39;nagios&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># I wrote my plugin in Ruby so lets make sure the VM has it. </span>
</span><span class='line'><span class="n">package</span> <span class="p">{</span> <span class="s1">&#39;ruby1.9.1&#39;</span><span class="p">:</span>
</span><span class='line'>  <span class="k">ensure</span> <span class="o">=&gt;</span> <span class="n">present</span><span class="p">,</span>
</span><span class='line'>  <span class="nb">require</span> <span class="o">=&gt;</span> <span class="no">Class</span><span class="o">[</span><span class="s1">&#39;nagios&#39;</span><span class="o">]</span><span class="p">,</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Yup, I had a couple of hero hacks in there to get around some issues with the <code>docker::run</code> define. That define should work, but  kept failing with a very odd &lsquo;&lt;&lt; is not a {}:hash&rsquo; error. I grep&#8217;ed through the module to try and find where this was coming from and I think it&rsquo;s a heredoc within a function for the define. I still need to look into it. I ran an exec after the image is downloaded to get around this problem.</p>

<p>I also hero hacked the update to the <code>nrpe.cfg</code> file as the Nagios module I used didn&rsquo;t make it clearly evident how or if it did this.</p>

<p>&hellip; In no way do any of these hacks make me an &ldquo;inpatient&rdquo; person.</p>

<h2>The Nagios Plugin</h2>

<p>Recall my plugin should monitor:</p>

<ol>
<li>Is the docker command available?</li>
<li>Is the webapp running?

<ul>
<li>Ensures webapp is running on <code>localhost:5000</code></li>
<li>Checks the log for 404 errors and sends warnings if so</li>
<li>Counts the errors for each URL with a 404 and outputs the count and URL which has the highest hit count</li>
<li>test the above by trying <code>10.10.33.2:5000/test</code> over and over again</li>
</ul>
</li>
</ol>


<h3>Let&rsquo;s break it down</h3>

<h4>Nagios Basics:</h4>

<p>First, let&rsquo;s define some basic outputs for the Nagios API. Since Nagios is only looking for specific exit codes from any given script we define those as methods here first.</p>

<pre><code>0 = OK
1 = Shit is potentially hitting the fan
2 = Shit is hitting the fan
3 = Unknown shit is happening
</code></pre>

<h4>The first part of my Plugin defines these:</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/bin/ruby</span>
</span><span class='line'><span class="c1"># Checks the docker status command for number of running containers</span>
</span><span class='line'><span class="c1"># Ensures the docker container is running by checking that the socket exists</span>
</span><span class='line'><span class="c1"># </span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Define some helper methods for Nagios with appropriate exit codes</span>
</span><span class='line'><span class="k">def</span> <span class="nf">ok</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;OK - </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="mi">0</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">critical</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Critical - </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="mi">2</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">warning</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Warning - </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="mi">1</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">unknown</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Unknown - </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="mi">3</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Check to ensure docker is installed</h4>

<p>Now let&rsquo;s check to ensure Docker is installed, we can use a simple <code>system()</code> method which returns exit codes only:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">docker_installed</span><span class="p">()</span>
</span><span class='line'>  <span class="k">if</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;which docker &gt; /dev/null&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">webapp_status</span><span class="p">()</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>      <span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Docker isn&#39;t installed&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Yup, it&rsquo;s that easy, <code>which docker</code> will return &lsquo;0&rsquo; or &lsquo;false&rsquo; if it does not find the command and &lsquo;1&rsquo; or &lsquo;true&rsquo; if a path to the command is found. This isn&rsquo;t the most robust check ever, but for now it&rsquo;s enough to move on. Since all my other def&rsquo;s work on the <code>docker</code> face and it&rsquo;s sub commands I need to ensure this is present before doing anything else.</p>

<h4>Check the webapp status</h4>

<p>First, I want to make sure the webapp is running on the VM on a specific port. I&rsquo;m going to use a <code>netstat</code> command and <code>awk</code> to return the process running on port 5000:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">webapp_status</span><span class="p">()</span>
</span><span class='line'>  <span class="c1"># Ensure the webapp is running on localhost:5000</span>
</span><span class='line'>  <span class="n">webapp_run</span> <span class="o">=</span> <span class="sb">`netstat -anp | grep 5000 | awk &#39;{print $7}&#39; | cut -d/ -f2`</span>
</span><span class='line'>  <span class="n">should_be</span>   <span class="o">=</span> <span class="s2">&quot;docker&quot;</span>
</span><span class='line'>  <span class="n">webapp_run</span><span class="o">.</span><span class="n">chomp!</span><span class="o">.</span><span class="n">strip!</span>
</span></code></pre></td></tr></table></div></figure>


<p>This should return this this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@nagios:/home/vagrant# netstat -anp | grep 5000 | awk <span class="s1">&#39;{print $7}&#39;</span> | cut -d/ -f2
</span><span class='line'>docker
</span></code></pre></td></tr></table></div></figure>


<p>Then we pass this into some basic &lsquo;if&rsquo; logic:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'> <span class="k">if</span> <span class="n">webapp_run</span> <span class="o">==</span> <span class="n">should_be</span>
</span><span class='line'>      <span class="c1"># Check to ensure there are no 404 errors in the log</span>
</span><span class='line'>      <span class="n">check_this</span> <span class="o">=</span> <span class="s2">&quot;docker logs $(docker ps -l | awk &#39;{print $1}&#39; | awk &#39;{if (NR == 2){print $0}}&#39;) 2&gt;&amp;1 | grep 404 | awk &#39;{print $7}&#39; | sort | uniq -c&quot;</span>
</span><span class='line'>      <span class="n">check</span> <span class="o">=</span> <span class="nb">system</span><span class="p">(</span><span class="n">check_this</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">check</span>
</span><span class='line'>          <span class="no">IO</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="n">check_this</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">io</span><span class="o">|</span>
</span><span class='line'>              <span class="n">line</span>  <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">readlines</span>
</span><span class='line'>              <span class="n">errors</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>              <span class="n">line</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">this</span><span class="o">|</span>
</span><span class='line'>                  <span class="n">number</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>                  <span class="n">url</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>                  <span class="n">errors</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>   
</span><span class='line'>              <span class="k">end</span>  
</span><span class='line'>              <span class="n">max_value</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">max</span>
</span><span class='line'>              <span class="n">max_key</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span><span class="o">==</span><span class="n">max_value</span> <span class="p">}</span><span class="o">.</span><span class="n">keys</span>  
</span><span class='line'>              <span class="k">case</span> <span class="n">max_value</span><span class="o">.</span><span class="n">to_i</span> <span class="o">&gt;</span> <span class="mi">20</span>
</span><span class='line'>                  <span class="k">when</span> <span class="kp">false</span>
</span><span class='line'>                      <span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">max_value</span><span class="si">}</span><span class="s2"> 404 Errors at localhost</span><span class="si">#{</span><span class="n">max_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>                  <span class="k">when</span> <span class="kp">true</span>
</span><span class='line'>                      <span class="n">critical</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">max_value</span><span class="si">}</span><span class="s2"> 404 Errors at localhost</span><span class="si">#{</span><span class="n">max_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="k">end</span>
</span><span class='line'>          <span class="k">end</span>  
</span></code></pre></td></tr></table></div></figure>


<p>Lot&rsquo;s of things are happening there.</p>

<p>1st, if &lsquo;docker&rsquo; is the output of the webapp status command we drop into another loop. This loop runs a <code>check_this</code> command that is derived from the <code>docker log</code> face. That particular face feeds the output from a sys-log-like to the terminals stdin.</p>

<p>But first, <code>docker logs</code> needs to have the process hash of the container you want to query, so I run a <code>docker ps -l</code> and <code>awk</code> for the hash of the process I want.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@nagios:/home/vagrant# docker ps -l
</span><span class='line'>CONTAINER ID        IMAGE                    COMMAND             CREATED             STATUS              PORTS                    NAMES
</span><span class='line'>c968cced9f32        training/webapp:latest   python app.py       33 minutes ago      Up 33 minutes       0.0.0.0:5000-&gt;5000/tcp   berserk_pare
</span></code></pre></td></tr></table></div></figure>


<p>This would definitely break if you had many containers running.</p>

<p>So anyways, if we have that hash we can now pass it to <code>docker logs</code> like I did in the ruby script like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">root</span><span class="vi">@nagios</span><span class="ss">:/</span><span class="n">home</span><span class="o">/</span><span class="n">vagrant</span><span class="c1"># docker logs c968cced9f32</span>
</span><span class='line'> <span class="o">*</span> <span class="no">Running</span> <span class="n">on</span> <span class="ss">http</span><span class="p">:</span><span class="sr">//</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="p">:</span><span class="mi">5000</span><span class="o">/</span>
</span></code></pre></td></tr></table></div></figure>


<p>Tight.</p>

<p>Now that I have access to the log from the webapp I can grep URL&rsquo;s which have 404 errors, add those to a hash as k,v&rsquo;s and then iterate over the hash for the key with the largest value.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">IO</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="n">check_this</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">io</span><span class="o">|</span>
</span><span class='line'>  <span class="n">line</span>  <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">readlines</span>
</span><span class='line'>  <span class="n">errors</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>  <span class="n">line</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">this</span><span class="o">|</span>
</span><span class='line'>      <span class="n">number</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>      <span class="n">url</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>      <span class="n">errors</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>   
</span><span class='line'>  <span class="k">end</span>  
</span><span class='line'>  <span class="n">max_value</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">max</span>
</span><span class='line'>  <span class="n">max_key</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span><span class="o">==</span><span class="n">max_value</span> <span class="p">}</span><span class="o">.</span><span class="n">keys</span>  
</span></code></pre></td></tr></table></div></figure>


<p>Now I can use that key&rsquo;s value to hit my <code>warning</code> or <code>critical</code> methods.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">case</span> <span class="n">max_value</span><span class="o">.</span><span class="n">to_i</span> <span class="o">&gt;</span> <span class="mi">20</span>
</span><span class='line'><span class="k">when</span> <span class="kp">false</span>
</span><span class='line'>  <span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">max_value</span><span class="si">}</span><span class="s2"> 404 Errors at localhost</span><span class="si">#{</span><span class="n">max_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">when</span> <span class="kp">true</span>
</span><span class='line'>  <span class="n">critical</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">max_value</span><span class="si">}</span><span class="s2"> 404 Errors at localhost</span><span class="si">#{</span><span class="n">max_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Of course, the end to this giant loop of loops does&hellip;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>     <span class="k">else</span>
</span><span class='line'>          <span class="n">ok</span><span class="p">(</span><span class="s2">&quot;Docker &amp; Webapp are in good shape!&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>      <span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Webapp is not running on localhost:5000&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>&hellip; and finally start it</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">docker_installed</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>My entire script looks like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Full </span>
</span><span class='line'><span class="c1">#!/usr/bin/ruby</span>
</span><span class='line'><span class="c1"># Checks the docker status command for number of running containers</span>
</span><span class='line'><span class="c1"># Ensures the docker container is running by checking that the socket exists</span>
</span><span class='line'><span class="c1"># </span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Define some helper methods for Nagios with appropriate exit codes</span>
</span><span class='line'><span class="k">def</span> <span class="nf">ok</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;OK - </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="mi">0</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">critical</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Critical - </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="mi">2</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">warning</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Warning - </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="mi">1</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">unknown</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="s2">&quot;Unknown - </span><span class="si">#{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="nb">exit</span> <span class="mi">3</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Check to ensure docker is installed</span>
</span><span class='line'><span class="k">def</span> <span class="nf">docker_installed</span><span class="p">()</span>
</span><span class='line'>  <span class="k">if</span> <span class="nb">system</span><span class="p">(</span><span class="s2">&quot;which docker &gt; /dev/null&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">webapp_status</span><span class="p">()</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>      <span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Docker isn&#39;t installed&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="nf">webapp_status</span><span class="p">()</span>
</span><span class='line'>  <span class="c1"># Ensure the webapp is running on localhost:5000</span>
</span><span class='line'>  <span class="n">webapp_run</span> <span class="o">=</span> <span class="sb">`netstat -anp | grep 5000 | awk &#39;{print $7}&#39; | cut -d/ -f2`</span>
</span><span class='line'>  <span class="n">should_be</span>   <span class="o">=</span> <span class="s2">&quot;docker&quot;</span>
</span><span class='line'>  <span class="n">webapp_run</span><span class="o">.</span><span class="n">chomp!</span><span class="o">.</span><span class="n">strip!</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">webapp_run</span> <span class="o">==</span> <span class="n">should_be</span>
</span><span class='line'>      <span class="c1"># Check to ensure there are no 404 errors in the log</span>
</span><span class='line'>      <span class="n">check_this</span> <span class="o">=</span> <span class="s2">&quot;docker logs $(docker ps -l | awk &#39;{print $1}&#39; | awk &#39;{if (NR == 2){print $0}}&#39;) 2&gt;&amp;1 | grep 404 | awk &#39;{print $7}&#39; | sort | uniq -c&quot;</span>
</span><span class='line'>      <span class="n">check</span> <span class="o">=</span> <span class="nb">system</span><span class="p">(</span><span class="n">check_this</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">check</span>
</span><span class='line'>          <span class="no">IO</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="n">check_this</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">io</span><span class="o">|</span>
</span><span class='line'>              <span class="n">line</span>  <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">readlines</span>
</span><span class='line'>              <span class="n">errors</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>              <span class="n">line</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">this</span><span class="o">|</span>
</span><span class='line'>                  <span class="n">number</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>                  <span class="n">url</span> <span class="o">=</span> <span class="n">this</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>                  <span class="n">errors</span><span class="o">.</span><span class="n">store</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">number</span><span class="p">)</span>   
</span><span class='line'>              <span class="k">end</span>  
</span><span class='line'>              <span class="n">max_value</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">max</span>
</span><span class='line'>              <span class="n">max_key</span> <span class="o">=</span> <span class="n">errors</span><span class="o">.</span><span class="n">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="n">v</span><span class="o">==</span><span class="n">max_value</span> <span class="p">}</span><span class="o">.</span><span class="n">keys</span>  
</span><span class='line'>              <span class="k">case</span> <span class="n">max_value</span><span class="o">.</span><span class="n">to_i</span> <span class="o">&gt;</span> <span class="mi">20</span>
</span><span class='line'>                  <span class="k">when</span> <span class="kp">false</span>
</span><span class='line'>                      <span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">max_value</span><span class="si">}</span><span class="s2"> 404 Errors at localhost</span><span class="si">#{</span><span class="n">max_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>                  <span class="k">when</span> <span class="kp">true</span>
</span><span class='line'>                      <span class="n">critical</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">max_value</span><span class="si">}</span><span class="s2"> 404 Errors at localhost</span><span class="si">#{</span><span class="n">max_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>              <span class="k">end</span>
</span><span class='line'>          <span class="k">end</span>  
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>          <span class="n">ok</span><span class="p">(</span><span class="s2">&quot;Docker &amp; Webapp are in good shape!&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>      <span class="n">critical</span><span class="p">(</span><span class="s2">&quot;Webapp is not running on localhost:5000&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">docker_installed</span><span class="p">()</span>
</span></code></pre></td></tr></table></div></figure>




		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-06-24T12:19:43-07:00" pubdate data-updated="true">Jun 24<span>th</span>, 2014</time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/06/03/continuous-integration-with-puppet-code/">
		
			Continuous Integration With Puppet Code</a>
	</h2>
	<div class="entry-content">
		<iframe src="http://www.slideshare.net/slideshow/embed_code/35435020" width="427" height="356" frameborder="0" marginwidth="0" marginheight="0" scrolling="no" style="border:1px solid #CCC; border-width:1px 1px 0; margin-bottom:5px; max-width: 100%;" allowfullscreen> </iframe>


<p> <div style="margin-bottom:5px"> <strong> <a href="https://www.slideshare.net/malnick/continuous-integration-withpuppet" title="Continuous integration with_puppet" target="_blank">Continuous integration with_puppet</a> </strong> from <strong><a href="http://www.slideshare.net/malnick" target="_blank">malnick</a></strong> </div></p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-06-03T07:54:12-07:00" pubdate data-updated="true">Jun 3<span>rd</span>, 2014</time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/05/30/what-is-this-module-doing/">
		
			What Is This Module Doing?</a>
	</h2>
	<div class="entry-content">
		

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-05-30T15:58:12-07:00" pubdate data-updated="true">May 30<span>th</span>, 2014</time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/05/29/packer-templates-and-vmware/">
		
			Packer Templates &amp; VMWare</a>
	</h2>
	<div class="entry-content">
		<h2>tl;dr</h2>

<p>There&rsquo;s not a lot of docs on Packer and the logging can be tricky to find sometimes depending on the vm you&rsquo;re booting (which provider backs it). If you&rsquo;re using VMWare and you&rsquo;re booting centos the <code>guest_os_type</code> key needs to be set appropriatly.</p>

<p>Some people seem to think this can be $anything that sounds reasonable (I did!) and there is no documentation on what should actually go there (as of writing this, Google was sparce). So if you have a doubt on what the <code>guest_os_type</code> value should be the best bet is to <code>$ diff</code> it with an already existing <code>*.your_vm_type</code> (&lsquo;vmx&rsquo;, &lsquo;ovf&rsquo;, et cetera).</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cat centos65-puppetmaster.json | grep -i guest_os_type
</span><span class='line'>    <span class="s2">&quot;guest_os_type&quot;</span>: <span class="s2">&quot;centos-65&quot;</span>,
</span></code></pre></td></tr></table></div></figure>


<p>However, if I query an already built <code>*.vmx</code> this is incorrect:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cat master2.vmx | grep -i guestos
</span><span class='line'>   <span class="nv">guestos</span> <span class="o">=</span> <span class="s2">&quot;redhat&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>For CentOS at least, your <code>guest_os_type</code> value should be set to <code>redhat</code>.</p>

<h2>Back Story</h2>

<p>This week I was working with a customer to automate the deployment of some VM&rsquo;s to vSphere. This deployment is replaceing some current scripts and manually configured templates. Actually, a lot of scripts and manually configured templates.</p>

<p>The long and the short of it, me and my team decided to implement Vagrant and Packer to push out pre-written Packer templates to vSphere via Vagrant&rsquo;s vSphere plugin using the VMWare provider.</p>

<p>After scripting the json for this node I ran <code>packer build centos65.json</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">==</span>&gt; vmware-iso: Downloading or copying <span class="nv">ISO</span>
</span><span class='line'><span class="o">==</span>&gt; vmware-iso: Downloading or copying ISO
</span><span class='line'>vmware-iso: Downloading or copying: http://mirrors.kernel.org/centos/6.5/isos/x86_64/CentOS-6.5
</span><span class='line'><span class="o">==</span>&gt; vmware-iso: Creating virtual machine <span class="nv">disk</span>
</span><span class='line'><span class="o">==</span>&gt; vmware-iso: Building and writing VMX <span class="nv">file</span>
</span><span class='line'><span class="o">==</span>&gt; vmware-iso: Starting HTTP server on port <span class="nv">8582</span>
</span><span class='line'><span class="o">==</span>&gt; vmware-iso: Starting virtual machine...
</span><span class='line'><span class="o">==</span>&gt; vmware-iso: Error starting VM: VMware error:
</span><span class='line'><span class="o">==</span>&gt; vmware-iso: Deleting output directory...
</span><span class='line'>Build <span class="s1">&#39;vmware-iso&#39;</span> errored: Error starting VM: VMware error:
</span><span class='line'><span class="o">==</span>&gt; Some builds didn<span class="err">&#39;</span>t <span class="nb">complete </span>successfully and had errors:
</span><span class='line'>--&gt; vmware-iso: Error starting VM: VMware error:
</span><span class='line'>
</span><span class='line'><span class="o">==</span>&gt; Builds finished but no artifacts were created.
</span></code></pre></td></tr></table></div></figure>


<p>The vm booted into fusion and opened but failed in <code>vmrun</code>. How did I know that was the issue?</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>grep -r vmrun /var/log/*
</span><span class='line'>system.log:May 29 05:30:32 bohr vmrun<span class="o">[</span>13249<span class="o">]</span>: com.vmware.fusion.78704: Invalid argument
</span><span class='line'>... <span class="c"># lots of other crap </span>
</span></code></pre></td></tr></table></div></figure>


<p>BUT WHAT ARGUMENT???</p>

<p>After digging around I found that logging for this issue was sketchy at best. Syslog, <code>/var/tmp/vmware</code>, the <code>guest_os_type</code> key needs to have an appropriate value (i.e., arugment from syslog):</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cat centos65-puppetmaster.json | grep -i guest_os_type
</span><span class='line'>    <span class="s2">&quot;guest_os_type&quot;</span>: <span class="s2">&quot;centos-65&quot;</span>,
</span></code></pre></td></tr></table></div></figure>


<p>However, if I query an already built <code>*.vmx</code> this is incorrect:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>cat master2.vmx | grep -i guestos
</span><span class='line'>   <span class="nv">guestos</span> <span class="o">=</span> <span class="s2">&quot;redhat&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>After changing the k,v in the json template and running <code>packer build</code> the vmrun command ran successfully.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-05-29T12:19:53-07:00" pubdate data-updated="true">May 29<span>th</span>, 2014</time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/05/16/r10k-control-repos.markdown/">
		
			R10k: Control Repos</a>
	</h2>
	<div class="entry-content">
		This document explains the architecture and deployment of a control repository for syncing multiple puppet environments, their associated puppet code (modules) and their assocaited data (hiera). This document does not review how to deploy r10k, however that is discussed in relevant detail [here](https://github.com/puppetlabs/prosvcs-malnick/blob/master/README.md#deploy-git-r10k-and-stuff).

##What is a control repo?

A control repository stores a Puppetfile and hiera data (hiera.yaml and hieradata/).

###What does it contain?

	hieradata/
	Puppetfile

It is also common to have a &#8220;`hiera.yaml&#8220;` in the control repo. However [for many reasons](http://www.jeffmalnick.com/blog/2014/05/15/hiera-and-r10k/) I don&#8217;t believe this is a good idea. It can lead to confusing issues with branching of the file that is only consulted once for it&#8217;s &#8220;`$datadir&#8220;` path and is not used on a per environment basis - it&#8217;s loaded once from &#8220;`$confdir&#8220;` during the *hiera()* call and is not consulted on a per environment basis (e.g. &#8220;`$confdir/environments/$environments/hiera.yaml&#8220;` **is not used** during the *hiera()* lookup, only &#8220;`$confdir/hiera.yaml&#8220;` is used). 
##How does it work?

The control repo is placed in a monolithic git repository. 

The repository can have one or more topic branches that are used by r10k to sync to local Puppet environments. 

###Configuration for Puppet code & Hiera data sync via r10k

Details on how to deploy a gitlab repo and assocaited topic branching for r10k sync are [here](https://github.com/puppetlabs/prosvcs-malnick/blob/master/README.md#deploy-git-r10k-and-stuff). 

Place a Puppetfile in &#8220;`$confdir/Puppetfile&#8220;`.

Populate your Puppetfile with what ever crap you need. 

In &#8220;`$confdir&#8220;`:

&#8220;`bash
git init
git remote add origin git@whatever.com:your_name/control_repo.git
git branch -m master production
git add Puppetfile
git add hiera.yaml[root@master puppet] r10k really doesn&#8217;t need this but we&#8217;ll add it anyways. 
git add hieradata/
git push -u origin production:production[root@master puppet] or whatever branch, maybe production?
&#8220;`

###Configure hiera.yaml for dynamic environments

**NOTE**: the hiera.yaml is only loaded from &#8220;`$confdir/hiera.yaml&#8220;` on each puppet run, this means even though you&#8217;ll have a hiera.yaml in &#8220;`$confdir/environments/$environment/&#8220;` those are not actually consulted, only the $confdir hiera.yaml is used - therefore, ***you can not have hierarchies per environment***. Since the &#8220;`$datadir&#8220;` is environment aware that namespace is filled at run time, and consults the specific environment datadir &#8220;`$confdir/environments/$environment/hieradata/&#8220;`. 

Your hiera.yaml needs to have a &#8220;`datadir&#8220;` configured for dynamic lookup so:

&#8220;`yaml
&#8212;
:backends:
  - yaml
:hierarchy:
  - &#8220;%{clientcert}&#8221;
  - &#8220;%{environment}&#8221;
  - global

:yaml:
  :datadir: &#8216;/etc/puppetlabs/puppet/environments/%{::environment}/hieradata&#8217;
&#8220;`

###Branching your Puppetfile
For example, assuming you already have a master or production branch:

&#8220;`bash
vi Puppetfile
&#8220;`
&#8230;add some git modules etc&#8230;

&#8220;`bash
git checkout -b development
git push origin development:development
git commit -am Puppetfile
r10k deploy environment -pv
&#8220;`
Now you have a new topic branch &#8216;development&#8217; and a new Puppet environment in &#8220;`$confdir/environments/development&#8220;`.

###Branching your hiera data

Our &#8220;`development&#8220;` branch needs it&#8217;s own data too:

&#8220;`bash
cd $confdir/hieradata
&#8220;`

* modify K,V&#8217;s in &#8220;`whatever.yaml&#8220;`
* modify other K,V&#8217;s as needed for your development environment


&#8220;`bash
git branch[root@master puppet] check your branch, make sure it&#8217;s still development
git commit -am hieradata
git push 
r10k deploy environment -pv
&#8220;`

Check &#8220;`$confdir/environments/development/hieradata&#8220;`

##Testing
###Configuration files for r10k, hiera, puppet:

####/etc/r10k.yaml
&#8220;`bash
root@master hieradata]# cat /etc/r10k.yaml
:cachedir: /var/cache/r10k
:sources:
  puppet:
    remote: &#8220;git@10.10.100.111:user/control_repo.git&#8221;
    basedir: /etc/puppetlabs/puppet/environments
    prefix: false
:purgedirs:
  - &#8220;&#8221;
&#8220;`
####/etc/puppetlabs/puppet/puppet.conf
&#8220;`bash
[root@master hieradata] cat /etc/puppetlabs/puppet/puppet.conf
[main]
certname = master.puppetlabs.vm
dns_alt_names = master.puppetlabs.vm,puppet
vardir = /var/opt/lib/pe-puppet
logdir = /var/log/pe-puppet
rundir = /var/run/pe-puppet
modulepath = /etc/puppetlabs/puppet/environments/$environment/modules:/opt/puppet/share/puppet/modules
server = master.puppetlabs.vm
user  = pe-puppet
group = pe-puppet
archive_files = true
archive_file_server = master.puppetlabs.vm
# cut [master] & [agent] sections, $modulepath above is the important config key here.
&#8220;`
####/etc/puppetlabs/puppet/hiera.yaml
&#8220;`bash
[root@master puppet] cat hiera.yaml
&#8212;
:backends:
  - yaml
:hierarchy:
  - &#8220;%{clientcert}&#8221;
  - &#8220;%{environment}&#8221;
  - global
:yaml:
  :datadir: &#8216;/etc/puppetlabs/puppet/environmets/%{environment}/hieradata&#8217;
&#8220;`
####/etc/puppetlabs/puppet/Puppetfile
&#8220;`bash
[root@master puppet]# cat Puppetfile
# mod, <module name>, <version or tag>, <source>
forge &#8220;http://forge.puppetlabs.com&#8221;

# Modules from the Puppet Forge
mod &#8220;puppetlabs/stdlib&#8221;
mod &#8220;puppetlabs/apache&#8221;, &#8220;0.11.0&#8221;
mod &#8220;puppetlabs/pe_gem&#8221;
mod &#8220;puppetlabs/mysql&#8221;
mod &#8220;puppetlabs/firewall&#8221;
mod &#8220;puppetlabs/vcsrepo&#8221;
mod &#8220;puppetlabs/git&#8221;
mod &#8220;puppetlabs/inifile&#8221;
mod &#8220;zack/r10k&#8221;
mod &#8220;gentoo/portage&#8221;
mod &#8220;thias/vsftpd&#8221;


# Modules from Github using various references
mod &#8220;wordpress&#8221;,
  :git => &#8220;git://github.com/hunner/puppet-wordpress.git&#8221;,
  :ref => &#8216;0.4.0&#8217;
&#8220;`
###Testing the Puppet Master &#8220;`master.puppetlabs.vm:$confdir/&#8220;`:

####Our topic branches:

&#8220;`bash
[root@master puppet] git branch
  development
* production
  staging
&#8220;`

####For the given topic branch above, production, let&#8217;s look at our hieradata in &#8220;`$confdir/hieradata&#8220;`:

&#8220;`bash
[root@master hieradata] pwd
/etc/puppetlabs/puppet/hieradata
[root@master hieradata] ls
agent1.puppetlabs.vm.yaml  agent2.puppetlabs.vm.yaml  agent3.puppetlabs.vm.yaml  master.puppetlabs.vm.yaml
&#8220;`

####and for each of these files we have the same K,V:

&#8220;`bash
[root@master hieradata] cat master.puppetlabs.vm.yaml
&#8212;
message: &#8220;%{fqdn} is running in environment %{environment}&#8221;
[root@master hieradata] cat agent1.puppetlabs.vm.yaml
&#8212;
message: &#8220;%{fqdn} is running in environment %{environment}&#8221;
&#8220;`

###Now let&#8217;s switch over to our development branch and compare:

&#8220;`bash
[root@master puppet] git checkout development
Switched to branch &#8216;development&#8217;
root@master hieradata] pwd
/etc/puppetlabs/puppet/hieradata
[root@master hieradata] ls
agent1.puppetlabs.vm.yaml  agent2.puppetlabs.vm.yaml  agent3.puppetlabs.vm.yaml  master.puppetlabs.vm.yaml
[root@master hieradata] cat agent1.puppetlabs.vm.yaml
&#8212;
message: &#8220;%{fqdn} is running in environment %{environment}&#8221;
[root@master hieradata] cat master.puppetlabs.vm.yaml
&#8212;
message: &#8220;%{fqdn} is running in environment %{environment}&#8221;
&#8220;`

Sync everything up with r10k so we can test:

&#8220;`bash
[root@master puppet] r10k deploy environment -pv
[R10K::Task::Deployment::DeployEnvironments - INFO] Loading environments from all sources
[R10K::Task::Environment::Deploy - NOTICE] Deploying environment staging
[R10K::Task::Puppetfile::Sync - INFO] Loading modules from Puppetfile into queue
[R10K::Task::Environment::Deploy - NOTICE] Deploying environment production
[R10K::Task::Puppetfile::Sync - INFO] Loading modules from Puppetfile into queue
[R10K::Task::Module::Sync - INFO] Deploying wordpress into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying vsftpd into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying portage into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying r10k into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying inifile into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying git into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying vcsrepo into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying firewall into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying mysql into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying pe_gem into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying apache into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying stdlib into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Environment::Deploy - NOTICE] Deploying environment master
[R10K::Task::Puppetfile::Sync - INFO] Loading modules from Puppetfile into queue
[R10K::Task::Environment::Deploy - NOTICE] Deploying environment development
[R10K::Task::Puppetfile::Sync - INFO] Loading modules from Puppetfile into queue
[R10K::Task::Deployment::PurgeEnvironments - INFO] Purging stale environments from /etc/puppetlabs/puppet/environments
&#8220;`


Since there is a &#8220;`%{certname}.yaml&#8220;` for the master we can do a quick check on the command line that we&#8217;re accessing the correct data:

&#8220;`bash
[root@master puppet] git checkout production
Already on &#8216;production&#8217;

[root@master puppet] puppet apply -e &#8220;notice(hiera(message))&#8221;
Notice: Scope(Class[main]): master.puppetlabs.vm is running in environment production
Notice: Compiled catalog for master.puppetlabs.vm in environment production in 0.06 seconds
Notice: Finished catalog run in 0.24 seconds
[root@master puppet]
&#8220;`

The &#8220;`$fqdn&#8220;` and &#8220;`$environment&#8220;` values were correctly filled in. **Note** that this is a poor test since my data files are essentially all the same, &#8220;`$environment&#8220;` will always match it&#8217;s environment and &#8220;`$fqdn&#8220;` will always match it&#8217;s fqdn -  we could be grabbing this value from anywhere. So Let&#8217;s try with hard coded values:

&#8220;`bash
[root@master hieradata] pwd
/etc/puppetlabs/puppet/hieradata
[root@master hieradata] git branch
  development
* production
  staging
[root@master hieradata] cat master.puppetlabs.vm.yaml
&#8212;
message: &#8220;I&#8217;m hard coding this value: environment production, master.puppetlabs.vm.yaml&#8221;
&#8220;`

Now push your new data for production branch up to gitlab

&#8220;`
[root@master puppet]# git add hieradata/
[root@master puppet]# git commit -m &#8220;hieradata hard coded&#8221;
[production 3a58e49] hieradata hard coded
 1 files changed, 1 insertions(+), 1 deletions(-)
 [root@master puppet]# git push
 Counting objects: 7, done.
 Delta compression using up to 4 threads.
 Compressing objects: 100% (4/4), done.
 Writing objects: 100% (4/4), 399 bytes, done.
 Total 4 (delta 2), reused 0 (delta 0)
 To git@10.10.100.111:user/control_repo.git
    1b240c6..3a58e49  production -> production
&#8220;`

and sync r10k

&#8220;`
[root@master puppet]# r10k deploy environment -pv
[R10K::Task::Deployment::DeployEnvironments - INFO] Loading environments from all sources
[R10K::Task::Environment::Deploy - NOTICE] Deploying environment staging
[R10K::Task::Puppetfile::Sync - INFO] Loading modules from Puppetfile into queue
[R10K::Task::Environment::Deploy - NOTICE] Deploying environment production
[R10K::Task::Puppetfile::Sync - INFO] Loading modules from Puppetfile into queue
# ommitting other output &#8230;
&#8220;`

and test for the correct hard coded K,V

&#8220;`
[root@master puppet]# puppet apply -e &#8220;notice(hiera(message))&#8221;
Notice: Scope(Class[main]): I&#8217;m hard coding this value: environment production, master.puppetlabs.vm.yaml
Notice: Compiled catalog for master.puppetlabs.vm in environment production in 0.05 seconds
Notice: Finished catalog run in 0.26 seconds
&#8220;`

YAY!

####And again on the development branch
&#8220;`bash
[root@master hieradata] pwd
/etc/puppetlabs/puppet/hieradata
[root@master hieradata] git branch
* development
  production
  staging
[root@master puppet] cat hieradata/master.puppetlabs.vm.yaml
&#8212;
message: &#8220;I&#8217;m hard coding this value: environment development, master.puppetlabs.vm.yaml&#8221;
&#8220;`

Push our new hieradata for &#8220;`development&#8220;` to gitlab:

&#8220;`bash
[root@master puppet] git add hieradata/
[root@master puppet] git commit -m &#8220;hieradata hard coded&#8221;
[development 2873db5] hieradata hard coded
 1 files changed, 1 insertions(+), 1 deletions(-)
[root@master puppet] git push
Counting objects: 7, done.
Delta compression using up to 4 threads.
Compressing objects: 100% (4/4), done.
Writing objects: 100% (4/4), 398 bytes, done.
Total 4 (delta 2), reused 0 (delta 0)
To git@10.10.100.111:user/control_repo.git
   08e249b..2873db5  development -> development
&#8220;`

andthen sync with r10k 

&#8220;`
[root@master puppet]# r10k deploy environment -pv
[R10K::Task::Deployment::DeployEnvironments - INFO] Loading environments from all sources
[R10K::Task::Environment::Deploy - NOTICE] Deploying environment staging
[R10K::Task::Puppetfile::Sync - INFO] Loading modules from Puppetfile into queue
[R10K::Task::Environment::Deploy - NOTICE] Deploying environment production
[R10K::Task::Puppetfile::Sync - INFO] Loading modules from Puppetfile into queue
# ommitted the other output&#8230;
&#8220;`

and test with the &#8220;`&#8211;environment development&#8220;` switch

&#8220;`
[root@master puppet]# puppet apply -e &#8220;notice(hiera(message))&#8221; &#8211;environment development
Notice: Scope(Class[main]): I&#8217;m hard coding this value: environment development, master.puppetlabs.vm.yaml
Notice: Compiled catalog for master.puppetlabs.vm in environment development in 0.05 seconds
Notice: Finished catalog run in 0.25 seconds
&#8220;&#8220;


We can also do a quick one time environment run with the &#8220;`&#8211;environment&#8220;` flag:









		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-05-16T12:34:33-07:00" pubdate data-updated="true">May 16<span>th</span>, 2014</time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/05/16/r10k-control-repos.markdown/">
		
			R10k: Control Repos</a>
	</h2>
	<div class="entry-content">
		This document explains the architecture and deployment of a control repository for syncing multiple puppet environments, their associated puppet code (modules) and their assocaited data (hiera). This document does not review how to deploy r10k, however that is discussed in relevant detail [here](https://github.com/puppetlabs/prosvcs-malnick/blob/master/README.md#deploy-git-r10k-and-stuff).

##What is a control repo?

A control repository stores a Puppetfile and hiera data (hiera.yaml and hieradata/).

###What does it contain?

	hieradata/
	Puppetfile

It is also common to have a &#8220;`hiera.yaml&#8220;` in the control repo. However [for many reasons](http://www.jeffmalnick.com/blog/2014/05/15/hiera-and-r10k/) I don&#8217;t believe this is a good idea. It can lead to confusing issues with branching of the file that is only consulted once for it&#8217;s &#8220;`$datadir&#8220;` path and is not used on a per environment basis - it&#8217;s loaded once from &#8220;`$confdir&#8220;` during the *hiera()* call and is not consulted on a per environment basis (e.g. &#8220;`$confdir/environments/$environments/hiera.yaml&#8220;` **is not used** during the *hiera()* lookup, only &#8220;`$confdir/hiera.yaml&#8220;` is used). 
##How does it work?

The control repo is placed in a monolithic git repository. 

The repository can have one or more topic branches that are used by r10k to sync to local Puppet environments. 

###Configuration for Puppet code & Hiera data sync via r10k

Details on how to deploy a gitlab repo and assocaited topic branching for r10k sync are [here](https://github.com/puppetlabs/prosvcs-malnick/blob/master/README.md#deploy-git-r10k-and-stuff). 

Place a Puppetfile in &#8220;`$confdir/Puppetfile&#8220;`.

Populate your Puppetfile with what ever crap you need. 

In &#8220;`$confdir&#8220;`:

&#8220;`bash
git init
git remote add origin git@whatever.com:your_name/control_repo.git
git branch -m master production
git add Puppetfile
git add hiera.yaml # r10k really doesn&#8217;t need this but we&#8217;ll add it anyways. 
git add hieradata/
git push -u origin production:production # or whatever branch, maybe production?
&#8220;`

###Configure hiera.yaml for dynamic environments

**NOTE**: the hiera.yaml is only loaded from &#8220;`$confdir/hiera.yaml&#8220;` on each puppet run, this means even though you&#8217;ll have a hiera.yaml in &#8220;`$confdir/environments/$environment/&#8220;` those are not actually consulted, only the $confdir hiera.yaml is used - therefore, ***you can not have hierarchies per environment***. Since the &#8220;`$datadir&#8220;` is environment aware that namespace is filled at run time, and consults the specific environment datadir &#8220;`$confdir/environments/$environment/hieradata/&#8220;`. 

Your hiera.yaml needs to have a &#8220;`datadir&#8220;` configured for dynamic lookup so:

&#8220;`yaml
&#8212;
:backends:
  - yaml
:hierarchy:
  - &#8220;%{clientcert}&#8221;
  - &#8220;%{environment}&#8221;
  - global

:yaml:
  :datadir: &#8216;/etc/puppetlabs/puppet/environments/%{::environment}/hieradata&#8217;
&#8220;`

###Branching your Puppetfile
For example, assuming you already have a master or production branch:

&#8220;`bash
vi Puppetfile
&#8220;`
&#8230;add some git modules etc&#8230;

&#8220;`bash
git checkout -b development
git push origin development:development
git commit -am Puppetfile
r10k deploy environment -pv
&#8220;`
Now you have a new topic branch &#8216;development&#8217; and a new Puppet environment in &#8220;`$confdir/environments/development&#8220;`.

###Branching your hiera data

Our &#8220;`development&#8220;` branch needs it&#8217;s own data too:

&#8220;`bash
cd $confdir/hieradata
&#8220;`

* modify K,V&#8217;s in &#8220;`whatever.yaml&#8220;`
* modify other K,V&#8217;s as needed for your development environment


&#8220;`bash
git branch # check your branch, make sure it&#8217;s still development
git commit -am hieradata
git push 
r10k deploy environment -pv
&#8220;`

Check &#8220;`$confdir/environments/development/hieradata&#8220;`

##Testing
###Configuration files for r10k, hiera, puppet:

####/etc/r10k.yaml
&#8220;`bash
root@master hieradata]# cat /etc/r10k.yaml
:cachedir: /var/cache/r10k
:sources:
  puppet:
    remote: &#8220;git@10.10.100.111:user/control_repo.git&#8221;
    basedir: /etc/puppetlabs/puppet/environments
    prefix: false
:purgedirs:
  - &#8220;&#8221;
&#8220;`
####/etc/puppetlabs/puppet/puppet.conf
&#8220;`bash
[root@master hieradata] cat /etc/puppetlabs/puppet/puppet.conf
[main]
certname = master.puppetlabs.vm
dns_alt_names = master.puppetlabs.vm,puppet
vardir = /var/opt/lib/pe-puppet
logdir = /var/log/pe-puppet
rundir = /var/run/pe-puppet
modulepath = /etc/puppetlabs/puppet/environments/$environment/modules:/opt/puppet/share/puppet/modules
server = master.puppetlabs.vm
user  = pe-puppet
group = pe-puppet
archive_files = true
archive_file_server = master.puppetlabs.vm
# cut [master] & [agent] sections, $modulepath above is the important config key here.
&#8220;`
####/etc/puppetlabs/puppet/hiera.yaml
&#8220;`bash
[root@master puppet] cat hiera.yaml
&#8212;
:backends:
  - yaml
:hierarchy:
  - &#8220;%{clientcert}&#8221;
  - &#8220;%{environment}&#8221;
  - global
:yaml:
  :datadir: &#8216;/etc/puppetlabs/puppet/environmets/%{environment}/hieradata&#8217;
&#8220;`
####/etc/puppetlabs/puppet/Puppetfile
&#8220;`bash
[root@master puppet]# cat Puppetfile
# mod, <module name>, <version or tag>, <source>
forge &#8220;http://forge.puppetlabs.com&#8221;

# Modules from the Puppet Forge
mod &#8220;puppetlabs/stdlib&#8221;
mod &#8220;puppetlabs/apache&#8221;, &#8220;0.11.0&#8221;
mod &#8220;puppetlabs/pe_gem&#8221;
mod &#8220;puppetlabs/mysql&#8221;
mod &#8220;puppetlabs/firewall&#8221;
mod &#8220;puppetlabs/vcsrepo&#8221;
mod &#8220;puppetlabs/git&#8221;
mod &#8220;puppetlabs/inifile&#8221;
mod &#8220;zack/r10k&#8221;
mod &#8220;gentoo/portage&#8221;
mod &#8220;thias/vsftpd&#8221;


# Modules from Github using various references
mod &#8220;wordpress&#8221;,
  :git => &#8220;git://github.com/hunner/puppet-wordpress.git&#8221;,
  :ref => &#8216;0.4.0&#8217;
&#8220;`
###Testing the Puppet Master &#8220;`master.puppetlabs.vm:$confdir/&#8220;`:

####Our topic branches:

&#8220;`bash
[root@master puppet] git branch
  development
* production
  staging
&#8220;`

####For the given topic branch above, production, let&#8217;s look at our hieradata in &#8220;`$confdir/hieradata&#8220;`:

&#8220;`bash
[root@master hieradata] pwd
/etc/puppetlabs/puppet/hieradata
[root@master hieradata] ls
agent1.puppetlabs.vm.yaml  agent2.puppetlabs.vm.yaml  agent3.puppetlabs.vm.yaml  master.puppetlabs.vm.yaml
&#8220;`

####and for each of these files we have the same K,V:

&#8220;`bash
[root@master hieradata] cat master.puppetlabs.vm.yaml
&#8212;
message: &#8220;%{fqdn} is running in environment %{environment}&#8221;
[root@master hieradata] cat agent1.puppetlabs.vm.yaml
&#8212;
message: &#8220;%{fqdn} is running in environment %{environment}&#8221;
&#8220;`

###Now let&#8217;s switch over to our development branch and compare:

&#8220;`bash
[root@master puppet] git checkout development
Switched to branch &#8216;development&#8217;
root@master hieradata] pwd
/etc/puppetlabs/puppet/hieradata
[root@master hieradata] ls
agent1.puppetlabs.vm.yaml  agent2.puppetlabs.vm.yaml  agent3.puppetlabs.vm.yaml  master.puppetlabs.vm.yaml
[root@master hieradata] cat agent1.puppetlabs.vm.yaml
&#8212;
message: &#8220;%{fqdn} is running in environment %{environment}&#8221;
[root@master hieradata] cat master.puppetlabs.vm.yaml
&#8212;
message: &#8220;%{fqdn} is running in environment %{environment}&#8221;
&#8220;`

Sync everything up with r10k so we can test:

&#8220;`bash
[root@master puppet] r10k deploy environment -pv
[R10K::Task::Deployment::DeployEnvironments - INFO] Loading environments from all sources
[R10K::Task::Environment::Deploy - NOTICE] Deploying environment staging
[R10K::Task::Puppetfile::Sync - INFO] Loading modules from Puppetfile into queue
[R10K::Task::Environment::Deploy - NOTICE] Deploying environment production
[R10K::Task::Puppetfile::Sync - INFO] Loading modules from Puppetfile into queue
[R10K::Task::Module::Sync - INFO] Deploying wordpress into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying vsftpd into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying portage into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying r10k into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying inifile into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying git into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying vcsrepo into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying firewall into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying mysql into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying pe_gem into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying apache into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Module::Sync - INFO] Deploying stdlib into /etc/puppetlabs/puppet/environments/production/modules
[R10K::Task::Environment::Deploy - NOTICE] Deploying environment master
[R10K::Task::Puppetfile::Sync - INFO] Loading modules from Puppetfile into queue
[R10K::Task::Environment::Deploy - NOTICE] Deploying environment development
[R10K::Task::Puppetfile::Sync - INFO] Loading modules from Puppetfile into queue
[R10K::Task::Deployment::PurgeEnvironments - INFO] Purging stale environments from /etc/puppetlabs/puppet/environments
&#8220;`


Since there is a &#8220;`%{certname}.yaml&#8220;` for the master we can do a quick check on the command line that we&#8217;re accessing the correct data:

&#8220;`bash
[root@master puppet] git checkout production
Already on &#8216;production&#8217;

[root@master puppet] puppet apply -e &#8220;notice(hiera(message))&#8221;
Notice: Scope(Class[main]): master.puppetlabs.vm is running in environment production
Notice: Compiled catalog for master.puppetlabs.vm in environment production in 0.06 seconds
Notice: Finished catalog run in 0.24 seconds
[root@master puppet]
&#8220;`

The &#8220;`$fqdn&#8220;` and &#8220;`$environment&#8220;` values were correctly filled in. **Note** that this is a poor test since my data files are essentially all the same, &#8220;`$environment&#8220;` will always match it&#8217;s environment and &#8220;`$fqdn&#8220;` will always match it&#8217;s fqdn -  we could be grabbing this value from anywhere. So Let&#8217;s try with hard coded values:

&#8220;`bash
[root@master hieradata] pwd
/etc/puppetlabs/puppet/hieradata
[root@master hieradata] git branch
  development
* production
  staging
[root@master hieradata] cat master.puppetlabs.vm.yaml
&#8212;
message: &#8220;I&#8217;m hard coding this value: environment production, master.puppetlabs.vm.yaml&#8221;
&#8220;`

Now push your new data for production branch up to gitlab

&#8220;`
[root@master puppet]# git add hieradata/
[root@master puppet]# git commit -m &#8220;hieradata hard coded&#8221;
[production 3a58e49] hieradata hard coded
 1 files changed, 1 insertions(+), 1 deletions(-)
 [root@master puppet]# git push
 Counting objects: 7, done.
 Delta compression using up to 4 threads.
 Compressing objects: 100% (4/4), done.
 Writing objects: 100% (4/4), 399 bytes, done.
 Total 4 (delta 2), reused 0 (delta 0)
 To git@10.10.100.111:user/control_repo.git
    1b240c6..3a58e49  production -> production
&#8220;`

and sync r10k

&#8220;`
[root@master puppet]# r10k deploy environment -pv
[R10K::Task::Deployment::DeployEnvironments - INFO] Loading environments from all sources
[R10K::Task::Environment::Deploy - NOTICE] Deploying environment staging
[R10K::Task::Puppetfile::Sync - INFO] Loading modules from Puppetfile into queue
[R10K::Task::Environment::Deploy - NOTICE] Deploying environment production
[R10K::Task::Puppetfile::Sync - INFO] Loading modules from Puppetfile into queue
# ommitting other output &#8230;
&#8220;`

and test for the correct hard coded K,V

&#8220;`
[root@master puppet]# puppet apply -e &#8220;notice(hiera(message))&#8221;
Notice: Scope(Class[main]): I&#8217;m hard coding this value: environment production, master.puppetlabs.vm.yaml
Notice: Compiled catalog for master.puppetlabs.vm in environment production in 0.05 seconds
Notice: Finished catalog run in 0.26 seconds
&#8220;`

YAY!

####And again on the development branch
&#8220;`bash
[root@master hieradata] pwd
/etc/puppetlabs/puppet/hieradata
[root@master hieradata] git branch
* development
  production
  staging
[root@master puppet] cat hieradata/master.puppetlabs.vm.yaml
&#8212;
message: &#8220;I&#8217;m hard coding this value: environment development, master.puppetlabs.vm.yaml&#8221;
&#8220;`

Push our new hieradata for &#8220;`development&#8220;` to gitlab:

&#8220;`bash
[root@master puppet] git add hieradata/
[root@master puppet] git commit -m &#8220;hieradata hard coded&#8221;
[development 2873db5] hieradata hard coded
 1 files changed, 1 insertions(+), 1 deletions(-)
[root@master puppet] git push
Counting objects: 7, done.
Delta compression using up to 4 threads.
Compressing objects: 100% (4/4), done.
Writing objects: 100% (4/4), 398 bytes, done.
Total 4 (delta 2), reused 0 (delta 0)
To git@10.10.100.111:user/control_repo.git
   08e249b..2873db5  development -> development
&#8220;`

andthen sync with r10k 

&#8220;`
[root@master puppet]# r10k deploy environment -pv
[R10K::Task::Deployment::DeployEnvironments - INFO] Loading environments from all sources
[R10K::Task::Environment::Deploy - NOTICE] Deploying environment staging
[R10K::Task::Puppetfile::Sync - INFO] Loading modules from Puppetfile into queue
[R10K::Task::Environment::Deploy - NOTICE] Deploying environment production
[R10K::Task::Puppetfile::Sync - INFO] Loading modules from Puppetfile into queue
# ommitted the other output&#8230;
&#8220;`

and test with the &#8220;`&#8211;environment development&#8220;` switch

&#8220;`
[root@master puppet]# puppet apply -e &#8220;notice(hiera(message))&#8221; &#8211;environment development
Notice: Scope(Class[main]): I&#8217;m hard coding this value: environment development, master.puppetlabs.vm.yaml
Notice: Compiled catalog for master.puppetlabs.vm in environment development in 0.05 seconds
Notice: Finished catalog run in 0.25 seconds
&#8220;&#8220;


We can also do a quick one time environment run with the &#8220;`&#8211;environment&#8220;` flag:









		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-05-16T12:34:33-07:00" pubdate data-updated="true">May 16<span>th</span>, 2014</time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/05/16/r10k-control-repos/">
		
			R10k: Control Repos</a>
	</h2>
	<div class="entry-content">
		<p>This document explains the architecture and deployment of a control repository for syncing multiple puppet environments, their associated puppet code (modules) and their assocaited data (hiera). This document does not review how to deploy r10k, however that is discussed in relevant detail <a href="https://github.com/puppetlabs/prosvcs-malnick/blob/master/README.md#deploy-git-r10k-and-stuff">here</a>.</p>

<h2>What is a control repo?</h2>

<p>A control repository stores a Puppetfile and hiera data (hiera.yaml and hieradata/).</p>

<h3>What does it contain?</h3>

<pre><code>hieradata/
Puppetfile
</code></pre>

<p>It is also common to have a <code>hiera.yaml</code> in the control repo. However <a href="http://www.jeffmalnick.com/blog/2014/05/15/hiera-and-r10k/">for many reasons</a> I don&rsquo;t believe this is a good idea. It can lead to confusing issues with branching of the file that is only consulted once for it&rsquo;s <code>$datadir</code> path and is not used on a per environment basis &ndash; it&rsquo;s loaded once from <code>$confdir</code> during the <em>hiera()</em> call and is not consulted on a per environment basis (e.g. <code>$confdir/environments/$environments/hiera.yaml</code> <strong>is not used</strong> during the <em>hiera()</em> lookup, only <code>$confdir/hiera.yaml</code> is used).</p>

<h2>How does it work?</h2>

<p>The control repo is placed in a monolithic git repository.</p>

<p>The repository can have one or more topic branches that are used by r10k to sync to local Puppet environments.</p>

<h3>Configuration for Puppet code &amp; Hiera data sync via r10k</h3>

<p>Details on how to deploy a gitlab repo and assocaited topic branching for r10k sync are <a href="https://github.com/puppetlabs/prosvcs-malnick/blob/master/README.md#deploy-git-r10k-and-stuff">here</a>.</p>

<p>Place a Puppetfile in <code>$confdir/Puppetfile</code>.</p>

<p>Populate your Puppetfile with what ever crap you need.</p>

<p>In <code>$confdir</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git init
</span><span class='line'>git remote add origin git@whatever.com:your_name/control_repo.git
</span><span class='line'>git branch -m master production
</span><span class='line'>git add Puppetfile
</span><span class='line'>git add hiera.yaml <span class="c"># r10k really doesn&#39;t need this but we&#39;ll add it anyways. </span>
</span><span class='line'>git add hieradata/
</span><span class='line'>git push -u origin production:production <span class="c"># or whatever branch, maybe production?</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Configure hiera.yaml for dynamic environments</h3>

<p><strong>NOTE</strong>: the hiera.yaml is only loaded from <code>$confdir/hiera.yaml</code> on each puppet run, this means even though you&rsquo;ll have a hiera.yaml in <code>$confdir/environments/$environment/</code> those are not actually consulted, only the $confdir hiera.yaml is used &ndash; therefore, <strong><em>you can not have hierarchies per environment</em></strong>. Since the <code>$datadir</code> is environment aware that namespace is filled at run time, and consults the specific environment datadir <code>$confdir/environments/$environment/hieradata/</code>.</p>

<p>Your hiera.yaml needs to have a <code>datadir</code> configured for dynamic lookup so:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="nn">---</span>
</span><span class='line'><span class="l-Scalar-Plain">:backends</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">yaml</span>
</span><span class='line'><span class="l-Scalar-Plain">:hierarchy</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="s">&quot;%{clientcert}&quot;</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="s">&quot;%{environment}&quot;</span>
</span><span class='line'>  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">global</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">:yaml</span><span class="p-Indicator">:</span>
</span><span class='line'>  <span class="l-Scalar-Plain">:datadir</span><span class="p-Indicator">:</span> <span class="s">&#39;/etc/puppetlabs/puppet/environments/%{::environment}/hieradata&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Branching your Puppetfile</h3>

<p>For example, assuming you already have a master or production branch:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>vi Puppetfile
</span></code></pre></td></tr></table></div></figure>


<p>&hellip;add some git modules etc&hellip;</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git checkout -b development
</span><span class='line'>git push origin development:development
</span><span class='line'>git commit -am Puppetfile
</span><span class='line'>r10k deploy environment -pv
</span></code></pre></td></tr></table></div></figure>


<p>Now you have a new topic branch &lsquo;development&rsquo; and a new Puppet environment in <code>$confdir/environments/development</code>.</p>

<h3>Branching your hiera data</h3>

<p>Our <code>development</code> branch needs it&rsquo;s own data too:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="nb">cd</span> <span class="nv">$confdir</span>/hieradata
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>modify K,V&rsquo;s in <code>whatever.yaml</code></li>
<li>modify other K,V&rsquo;s as needed for your development environment</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>git branch <span class="c"># check your branch, make sure it&#39;s still development</span>
</span><span class='line'>git commit -am hieradata
</span><span class='line'>git push
</span><span class='line'>r10k deploy environment -pv
</span></code></pre></td></tr></table></div></figure>


<p>Check <code>$confdir/environments/development/hieradata</code></p>

<h2>Testing</h2>

<h3>Configuration files for r10k, hiera, puppet:</h3>

<h4>/etc/r10k.yaml</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>root@master hieradata<span class="o">]</span><span class="c"># cat /etc/r10k.yaml</span>
</span><span class='line'>:cachedir: /var/cache/r10k
</span><span class='line'>:sources:
</span><span class='line'>  puppet:
</span><span class='line'>    remote: <span class="s2">&quot;git@10.10.100.111:user/control_repo.git&quot;</span>
</span><span class='line'>    basedir: /etc/puppetlabs/puppet/environments
</span><span class='line'>    prefix: <span class="nb">false</span>
</span><span class='line'>:purgedirs:
</span><span class='line'>  - <span class="s2">&quot;&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h4>/etc/puppetlabs/puppet/puppet.conf</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> cat /etc/puppetlabs/puppet/puppet.conf
</span><span class='line'><span class="o">[</span>main<span class="o">]</span>
</span><span class='line'><span class="nv">certname</span> <span class="o">=</span> master.puppetlabs.vm
</span><span class='line'><span class="nv">dns_alt_names</span> <span class="o">=</span> master.puppetlabs.vm,puppet
</span><span class='line'><span class="nv">vardir</span> <span class="o">=</span> /var/opt/lib/pe-puppet
</span><span class='line'><span class="nv">logdir</span> <span class="o">=</span> /var/log/pe-puppet
</span><span class='line'><span class="nv">rundir</span> <span class="o">=</span> /var/run/pe-puppet
</span><span class='line'><span class="nv">modulepath</span> <span class="o">=</span> /etc/puppetlabs/puppet/environments/<span class="nv">$environment</span>/modules:/opt/puppet/share/puppet/modules
</span><span class='line'><span class="nv">server</span> <span class="o">=</span> master.puppetlabs.vm
</span><span class='line'><span class="nv">user</span>  <span class="o">=</span> pe-puppet
</span><span class='line'><span class="nv">group</span> <span class="o">=</span> pe-puppet
</span><span class='line'><span class="nv">archive_files</span> <span class="o">=</span> <span class="nb">true</span>
</span><span class='line'><span class="nv">archive_file_server</span> <span class="o">=</span> master.puppetlabs.vm
</span><span class='line'><span class="c"># cut [master] &amp; [agent] sections, $modulepath above is the important config key here.</span>
</span></code></pre></td></tr></table></div></figure>


<h4>/etc/puppetlabs/puppet/hiera.yaml</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> cat hiera.yaml
</span><span class='line'>---
</span><span class='line'>:backends:
</span><span class='line'>  - yaml
</span><span class='line'>:hierarchy:
</span><span class='line'>  - <span class="s2">&quot;%{clientcert}&quot;</span>
</span><span class='line'>  - <span class="s2">&quot;%{environment}&quot;</span>
</span><span class='line'>  - global
</span><span class='line'>:yaml:
</span><span class='line'>  :datadir: <span class="s1">&#39;/etc/puppetlabs/puppet/environmets/%{environment}/hieradata&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h4>/etc/puppetlabs/puppet/Puppetfile</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span><span class="c"># cat Puppetfile</span>
</span><span class='line'><span class="c"># mod, &lt;module name&gt;, &lt;version or tag&gt;, &lt;source&gt;</span>
</span><span class='line'>forge <span class="s2">&quot;http://forge.puppetlabs.com&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Modules from the Puppet Forge</span>
</span><span class='line'>mod <span class="s2">&quot;puppetlabs/stdlib&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;puppetlabs/apache&quot;</span>, <span class="s2">&quot;0.11.0&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;puppetlabs/pe_gem&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;puppetlabs/mysql&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;puppetlabs/firewall&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;puppetlabs/vcsrepo&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;puppetlabs/git&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;puppetlabs/inifile&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;zack/r10k&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;gentoo/portage&quot;</span>
</span><span class='line'>mod <span class="s2">&quot;thias/vsftpd&quot;</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c"># Modules from Github using various references</span>
</span><span class='line'>mod <span class="s2">&quot;wordpress&quot;</span>,
</span><span class='line'>  :git <span class="o">=</span>&gt; <span class="s2">&quot;git://github.com/hunner/puppet-wordpress.git&quot;</span>,
</span><span class='line'>  :ref <span class="o">=</span>&gt; <span class="s1">&#39;0.4.0&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Testing the Puppet Master <code>master.puppetlabs.vm:$confdir/</code>:</h3>

<h4>Our topic branches:</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> git branch
</span><span class='line'>  development
</span><span class='line'>* production
</span><span class='line'>  staging
</span></code></pre></td></tr></table></div></figure>


<h4>For the given topic branch above, production, let&rsquo;s look at our hieradata in <code>$confdir/hieradata</code>:</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> <span class="nb">pwd</span>
</span><span class='line'>/etc/puppetlabs/puppet/hieradata
</span><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> ls
</span><span class='line'>agent1.puppetlabs.vm.yaml  agent2.puppetlabs.vm.yaml  agent3.puppetlabs.vm.yaml  master.puppetlabs.vm.yaml
</span></code></pre></td></tr></table></div></figure>


<h4>and for each of these files we have the same K,V:</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> cat master.puppetlabs.vm.yaml
</span><span class='line'>---
</span><span class='line'>message: <span class="s2">&quot;%{fqdn} is running in environment %{environment}&quot;</span>
</span><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> cat agent1.puppetlabs.vm.yaml
</span><span class='line'>---
</span><span class='line'>message: <span class="s2">&quot;%{fqdn} is running in environment %{environment}&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Now let&rsquo;s switch over to our development branch and compare:</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> git checkout development
</span><span class='line'>Switched to branch <span class="s1">&#39;development&#39;</span>
</span><span class='line'>root@master hieradata<span class="o">]</span> <span class="nb">pwd</span>
</span><span class='line'>/etc/puppetlabs/puppet/hieradata
</span><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> ls
</span><span class='line'>agent1.puppetlabs.vm.yaml  agent2.puppetlabs.vm.yaml  agent3.puppetlabs.vm.yaml  master.puppetlabs.vm.yaml
</span><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> cat agent1.puppetlabs.vm.yaml
</span><span class='line'>---
</span><span class='line'>message: <span class="s2">&quot;%{fqdn} is running in environment %{environment}&quot;</span>
</span><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> cat master.puppetlabs.vm.yaml
</span><span class='line'>---
</span><span class='line'>message: <span class="s2">&quot;%{fqdn} is running in environment %{environment}&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Sync everything up with r10k so we can test:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> r10k deploy environment -pv
</span><span class='line'><span class="o">[</span>R10K::Task::Deployment::DeployEnvironments - INFO<span class="o">]</span> Loading environments from all sources
</span><span class='line'><span class="o">[</span>R10K::Task::Environment::Deploy - NOTICE<span class="o">]</span> Deploying environment staging
</span><span class='line'><span class="o">[</span>R10K::Task::Puppetfile::Sync - INFO<span class="o">]</span> Loading modules from Puppetfile into queue
</span><span class='line'><span class="o">[</span>R10K::Task::Environment::Deploy - NOTICE<span class="o">]</span> Deploying environment production
</span><span class='line'><span class="o">[</span>R10K::Task::Puppetfile::Sync - INFO<span class="o">]</span> Loading modules from Puppetfile into queue
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying wordpress into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying vsftpd into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying portage into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying r10k into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying inifile into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying git into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying vcsrepo into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying firewall into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying mysql into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying pe_gem into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying apache into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Module::Sync - INFO<span class="o">]</span> Deploying stdlib into /etc/puppetlabs/puppet/environments/production/modules
</span><span class='line'><span class="o">[</span>R10K::Task::Environment::Deploy - NOTICE<span class="o">]</span> Deploying environment master
</span><span class='line'><span class="o">[</span>R10K::Task::Puppetfile::Sync - INFO<span class="o">]</span> Loading modules from Puppetfile into queue
</span><span class='line'><span class="o">[</span>R10K::Task::Environment::Deploy - NOTICE<span class="o">]</span> Deploying environment development
</span><span class='line'><span class="o">[</span>R10K::Task::Puppetfile::Sync - INFO<span class="o">]</span> Loading modules from Puppetfile into queue
</span><span class='line'><span class="o">[</span>R10K::Task::Deployment::PurgeEnvironments - INFO<span class="o">]</span> Purging stale environments from /etc/puppetlabs/puppet/environments
</span></code></pre></td></tr></table></div></figure>


<p>Since there is a <code>%{certname}.yaml</code> for the master we can do a quick check on the command line that we&rsquo;re accessing the correct data:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> git checkout production
</span><span class='line'>Already on <span class="s1">&#39;production&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> puppet apply -e <span class="s2">&quot;notice(hiera(message))&quot;</span>
</span><span class='line'>Notice: Scope<span class="o">(</span>Class<span class="o">[</span>main<span class="o">])</span>: master.puppetlabs.vm is running in environment production
</span><span class='line'>Notice: Compiled catalog <span class="k">for </span>master.puppetlabs.vm in environment production in 0.06 seconds
</span><span class='line'>Notice: Finished catalog run in 0.24 seconds
</span><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>$fqdn</code> and <code>$environment</code> values were correctly filled in. <strong>Note</strong> that this is a poor test since my data files are essentially all the same, <code>$environment</code> will always match it&rsquo;s environment and <code>$fqdn</code> will always match it&rsquo;s fqdn &ndash;  we could be grabbing this value from anywhere. So Let&rsquo;s try with hard coded values:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> <span class="nb">pwd</span>
</span><span class='line'>/etc/puppetlabs/puppet/hieradata
</span><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> git branch
</span><span class='line'>  development
</span><span class='line'>* production
</span><span class='line'>  staging
</span><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> cat master.puppetlabs.vm.yaml
</span><span class='line'>---
</span><span class='line'>message: <span class="s2">&quot;I&#39;m hard coding this value: environment production, master.puppetlabs.vm.yaml&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now push your new data for production branch up to gitlab</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span><span class="c"># git add hieradata/</span>
</span><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span><span class="c"># git commit -m &quot;hieradata hard coded&quot;</span>
</span><span class='line'><span class="o">[</span>production 3a58e49<span class="o">]</span> hieradata hard coded
</span><span class='line'> 1 files changed, 1 insertions<span class="o">(</span>+<span class="o">)</span>, 1 deletions<span class="o">(</span>-<span class="o">)</span>
</span><span class='line'> <span class="o">[</span>root@master puppet<span class="o">]</span><span class="c"># git push</span>
</span><span class='line'> Counting objects: 7, <span class="k">done</span>.
</span><span class='line'> Delta compression using up to 4 threads.
</span><span class='line'> Compressing objects: 100% <span class="o">(</span>4/4<span class="o">)</span>, <span class="k">done</span>.
</span><span class='line'> Writing objects: 100% <span class="o">(</span>4/4<span class="o">)</span>, 399 bytes, <span class="k">done</span>.
</span><span class='line'> Total 4 <span class="o">(</span>delta 2<span class="o">)</span>, reused 0 <span class="o">(</span>delta 0<span class="o">)</span>
</span><span class='line'> To git@10.10.100.111:user/control_repo.git
</span><span class='line'>    1b240c6..3a58e49  production -&gt; production
</span></code></pre></td></tr></table></div></figure>


<p>and sync r10k</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span><span class="c"># r10k deploy environment -pv</span>
</span><span class='line'><span class="o">[</span>R10K::Task::Deployment::DeployEnvironments - INFO<span class="o">]</span> Loading environments from all sources
</span><span class='line'><span class="o">[</span>R10K::Task::Environment::Deploy - NOTICE<span class="o">]</span> Deploying environment staging
</span><span class='line'><span class="o">[</span>R10K::Task::Puppetfile::Sync - INFO<span class="o">]</span> Loading modules from Puppetfile into queue
</span><span class='line'><span class="o">[</span>R10K::Task::Environment::Deploy - NOTICE<span class="o">]</span> Deploying environment production
</span><span class='line'><span class="o">[</span>R10K::Task::Puppetfile::Sync - INFO<span class="o">]</span> Loading modules from Puppetfile into queue
</span><span class='line'><span class="c"># ommitting other output ...</span>
</span></code></pre></td></tr></table></div></figure>


<p>and test for the correct hard coded K,V</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span><span class="c"># puppet apply -e &quot;notice(hiera(message))&quot;</span>
</span><span class='line'>Notice: Scope<span class="o">(</span>Class<span class="o">[</span>main<span class="o">])</span>: I<span class="err">&#39;</span>m hard coding this value: environment production, master.puppetlabs.vm.yaml
</span><span class='line'>Notice: Compiled catalog <span class="k">for </span>master.puppetlabs.vm in environment production in 0.05 seconds
</span><span class='line'>Notice: Finished catalog run in 0.26 seconds
</span></code></pre></td></tr></table></div></figure>


<p>YAY!</p>

<h4>And again on the development branch</h4>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> <span class="nb">pwd</span>
</span><span class='line'>/etc/puppetlabs/puppet/hieradata
</span><span class='line'><span class="o">[</span>root@master hieradata<span class="o">]</span> git branch
</span><span class='line'>* development
</span><span class='line'>  production
</span><span class='line'>  staging
</span><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> cat hieradata/master.puppetlabs.vm.yaml
</span><span class='line'>---
</span><span class='line'>message: <span class="s2">&quot;I&#39;m hard coding this value: environment development, master.puppetlabs.vm.yaml&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Push our new hieradata for <code>development</code> to gitlab:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> git add hieradata/
</span><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> git commit -m <span class="s2">&quot;hieradata hard coded&quot;</span>
</span><span class='line'><span class="o">[</span>development 2873db5<span class="o">]</span> hieradata hard coded
</span><span class='line'> 1 files changed, 1 insertions<span class="o">(</span>+<span class="o">)</span>, 1 deletions<span class="o">(</span>-<span class="o">)</span>
</span><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span> git push
</span><span class='line'>Counting objects: 7, <span class="k">done</span>.
</span><span class='line'>Delta compression using up to 4 threads.
</span><span class='line'>Compressing objects: 100% <span class="o">(</span>4/4<span class="o">)</span>, <span class="k">done</span>.
</span><span class='line'>Writing objects: 100% <span class="o">(</span>4/4<span class="o">)</span>, 398 bytes, <span class="k">done</span>.
</span><span class='line'>Total 4 <span class="o">(</span>delta 2<span class="o">)</span>, reused 0 <span class="o">(</span>delta 0<span class="o">)</span>
</span><span class='line'>To git@10.10.100.111:user/control_repo.git
</span><span class='line'>   08e249b..2873db5  development -&gt; development
</span></code></pre></td></tr></table></div></figure>


<p>andthen sync with r10k</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span><span class="c"># r10k deploy environment -pv</span>
</span><span class='line'><span class="o">[</span>R10K::Task::Deployment::DeployEnvironments - INFO<span class="o">]</span> Loading environments from all sources
</span><span class='line'><span class="o">[</span>R10K::Task::Environment::Deploy - NOTICE<span class="o">]</span> Deploying environment staging
</span><span class='line'><span class="o">[</span>R10K::Task::Puppetfile::Sync - INFO<span class="o">]</span> Loading modules from Puppetfile into queue
</span><span class='line'><span class="o">[</span>R10K::Task::Environment::Deploy - NOTICE<span class="o">]</span> Deploying environment production
</span><span class='line'><span class="o">[</span>R10K::Task::Puppetfile::Sync - INFO<span class="o">]</span> Loading modules from Puppetfile into queue
</span><span class='line'><span class="c"># ommitted the other output...</span>
</span></code></pre></td></tr></table></div></figure>


<p>and test with the <code>--environment development</code> switch</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@master puppet<span class="o">]</span><span class="c"># puppet apply -e &quot;notice(hiera(message))&quot; --environment development</span>
</span><span class='line'>Notice: Scope<span class="o">(</span>Class<span class="o">[</span>main<span class="o">])</span>: I<span class="err">&#39;</span>m hard coding this value: environment development, master.puppetlabs.vm.yaml
</span><span class='line'>Notice: Compiled catalog <span class="k">for </span>master.puppetlabs.vm in environment development in 0.05 seconds
</span><span class='line'>Notice: Finished catalog run in 0.25 seconds
</span></code></pre></td></tr></table></div></figure>


<p>`</p>

<p>We can also do a quick one time environment run with the <code>--environment</code> flag:</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-05-16T12:34:33-07:00" pubdate data-updated="true">May 16<span>th</span>, 2014</time></div>
	


	
</div></article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/05/15/hiera-and-r10k/">
		
			Why I Don&#8217;t Place a hiera.yaml in My CR</a>
	</h2>
	<div class="entry-content">
		<p>Here&rsquo;s a really good reason. First off, unless your hiera.yaml is super complicated, then it probably doesn&rsquo;t need to be in version control. However, for a lot of deployments you need it in VC, but not in your control repo (i.e., the one that r10k will access for Puppetfile, hieradata and build our corrosponding enviros for on your master).</p>

<p>No, place that hiera.yaml in it&rsquo;s own VC repo.</p>

<p>I had a control repo with:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Puppetfile
</span><span class='line'>hieradata/
</span><span class='line'>hiera.yaml</span></code></pre></td></tr></table></div></figure>


<p>and I kept running in to this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@master hieradata]# puppet apply -e "notice(hiera(message))"
</span><span class='line'>Error: Could not find data item message in any Hiera data file and no default supplied at line 1 on node master.puppetlabs.vm</span></code></pre></td></tr></table></div></figure>


<p>This was a very simple test to see if my <code>production</code> environment was grabbing the correct data via a message K,V in <code>$confdir/environments/production/hieradata/master.puppetlabs.vm.yaml</code> .</p>

<p>Check out the &mdash;debug</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>Debug: hiera(): Hiera YAML backend starting
</span><span class='line'>Debug: hiera(): Looking up message in YAML backend
</span><span class='line'>Debug: hiera(): Looking for data source master.puppetlabs.vm
</span><span class='line'>Debug: hiera(): Cannot find datafile /etc/puppetlabs/puppet/environmets/production/hieradata/master.puppetlabs.vm.yaml, skipping
</span><span class='line'>Debug: hiera(): Looking for data source production
</span><span class='line'>Debug: hiera(): Cannot find datafile /etc/puppetlabs/puppet/environmets/production/hieradata/production.yaml, skipping
</span><span class='line'>Debug: hiera(): Looking for data source global
</span><span class='line'>Debug: hiera(): Cannot find datafile /etc/puppetlabs/puppet/environmets/production/hieradata/global.yaml, skipping</span></code></pre></td></tr></table></div></figure>


<p>So I copied the <code>datafile</code> path and redirected it to a diff along with a &#8220;`$(pwd) while in the /etc/puppetlabs/puppet/environments/production/hieradata directory:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@master hieradata]# diff &lt;(echo "/etc/puppetlabs/puppet/environmets/production/hieradata/") &lt;(echo "$(pwd)")
</span><span class='line'>1c1
</span><span class='line'>&lt; /etc/puppetlabs/puppet/environmets/production/hieradata/
</span><span class='line'>---
</span><span class='line'>&gt; /etc/puppetlabs/puppet/environments/production/hieradata</span></code></pre></td></tr></table></div></figure>


<p>So the <code>$datadir</code> path in hiera.yaml</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>[root@master puppet]# cat hiera.yaml | grep datadir
</span><span class='line'>  :datadir: '/etc/puppetlabs/puppet/environmets/%{environment}/hieradata'</span></code></pre></td></tr></table></div></figure>


<p>is indeed missing that f-ing &lsquo;n&rsquo;. Why? Because this was the second time this happened to me today.</p>

<p>Really? The second time? Really. The second fucking time.</p>

<p>I previously committed hiera.yaml along with hieradata/ and my Puppetfile to branch production. I tested it and came across this problem. Did the same test to figure out the correct path and updated hiera.yaml.</p>

<p>However, hiera.yaml was also in my development and staging branches. I didn&rsquo;t update those. So here I was again doing tests on development data for Puppet and <strong>boom</strong> my shit&rsquo;s broken again.</p>

<p>Since hiera.yaml is only used singularly on a puppet run, i.e., it&rsquo;s not consulted on a per environment basis, you only need one copy of it, and that&rsquo;s the one in your puppet $confdir. Having it scattered to the winds with r10k in the control repo does not give you any extra functionality (yet, someday we might make it enviro aware, but currently is not the case).</p>

<p>So if you&rsquo;re going to run your hiera.yaml into a VCS then do it in it&rsquo;s own monolithic repo. You can symlink it into the $confdir for Puppet.</p>

		
		
	</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-05-15T16:12:36-07:00" pubdate data-updated="true">May 15<span>th</span>, 2014</time></div>
	


	
</div></article>

<nav id="pagenavi">
    
        <a href="/" class="prev">Prev</a>
    
    
        <a href="/blog/page/3/" class="next">Next</a>
    
    <div class="center"><a href="/archives">Blog Archives</a></div>
</nav></div>
	<footer id="footer" class="inner">Copyright &copy; 2015

    Jeff

<br>
Powered by Octopress.
</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






</body>
</html>
