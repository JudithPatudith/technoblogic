
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Using Golang for More Performant DevOps Tasks - What we observe is not nature itself, but nature exposed to our method of questioning</title>
  <meta name="author" content="Jeff">

  
  <meta name="description" content="Using Golang for More Performant DevOps Tasks written Part 1 if 2 This is a two part post on leveraging golang for more performant DevOps tasks. In &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="httpL://www.jeffmalnick.com/blog/2015/07/31/using-golang-for-more-performant-devops-tasks">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="What we observe is not nature itself, but nature exposed to our method of questioning" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  

</head>

  <body>
    <a href="/" class="home-icon">
      <img src="/images/home.png"/>
    </a>

    <article role="article" class="full-single-article">
  <div class="container">
    <div class="row">
      <div class="col-md-8 col-md-offset-2">
        <h1>Using Golang for More Performant DevOps Tasks</h1>
        <div class="meta">
          written 








  



<time datetime="2015-07-31T06:05:55-07:00" pubdate data-updated="true"></time>
          


        </div>
        <h1>Part 1 if 2</h1>

<p>This is a two part post on leveraging golang for more performant DevOps tasks. In this post, I&rsquo;ll go over the benefits of GoLang and dive into the re-writing of an application we use to track versions of all our running services, focusing on building a REST interface to available services in haproxy.cfg. In the second post I&rsquo;ll move into re-writing the tool that leverages that REST interface to give us visibility into the versions of running services in our infrastructure - a very important tool in a microservices architecture.</p>

<h2>The Why</h2>

<p>A major component of the DevOps workflow is building more visibility into the daily operations of a deployment. In my career I&rsquo;ve typically build my tools in Ruby. Sinatra webhooks were a mainstay of almost all my applications. It&rsquo;s simple to read, easy to implement language that is as useful on the command line as it is building full fledged web applications.</p>

<p>What Ruby is not, however, is lightweight and fast. Often times, it&rsquo;s also easy to get bitten by developing on OSx and deploying into a linux environment is not of the same Ruby version you built on. Ruby is also an interpreted language (queue comments about how it&rsquo;s not <em>just</em> an interpreted language).</p>

<h2>GoLang</h2>

<p>Go is a compiled language. And when I say it&rsquo;s compiled, I mean the GC compiler (well there are a few compilers, but GC is the main one), I mean it compiles directly to assembly. No need to have an exact Go version match on a given machine for deployment. Also, packages tend to be <strong>far</strong> smaller than interpreted versions.</p>

<p>Go is strict about importing libraries. If the library is imported and unused, it&rsquo;ll blow up. Initially this felt like a burden (but I want <strong><em>all</em></strong> the libraries!! What if&hellip;), but in the end it makes up for some very efficient compile times and less bloat.</p>

<h2>An Example</h2>

<p>I wrote a program not to long ago called <a href="https://github.com/malnick/versionctl">VersionCtl</a>. VersionCtl queried the CSV endpoint on our internal HaProxies, which had only services currently running which were provisioned by Puppet. The server name attribute was <code>$::role-$dashed_ip_address</code>. By parsing the IP address in the server name I could build up a list of currently available services, and query them for the running version on the available (internally) management port.</p>

<p>I then compared the versions currently running to those that were defined in a hiera data file called versions.yaml. Versions.yaml is managed by a webhook on our Puppet Master that receives a POST from Jenkins every time a new service is build (per environment). The webhook writes the new version of a service to this file, and implements MCO to kick off a run on all boxes matching a <code>$::role</code> fact.</p>

<p>Sometimes, CI would break: we would deploy a service and the running version was not the version we just deployed. VersionCtl compares the versions in hiera to the currently running versions (the versions.yaml is exposed via another REST endpoint on the Puppet Master). If the versions don&rsquo;t match, the server line goes red; if they match, everything is green.</p>

<p>What this looked like when everything was OK:</p>

<p>&lt;&lt;<Image>>></p>

<p>And when things broke:</p>

<p>&lt;&lt;<Image>>></p>

<h2>But, Problems&hellip;</h2>

<p>To say the least, I wasn&rsquo;t happy with this program. It was slow to query all the endpoints, and the code felt bloated at best. Several optimizations could be made, least of which was writing it in something more lightweight.</p>

<p>First, I redesigned in my head, how it should work. First off, the parsing of Haproxy&rsquo;s CSV endpoint was not performant or durable. If the <code>server name</code> attribute changed, it would not work. Also, Haproxy should have some kind of endpoint on it that VersionCtl could query to get available services - services listed on the server line in the haproxy.cfg file. This way I could also get the management port info that the current version of versionctl required to reach the /info endpoint.</p>

<p>This also meant I would have info regarding individual processes. Before, if we had many instances of the same service running on a box,  we&rsquo;d end up guessing what port each was running on since that isn&rsquo;t available in the CSV endpoint. The CSV endpoint should only be used to determine if a given <code>server name</code> is available, and that&rsquo;s it. All other service info needs to come out of the config file.</p>

<p>The second part is that this is a simple REST proxy for our /info endpoints - it should be fast as &hellip; fast. I wanted to make the service lightweight in the sense that haproxy&rsquo;s admin console is lightweight. Very simple HTML updated by a fast backend. Done and Done.</p>

<h2>A REST Interface for HaProxy</h2>

<p>First, we needed to build this rest interface for haproxy, I decided to use GoLang for this as I could easily build a binary for AMD64 and ship it to our linux distro via Puppet and an internal datastore.
The project is available <a href="https://github.com/malnick/rest_haproxy">here</a>, but let&rsquo;s take a closer look:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kn">package</span> <span class="nx">main</span>
</span><span class='line'>
</span><span class='line'><span class="kn">import</span> <span class="p">(</span>
</span><span class='line'>  <span class="s">&quot;bufio&quot;</span>
</span><span class='line'>  <span class="s">&quot;encoding/json&quot;</span>
</span><span class='line'>  <span class="s">&quot;log&quot;</span>
</span><span class='line'>  <span class="s">&quot;net/http&quot;</span>
</span><span class='line'>  <span class="s">&quot;os&quot;</span>
</span><span class='line'>  <span class="s">&quot;regexp&quot;</span>
</span><span class='line'>  <span class="s">&quot;strings&quot;</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kd">type</span> <span class="nx">Available</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">Name</span>     <span class="kt">string</span>
</span><span class='line'>  <span class="nx">Ip</span>       <span class="kt">string</span>
</span><span class='line'>  <span class="nx">Port</span>     <span class="kt">string</span>
</span><span class='line'>  <span class="nx">MgmtPort</span> <span class="kt">string</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">type</span> <span class="nx">Services</span> <span class="kd">struct</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">Servers</span> <span class="p">[]</span><span class="nx">Available</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We start with some basic data structures: one that ships our available services into JSON, and another that will drop into a slice that defines each service.</p>

<p>Our main() is straightforward:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kd">func</span> <span class="nx">main</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">http</span><span class="p">.</span><span class="nx">HandleFunc</span><span class="p">(</span><span class="s">&quot;/services&quot;</span><span class="p">,</span> <span class="nx">response</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">http</span><span class="p">.</span><span class="nx">ListenAndServe</span><span class="p">(</span><span class="s">&quot;:3000&quot;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>HandleFunc</code> takes our response function, which kicks off the rest of the process:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kd">func</span> <span class="nx">response</span><span class="p">(</span><span class="nx">rw</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">request</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">services</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">parsefile</span><span class="p">(</span><span class="s">&quot;/etc/haproxy/haproxy.cfg&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;ERROR: &quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="nx">json</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">Marshal</span><span class="p">(</span><span class="nx">services</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">rw</span><span class="p">.</span><span class="nx">Write</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">json</span><span class="p">))</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now things get interesting, the parsefile() takes the path to the haproxy.cfg, and loads it into the services struct:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'><span class="kd">func</span> <span class="nx">parsefile</span><span class="p">(</span><span class="nx">filename</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="nx">Services</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="c1">// Temp array</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">temp_avail</span> <span class="p">[]</span><span class="nx">Available</span>
</span><span class='line'>  <span class="kd">var</span> <span class="nx">a</span> <span class="nx">Available</span>
</span></code></pre></td></tr></table></div></figure>


<p>We define a temporary array with type <code>Available</code>, and an instance of <code>Available</code> as <code>a</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'>  <span class="c1">// Define our regex to parse</span>
</span><span class='line'>  <span class="nx">regex</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">regexp</span><span class="p">.</span><span class="nx">Compile</span><span class="p">(</span><span class="s">`^\s*server`</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span> <span class="c1">// there was a problem with the regular expression.</span>
</span><span class='line'>  <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then we define a rexex to match against. It matches any white space that eventually a <code>server</code> line directive.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'>  <span class="nx">inFile</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="nx">filename</span><span class="p">)</span>
</span><span class='line'>  <span class="k">defer</span> <span class="nx">inFile</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
</span><span class='line'>  <span class="nx">scanner</span> <span class="o">:=</span> <span class="nx">bufio</span><span class="p">.</span><span class="nx">NewScanner</span><span class="p">(</span><span class="nx">inFile</span><span class="p">)</span>
</span><span class='line'>  <span class="nx">scanner</span><span class="p">.</span><span class="nx">Split</span><span class="p">(</span><span class="nx">bufio</span><span class="p">.</span><span class="nx">ScanLines</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then we open the haproxy config, and build a new Scanner using bufio.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='go'><span class='line'>  <span class="k">for</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">Scan</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>    <span class="nx">line</span> <span class="o">:=</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">Text</span><span class="p">()</span>
</span><span class='line'>    <span class="k">if</span> <span class="nx">regex</span><span class="p">.</span><span class="nx">MatchString</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;MATCHED:\n&quot;</span><span class="p">,</span> <span class="nx">line</span><span class="p">)</span>
</span><span class='line'>      <span class="nx">larry</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">Fields</span><span class="p">(</span><span class="nx">line</span><span class="p">)</span>
</span><span class='line'>      <span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;LENGTH: &quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">larry</span><span class="p">))</span>
</span><span class='line'>      <span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;NAME: &quot;</span><span class="p">,</span> <span class="nx">larry</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span class='line'>      <span class="nx">a</span><span class="p">.</span><span class="nx">Name</span> <span class="p">=</span> <span class="nx">larry</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>      <span class="nx">dest</span> <span class="o">:=</span> <span class="nx">strings</span><span class="p">.</span><span class="nx">Split</span><span class="p">(</span><span class="nx">larry</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s">&quot;:&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nx">a</span><span class="p">.</span><span class="nx">Ip</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">Port</span> <span class="p">=</span> <span class="nx">dest</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">dest</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</span><span class='line'>      <span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;IP: &quot;</span><span class="p">,</span> <span class="nx">dest</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span><span class='line'>      <span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;PORT: &quot;</span><span class="p">,</span> <span class="nx">dest</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span><span class='line'>      <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">larry</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">a</span><span class="p">.</span><span class="nx">MgmtPort</span> <span class="p">=</span> <span class="nx">larry</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
</span><span class='line'>      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">a</span><span class="p">.</span><span class="nx">MgmtPort</span> <span class="p">=</span> <span class="nx">a</span><span class="p">.</span><span class="nx">Port</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;MGMT PORT: &quot;</span><span class="p">,</span> <span class="nx">a</span><span class="p">.</span><span class="nx">MgmtPort</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="nx">temp_avail</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">temp_avail</span><span class="p">,</span> <span class="nx">a</span><span class="p">)</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">return</span> <span class="o">&amp;</span><span class="nx">Services</span><span class="p">{</span>
</span><span class='line'>      <span class="nx">Servers</span><span class="p">:</span> <span class="nx">temp_avail</span><span class="p">,</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="kc">nil</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The last thing we do is scan each line in the file, match the server lines we want, and split those into slices on white space. We parse out the parts we want, and load those into our instance of <code>Available</code> as <code>a</code>.</p>

<p>I originally did this with a <code>strings.Split</code> but realized the white space at the beginning of the line would also be a slice element. I had to remove that white space. In the end, I went with <code>strings.Fields</code> since it only grabs non-blank strings, allowing me to have a known slice length.</p>

<p>We then append our instance of <code>a</code> to our <code>temp_avail</code> slice. Once we reach the end of the file, we pass <code>temp_avail</code> to our <code>Servers</code> key and return the pointer to &#8220;`Services&#8220;&#8220;.</p>

<p>The ability to have pointers in golang is one performance increase over creating new object variables (instance or class) in Ruby - you have far more control over memory allocation and variable bloat.</p>

<p>Upon return, golang dereferences the &amp;Services to a meaningful variable <code>services</code> in the response().</p>

<p>Once compete, response() marshels <code>services</code> to JSON and writes it out as a type <code>[]byte</code> (expected by http.ResponseWriter).</p>

<p>Given a haproxy configuration at path <code>/etc/haproxy/haproxy.cfg</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='ini'><span class='line'><span class="err">global</span>
</span><span class='line'>  <span class="err">daemon</span>
</span><span class='line'>  <span class="err">group</span>  <span class="err">haproxy</span>
</span><span class='line'>  <span class="err">log</span>  <span class="err">127.0.0.1</span> <span class="err">local0</span>
</span><span class='line'>  <span class="err">log</span>  <span class="err">127.0.0.1</span> <span class="err">local1</span> <span class="err">notice</span>
</span><span class='line'>  <span class="err">maxconn</span>  <span class="err">4096</span>
</span><span class='line'>
</span><span class='line'><span class="err">defaults</span>
</span><span class='line'>  <span class="err">log</span> <span class="err">global</span>
</span><span class='line'>  <span class="err">mode</span>  <span class="err">http</span>
</span><span class='line'>
</span><span class='line'><span class="err">frontend</span> <span class="err">http-in</span>
</span><span class='line'>  <span class="err">bind</span> <span class="err">*:80</span>
</span><span class='line'>  <span class="err">acl</span> <span class="err">service</span> <span class="err">path_beg</span> <span class="err">-t</span> <span class="err">/service</span>
</span><span class='line'>  <span class="err">acl</span> <span class="err">other_service</span> <span class="err">path_beg</span> <span class="err">-t</span> <span class="err">/other_service</span>
</span><span class='line'>  <span class="err">default</span> <span class="err">backend</span> <span class="err">my_service</span>
</span><span class='line'>  <span class="err">use_backend</span> <span class="err">service</span> <span class="err">if</span> <span class="err">my_service</span>
</span><span class='line'>  <span class="err">use_backend</span> <span class="err">other_service</span> <span class="err">if</span> <span class="err">other_service</span>
</span><span class='line'>
</span><span class='line'><span class="err">backend</span> <span class="err">service</span>
</span><span class='line'>  <span class="err">balance</span> <span class="err">leastconn</span>
</span><span class='line'>  <span class="err">server</span> <span class="err">service-01</span> <span class="err">10.0.1.10:31501</span> <span class="err">check</span> <span class="err">port</span> <span class="err">32501</span>
</span><span class='line'>  <span class="err">server</span> <span class="err">service-02</span> <span class="err">10.0.1.10:21502</span> <span class="err">check</span> <span class="err">port</span> <span class="err">32502</span>
</span><span class='line'>  <span class="err">server</span> <span class="err">service-03</span> <span class="err">10.0.2.10:31500</span> <span class="err">check</span> <span class="err">port</span> <span class="err">32501</span>
</span><span class='line'>  <span class="err">server</span> <span class="err">service-04</span> <span class="err">10.0.2.11:31500</span> <span class="err">check</span> <span class="err">port</span> <span class="err">32502</span>
</span><span class='line'>
</span><span class='line'><span class="err">backend</span> <span class="err">other_service</span>
</span><span class='line'>  <span class="err">balance</span> <span class="err">leastconn</span>
</span><span class='line'>  <span class="err">server</span> <span class="err">service-01</span> <span class="err">10.0.5.10:31501</span> <span class="err">check</span>
</span><span class='line'>  <span class="err">server</span> <span class="err">service-02</span> <span class="err">10.0.5.10:21502</span> <span class="err">check</span>
</span><span class='line'>  <span class="err">server</span> <span class="err">service-03</span> <span class="err">10.0.5.10:31503</span> <span class="err">check</span>
</span><span class='line'>  <span class="err">server</span> <span class="err">service-04</span> <span class="err">10.0.5.11:31500</span> <span class="err">check</span>
</span></code></pre></td></tr></table></div></figure>


<p>Will result in the following JSON endpoint available at: <code>localhost:3000/services</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;Servers&quot;</span><span class="p">:</span> <span class="p">[</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;service-01&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;Ip&quot;</span><span class="p">:</span> <span class="s2">&quot;10.0.1.10&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;Port&quot;</span><span class="p">:</span> <span class="s2">&quot;31501&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;MgmtPort&quot;</span><span class="p">:</span> <span class="s2">&quot;32501&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;service-02&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;Ip&quot;</span><span class="p">:</span> <span class="s2">&quot;10.0.1.10&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;Port&quot;</span><span class="p">:</span> <span class="s2">&quot;21502&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="nt">&quot;MgmtPort&quot;</span><span class="p">:</span> <span class="s2">&quot;32502&quot;</span>
</span><span class='line'>  <span class="p">},</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;service-03&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;Ip&quot;</span><span class="p">:</span> <span class="s2">&quot;10.0.2.10&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;Port&quot;</span><span class="p">:</span> <span class="s2">&quot;31500&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;MgmtPort&quot;</span><span class="p">:</span> <span class="s2">&quot;32501&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;service-04&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;Ip&quot;</span><span class="p">:</span> <span class="s2">&quot;10.0.2.11&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;Port&quot;</span><span class="p">:</span> <span class="s2">&quot;31500&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;MgmtPort&quot;</span><span class="p">:</span> <span class="s2">&quot;32502&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;service-01&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;Ip&quot;</span><span class="p">:</span> <span class="s2">&quot;10.0.5.10&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;Port&quot;</span><span class="p">:</span> <span class="s2">&quot;31501&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;MgmtPort&quot;</span><span class="p">:</span> <span class="s2">&quot;31501&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;service-02&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;Ip&quot;</span><span class="p">:</span> <span class="s2">&quot;10.0.5.10&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;Port&quot;</span><span class="p">:</span> <span class="s2">&quot;21502&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;MgmtPort&quot;</span><span class="p">:</span> <span class="s2">&quot;21502&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;service-03&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;Ip&quot;</span><span class="p">:</span> <span class="s2">&quot;10.0.5.10&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;Port&quot;</span><span class="p">:</span> <span class="s2">&quot;31503&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;MgmtPort&quot;</span><span class="p">:</span> <span class="s2">&quot;31503&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;Name&quot;</span><span class="p">:</span> <span class="s2">&quot;service-04&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;Ip&quot;</span><span class="p">:</span> <span class="s2">&quot;10.0.5.11&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;Port&quot;</span><span class="p">:</span> <span class="s2">&quot;31500&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;MgmtPort&quot;</span><span class="p">:</span> <span class="s2">&quot;31500&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Great, now we have a REST endpoint to get services out of HaProxy which is performant and lightweight. In part 2 of this post we&rsquo;ll see how to re-build the Ruby version of VersionCtl, which leverages this endpoint, in GoLang. We&rsquo;ll then review some performance benchmarkers to get meaningful insights to how much faster the GoLang implementation is.</p>


        <hr class="divider-short"/>

        
      </div>
    </div>
  </div>
</article>

<hr class="divider-short"/>

<div class="archive-link">
  <div class="container">
    <div class="row">
      <div class="col-md-8 col-md-offset-2">
        
          <a class="pull-left" href="/blog/2015/07/21/weak-dh-ciphers/" title="Previous Post: Weak Diffe-Helman SSL Ciphers">&laquo; Previous: Weak Diffe-Helman SSL Ciphers</a>
        

        
      </div>
    </div>
  </div>
</div>

    <footer id="footer" class="her-row">
  <div class="container">
    <div class="row">
      <div class="col-md-1">
  <a href="/"><h4>Home</h4></a>
</div>

<div class="col-md-2">
  <div class="social-icon-list">
    
    <a href="https://twitter.com/8bitsofsketch"><img src="/images/glyphicons_social_31_twitter.png"/></a>
    

    
    <a href="https://github.com/malnick"><img src="/images/glyphicons_social_21_github.png"/></a>
    

    

    
    <a href="mailto:malnick@gmail.com"><img src="/images/glyphicons_social_39_e-mail.png"/></a>
    
  </div>
</div>

<div class="pull-right">
  <h4>Powered by <a href="http://octopress.org/">Octopress</a>. Designed by <a href="http://AdrianArtiles.com">Adrian Artiles</a>.</h4>
</div>


    </div>
  </div>
</footer>

    
  </body>
</html>
