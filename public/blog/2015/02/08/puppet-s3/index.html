
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>puppet-s3 & continuous integration with Puppet, Jenkins and AWS - </title>
  <meta name="author" content="Jeff">

  
  <meta name="description" content="puppet-s3 & continuous integration with Puppet, Jenkins and AWS written The (puppet-s3)[https://www.github.com/malnick/puppet-s3] module. Usage: 1
2 &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="httpL://www.jeffmalnick.com/blog/2015/02/08/puppet-s3">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  

</head>

  <body>
    <a href="/" class="home-icon">
      <img src="/images/home.png"/>
    </a>

    <article role="article" class="full-single-article">
  <div class="container">
    <div class="row">
      <div class="col-md-8 col-md-offset-2">
        <h1>puppet-s3 & continuous integration with Puppet, Jenkins and AWS</h1>
        <div class="meta">
          written 








  



<time datetime="2015-02-08T15:29:47-08:00" pubdate data-updated="true"></time>
          


        </div>
        <p>The (puppet-s3)[<a href="https://www.github.com/malnick/puppet-s3">https://www.github.com/malnick/puppet-s3</a>] module.</p>

<p>Usage:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">s3</span> <span class="p">{</span> <span class="s1">&#39;/path/to/file/on/my/local/filesystem&#39;</span><span class="p">:</span>
</span><span class='line'>    <span class="c1"># Required paramters:</span>
</span><span class='line'>    <span class="k">ensure</span>              <span class="o">=&gt;</span> <span class="n">present</span><span class="p">,</span>
</span><span class='line'>    <span class="n">source</span>              <span class="o">=&gt;</span> <span class="s1">&#39;/bucket/path/to/object&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">access_key_id</span>       <span class="o">=&gt;</span> <span class="s1">&#39;mysecret&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="n">secret_access_key</span>   <span class="o">=&gt;</span> <span class="s1">&#39;anothersecret&#39;</span><span class="p">,</span>
</span><span class='line'>    <span class="c1"># Optional parameters:</span>
</span><span class='line'>    <span class="n">region</span>              <span class="o">=&gt;</span> <span class="s1">&#39;us-west-1&#39;</span><span class="p">,</span> <span class="c1"># Defaults to us-east-1</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Overview</h2>

<p>Puppet s3 is my response to the need for secure downloads from S3 via Puppet. At SRC:CLR we use IAM authentication for S3 downloads. This piece of Puppet allows us to build out
our Jenkins continuous integration hook between the build and deployment process.</p>

<p>Currently the S3 type is only <em>psudo-idempotent</em>. What does that mean? It means <code>exists()?</code> actually pulls down the specified object to compare to the one on disk via a
tempfile. Then, if it returns false, <code>create()</code> pulls it down again.</p>

<p>Yes, this is horribly inefficient.</p>

<p>Yes, performance falls.</p>

<p>Yes, I plan on changing it in the near future.</p>

<h2>The Longview</h2>

<p>The reason we needed this provider is to enable us to pull S3 objects using our IAM authentication. But that is one small step towards our larger goal of fully integrating our Jenkins build
pipeline with our Puppet deployed AWS infrastructure.</p>

<p>To fully realize this integration we needed a way to pull the S3 zip file that is our built application, from S3. Jenkins deposits this zip file for us.</p>

<p>Then, Puppet compares the version number on S3 with the version number on disk. If greater, it pulls the new version.</p>

<h2>The Pipeline</h2>

<p>The pipeline from <code>git push</code> to <code>puppet agent -t</code> looks like this:</p>

<ol>
<li>A PR is submitted in Github and human eyes do a final check on the code.</li>
<li>If the human check passes, a manual merge to master is invoked.</li>
<li>A human manually runs a Jenkins build for either QA or Production environments. Lets assume this is a production deployment for this example.</li>
<li>The Jenkins build:

<ol>
<li>Runs Java tests</li>
<li>If the tests pass, builds a Java Jar.</li>
<li>Places this jar on S3 as: <code>our_app_${version}.zip</code> Let&rsquo;s assume $version is 3.2.1</li>
<li>Sends a HTTP POST to our Puppet Master with the following JSON:</li>
</ol>
</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="err">&#39;environment&#39;:&#39;production&#39;,</span>
</span><span class='line'>    <span class="err">&#39;role&#39;:&#39;application_backend&#39;,</span>
</span><span class='line'>    <span class="err">&#39;version&#39;:&#39;3.2.1&#39;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>A webhook running on our Puppet Master parses the POST and does the following:</p>

<ol>
<li>Edits the hieradata file at <code>/etc/puppetlabs/puppet/environments/${environment}/roles/${role}.yaml</code> to replace the value of key <code>profiles::sc_services::application_backend::version</code> with
the value sent in the POST: 3.2.1. $environment and $role are also inserted in the $path above to make a fully qualified path.</li>
<li>Commits this yaml data file locally and pushes it back up to our Puppet control repo.</li>
<li>It then invokes MCO as:</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">su</span> <span class="o">-</span> <span class="n">peadmin</span> <span class="o">-</span><span class="n">c</span> <span class="err">&#39;</span><span class="n">mco</span> <span class="n">puppet</span> <span class="n">runonce</span> <span class="o">-</span><span class="n">F</span> <span class="n">role</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="n">role</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Where $role is our role sent in the POST</p>


        <hr class="divider-short"/>

        
      </div>
    </div>
  </div>
</article>

<hr class="divider-short"/>

<div class="archive-link">
  <div class="container">
    <div class="row">
      <div class="col-md-8 col-md-offset-2">
        
          <a class="pull-left" href="/blog/2015/02/06/puppet-webhook/" title="Previous Post: puppet-webhook">&laquo; Previous: puppet-webhook</a>
        

        
          <a class="pull-right" href="/blog/2015/02/20/why-devops-isnt-a-job-its-a-culture/" title="Next Post: Why DevOps Isn't a Job, It's a Culture">Next: Why DevOps Isn&#8217;t a Job, It&#8217;s a Culture &raquo;</a>
        
      </div>
    </div>
  </div>
</div>

    <footer id="footer" class="her-row">
  <div class="container">
    <div class="row">
      <div class="col-md-1">
  <a href="/"><h4>Home</h4></a>
</div>

<div class="col-md-2">
  <div class="social-icon-list">
    
    <a href="https://twitter.com/8bitsofsketch"><img src="/images/glyphicons_social_31_twitter.png"/></a>
    

    
    <a href="https://github.com/malnick"><img src="/images/glyphicons_social_21_github.png"/></a>
    

    

    
    <a href="mailto:malnick@gmail.com"><img src="/images/glyphicons_social_39_e-mail.png"/></a>
    
  </div>
</div>

<div class="pull-right">
  <h4>Powered by <a href="http://octopress.org/">Octopress</a>. Designed by <a href="http://AdrianArtiles.com">Adrian Artiles</a>.</h4>
</div>


    </div>
  </div>
</footer>

    
  </body>
</html>
